<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://eclipse-leda.github.io/leda/docs/app-deployment/">
<link rel="alternate" type="application/rss&#43;xml" href="https://eclipse-leda.github.io/leda/docs/app-deployment/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/leda/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/leda/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/leda/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/leda/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/leda/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/leda/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/leda/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/leda/favicons/android-192x192.png" sizes="192x192">

<title>Vehicle Applications | Eclipse Leda Documentation</title>
<meta name="description" content="">
<meta property="og:title" content="Vehicle Applications" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://eclipse-leda.github.io/leda/docs/app-deployment/" />
<meta itemprop="name" content="Vehicle Applications">
<meta itemprop="description" content=""><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vehicle Applications"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/leda/scss/main.min.f3285dc0e759279bf1de548d3a7e5438b3bc2cb632d1b1b15d9b597f0091a2c6.css" as="style">
<link href="/leda/scss/main.min.f3285dc0e759279bf1de548d3a7e5438b3bc2cb632d1b1b15d9b597f0091a2c6.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W31KMZWGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-6W31KMZWGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/leda/"><span class="navbar-brand__logo navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="30 270 300 300" id="svg2"><defs id="defs6"><clipPath id="clipPath24" clipPathUnits="userSpaceOnUse"><path id="path22" d="m5116.71 2737.03v81.36c0 51.02 13.61 71.72 55.28 74.55h288.29v-182.27c-4.26-34.29-16.73-48.19-55.28-48.19h-226.21c-47.05.0-62.08 20.69-62.08 74.55zm-139.46 17.86c0-128.41 84.19-198.71 222.24-198.71h42.8c107.43.0 184.82 2.84 217.99 84.19v-84.19h137.76v534.05c0 128.13-97.8 198.71-235.85 198.71H5051.8v-106.3h360c36 0 48.48-23.52 48.48-60.66v-122.74h-260.79c-138.05.0-222.24-70.59-222.24-198.71zm-332.5-44.22c-3.97-34.29-16.44-48.19-55-48.19h-225.07c-46.76.0-62.08 20.69-62.08 74.55v371.06c0 51.03 13.9 71.71 55.28 74.55h231.87c41.39-2.84 55-23.52 55-74.55zm139.46 854.08h-138.04v-360c-33.17 81.36-110.28 84.19-217.99 84.19h-42.8c-137.77.0-221.96-70.58-221.96-198.71v-335.34c0-128.41 84.19-198.71 221.96-198.71h42.8c107.71.0 184.82 2.84 217.99 84.19v-84.19h138.04zm-925.8-587.62h-362.83v144.85c0 28.91 12.47 60.66 48.2 60.66h266.45c35.71.0 48.18-31.75 48.18-60.66zm139.47-106.3v219.4c0 128.13-98.08 198.71-236.13 198.71h-169.51c-138.04.0-235.84-70.58-235.84-198.71v-335.34c0-128.41 97.8-198.71 235.84-198.71h405.64v106.3h-454.1c-35.73.0-48.2 23.54-48.2 60.66v147.69zM2642.92 2556.18h630.71v117.36h-483.02v794.55h-147.69z"/></clipPath><linearGradient id="linearGradient34" spreadMethod="pad" gradientTransform="matrix(2955.12,0,0,-2955.12,2642.92,3060.47)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop26" offset="0" style="stop-opacity:1;stop-color:#77add1"/><stop id="stop28" offset=".189014" style="stop-opacity:1;stop-color:#64c6ee"/><stop id="stop30" offset=".994475" style="stop-opacity:1;stop-color:#7b3199"/><stop id="stop32" offset="1" style="stop-opacity:1;stop-color:#7b3199"/></linearGradient><linearGradient id="linearGradient44" spreadMethod="pad" gradientTransform="matrix(1875.15,0,0,-1875.15,364.686,2981.28)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop38" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop40" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop42" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient><clipPath id="clipPath54" clipPathUnits="userSpaceOnUse"><path id="path52" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31z"/></clipPath><linearGradient id="linearGradient70" spreadMethod="pad" gradientTransform="matrix(1417.96,0,0,-1417.96,477.178,2901.88)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop56" offset="0" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop58" offset=".11811164" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop60" offset=".509456" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop62" offset=".76356415" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop64" offset=".994475" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop66" offset=".99510668" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop68" offset="1" style="stop-opacity:1;stop-color:#4e9133"/></linearGradient><linearGradient id="linearGradient80" spreadMethod="pad" gradientTransform="matrix(942.78,0,0,-942.78,720.659,3019.8)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop74" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop76" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop78" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient></defs><g transform="matrix(1.3333333,0,0,-1.3333333,0,795.04)" id="g10"><g transform="scale(0.1)" id="g12"><path id="path46" style="fill:url(#linearGradient44);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m462.512 2989.03c1.133-223.65 47.902-452.13 142.867-685.13 24.66-60.94 67.465-109.13 120.187-139.47 52.727-30.61 115.657-43.93 180.852-35.14 236.122 32.03 453.262 104.03 650.552 218.55 193.89 112.53 368.79 266.17 523.27 463.18 41.11 52.15 61.8 113.67 61.8 174.9.28 61.51-20.13 123.02-60.95 175.18-145.7 186.8-317.19 337.89-515.62 450.99-194.74 110.83-415.84 185.1-665.005 220.82-65.481 9.36-128.692-3.4-181.699-33.74C665.758 3768.85 622.672 3720.94 597.441 3660c-90.14-219.4-136.062-443.06-134.929-670.97zm51.875-721.98c-99.5 244.06-148.535 484.73-149.668 721.42-1.418 241.23 47.054 477.63 142.297 708.66 33.73 81.92 91.843 146.27 163.273 187.08 71.719 40.82 156.473 58.11 244.066 45.64 261.355-37.13 494.075-115.65 699.595-232.72 209.76-119.34 390.61-278.65 544.25-475.66 54.71-70.01 81.92-152.78 81.63-235.55.0-83.06-27.49-165.83-82.2-235.56-162.42-206.65-346.68-368.5-551.62-487.27-208.35-121.05-437.67-197.02-686.549-230.75-87.313-11.9-171.785 5.95-242.934 47.05-71.433 41.39-128.976 106.02-162.14 187.66v0"/><g id="g48"><g clip-path="url(#clipPath54)" id="g50"><path id="path72" style="fill:url(#linearGradient70);fill-opacity:1;fill-rule:nonzero;stroke:none" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31v0"/></g></g><path id="path82" style="fill:url(#linearGradient80);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m935.898 3147.21c-54.71-85.89-93.543-185.38-115.085-298.77-4.821-24.94-1.418-49.33 9.07-69.74 10.207-20.69 27.496-37.98 49.605-48.75 97.508-46.78 197.292-73.42 300.192-78.81 101.19-5.1 205.51 9.92 312.94 46.78 23.81 8.21 42.81 23.53 55.56 42.8 12.48 19.56 18.71 43.37 16.44 68.88-9.07 108.28-36.57 208.92-83.9 301.61-46.49 91.28-111.97 175.18-197.58 251.15-18.71 16.44-41.1 25.51-63.78 26.93-22.67 1.13-45.92-5.11-66.33-19.28-88.72-61.51-161.292-135.78-217.132-222.8zM724.434 2866.87c24.093 125.28 67.461 236.12 128.976 332.78 63.211 98.93 144.563 182.27 243.5 250.87 38.83 27.21 83.9 39.11 128.12 36.56 44.22-2.55 87.31-19.84 123.03-51.59 95.24-84.47 168.37-178.01 220.25-279.78 53-104.31 84.19-217.14 94.39-337.89 3.97-47.61-8.22-92.98-32.6-130.39-24.09-37.42-60.66-66.9-105.45-82.21-119.34-41.1-236.12-57.83-349.79-51.87-115.94 6.24-228.473 36-337.325 88.44-42.805 20.41-75.398 53.29-95.242 92.98-19.848 39.68-26.648 85.6-17.859 132.1v0"/></g></g></svg></span><span class="navbar-brand__name">Eclipse Leda Documentation</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/eclipse-leda" target="_blank" rel="noopener"><span>GitHub</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/leda/offline-search-index.931e6b2db63949a378036ff13b343c7c.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>

  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/leda/docs/app-deployment/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Vehicle Applications</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-10a0e990614b64cb6bbaff75a319ebb7">Seat Adjuster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-5505f58168fbe80d37b842b17c307c91">Dog Mode</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-3883f410544279ff57519024d0f51858">VSS &amp; Kuksa.VAL</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-dbbddc97bd5f17bd1da0e1904dfc0feb">Custom Vehicle Signals</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-b17a47275ec6859512c169cb02d9ee24">CarSim</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-7f8e31fb834452efdebda21d1bf86969">Velocitas VApps</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-03ddd8c0f79b13ee47ac2332bd2c2a23">Cloud2Device Messages</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>


<div class="content">
      <p>This chapter contains use cases and examples for SDV applications.</p>
<p>Some of these example are taken from the following sources:</p>
<ul>
<li><a href="https://digital.auto">Digital.Auto</a> and its <a href="https://digitalauto.netlify.app/">playground</a></li>
<li><a href="https://eclipse.dev/velocitas/docs/tutorials/">Eclipse Velocitas tutorials</a></li>
<li><a href="https://github.com/eclipse/kuksa.val.services">Eclipse Kuksa.VAL examples</a></li>
<li><a href="https://projects.eclipse.org/projects/automotive.sdv-blueprints">Eclipse SDV Blueprints</a></li>
<li><a href="https://github.com/eclipse-chariott/chariott/tree/main/examples/applications">Eclipse Chariott examples</a></li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-10a0e990614b64cb6bbaff75a319ebb7">1 - Seat Adjuster</h1>
    
	<p>The <strong>Seat Adjuster</strong> use case has been derived from the <a href="https://eclipse.dev/velocitas/docs/about/use_cases/seat_adjuster/">Eclipse Velocitas Seat Adjuster example</a>,
the <a href="https://github.com/eclipse/kuksa.val.services/tree/main/seat_service">Eclipse Kuksa.VAL Seat Service example</a>
and the <a href="https://digitalauto.netlify.app/model/997XF1ch2f5DjgPIzhY3/library/prototype/ZqhnonCBSSwP8ZVM7CFh">Digital.Playground Prototyping Library</a></p>
<h2 id="description">Description</h2>
<p>The Seat Adjuster use cases demonstrates the idea of having a cloud-based driver profile hosted by a third-party web service,
which is then used by a custom application to move the driver seat to certain positions.</p>
<p>Examples range from simple personalization to dynamic seat control (such as periodic back massages) based on personal health treatment plans by an health insurance organization.
A driver could opt-in to such a service, which would lead to the ad-hoc installation of a seat adjuster vehicle application when the driver enters the vehicle.
The seat adjuster application would then contact the health insurance webservice to retrieve the driver&rsquo;s personal treatment plan for back massage and
start moving the motors in certain intervals, to ease or prevent back pain during long driving periods.</p>
<p>This example focuses on the technical aspect, namely the interface between such an assumed application with the high-level logic,
and the lower-level backend service (Seat Service), which controls the communication to the underlying hardware (Seat ECU).
In this case, the Vehicle Signal Specification and the simple signal for seat position is used exemplarily.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><img src="seatadjuster.png" alt="Leda Seat Adjuster Use Case"></p>
<ul>
<li>Cloud or mobile trigger: not part of the Leda image, but can be simulated by issueing MQTT messages</li>
<li>Eclipse Velocitas - Vehicle Application: <strong>Seat Adjuster</strong> (to be deployed by user as part of the Velocitas tutorial)</li>
<li>Eclipse Kuksa.VAL - Example Service: <strong>Seat Service</strong> (pre-installed)</li>
<li>Eclipse Kuksa.VAL - <strong>Data Broker</strong> (pre-installed)</li>
<li>Seat ECU and the separate Seat Motor hardware: not part of the Leda image, but can be emulated using virtual CAN-Bus.
The Kuksa Seat Service container contains configuration options to use VCAN</li>
</ul>
<h2 id="data-flow">Data Flow</h2>
<p>In the high-level data flow, the northbound applications interact with the <em>Vehicle Abstraction Layer</em> via the data broker:</p>
<div class="mermaid">flowchart TB
    seatadjuster[Seat Adjuster]
    databroker[(Kuksa.VAL<br>Data Broker)]
    seatservice[Seat Service]

    seatadjuster -- "Vehicle.Cabin.Seat.Row1.Pos1.Position" --> databroker
    databroker <-.-> seatservice
  </div>
  
  <h3 id="detailed-setting-position">Detailed: Setting position</h3>
<p>In this tutorial, let&rsquo;s have a more detailed look into the involved interfaces in the data flow for setting a <em>desired seat position</em>.</p>
<p>The <strong>Client</strong> can be a local app, e.g. deployed in the Infotainment domain and provide a user interface to the driver. It could also be a remotely deployed cloud application, sending the same request to move the seat via cloud messaging infrastructure.</p>
<div class="mermaid">flowchart TB
    client[Client]
    anotherClient[Another Client]
    seatadjuster[Seat Adjuster]
    databroker[(Kuksa.VAL<br>Data Broker)]
    mqttRequest[[MQTT topic<br>seatadjuster/setPosition/request]]
    %% mqttResponse[[MQTT topic<br>seatadjuster/setPosition/response]]
    %% mqttCurrent[[MQTT topic<br>seatadjuster/currentPosition]]
    seatservice[Seat Service]
    canbus[CAN-Bus and Seat ECU]

    client -- "JSON Request: position, requestId" --> mqttRequest
    anotherClient -.-> mqttRequest
    mqttRequest --> seatadjuster
    seatadjuster -- "Set Desired<br>Vehicle.Cabin.Seat.Row1.Pos1.Position<br>gRPC" --> databroker
    databroker -- "Publish<br>Vehicle.Cabin.Seat.Row1.Pos1.Position<br>(Actuator)" --> seatservice
    seatservice -- "CAN Frame: SECU1_CMD1<br>CAN-ID 0x705" --> canbus
  </div>
  
  <p>The <strong>Data Broker</strong> and its use of the <em>Vehicle Signal Specification</em> represents the abstraction layer, to make the application&rsquo;s interface independent of the actual physical seat service.</p>
<p>The <strong>Seat Service</strong> uses the physical layer (e.g. CAN-Bus) to communicate with the vehicle actuators.</p>
<h3 id="responses-and-current-position">Responses and current position</h3>
<p>In this data flow diagram, it shows how the information about the processing of the request to set the desired position is handled, as well as continuous updates to inform clients about the current position while the seat is moving towards the desired position.</p>
<div class="mermaid">flowchart TD
    client[Client]
    anotherClient[Another Client]
    seatadjuster[Seat Adjuster]
    databroker[(Kuksa.VAL<br>Data Broker)]
%%    mqttRequest[[MQTT topic<br>seatadjuster/setPosition/request]]
    mqttResponse[[MQTT topic<br>seatadjuster/setPosition/response]]
    mqttCurrent[[MQTT topic<br>seatadjuster/currentPosition]]
    seatservice[Seat Service]
    canbus[CAN-Bus and Seat ECU]

    canbus -- "CAN Frame: SECU1_STAT<br>CAN-ID 0x712" --> seatservice
    seatservice -- "Feed<br>Vehicle.Cabin.Seat.Row1.Pos1.Position<br>(Sensor)" --> databroker
    databroker -- "Publish<br>Vehicle.Cabin.Seat.Row1.Pos1.Position" --> seatadjuster
    seatadjuster -- "Once" --> mqttResponse
    seatadjuster -- "While seat is moving" --> mqttCurrent
    mqttResponse -- "SetPosition Response<br>(Accepted / Error)" --> client
    mqttCurrent --> client

    mqttCurrent -.-> anotherClient
  </div>
  
  <h3 id="safety-considerations">Safety Considerations</h3>
<blockquote>
<p><strong>Attention:</strong> Safety considerations are not in scope for this example tutorial. This example is for demonstrating the general approach.
Actual safety requirements must be handled within the Seat ECU as the lowest level component to guard against non-safe use of the seat motors.
Non-ASIL domains are not certified for safety requirements. <strong>Please pay attention when following the physical CAN tutorial and attaching physical actuators to not harm anybody by accidental movements of seat motors.</strong></p>
</blockquote>
<p>However, the Seat Adjuster example application contains a rudimentary &ldquo;Safe State&rdquo; condition check: it will only allow to move the seat
when the vehicle is not moving.</p>
<p>The condition is using VSS path notation: <code>Vehicle.Speed == 0</code> (see <a href="https://github.com/eclipse-velocitas/vehicle-app-python-sdk/blob/v0.9.0/examples/seat-adjuster/src/main.py#L82">main.py#L82 in v0.9.0</a>)</p>
<blockquote>
<p>Note: The Kuksa.VAL CAN Feeder, which is deployed <em>by default on Eclipse Leda</em> is constantly updating the <a href="/leda/docs/vss/vehicle/driver/"><code>Vehicle.Speed</code></a>.
You need to disable the <code>feedercan</code> container, otherwise the Seat Adjuster application <em>will decline the request and not move the seat</em>.</p>
</blockquote>
<h2 id="getting-started">Getting started</h2>
<p>The following steps are based on Velocitas 0.9.0 and Leda 0.1.0:</p>
<ol>
<li>
<p>Follow the Velocitas <a href="https://eclipse.dev/velocitas/docs/about/use_cases/seat_adjuster/">Seat Adjuster tutorial</a>: fork, build and deploy your clone of the <a href="https://github.com/eclipse-velocitas/vehicle-app-python-sdk/tree/v0.9.0/examples/seat-adjuster">seat adjuster example (v0.9.0)</a></p>
</li>
<li>
<p>Download and run the Leda quickstart image, or run it in Docker:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -it ghcr.io/eclipse-leda/leda-distro/leda-quickstart-x86
</span></span></code></pre></div></li>
<li>
<p>Deploy your seat adjuster application to the container runtime</p>
<p>3.1 Manually by using <code>kanto-cm</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kanto-cm create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --name seatadjuster-app <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SDV_SEATSERVICE_ADDRESS=grpc://seatservice-example:50051&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SDV_MQTT_ADDRESS=mqtt://mosquitto:1883&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;SDV_MIDDLEWARE_TYPE=native&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --hosts<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;databroker:container_databroker-host, mosquitto:host_ip, seatservice-example:container_seatservice-example-host&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ghcr.io/&lt;YOUR_ORG&gt;/seat-adjuster-app:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kanto-cm start --name seatadjuster-app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kanto-cm logs --name seatadjuster-app
</span></span></code></pre></div><p>or</p>
<p>3.2 Provide a deployment descriptor in <code>/var/containers/manifests</code>.
An example deployment descriptor can be found in <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatadjuster-app.json.disabled">meta-leda-components</a>. Details on the deployment can be found in <a href="/leda/docs/app-deployment/velocitas/">Leda Vehicle Applications</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart kanto-auto-deployer
</span></span></code></pre></div></li>
<li>
<p>Ensure the databroker and the seat service containers are running and you know how to check their log files (kantui, kanto-cm)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kanto-cm logs --name seatservice-example
</span></span></code></pre></div></li>
<li>
<p>Subscribe to MQTT topics `seatadjuster/#&rsquo; to see the responses from the seat adjuster app:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mosquitto_sub -t <span style="color:#4e9a06">&#39;seatadjuster/#&#39;</span> -v
</span></span></code></pre></div></li>
<li>
<p>Disable the <code>feedercan</code> container: <code>kanto-cm stop -n feedercan</code> to stop updating the <a href="/leda/docs/vss/vehicle/driver/"><code>Vehicle.Speed</code></a> signal. If the feedercan container is not stopped, the seatadjuster-app will respond with the following error message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">seatadjuster/setPosition/response</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;requestId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;result&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Not allowed to move seat because vehicle speed is 9.0 and not 0&#34;</span><span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></div></li>
<li>
<p>Publish an MQTT message for the seat adjuster application to set the maximum position to <code>1000</code> (which is the equivalent to 100%):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mosquitto_pub -t seatadjuster/setPosition/request -m <span style="color:#4e9a06">&#39;{&#34;position&#34;: 1000, &#34;requestId&#34;: &#34;12345&#34;}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>The expected output responses on MQTT topics should look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>seatadjuster/setPosition/request {&#34;position&#34;: 1000, &#34;requestId&#34;: &#34;12345&#34;}
</span></span><span style="display:flex;"><span>seatadjuster/setPosition/response {&#34;requestId&#34;: &#34;12345&#34;, &#34;result&#34;: {&#34;status&#34;: 0, &#34;message&#34;: &#34;Set Seat position to: 1000&#34;}}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 00}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 10}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 20}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 30}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 40}
</span></span><span style="display:flex;"><span>seatadjuster/currentPosition {&#34;position&#34;: 50}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
</ol>
<h2 id="seat-adjuster">Seat Adjuster</h2>
<p>The Seat Adjuster application needs to be reconfigured, as Velocitas SDK by default uses the DAPR middleware.
On Eclipse Leda, there is no DAPR middleware installed by default and hence, the Velocitas application will use the <em>Native</em> middleware type.</p>
<p>Also, the hostnames of dependent services need to be configured according to the actual network setup in Eclipse Leda&rsquo;s container runtime:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>SDV_SEATSERVICE_ADDRESS=grpc://seatservice-example:50051
</span></span><span style="display:flex;"><span>SDV_MQTT_ADDRESS=mqtt://mosquitto:1883
</span></span><span style="display:flex;"><span>SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555
</span></span><span style="display:flex;"><span>SDV_MIDDLEWARE_TYPE=native
</span></span></code></pre></div><p>Hostname configuration also needs to be updated accordingly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>databroker:container_databroker-host
</span></span><span style="display:flex;"><span>mosquitto:host_ip
</span></span><span style="display:flex;"><span>seatservice-example:container_seatservice-example-host
</span></span></code></pre></div><h3 id="testing">Testing</h3>
<p>To test the Seat Adjuster app API, send the following MQTT message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_pub -t seatadjuster/setPosition/request -m <span style="color:#4e9a06">&#39;{&#34;position&#34;: 300, &#34;requestId&#34;: 1}&#39;</span> -d
</span></span></code></pre></div><blockquote>
<p><em>Note:</em> To see also the responses, run <code>mosquitto_pub -t 'seatadjuster/#' -m '{&quot;position&quot;: 350}'</code> on a separate shell</p>
</blockquote>
<h3 id="prototyping">Prototyping</h3>
<p>The pseudo-code for the Seat Adjuster application could look like the following excerpt from the <a href="https://digitalauto.netlify.app/model/997XF1ch2f5DjgPIzhY3/library/prototype/ZqhnonCBSSwP8ZVM7CFh/view/code">Digital.Playground example</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">sdv_model</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Vehicle</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vehicle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Vehicle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">on_user_profile_changed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Height</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#34;VerticalHeight&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Position</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#34;HorizontalPosition&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><p>In the next step, this prototype can be taken to the next level of implementation by using the <a href="https://github.com/eclipse-velocitas/vehicle-app-python-sdk/blob/main/examples/seat-adjuster/src/main.py#L81">Velocitas example</a> to express it like this, with possibly more logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@subscribe_topic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;seatadjuster/setPosition/request&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">on_set_position_request_received</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_str</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vehicle_speed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Speed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">vehicle_speed</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Position</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">position</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Set Seat position to: </span><span style="color:#4e9a06">{</span><span style="color:#000">position</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Failed to set the position </span><span style="color:#4e9a06">{</span><span style="color:#000">position</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, error: </span><span style="color:#4e9a06">{</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Exception on set Seat position&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">error_msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;&#34;&#34;Not allowed to move seat because vehicle speed
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        is </span><span style="color:#4e9a06">{</span><span style="color:#000">vehicle_speed</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> and not 0&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">error_msg</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">publish_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response_topic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="seat-service">Seat Service</h2>
<p>The Seat Service is a <em>Vehicle Service</em> example implementation.</p>
<p>It communicates with the physical vehicle layer, in this case either a virtual or physical CAN bus, to control the Seat ECU.</p>
<p>The example container is configured to use emulated CAN-Bus and deployed by default.</p>
<h3 id="vehicle-signal">Vehicle Signal</h3>
<p>The VSS Path under control by Seat Service is <a href="/leda/docs/vss/vehicle/cabin/seat/row1/pos1/position/"><code>Vehicle.Cabin.Seat.Row1.Pos1.Position</code></a>:</p>
<blockquote>
<p><em>Signal Description:</em> Seat position on vehicle x-axis. Position is relative to the frontmost position supported by the seat. 0 = Frontmost position supported.</p>
</blockquote>
<p>The value is the <em>distance measured in millimeters</em>.</p>
<p>The example implementation supports values between <code>0</code> and <code>1000</code> millimeters.</p>
<blockquote>
<p><em>Note:</em> This range of valid values is not reflected in the standard Vehicle Signal Specification. OEMs would overlay the VSS tree with actual Min/Max values, depending on the specific seat hardware available in the specific vehicle model.</p>
</blockquote>
<h3 id="testing-1">Testing</h3>
<p>Whether you are running the seatservice-example with a simulated CAN or a physical (emulated) CAN, the seatservice-example container included in the Leda Quickstart image provides a simple client application that can be used to test the GRPC interface.</p>
<p>To set the seat position to <code>x%</code>, take <code>x*10</code> and truncate it to an integer <code>&lt;position&gt;</code>. Then using the sdv-ctr-exec script issue the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sdv-ctr-exec -n seatservice-example /app/bin/seat_svc_client &lt;position&gt;
</span></span></code></pre></div><p>You can now check the logs (either with <code>kanto-cm logs</code> or <code>kantui</code>) and you should be able to see the <code>seatservice-example</code> application responding to the command by moving the seat to the desired position.</p>
<h3 id="virtual-can-bus">Virtual CAN-Bus</h3>
<ol>
<li>
<p>You will have to generate initial CAN frames that will emulate the car ECU responding to the service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cangen -v can0 -L <span style="color:#0000cf;font-weight:bold">8</span> -I <span style="color:#0000cf;font-weight:bold">712</span> -D r -n <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>can0  712#4F.BF.B0.6B.5F.2D.54.09
</span></span><span style="display:flex;"><span>can0  712#13.2E.98.7E.77.11.99.5B
</span></span><span style="display:flex;"><span>can0  712#15.70.87.07.73.24.3A.7A
</span></span><span style="display:flex;"><span>can0  712#99.7F.F5.3F.FB.99.00.04
</span></span><span style="display:flex;"><span>can0  712#FE.1C.D5.55.22.86.3A.1F
</span></span></code></pre></div></li>
<li>
<p>You can now start tracing CAN frames written to the bus with <code>candump can0</code></p>
</li>
<li>
<p>From now on when a request to change the seat position is issued you will be able to see the corresponding CAN frames in the trace.</p>
</li>
</ol>
<p><em>Note</em>: On QEMU you can tunnel the host CAN bus to the guest: <a href="../../general-usage/running-qemu/canbus/#enabling-can-bus-interfaces-can">Tunneling a CAN Interface from the Host</a>.</p>
<h3 id="hardware-can-bus">Hardware CAN-Bus</h3>
<p>The default configuration of the <em>Seat Service</em> is using simulated VCAN. If you want to switch to a physical CAN-Bus interface, the container needs to have access to the CAN-Bus hardware.</p>
<p>Such a CAN-Bus device might be a Raspberry Pi setup with an MCP251x-based CAN-Hat extension or a QEMU image with an emulated <em>kvaser_pci</em> device (enabled on the Leda QEMU Quickstart images by default).</p>
<p>This setup would require some adjustments to the container manifest in order for the container to have access to the physical CAN-Bus.</p>
<ol>
<li>
<p>Make Seat Service container privileged and run on the host network interface:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;host_config&#34;</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Remove all port mappings and extra hosts (set <code>&quot;extra_hosts&quot;: []</code> and <code>&quot;port_mappings&quot;: []</code>) for the container as it&rsquo;s now running in host-networking mode (host_ip variable no longer available) and all ports are directly exposed.</p>
</li>
<li>
<p>Set the address to the databroker to <code>localhost:30555</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;BROKER_ADDR=127.0.0.1:30555&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Reconfigure the seat controller application to use the physical CAN interface, please see Eclipse Kuksa.VAL <a href="https://github.com/eclipse/kuksa.val.services/blob/main/seat_service/src/lib/seat_adjuster/seat_controller/README.md">seat_controller/README.md</a> for details:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#000">SC_CAN</span><span style="color:#ce5c00;font-weight:bold">=</span>can0
</span></span><span style="display:flex;"><span><span style="color:#000">CAN</span><span style="color:#ce5c00;font-weight:bold">=</span>can0
</span></span></code></pre></div><p>All the necessary changes combined for clarity as a single diff can be found below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#a40000">--- ../meta-leda-fork/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example_dev/seatservice.json	2023-03-06 11:32:00.771754434 +0200
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+++ seatservice-new.json	2023-03-06 11:37:12.967182044 +0200
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span><span style="color:#800080;font-weight:bold">@@ -14,26 +14,16 @@
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>    &#34;hooks&#34;: [],
</span></span><span style="display:flex;"><span>    &#34;host_config&#34;: {
</span></span><span style="display:flex;"><span>        &#34;devices&#34;: [],
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;network_mode&#34;: &#34;bridge&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;privileged&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        &#34;network_mode&#34;: &#34;host&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+        &#34;privileged&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        &#34;restart_policy&#34;: {
</span></span><span style="display:flex;"><span>            &#34;maximum_retry_count&#34;: 0,
</span></span><span style="display:flex;"><span>            &#34;retry_timeout&#34;: 0,
</span></span><span style="display:flex;"><span>            &#34;type&#34;: &#34;unless-stopped&#34;
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        &#34;runtime&#34;: &#34;io.containerd.runc.v2&#34;,
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;extra_hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            &#34;databroker-host:host_ip&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        ],
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;port_mappings&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            {
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;protocol&#34;: &#34;tcp&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;container_port&#34;: 50051,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_ip&#34;: &#34;localhost&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_port&#34;: 30051,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_port_end&#34;: 30051
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            }
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        ],
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        &#34;extra_hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+        &#34;port_mappings&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        &#34;log_config&#34;: {
</span></span><span style="display:flex;"><span>            &#34;driver_config&#34;: {
</span></span><span style="display:flex;"><span>                &#34;type&#34;: &#34;json-file&#34;,
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">@@ -58,9 +48,11 @@
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>    },
</span></span><span style="display:flex;"><span>    &#34;config&#34;: {
</span></span><span style="display:flex;"><span>        &#34;env&#34;: [
</span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;BROKER_ADDR=databroker-host:30555&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;RUST_LOG=info&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;vehicle_data_broker=info&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+            &#34;CAN=can0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;SC_CAN=can0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;BROKER_ADDR=127.0.0.1:30555&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;RUST_LOG=info&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;vehicle_data_broker=info&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        ],
</span></span><span style="display:flex;"><span>        &#34;cmd&#34;: []
</span></span><span style="display:flex;"><span>    },
</span></span></code></pre></div></li>
</ol>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/COVESA/vehicle_signal_specification/blob/master/spec/Cabin/SingleSeat.vspec">https://github.com/COVESA/vehicle_signal_specification/blob/master/spec/Cabin/SingleSeat.vspec</a></li>
<li><a href="https://github.com/eclipse/kuksa.val.services/tree/main/seat_service">https://github.com/eclipse/kuksa.val.services/tree/main/seat_service</a></li>
<li><a href="https://eclipse.dev/velocitas/docs/about/use_cases/seat_adjuster/">https://eclipse.dev/velocitas/docs/about/use_cases/seat_adjuster/</a></li>
<li><a href="https://github.com/eclipse-velocitas/vehicle-app-python-sdk/tree/v0.9.0/examples/seat-adjuster">https://github.com/eclipse-velocitas/vehicle-app-python-sdk/tree/v0.9.0/examples/seat-adjuster</a></li>
<li><a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatadjuster-app.json.disabled">https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatadjuster-app.json.disabled</a></li>
<li><a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatservice.json">https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatservice.json</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5505f58168fbe80d37b842b17c307c91">2 - Dog Mode</h1>
    
	<p>The <strong>Dog Mode</strong> use case has been derived from the <a href="https://eclipse.dev/velocitas/docs/about/use_cases/dog_mode/">Eclipse Velocitas Dog Mode example</a> and the <a href="https://github.com/eclipse/kuksa.val.services/tree/main/hvac_service">Eclipse Kuksa.VAL HVAC Service example</a>.</p>
<h2 id="description">Description</h2>
<p>In the <strong>Dog Mode</strong> use case, an existing vehicle service (such as HVAC for Heating, Ventilation and Air Conditioning) is used for another use case.
When a driver enables the dog mode, the vehicle will keep the climate in a status to accomodates the pet while the driver is gone for a few minutes.</p>
<p>The focus on this example is to show how an additional application can reuse existing functionality for new use cases. The vehicle service being used does not need to be adapted for the new use case. The new use case is deployed as an additional functionality, separated from the rest of the existing system.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><img src="dogmode.png" alt="Leda Dog Mode Use Case"></p>
<ul>
<li>Cloud or mobile trigger: not part of the Leda image, but can be simulated by issueing MQTT messages</li>
<li>Eclipse Velocitas - Vehicle Application: <strong>Dog Mode</strong> (to be deployed by user as part of the Velocitas tutorial)</li>
<li>Eclipse Kuksa.VAL - Example Service: <strong>HVAC Service</strong> (pre-installed)</li>
<li>Eclipse Kuksa.VAL - <strong>Data Broker</strong> (pre-installed)</li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ol>
<li>
<p>Follow the Velocitas tutorial: build and deploy your clone of the <a href="https://eclipse.dev/velocitas/docs/about/use_cases/dog_mode/">dog mode example</a></p>
</li>
<li>
<p>Download and run the Leda quickstart image</p>
</li>
<li>
<p>Deploy the application to the container runtime, either manually by using <code>kanto-cm create</code> or by providing a deployment descriptor in <code>/var/containers/manifests</code>. An example deployment descriptor can be found in <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatservice.json">meta-leda-components</a>. Details on the deployment can be found in <a href="/leda/docs/app-deployment/velocitas/">Leda Vehicle Applications</a></p>
</li>
<li>
<p>Ensure the databroker and the service containers are running and you know how to check their log files</p>
</li>
<li>
<p>Monitor vehicle data: <code>mosquitto_sub -t dogmode/display</code></p>
</li>
<li>
<p>Enable dog mode by using the <code>databroker-cli</code></p>
<pre><code> connect
 set Vehicle.Cabin.DogMode 1
</code></pre>
</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3883f410544279ff57519024d0f51858">3 - VSS &amp; Kuksa.VAL</h1>
    
	<p>To generically interact with the Vehicle Signals which are managed in the Eclipse Kuksa.VAL Databroker,
you can either use the natively installed <code>databroker-cli</code> command line tool, or use the CLI tool from an updated and released containerized image.</p>
<h2 id="kuksa-databroker-cli">Kuksa Databroker CLI</h2>
<p>To install a new version of the Kuksa Databroker CLI container, follow these steps:</p>
<ol>
<li>
<p>Create the container in Kanto:</p>
<pre><code> kanto-cm create --i --t --network=host --name=databroker-cli ghcr.io/eclipse/kuksa.val/databroker-cli:master
</code></pre>
</li>
<li>
<p>Start the command line tool within a container in interactive mode:</p>
<pre><code> kanto-cm start --a --i --name databroker-cli
</code></pre>
</li>
<li>
<p>In the databroker shell, connect to the databroker via the URL <code>http://127.0.0.1:30555/</code>:</p>
<pre><code> connect http://127.0.0.1:30555/
</code></pre>
</li>
</ol>
<p><img src="kuksa-databroker-cli.png" alt="Kuksa Databroker CLI Container"></p>
<h2 id="kuksa-client">Kuksa Client</h2>
<p>To install a new version of the Kuksa Client container, follow these steps:</p>
<ol>
<li>
<p>Pull the container image</p>
<pre><code> ctr --namespace kanto-cm image pull ghcr.io/eclipse/kuksa.val/kuksa-client:master
</code></pre>
</li>
<li>
<p>Create the container in Kanto Namespace:</p>
<pre><code> ctr --namespace kanto-cm container create --net-host --tty ghcr.io/eclipse/kuksa.val/kuksa-client:master kuksa-client
</code></pre>
</li>
<li>
<p>Start the container in detached mode:</p>
<pre><code> ctr --namespace kanto-cm tasks start --detach kuksa-client
</code></pre>
</li>
<li>
<p>Start the command line tool with additional command line options:</p>
<pre><code> ctr --namespace kanto-cm tasks exec --tty --exec-id sometask kuksa-client /kuksa-client/bin/kuksa-client --port 30555 --protocol grpc --insecure
</code></pre>
</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dbbddc97bd5f17bd1da0e1904dfc0feb">3.1 - Custom Vehicle Signals</h1>
    
	<p>The <a href="https://github.com/COVESA/vehicle_signal_specification">Vehicle Signal Specification</a> has a lot of standard Vehicle Signals already defined.</p>
<p>However, if you want to add additional custom signals or mappings from CAN-Bus for the
Kuksa.VAL <a href="https://github.com/eclipse/kuksa.val.feeders/tree/main/dbc2val">dbc2val feeder</a>,
the VSS data model needs to be customized and regenerated.</p>
<p>The following steps can be performed on a development machine to regenerate VSS data model with custom a <em>vspec</em> mapping.</p>
<ol>
<li>Concepts</li>
<li>Setup workspace</li>
<li>Defining the VSS Overlay</li>
<li>Regenerate VSpec JSON</li>
<li>Generate a candump</li>
<li>Databroker and dbc2val containers</li>
<li>Testing with data</li>
</ol>
<h2 id="concepts">Concepts</h2>
<h3 id="vss-overlay">VSS Overlay</h3>
<p>The <a href="https://covesa.github.io/vehicle_signal_specification/rule_set/overlay/">VSS Overlay concept</a> allows to override the
standard signals in the specification with custom signals. It defines metadata attributes like signal name, datatype, description etc.</p>
<p>In addition, the vspec file allows to add custom metadata, such as the <code>dbc</code> node in the following example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">Vehicle.Speed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sensor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">datatype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">float</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dbc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Kombi_01</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">signal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KBI_angez_Geschw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">interval_ms</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>See Eclipse Kuksa documentation about <a href="https://github.com/eclipse/kuksa.val.feeders/blob/main/dbc2val/mapping/mapping.md">dbc2val mapping</a> for details.</p>
<p>There are also ways to automatically transform the CAN-Bus signal values into VSS values:</p>
<ul>
<li>Mapping of literal values, such as enums and booleans</li>
<li>Mathematical transformations</li>
<li>Full and partial transformations</li>
</ul>
<h2 id="setup-workspace">Setup workspace</h2>
<h3 id="required-tools">Required tools</h3>
<ul>
<li>Git</li>
<li>Docker</li>
<li>Python 3</li>
<li>can-utils</li>
<li>a YAML/JSON text editor</li>
</ul>
<p>Depending on your host OS, you may need to install the packages first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install can-utils git docker python3
</span></span></code></pre></div><h3 id="workspace-structure">Workspace structure</h3>
<p>You need the following files in your workspace folder:</p>
<ul>
<li><code>./custom.dbc</code> - The vehicle-specific DBC file.
You can use the <a href="https://github.com/joshwardell/model3dbc">Tesla Model 3 example</a>
or check out the <a href="https://github.com/commaai/opendbc">opendbc</a> project.</li>
<li><code>./custom.vspec</code> - The VSS overlay from the previous step</li>
</ul>
<h2 id="defining-the-vss-overlay">Defining the VSS Overlay</h2>
<p>The definition of an VSS overlay is a manual process.
It requires research, browsing the existing VSS catalog and deep knowledge of the vehicle signals.
Especially knowing the semantic of a signal and how to map it between DBC and VSS is a complex task.</p>
<blockquote>
<p>Note: The Leda team is not aware of any advanced tooling to support the automation of this task.</p>
</blockquote>
<ol>
<li>Create a new file <code>custom.vspec</code>. Use YAML format</li>
<li>For each identified signal:
<ol>
<li>Look up if there already is a corresponding signal in VSS. You may use the <a href="https://digital.auto">Digital.Auto Playground</a> or the spec directly.</li>
<li>Add a new top-level entry to the custom.vspec file. The key is the full VSS path name in dot notation.</li>
<li>Add the corresponding <code>dbc</code> node</li>
<li>Add the <code>signal</code> attribute and enter the name of the CAN-Bus signal name in the DBC</li>
<li>Add additional attributes such as <code>interval_ms</code>, <code>message</code> or <code>transform</code>.
<blockquote>
<p>Note: The attributes <code>signal</code>, <code>interval_ms</code> and <code>transform</code> are evaluated by dbc2val.
The attribute <code>message</code> is only evaluated by the below demo script and is optional.</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CAN Message: Kombi_01</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Vehicle.Speed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sensor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">datatype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">float</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dbc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Kombi_01</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">signal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KBI_angez_Geschw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">interval_ms</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># CAN Message: FS_Position_01</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Vehicle.Cabin.Seat.Row1.Pos1.Position</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sensor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">datatype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">float</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dbc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FS_Position_01</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">signal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FSS_Laenge_Pos</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">interval_ms</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These two extensions will be added to the combined VSS tree:</p>
<p><img src="vss-overlay.png" alt="VSS Overlay with custom CAN-Bus metadata"></p>
<h3 id="regenerating-vspec">Regenerating VSpec</h3>
<p>The script <code>vspec2json.py</code> from <a href="https://github.com/covesa/vss-tools">COVESA VSS Tools</a> can then be used to merge the overlay file with the standard specification.</p>
<p>For Leda devices, you can use <code>kanto-cm</code> to run the tool as a container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copy custom.dbc and custom.vspec to /home/root</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Run in /home/root</span>
</span></span><span style="display:flex;"><span>kanto-cm create --name vspec2json --rp no --mp<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/home/root:/data&#34;</span> ghcr.io/eclipse-leda/leda-vss-vspec2json:main
</span></span><span style="display:flex;"><span>kanto-cm start --a --i --name vspec2json
</span></span></code></pre></div><p>For developer workstations, there is a convenient pre-built Docker container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run --name vspec2json --rm -v <span style="color:#4e9a06">`</span><span style="color:#204a87">pwd</span><span style="color:#4e9a06">`</span>:/data ghcr.io/eclipse-leda/leda-vss-vspec2json:main
</span></span></code></pre></div><p>Or, if you want to run vspec2json from the sources, clone the repository and invoke it like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --recurse-submodules <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --branch v3.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-branch <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --depth <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    https://github.com/COVESA/vehicle_signal_specification
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python3 vehicle_signal_specification/vss-tools/vspec2json.py <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -e dbc <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -o custom.vspec <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --uuid <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --json-pretty <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --json-all-extended-attributes <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ../vehicle_signal_specification/spec/VehicleSignalSpecification.vspec <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    custom_vss_dbc.json
</span></span></code></pre></div><p>With the resulting file <code>custom_vss_dbc.json</code> and the corresponding DBC file, the dbc2val feeder can relay the signals to the databroker.
dbc2val can either read from a CAN-Dump file (generated by <code>candump</code> from can-utils) in an endless loop, or can listen on actual virtual or physical CAN interfaces.</p>
<p>The output should look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>custom.dbc  custom.vspec
</span></span><span style="display:flex;"><span>$ docker run --name vspec2json --rm -v <span style="color:#4e9a06">`</span><span style="color:#204a87">pwd</span><span style="color:#4e9a06">`</span>:/data ghcr.io/eclipse-leda/leda-vss-vspec2json:main
</span></span><span style="display:flex;"><span>INFO     Output to json format
</span></span><span style="display:flex;"><span>INFO     Known extended attributes: dbc
</span></span><span style="display:flex;"><span>INFO     Added <span style="color:#0000cf;font-weight:bold">54</span> units from /vss/spec/units.yaml
</span></span><span style="display:flex;"><span>INFO     Loading vspec from /vss/spec/VehicleSignalSpecification.vspec...
</span></span><span style="display:flex;"><span>INFO     Applying VSS overlay from /data/custom.vspec...
</span></span><span style="display:flex;"><span>INFO     Autocreating implicit branch Vehicle
</span></span><span style="display:flex;"><span>INFO     Autocreating implicit branch Cabin
</span></span><span style="display:flex;"><span>INFO     Autocreating implicit branch Seat
</span></span><span style="display:flex;"><span>INFO     Autocreating implicit branch Row1
</span></span><span style="display:flex;"><span>INFO     Autocreating implicit branch Pos1
</span></span><span style="display:flex;"><span>INFO     Calling exporter...
</span></span><span style="display:flex;"><span>INFO     Generating JSON output...
</span></span><span style="display:flex;"><span>INFO     Serializing pretty JSON...
</span></span><span style="display:flex;"><span>INFO     All <span style="color:#204a87;font-weight:bold">done</span>.
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>custom.dbc  custom.vspec  custom_vss_dbc.json
</span></span></code></pre></div><h2 id="databroker-container">Databroker Container</h2>
<p>Ensure the databroker container is up and running:</p>
<p>On developer workstation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run --name databroker --detach --rm -p 55555:55555/tcp ghcr.io/eclipse/kuksa.val/databroker:0.3.1
</span></span></code></pre></div><p>On Leda device (if not already running)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm start --name databroker
</span></span></code></pre></div><h2 id="testing-with-data">Testing with data</h2>
<p>To see actual data, we need to use the candump or another CAN source and feed that data into the databroker.
After that is running, we can use the databroker-cli tool to subscribe to the example VSS signals.</p>
<h3 id="generate-a-candump">Generate a candump</h3>
<p>To generate a candump for testing purposes, start the candump tool and listen for some packets.</p>
<p>In the following example, the first 20 CAN frames are being recorded and the command will exit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>candump -L -n <span style="color:#0000cf;font-weight:bold">20</span> vcan0 &gt; candump.log
</span></span></code></pre></div><p>If you do not have an external CAN source, you may want to simulate CAN frames.
There is a Python library for parsing DBC files, which also let&rsquo;s you encode and send the actual CAN messages.</p>
<p>An example script could look like this:</p>
<blockquote>
<p>Note: Due to GPL-3 licensing, the Leda quickstart image does not contain some Python standard libraries. This script will not run on a Leda quickstart image.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>import random
</span></span><span style="display:flex;"><span>import <span style="color:#204a87">time</span>
</span></span><span style="display:flex;"><span>from pprint import pprint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import yaml
</span></span><span style="display:flex;"><span>import cantools
</span></span><span style="display:flex;"><span>import can
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">can_bus</span> <span style="color:#ce5c00;font-weight:bold">=</span> can.interface.Bus<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;vcan0&#39;</span>, <span style="color:#000">bustype</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;socketcan&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">db</span> <span style="color:#ce5c00;font-weight:bold">=</span> cantools.database.load_file<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;custom.dbc&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>with open<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;custom.vspec&#34;</span>, <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> as stream:
</span></span><span style="display:flex;"><span>    try:
</span></span><span style="display:flex;"><span>        <span style="color:#000">vspec</span> <span style="color:#ce5c00;font-weight:bold">=</span> yaml.safe_load<span style="color:#ce5c00;font-weight:bold">(</span>stream<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> key in vspec:
</span></span><span style="display:flex;"><span>            <span style="color:#000">message_name</span><span style="color:#ce5c00;font-weight:bold">=</span>vspec<span style="color:#ce5c00;font-weight:bold">[</span>key<span style="color:#ce5c00;font-weight:bold">][</span><span style="color:#4e9a06">&#39;dbc&#39;</span><span style="color:#ce5c00;font-weight:bold">][</span><span style="color:#4e9a06">&#39;message&#39;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">signal_name</span><span style="color:#ce5c00;font-weight:bold">=</span>vspec<span style="color:#ce5c00;font-weight:bold">[</span>key<span style="color:#ce5c00;font-weight:bold">][</span><span style="color:#4e9a06">&#39;dbc&#39;</span><span style="color:#ce5c00;font-weight:bold">][</span><span style="color:#4e9a06">&#39;signal&#39;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">example_message</span> <span style="color:#ce5c00;font-weight:bold">=</span> db.get_message_by_name<span style="color:#ce5c00;font-weight:bold">(</span>message_name<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># Initialize an empty message</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> signal in example_message.signals:
</span></span><span style="display:flex;"><span>                data<span style="color:#ce5c00;font-weight:bold">[</span>signal.name<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> False
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            pprint<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Message: %s&#34;</span> % example_message<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># Send 10 frames with random data</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> x in range<span style="color:#ce5c00;font-weight:bold">(</span>10<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>                data<span style="color:#ce5c00;font-weight:bold">[</span>signal_name<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> random.uniform<span style="color:#ce5c00;font-weight:bold">(</span>0,100<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">encoded_data</span> <span style="color:#ce5c00;font-weight:bold">=</span> example_message.encode<span style="color:#ce5c00;font-weight:bold">(</span>data<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> can.Message<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">arbitration_id</span><span style="color:#ce5c00;font-weight:bold">=</span>example_message.frame_id, <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">=</span>encoded_data<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                pprint<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CAN Frame: %s&#34;</span> % message<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                can_bus.send<span style="color:#ce5c00;font-weight:bold">(</span>message<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># Wait up to 1 second</span>
</span></span><span style="display:flex;"><span>                time.sleep<span style="color:#ce5c00;font-weight:bold">(</span>random.random<span style="color:#ce5c00;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    except yaml.YAMLError as exc:
</span></span><span style="display:flex;"><span>        print<span style="color:#ce5c00;font-weight:bold">(</span>exc<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;Message: message(&#39;Kombi_01&#39;, 0x30b, False, 8, {None: &#39;MQB&#39;})&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 b9 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 16 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 ca 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 ad 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 b0 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 79 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 1b 01&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 19 01&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 0a 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 0000030b    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    00 00 00 00 00 00 b0 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;Message: message(&#39;FS_Position_01&#39;, 0x6be, False, 8, None)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    59 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    31 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    29 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    07 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    40 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    55 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    54 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    07 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    62 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;CAN Frame: Timestamp:        0.000000    ID: 000006be    X Rx                &#39;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;DL:  8    59 00 00 00 00 00 00 00&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="dbc2val-on-workstation">dbc2val on workstation</h3>
<p>Get the latest sources:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/eclipse/kuksa.val.feeders
</span></span></code></pre></div><p>Looping a CAN dump recording:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kuksa.val.feeders/dbc2val/dbcfeeder.py <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --dumpfile candump.log <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --canport vcan0 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --server-type kuksa_databroker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --dbcfile custom.dbc <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --mapping custom_vss_dbc.json
</span></span></code></pre></div><p>Listening on CAN interface:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CAN must be set up up front, e.g.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># modprobe vcan</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ip link add dev vcan0 type vcan</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ip link set vcan0 up</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kuksa.val.feeders/dbc2val/dbcfeeder.py <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --canport vcan0 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --use-socketcan <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --server-type kuksa_databroker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --dbcfile /custom/custom.dbc <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --mapping /custom/custom_vss_dbc.json
</span></span></code></pre></div><h3 id="dbc2val-on-leda-device">dbc2val on Leda device</h3>
<p>To run the dbc2val feeder on Leda, you can use <code>kanto-cm</code> (instead of <code>docker</code>) to create the respective containers.</p>
<blockquote>
<p>Note: Due to <a href="https://github.com/eclipse/kuksa.val.feeders/issues/73">Issue #73</a>,
the container <code>ghcr.io/eclipse/kuksa.val.feeders/dbc2val:v0.1.1</code> cannot be used with SocketCAN.
Please use a later release or build the container from the sources after fixing the bug.
Alternatively, use the candump file instead of SocketCAN.</p>
</blockquote>
<ol>
<li>
<p>Remove any existing <code>dbc2val</code> container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm remove --force --name dbc2val
</span></span></code></pre></div></li>
<li>
<p>Create the new container in Kanto Container Management:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --name dbc2val <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --mp<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/home/root:/data&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">VDB_ADDRESS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;databroker:30555&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">USECASE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;databroker&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --network<span style="color:#ce5c00;font-weight:bold">=</span>host <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --privileged <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ghcr.io/eclipse/kuksa.val.feeders/dbc2val:v0.1.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    /dist/dbcfeeder-exe <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --canport vcan0 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --use-socketcan <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --usecase databroker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --dbcfile /data/custom.dbc <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --mapping /data/custom_vss_dbc.json
</span></span></code></pre></div><blockquote>
<p>Note: The <em>host networking</em> and <em>privileged</em> is used to allow the container access to the CAN sockets.</p>
</blockquote>
</li>
<li>
<p>Start the container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm start --a --i --name dbc2val
</span></span></code></pre></div></li>
<li>
<p>Check the logs to verify container is running:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm logs --name dbc2val
</span></span></code></pre></div></li>
</ol>
<h3 id="querying-via-cli">Querying via CLI</h3>
<p>To be able to see the changes, you may want to use the Kuksa Databroker CLI:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run --rm -it --network host ghcr.io/eclipse/kuksa.val/databroker-cli:0.3.1
</span></span></code></pre></div><p>Now, depending on the way how the dbc2val feeder has been started (candump vs. socketcan), you will either already see data from the candump loop.</p>
<p><img src="kuksa-databroker-cli.png" alt="Eclipse Kuksa.VAL Databroker CLI"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b17a47275ec6859512c169cb02d9ee24">4 - CarSim</h1>
    
	<p>The <strong>CarSim</strong> example provides basic Vehicle Signals based on a physical model simulation and feeds them to the databroker.</p>
<p><a href="./kinetic.svg"><img src="./kinetic.png" alt="Eclipse Leda CarSim Kinetics"></a></p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><a href="./carsim-arch-overview.svg"><img src="./carsim-arch-overview.png" alt="Eclipse Leda CarSim DriverSim Architecture Overview"></a></p>
<h2 id="description">Description</h2>
<p>CarSim is a simple physical model implementation, based on the <a href="https://thef1clan.com/2020/09/21/vehicle-dynamics-the-kinematic-bicycle-model/">kinematic bicycle model</a>.
It can be used as a <em>mock implementation</em> in development, testing and simulation scenarios.</p>
<p>It takes three external inputs:</p>
<ul>
<li>accelerator position</li>
<li>brake position</li>
<li>steering wheel angle</li>
</ul>
<p>It propagates the physical model in time with a pre-defined step interval (10ms), recalculates the acceleration components,
speed and position, and finally publishes the numeric values as standard VSS datapoints to the databroker.</p>
<p>To simulate the input from a human driver, the optional <strong>DriverSim</strong> component can be run in parallel.
DriverSim toggles between two different types of driver style in a pre-defined time interval:</p>
<ul>
<li><strong>Good driver</strong> - slowly accelerates and moves the steering angle accordingly and then slowly brakes.</li>
<li><strong>Bad driver</strong> - accelerates hard (full throttle), moves the steering wheel randomly in both directions, brakes hard.</li>
</ul>
<h2 id="background">Background</h2>


<div class="pageinfo pageinfo-primary">
<p><strong>Decoupled Design</strong></p>
<p>CarSim and DriverSim <strong>only communicate through the databroker</strong> by using standardized Vehicle Signals.</p>

</div>

<p>Each component can be replaced individually <strong>at runtime</strong>, e.g. by more advanced or real implementations.
There is no need to adapt, recompile or redeploy any of the other applications.</p>
<p>This is <strong>important</strong> for decoupling and <a href="https://fosdem.org/2023/schedule/event/kuksa/">standardizing vehicle signals</a>,
to enable future vehicle application platforms to evolve.
Loose coupling and standardizing of vehicle signal interfaces enable thirdparty applications to use signals
in higher-level applications or value-add services.</p>
<p>Both implementors (imagine separate organizations), can agree to use the Vehicle Signal Specification
to decouple the development lifecycle for vehicle applications and vehicle services. This decoupling approach
reduces the time and effort for proprietary design specifications processes tremendously.</p>
<h2 id="vehicle-signals">Vehicle Signals</h2>
<p>The CarSim application reads the following input signals from the databroker:</p>
<h3 id="input">Input</h3>
<table>
<thead>
<tr>
<th>&ldquo;Human&rdquo; driver input</th>
<th>Python variable</th>
<th>VSS subscription path</th>
<th>VSS datatype</th>
</tr>
</thead>
<tbody>
<tr>
<td>Brake pedal position</td>
<td>DP_BRAKE_POS</td>
<td><a href="/leda/docs/vss/vehicle/chassis/brake/pedalposition/"><code>Vehicle.Chassis.Brake.PedalPosition</code></a></td>
<td>uint8</td>
</tr>
<tr>
<td>Accelerator pedal position</td>
<td>DP_ACCELR_POS</td>
<td><a href="/leda/docs/vss/vehicle/chassis/accelerator/pedalposition/"><code>Vehicle.Chassis.Accelerator.PedalPosition</code></a></td>
<td>uint8</td>
</tr>
<tr>
<td>Steering wheel angle</td>
<td>DP_STEER_ANGLE</td>
<td><a href="/leda/docs/vss/vehicle/chassis/steeringwheel/angle/"><code>Vehicle.Chassis.SteeringWheel.Angle</code></a></td>
<td>int16</td>
</tr>
</tbody>
</table>
<p><em>Note: You can either provide these signals externally on your own, or use <code>DriverSim</code> to simulate them.</em></p>
<h3 id="output">Output</h3>
<p>The CarSim application feeds the following output signals to the databroker:</p>
<table>
<thead>
<tr>
<th>Python variable</th>
<th>VSS feeding path</th>
<th>VSS datatype</th>
</tr>
</thead>
<tbody>
<tr>
<td>DP_SPEED</td>
<td><a href="/leda/docs/vss/vehicle/speed/"><code>Vehicle.Speed</code></a></td>
<td>float</td>
</tr>
<tr>
<td>DP_ACCEL_LAT</td>
<td><a href="/leda/docs/vss/vehicle/acceleration/lateral/"><code>Vehicle.Acceleration.Lateral</code></a></td>
<td>float</td>
</tr>
<tr>
<td>DP_ACCEL_LONG</td>
<td><a href="/leda/docs/vss/vehicle/acceleration/longitudinal/"><code>Vehicle.Acceleration.Longitudinal</code></a></td>
<td>float</td>
</tr>
<tr>
<td>DP_ACCEL_VERT</td>
<td><a href="/leda/docs/vss/vehicle/acceleration/vertical/"><code>Vehicle.Acceleration.Vertical</code></a></td>
<td>float</td>
</tr>
</tbody>
</table>
<h2 id="getting-started">Getting started</h2>
<ol>
<li>
<p>Start up Leda and wait for the runtime to be available. For other deployment options, see <a href="/leda/docs/general-usage/">Getting Started</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it ghcr.io/eclipse-leda/leda-distro/leda-quickstart-x86
</span></span></code></pre></div></li>
<li>
<p>Deploy the <a href="https://github.com/eclipse-leda/leda-example-applications/pkgs/container/leda-example-applications%2Fleda-example-carsim"><code>CarSim</code></a>
container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm create --name carsim --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">DATABROKER_ADDRESS</span><span style="color:#ce5c00;font-weight:bold">=</span>databroker:55555 --hosts<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;databroker:container_databroker-host&#34;</span> ghcr.io/eclipse-leda/leda-example-applications/leda-example-carsim:v0.0.1
</span></span><span style="display:flex;"><span>kanto-cm start --name carsim
</span></span></code></pre></div></li>
<li>
<p>Deploy <a href="https://github.com/eclipse-leda/leda-example-applications/pkgs/container/leda-example-applications%2Fleda-example-driversim"><code>DriverSim</code></a>
container:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kanto-cm create --name driversim --e<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">DATABROKER_ADDRESS</span><span style="color:#ce5c00;font-weight:bold">=</span>databroker:55555 --hosts<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;databroker:container_databroker-host&#34;</span> ghcr.io/eclipse-leda/leda-example-applications/leda-example-driversim:v0.0.1
</span></span><span style="display:flex;"><span>kanto-cm start --name driversim
</span></span></code></pre></div></li>
<li>
<p>Use <code>kantui</code> or <code>kanto-cm logs --name &lt;carsim|driversim&gt;</code> to view log files:</p>
<p><img src="./kantui_carsim.png" alt="Eclipse Leda KantUI CarSim Logs"></p>
<p><img src="./kantui_driversim.png" alt="Eclipse Leda KantUI DriverSim Logs"></p>
</li>
<li>
<p>Use the <code>databroker-cli</code> to subscribe to the following VSS signals.</p>
<blockquote>
<p><em>Note:</em> Separate multiple signals by commas. Use <code>&lt;TAB&gt;</code> to auto-complete signal names.
See <a href="https://github.com/eclipse/kuksa.val/blob/master/kuksa_databroker/doc/QUERY.md">QUERY.md</a> for the query syntax.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ databroker-cli
</span></span><span style="display:flex;"><span>connect localhost:30555
</span></span><span style="display:flex;"><span>subscribe
</span></span><span style="display:flex;"><span>    SELECT
</span></span><span style="display:flex;"><span>     Vehicle.Speed,
</span></span><span style="display:flex;"><span>     Vehicle.Acceleration.Vertical,
</span></span><span style="display:flex;"><span>     Vehicle.Acceleration.Longitudinal,
</span></span><span style="display:flex;"><span>     Vehicle.Acceleration.Lateral
</span></span><span style="display:flex;"><span>    WHERE
</span></span><span style="display:flex;"><span>     Vehicle.Speed &gt; <span style="color:#0000cf;font-weight:bold">50</span>
</span></span></code></pre></div><p><img src="./carsim-databroker-cli2.png" alt="Eclipse Leda CarSim Databroker-CLI"></p>
</li>
<li>
<p>Happy hacking!</p>
<p>Need ideas? How about implementing your own driver simulation and integrate with existing open source simulation technologies from <em>Autonomous Driving</em>?</p>
</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li>Sources: <a href="https://github.com/eclipse-leda/leda-example-applications/tree/main/kuksa-carsim">https://github.com/eclipse-leda/leda-example-applications/tree/main/kuksa-carsim</a></li>
<li>Kinetic Bicycle Model: <a href="https://thef1clan.com/2020/09/21/vehicle-dynamics-the-kinematic-bicycle-model/">https://thef1clan.com/2020/09/21/vehicle-dynamics-the-kinematic-bicycle-model/</a></li>
<li>Kuksa.VAL: <a href="https://github.com/eclipse/kuksa.val/tree/master/kuksa_databroker">https://github.com/eclipse/kuksa.val/tree/master/kuksa_databroker</a></li>
<li>COVESA Vehicle Signal Specification: <a href="https://github.com/COVESA/vehicle_signal_specification">https://github.com/COVESA/vehicle_signal_specification</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f8e31fb834452efdebda21d1bf86969">5 - Velocitas VApps</h1>
    
	<p>For local deployment without a cloud backend, deployment specifications for <a href="https://projects.eclipse.org/projects/automotive.velocitas">Eclipse Velocitas</a> Vehicle Apps may be put directly onto the device.</p>
<ul>
<li>Create a Kanto deployment specification for your vehicle app. You may copy one of the existing JSON files in <code>/data/var/containers/manifests</code> as a template</li>
<li>Copy the specification file to the device, e.g. <code>scp -P 2222 myapp.json root@localhost:/data/var/containers/manifests/</code></li>
<li>Apply the specification: <code>systemctl restart kanto-auto-deployer</code></li>
</ul>
<p>To update an existing container when the configuration has changed, delete the container and restart kanto-auto-deployer:</p>
<pre><code>kanto-cm remove -n myapp-example
# Edit /data/var/containers/manifests/myapp.json
kanto-auto-deployer
</code></pre>
<h2 id="configuration-of-velocitas-middleware-type">Configuration of Velocitas Middleware Type</h2>
<p>The following Velocitas environment variables need to be set to configure the proper middleware type and hostnames of services:</p>
<pre tabindex="0"><code>SDV_MQTT_ADDRESS=mqtt://mosquitto:1883
SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555
SDV_MIDDLEWARE_TYPE=native
</code></pre><h2 id="example-deployment-specification">Example Deployment Specification</h2>
<blockquote>
<p>Attention: The current implementation requires all fields to be present in the JSON, even if the values are not set or used. Do not remove any fields, as it may break the functionality.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myapp-example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;image&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/my-org/my-repo/my-app:latest&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;decrypt_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;domain_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;resolv_conf_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hostname_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;mounts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hooks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;devices&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restart_policy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;maximum_retry_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;retry_timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;unless-stopped&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;runtime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;io.containerd.runc.v2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;extra_hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;port_mappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;container_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30151</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_ip&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50151</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port_end&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50151</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;log_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;driver_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;json-file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_files&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;100M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;root_dir&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;mode_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;blocking&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_buffer_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;resources&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;io_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stderr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;open_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;stdin_once&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;tty&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;VEHICLEDATABROKER_DAPR_APP_ID=vehicledatabroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;SDV_MQTT_ADDRESS=mqtt://mosquitto:1883&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;SDV_VEHICLEDATABROKER_ADDRESS=grpc://databroker:55555&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;SDV_MIDDLEWARE_TYPE=native&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;network_settings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;started_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exit_code&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;finished_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exited&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;dead&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restarting&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;paused&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;running&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;oom_killed&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;created&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;manually_stopped&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;restart_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-03ddd8c0f79b13ee47ac2332bd2c2a23">6 - Cloud2Device Messages</h1>
    
	<p><img src="c2d-architecture-overview.png" alt="c2d-overview"></p>
<p>In order to verify that the device and the cloud connector can successfully receive messages sent by the cloud backend, we will send a dummy message to the device.</p>
<h2 id="pre-requisites">Pre-Requisites</h2>
<ul>
<li>Device is up and running, e.g by <a href="/leda/docs/general-usage/running-qemu/">running in qemu</a></li>
<li>Eclipse Leda has successfully booted</li>
<li>The device has been provisioned and configured, see <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h2 id="validating-configuration">Validating configuration</h2>
<p>First, let&rsquo;s check that the cloud connection is active.</p>
<ul>
<li>
<p>Login as <code>root</code></p>
</li>
<li>
<p>Run sdv-health and check for the <em>SDV Connectivity</em> section:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sdv-health
</span></span></code></pre></div><p><img src="sdv-health-connectivity.png" alt="sdv-health-connectivity"></p>
</li>
<li>
<p>Start watching the output of the cloud connector:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kantui
</span></span></code></pre></div></li>
<li>
<p>Select the <code>cloud-connector</code> container and press <code>L</code> to watch the logs</p>
<blockquote>
<p><em>Note:</em> When an unknown type of message is received, the cloud connector will log an error:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>2022/04/13 16:04:41.911727  [agent]  ERROR  Handler returned error err=&#34;cannot deserialize cloud message: invalid character &#39;H&#39; looking for beginning of value
</span></span></code></pre></div></blockquote>
</li>
<li>
<p>Start watching on the MQTT message broker:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mosquitto_sub -h localhost -t <span style="color:#4e9a06">&#39;#&#39;</span> --pretty -v
</span></span></code></pre></div><blockquote>
<p><em>Note:</em> When a known type of message is received, the cloud connector will forward the message to the MQTT broker into the corresponding topic <code>$appId/$cmdName</code></p>
</blockquote>
</li>
</ul>
<h2 id="sending-a-device-message">Sending a Device Message</h2>
<ul>
<li>Go to the Web Console of Azure IoT Hub</li>
<li>Select the device</li>
<li>Click on &ldquo;Send Message&rdquo;</li>
<li>Enter a C2D payload and click &ldquo;Send&rdquo;</li>
</ul>
<p>Alternatively, on command line, use the Azure CLI client. Replace <code>DeviceId</code> and <code>IotHubName</code> with the appropriate names of your IoT Hub and device.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>az iot device c2d-message send <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --device-id <span style="color:#4e9a06">${</span><span style="color:#000">DeviceID</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --hub-name <span style="color:#4e9a06">${</span><span style="color:#000">IotHubName</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --data <span style="color:#4e9a06">&#39;Hello World&#39;</span>
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      


<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/eclipse-leda" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
        
          <p class="mt-2"><a href="/leda/docs/about/">About Leda</a></p>
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org">
        Eclipse Foundation
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/privacy.php">
        Privacy Policy
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/termsofuse.php">
        Terms of Use
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/copyright.php">
        Copyright Agent
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/">
        Legal
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/epl-2.0/">
        License
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/security/">
        Report a Vulnerability
      </a>
    </small>
  </li>
  
</ul>

        
        
      </div>
  </div>
</footer>


    </div>
    
  <script src="/leda/js/main.min.054f118c2d3b183635f9655daee6fcebd03931cb3727d1f12fe0dda1fd784631.js" integrity="sha256-BU8RjC07GDY1&#43;WVdrub869A5Mcs3J9HxL&#43;Ddof14RjE=" crossorigin="anonymous"></script>
<script defer src="/leda/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/leda/js/tabpane-persist.js'></script>

  </body>
</html>
