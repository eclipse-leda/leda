<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.98.0" />
<link rel="canonical" type="text/html" href="https://eclipse-leda.github.io/leda/docs/build/">
<link rel="alternate" type="application/rss&#43;xml" href="https://eclipse-leda.github.io/leda/docs/build/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/leda/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/leda/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/leda/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/leda/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/leda/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/leda/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/leda/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/leda/favicons/android-192x192.png" sizes="192x192">

<title>Building Leda | Eclipse Leda Documentation</title>
<meta name="description" content="">
<meta property="og:title" content="Building Leda" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://eclipse-leda.github.io/leda/docs/build/" />

<meta itemprop="name" content="Building Leda">
<meta itemprop="description" content=""><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building Leda"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/leda/scss/main.min.8070449d98aab34a199be540534469d8ff15f1c607d5168b6d28a45467de9e2f.css" as="style">
<link href="/leda/scss/main.min.8070449d98aab34a199be540534469d8ff15f1c607d5168b6d28a45467de9e2f.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/leda/"><span class="navbar-brand__logo navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="30 270 300 300" id="svg2"><defs id="defs6"><clipPath id="clipPath24" clipPathUnits="userSpaceOnUse"><path id="path22" d="m5116.71 2737.03v81.36c0 51.02 13.61 71.72 55.28 74.55h288.29v-182.27c-4.26-34.29-16.73-48.19-55.28-48.19h-226.21c-47.05.0-62.08 20.69-62.08 74.55zm-139.46 17.86c0-128.41 84.19-198.71 222.24-198.71h42.8c107.43.0 184.82 2.84 217.99 84.19v-84.19h137.76v534.05c0 128.13-97.8 198.71-235.85 198.71H5051.8v-106.3h360c36 0 48.48-23.52 48.48-60.66v-122.74h-260.79c-138.05.0-222.24-70.59-222.24-198.71zm-332.5-44.22c-3.97-34.29-16.44-48.19-55-48.19h-225.07c-46.76.0-62.08 20.69-62.08 74.55v371.06c0 51.03 13.9 71.71 55.28 74.55h231.87c41.39-2.84 55-23.52 55-74.55zm139.46 854.08h-138.04v-360c-33.17 81.36-110.28 84.19-217.99 84.19h-42.8c-137.77.0-221.96-70.58-221.96-198.71v-335.34c0-128.41 84.19-198.71 221.96-198.71h42.8c107.71.0 184.82 2.84 217.99 84.19v-84.19h138.04zm-925.8-587.62h-362.83v144.85c0 28.91 12.47 60.66 48.2 60.66h266.45c35.71.0 48.18-31.75 48.18-60.66zm139.47-106.3v219.4c0 128.13-98.08 198.71-236.13 198.71h-169.51c-138.04.0-235.84-70.58-235.84-198.71v-335.34c0-128.41 97.8-198.71 235.84-198.71h405.64v106.3h-454.1c-35.73.0-48.2 23.54-48.2 60.66v147.69zM2642.92 2556.18h630.71v117.36h-483.02v794.55h-147.69z"/></clipPath><linearGradient id="linearGradient34" spreadMethod="pad" gradientTransform="matrix(2955.12,0,0,-2955.12,2642.92,3060.47)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop26" offset="0" style="stop-opacity:1;stop-color:#77add1"/><stop id="stop28" offset=".189014" style="stop-opacity:1;stop-color:#64c6ee"/><stop id="stop30" offset=".994475" style="stop-opacity:1;stop-color:#7b3199"/><stop id="stop32" offset="1" style="stop-opacity:1;stop-color:#7b3199"/></linearGradient><linearGradient id="linearGradient44" spreadMethod="pad" gradientTransform="matrix(1875.15,0,0,-1875.15,364.686,2981.28)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop38" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop40" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop42" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient><clipPath id="clipPath54" clipPathUnits="userSpaceOnUse"><path id="path52" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31z"/></clipPath><linearGradient id="linearGradient70" spreadMethod="pad" gradientTransform="matrix(1417.96,0,0,-1417.96,477.178,2901.88)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop56" offset="0" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop58" offset=".11811164" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop60" offset=".509456" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop62" offset=".76356415" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop64" offset=".994475" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop66" offset=".99510668" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop68" offset="1" style="stop-opacity:1;stop-color:#4e9133"/></linearGradient><linearGradient id="linearGradient80" spreadMethod="pad" gradientTransform="matrix(942.78,0,0,-942.78,720.659,3019.8)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop74" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop76" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop78" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient></defs><g transform="matrix(1.3333333,0,0,-1.3333333,0,795.04)" id="g10"><g transform="scale(0.1)" id="g12"><path id="path46" style="fill:url(#linearGradient44);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m462.512 2989.03c1.133-223.65 47.902-452.13 142.867-685.13 24.66-60.94 67.465-109.13 120.187-139.47 52.727-30.61 115.657-43.93 180.852-35.14 236.122 32.03 453.262 104.03 650.552 218.55 193.89 112.53 368.79 266.17 523.27 463.18 41.11 52.15 61.8 113.67 61.8 174.9.28 61.51-20.13 123.02-60.95 175.18-145.7 186.8-317.19 337.89-515.62 450.99-194.74 110.83-415.84 185.1-665.005 220.82-65.481 9.36-128.692-3.4-181.699-33.74C665.758 3768.85 622.672 3720.94 597.441 3660c-90.14-219.4-136.062-443.06-134.929-670.97zm51.875-721.98c-99.5 244.06-148.535 484.73-149.668 721.42-1.418 241.23 47.054 477.63 142.297 708.66 33.73 81.92 91.843 146.27 163.273 187.08 71.719 40.82 156.473 58.11 244.066 45.64 261.355-37.13 494.075-115.65 699.595-232.72 209.76-119.34 390.61-278.65 544.25-475.66 54.71-70.01 81.92-152.78 81.63-235.55.0-83.06-27.49-165.83-82.2-235.56-162.42-206.65-346.68-368.5-551.62-487.27-208.35-121.05-437.67-197.02-686.549-230.75-87.313-11.9-171.785 5.95-242.934 47.05-71.433 41.39-128.976 106.02-162.14 187.66v0"/><g id="g48"><g clip-path="url(#clipPath54)" id="g50"><path id="path72" style="fill:url(#linearGradient70);fill-opacity:1;fill-rule:nonzero;stroke:none" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31v0"/></g></g><path id="path82" style="fill:url(#linearGradient80);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m935.898 3147.21c-54.71-85.89-93.543-185.38-115.085-298.77-4.821-24.94-1.418-49.33 9.07-69.74 10.207-20.69 27.496-37.98 49.605-48.75 97.508-46.78 197.292-73.42 300.192-78.81 101.19-5.1 205.51 9.92 312.94 46.78 23.81 8.21 42.81 23.53 55.56 42.8 12.48 19.56 18.71 43.37 16.44 68.88-9.07 108.28-36.57 208.92-83.9 301.61-46.49 91.28-111.97 175.18-197.58 251.15-18.71 16.44-41.1 25.51-63.78 26.93-22.67 1.13-45.92-5.11-66.33-19.28-88.72-61.51-161.292-135.78-217.132-222.8zM724.434 2866.87c24.093 125.28 67.461 236.12 128.976 332.78 63.211 98.93 144.563 182.27 243.5 250.87 38.83 27.21 83.9 39.11 128.12 36.56 44.22-2.55 87.31-19.84 123.03-51.59 95.24-84.47 168.37-178.01 220.25-279.78 53-104.31 84.19-217.14 94.39-337.89 3.97-47.61-8.22-92.98-32.6-130.39-24.09-37.42-60.66-66.9-105.45-82.21-119.34-41.1-236.12-57.83-349.79-51.87-115.94 6.24-228.473 36-337.325 88.44-42.805 20.41-75.398 53.29-95.242 92.98-19.848 39.68-26.648 85.6-17.859 132.1v0"/></g></g></svg></span><span class="navbar-brand__name">Eclipse Leda Documentation</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item me-4 mb-2 mb-lg-0">
        <a class="nav-link" href="https://github.com/eclipse-leda" target="_blank"><span>GitHub</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/leda/offline-search-index.2c79a20662985fb35d51891dd8fc03f9.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/leda/docs/build/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Building Leda</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-5a114e9c0d2f593adb6abac02f868f4c">Concepts</a></li>


    
  
    
    
	
<li>2: <a href="#pg-83c252b9f9f1de95e6f3ad59a0779c80">Metalayer</a></li>


    
  
    
    
	
<li>3: <a href="#pg-6bebc82bbfd98602300c719ed32319de">Setup development environment</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-f489e253846ca9247a8d639e81213fab">Codespaces</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1.1: <a href="#pg-71f44dd882af01efbed1f4ad8361d98b">Advanced topics</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.2: <a href="#pg-c93bbe2b4afa4f696fe56387e16376bc">GitHub Runner</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3.3: <a href="#pg-dd5aea642d95644a121fa3b9232f771f">VSCode DevContainer</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-a56f201c9d821bac8e46a01e6750e56c">Building with kas/manually</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-e9d306dcf183db3f873e59965d0cae97">Run the build</a></li>


    
  
    
    
	
<li>5: <a href="#pg-c18e94c2f6e61c26c3af49dce54f0909">Automated Tests</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-8fd1dfda73f2cd3ab1ec676ecd359ca5">Robot Keywords</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-54e9dcaf283ef882361a51e9acfc06d5">Rust Tests</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-40e3f4818f73b84ce32042db1961675c">GitHub Workflow</a></li>


    
  
    
    
	
<li>7: <a href="#pg-62352f3530820244cfc19d6fdad57df1">Runqemu</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-1c63e657519124a213cf5b9778390873">Miscellaneous</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-685226a9e960be283b847d67e85319af">Resource Consumptions</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-1e40b1f7122c24679a439cddb45a2953">Partition Layout</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-bdf9cb83992bb147748b5ca9a98cda7a">Releasing</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-36dea19e60b747437042ee148647e878">Validating</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-c94e454d5004f1527a7e3bb4f39a40e3">Developing and Maintaining Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-d807daac010fe21775fe6dc4f7bef15d">Rust Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1.1: <a href="#pg-a15bf08ceb9050ab919c4dd1e39f4581">Communicating with Кanto-CM via gRPC</a></li>


    
  
    
    
	
<li>10.1.2: <a href="#pg-4ceae03484d6716691789648aa48571f">Kanto Auto deployer</a></li>


    
  
    
    
	
<li>10.1.3: <a href="#pg-1a1d75c926eacba3c473eb373af6186f">Kantui</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10.2: <a href="#pg-4f521ffe9ea62a6a0abf7d17bb18e912">Shell Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.2.1: <a href="#pg-6db933c8beae49618c83597c4bad0cde">sdv-health</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p>Running BitBake to build your own images requires some extra setup on the build machine. Please see the following chapters for more information about the build process itself and how to setup a development and build infrastructure.</p>
<p><img src="build-terminal.png" alt="Build Shell"></p>
<p>If you are interested to contribute or to get in touch with us, please see our <a href="/leda/docs/project-info/community/">Community</a> pages and <a href="/leda/docs/project-info/contribution-guidelines/">Contribution Guidelines</a>.</p>
<p>For reporting security vulnerabilities, please follow our <a href="/leda/docs/project-info/security/">Security Policy</a>.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5a114e9c0d2f593adb6abac02f868f4c">1 - Concepts</h1>
    
	<p>The example build configurations in this repository are based on the official <a href="https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html">BitBake Quickstart tutorial</a> and have been extended to include Leda SDV components.</p>
<h2 id="build-setup">Build Setup</h2>
<p>To set up your own BitBake build configuration, follow the BitBake documentation and include <code>meta-leda</code> in your <code>bblayers.conf</code> and add the SDV packages into your <code>local.conf</code>.</p>
<p>The Leda build is mainly using the kas tool for a simplified maintenance of the BitBake Configuration files. The kas configuration files are located in <code>kas/</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">header</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">distro</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">leda</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">machine</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">qemux86-64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">target</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sdv-image-all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repos</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">meta-leda</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://github.com/eclipse-leda/meta-leda&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">refspec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">layers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-bsp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-components</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-distro</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="leda-metalayer">Leda Metalayer</h2>
<p>The <code>meta-leda</code> layer conatins the BitBake Classes and Recipes to integrate SDV Components into a BitBake based build setup.</p>
<p>Please see <a href="https://github.com/eclipse-leda/meta-leda">https://github.com/eclipse-leda/meta-leda</a> for more information.</p>
<h2 id="recipes-for-containerized-components">Recipes for containerized components</h2>
<p>The SDV.EDGE stack is based on a containerized architecture and the intention is to have as much components containerized as possible, to ensure a high degree of isolation and updateability. To ensure some degree of flexibility and control, certain core components may also be installed as native services.</p>
<p>To automatically deploy the containers of the SDV reference implementation and example applications and services, the build configurations will deploy a couple of deployment specifiction files into the auto-deployment folder <code>/data/var/containers/manifests</code>.</p>
<p>At start time, these containers will be automatically deployed:</p>
<ul>
<li>Cloud Connector</li>
<li>Self Update Agent</li>
<li>Vehicle Update Manager</li>
<li>Vehicle API / Vehicle Abstraction Layer
<ul>
<li>Data Broker (Eclipse Kuksa)</li>
<li>Example Seat Service (CAN-bus implementation)</li>
</ul>
</li>
</ul>
<p>For a full list of containers, see <code>meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers</code></p>
<h2 id="recipes-for-containerized-applications">Recipes for containerized applications</h2>
<p>OpenEmbedded&rsquo;s <a href="https://layers.openembedded.org/layerindex/branch/master/layer/meta-virtualization/">meta-virtualization</a> already contains some recipes and reusabled classes for building virtualization and containerized applications.</p>
<p><code>meta-leda</code> extends that functionality by using <code>skopeo</code> to package container images. To minimize the runtime requirements (dependencies, disk usage), an approach to pre-load container images and its layers directly into the content storage of the container runtime is followed.</p>
<h2 id="building-containers-with-yocto">Building containers with Yocto</h2>
<p>For components which can either be installed natively or as container, it can be beneficial to build these containers using Yocto as well. An example is in <code>meta-leda-distro-container/recipes-sdv/sdv-containers/cyclonedds-example-container_0.1.bb</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83c252b9f9f1de95e6f3ad59a0779c80">2 - Metalayer</h1>
    
	<h2 id="initializing-bitbake-environment">Initializing BitBake environment</h2>
<p>Initialize the build environment and start the build for QEMU:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas build kas/leda-qemux86-64.yaml
</span></span></code></pre></div><h2 id="building-specific-recipes">Building specific recipes</h2>
<p>General usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas build kas/leda-qemux86-64.yaml --target &lt;recipename&gt;
</span></span></code></pre></div><h2 id="metalayer-structure">Metalayer Structure</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span> meta-leda-bsp
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-bsp                  // Board Support Packages, eg specifics for QEMU and Raspberry Pi
</span></span><span style="display:flex;"><span> meta-leda-components
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-sdv
</span></span><span style="display:flex;"><span>   |-- eclipse-leda               // Build recipes for Eclipse Leda Incubator components
</span></span><span style="display:flex;"><span>   |-- eclipse-kuksa              // Build recipes for Eclipse Kuksa
</span></span><span style="display:flex;"><span>   |-- eclipse-cyclonedds         // Build recipes for Eclipse CycloneDDS
</span></span><span style="display:flex;"><span>   |-- northstar                  // Build recipes for Northstar Container Runtime
</span></span><span style="display:flex;"><span>   |-- packagegroups              // Grouping packages
</span></span><span style="display:flex;"><span>   \-- sdv-base                   // SDV Base Bundle: fstab, can0.network
</span></span><span style="display:flex;"><span>     |--- base-files
</span></span><span style="display:flex;"><span>     |--- SDV Core Utilities
</span></span><span style="display:flex;"><span>     \--- SDV Utilities
</span></span><span style="display:flex;"><span>   |-- sdv-containers             // Container images recipes for pre-caching / airgap installation
</span></span><span style="display:flex;"><span>     |--- Cloud Agent
</span></span><span style="display:flex;"><span>     |--- Data Broker
</span></span><span style="display:flex;"><span>     |--- Feeder CAN
</span></span><span style="display:flex;"><span>     |--- OTel Collector
</span></span><span style="display:flex;"><span>     |--- Self Update Agent
</span></span><span style="display:flex;"><span>     |--- Vehicle Update manager
</span></span><span style="display:flex;"><span>     |--- Example Seat Service
</span></span><span style="display:flex;"><span>     \--- ...
</span></span><span style="display:flex;"><span>   |-- sdv-core                   // SDV Core Bundle
</span></span><span style="display:flex;"><span>     |--- SDV RAUC Bundle         // RAUC Update Bundle Manifest
</span></span><span style="display:flex;"><span>   \-- tools                      // Convenience tools for the &#34;full&#34; image, eg nerdctl and kantui
</span></span><span style="display:flex;"><span> meta-leda-distro
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-containers           // Container related configuration recipes (containerd, nerdctl)
</span></span><span style="display:flex;"><span> \-- recipes-core                 // Core recipes (base-files, systemd)
</span></span><span style="display:flex;"><span> \-- recipes-kernel               // Kernel configuration, eg kernel modules, logging, virtio
</span></span><span style="display:flex;"><span> \-- recipes-sdv-distro           // Image definitions
</span></span><span style="display:flex;"><span> \-- wic                          // WIC Kickstarter files - Partition layouts
</span></span><span style="display:flex;"><span>meta-leda-distro-container
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-sdv                  // Build containers with Yocto
</span></span></code></pre></div><h2 id="base-bundle">Base Bundle</h2>
<p>Contains the recipes to build and install the minimal set of dependencies for the SDV stack on the edge device. With these minimal components, the SDV stack should be able to bootstrap itself.</p>
<h3 id="can-bus-kernel-configuration">CAN-Bus Kernel Configuration</h3>
<p>To enable support for CAN bus related modules, the kernel needs to be reconfigured. This is done by the <code>sdv-canbus-modules.inc</code> include file in the <code>recipes-kernel/linux</code> folder, which patches Poky&rsquo;s <code>linux-yocto</code> recipe.</p>
<p>Verifying and displaying the current kernel configuration: <code>bitbake -e virtual/kernel</code></p>
<p>To verify the recipe and the kernel configuration: <code>bitbake linux-yocto -c kernel_configcheck -f</code></p>
<p>The kernel config file can be found in:
<code>./tmp/work/qemux86_64-poky-linux/linux-yocto/*/linux-qemux86_64-standard-build/.config</code></p>
<h2 id="core-bundle">Core Bundle</h2>
<p>Contains the recipes to build and install additional SDV components, which are required for a proper runtime setup.</p>
<h2 id="containers">Containers</h2>
<p>Contains the recipes for pre-installing specific containers into the container management at runtime. This is mainly for pre-caching container image layers onto the device to speed up the initial deployment but can also be used to enable offline usecases.</p>
<h2 id="build-host-system-requirements">Build Host System Requirements</h2>
<ul>
<li>Yocto Project 4.0 (kirkstone) or higher</li>
<li>100GB+ free disk space per build configuration</li>
<li>Online connection for fetching sources and container images</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6bebc82bbfd98602300c719ed32319de">3 - Setup development environment</h1>
    
	<p>There are multiple variants on how to set up a build environment:</p>
<ul>
<li>with <a href="/leda/docs/build/devenv/github-codespaces/">GitHub Codespaces</a> - recommended for developers with restricted internet access, such as corporate proxies, or with Windows hosts</li>
<li>with <a href="/leda/docs/build/devenv/vscode-devcontainer/">VSCode DevContainer</a> - recommended for Linux hosts</li>
<li>Custom setup - for teams</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f489e253846ca9247a8d639e81213fab">3.1 - Codespaces</h1>
    
	<h1 id="setting-up-development-environment-in-github-codespaces">Setting up Development Environment in GitHub Codespaces</h1>
<h2 id="install-the-github-codespaces-extension">Install the GitHub Codespaces Extension</h2>
<p><em>Note:</em> When using our DevContainer, the <em>GitHub Codespaces</em> extension is pre-installed.</p>
<ul>
<li>Start VSCode</li>
<li>Go to <em>Extensions</em></li>
<li>Search for &ldquo;GitHub Codespaces&rdquo;</li>
<li>Click <em>Install</em></li>
</ul>
<p>Alternatively, create a new codespace via the GitHub web interface:</p>
<p><img src="github-code-new-codespace.png" alt=""></p>
<p>Select a big enough machine type for Yocto/BitBake, e.g. 16 CPU. You need at leasst 50GB disk space.</p>
<p><img src="github-codespaces-remote-explorer.png" alt=""></p>
<h2 id="building-leda-in-a-github-codespace">Building Leda in a Github Codespace</h2>
<p>After successfully obtaining and connecting to a codespace you can build Leda either with kas or manually:</p>
<ul>
<li>
<p>To build with kas follow the instructions at: <a href="/leda/docs/build/devenv/build-kas-manually/#building-with-kas">Building with kas</a></p>
</li>
<li>
<p>To build manually: <a href="/leda/docs/build/devenv/build-kas-manually/#building-manually">Building manually</a></p>
</li>
</ul>
<h2 id="private-repositories">Private Repositories</h2>
<p>When using GitHub Codespaces with submodules and private repositories,
a separate tool for git authentication is required (see <a href="https://github.com/microsoft/vscode/issues/109050">VSCode issue #109050</a>), as the authentication token provided to the GitHub Codespaces virtual machine only allows access to the main repository.</p>
<p>Git Credential Manager:
<a href="https://aka.ms/gcm">https://aka.ms/gcm</a></p>
<p>Installation:</p>
<pre tabindex="0"><code>curl -LO https://raw.githubusercontent.com/GitCredentialManager/git-credential-manager/main/src/linux/Packaging.Linux/install-from-source.sh &amp;&amp;
sh ./install-from-source.sh &amp;&amp;
git-credential-manager-core configure
</code></pre>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-71f44dd882af01efbed1f4ad8361d98b">3.1.1 - Advanced topics</h1>
    
	<h2 id="git-authentication">Git Authentication</h2>
<p>For private repositories, we need to separately authenticate against the submodule repositories, as
GitHub Codespaces will only inject a token with access rights to the current repository.</p>
<ol>
<li>
<p>Change to the users home directory</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~
</span></span></code></pre></div></li>
<li>
<p>Install <a href="https://github.com/GitCredentialManager/git-credential-manager">Git Credential Manager</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://raw.githubusercontent.com/GitCredentialManager/git-credential-manager/main/src/linux/Packaging.Linux/install-from-source.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>sh ./install-from-source.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>git-credential-manager-core configure
</span></span></code></pre></div></li>
<li>
<p>Configure a credential store typ, e.g. <code>git config --global credential.credentialStore plaintext</code></p>
</li>
<li>
<p>Verify with <code>git config --global -l</code>, it should show git-credential-manager-core as the credential helper.</p>
</li>
</ol>
<h2 id="update-the-submodules">Update the submodules</h2>
<p>Run <code>git submodule update --recursive</code></p>
<p>See <a href="https://github.com/microsoft/vscode/issues/109050">VSCode Issue #109050</a> for details.</p>
<h2 id="setup-skopeo">Setup skopeo</h2>
<p>Skopeo is needed to download various files during the build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /run/containers/1000
</span></span><span style="display:flex;"><span>sudo chmod a+w /run/containers/1000
</span></span><span style="display:flex;"><span>skopeo login ghcr.io --authfile ~/auth.json --username &lt;your GitHub User&gt; 
</span></span></code></pre></div><p>Enter your token when asked for the password.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c93bbe2b4afa4f696fe56387e16376bc">3.2 - GitHub Runner</h1>
    
	<h1 id="create-a-new-github-runner-for-this-repo">Create a new GitHub Runner for this repo</h1>
<p>Start with creating a new azure VM:</p>
<ul>
<li>Ubuntu Server Latest, currently 20.04</li>
<li>Size Standard D16ds v5</li>
<li>The admin user should be called &ldquo;runner&rdquo;</li>
</ul>
<p>Once the VM is ready:</p>
<ol>
<li>Stop the VM</li>
<li>Go to &ldquo;Disk&rdquo; and resize the OS disk to 512 GB</li>
<li>Start the VM again</li>
</ol>
<h1 id="run-the-script-to-setup-the-runner">Run the script to setup the runner</h1>
<p>Log on to the VM as runner. Either copy the <code>scripts/PrepVMasGHRunner.sh</code> onto the VM or create a new script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nano prep.sh
</span></span></code></pre></div><p>Copy the content of the PrepVMasGHRunner.sh from this repo into the new file, save it and make it executable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod <span style="color:#0000cf;font-weight:bold">755</span> prep.sh
</span></span></code></pre></div><p>Call it with the token and the next available nummer, see below how to get this items:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./prep.sh <span style="color:#4e9a06">&#34;ASYVOMU........DTCFCMBA&#34;</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><p>In the Azure portal go the VM, go to the &ldquo;network&rdquo; section and delete the rule opening port 22.
Congratulation, you are done!</p>
<h1 id="how-to-get-the-token-and-the-number-to-call-the-script">How to get the token and the number to call the script</h1>
<p>In the repo, go to &ldquo;Settings&rdquo; -&gt; &ldquo;Actions&rdquo;. You see the currently provisioned runners:</p>
<p><img src="nextnumber.png" alt="Alt text" title="Find next number"></p>
<p>Pick the next number and pass it to the script.</p>
<p>To get the token press the green button in the above screenshot. The token is in the command:</p>
<p><img src="token.png" alt="Alt text" title="Get the token"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd5aea642d95644a121fa3b9232f771f">3.3 - VSCode DevContainer</h1>
    
	<h2 id="preparation">Preparation</h2>
<ul>
<li>Obtain the <a href="https://docs.docker.com/engine/install/">Docker Engine</a> for your distribution and add your non-privileged user to the docker group (<code>sudo usermod -aG docker $USER</code> )</li>
<li>Install <a href="https://code.visualstudio.com/download">Visual Studio Code</a></li>
</ul>
<h2 id="visual-studio-code-development-containers">Visual Studio Code: Development Containers</h2>
<ul>
<li>Open Visual Studio Code</li>
<li>Open Command Palette (<code>F1</code>) and select <code>Clone repository in Container Volume</code></li>
<li>Select <code>eclipse-leda/meta-leda</code> and the main branch.</li>
<li>Adapt proxy configurations if necessary (<code>.devcontainer/proxy.sh</code>)</li>
</ul>
<p><em>For a clean remote build machine, you may want to <a href="/leda/docs/build/devenv/github-codespaces/">set up a development environment on GitHub CodeSpaces</a></em></p>
<h2 id="building-leda-in-a-vscode-devcontainer">Building Leda in a VSCode DevContainer:</h2>
<p>After successfully setting up your DevContainer you can build Leda either with kas or manually:</p>
<ul>
<li>
<p>To build with kas follow the instructions at: <a href="/leda/docs/build/devenv/build-kas-manually/#building-with-kas">Building with kas</a></p>
</li>
<li>
<p>To build manually: <a href="/leda/docs/build/devenv/build-kas-manually/#building-manually">Building manually</a></p>
</li>
</ul>
<h2 id="authentication">Authentication</h2>
<p>The build process requires online connection and you must be authenticated to access private repositories.</p>
<ol>
<li>Create a GitHub Personal Access Token (PAT) at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> and grant <code>read:packages</code> permission</li>
<li>Use <code>Configure SSO</code> and authorize your PAT for the organization</li>
<li>On the build host, authenticate to ghcr.io: <code>skopeo login ghcr.io --authfile ~/auth.json --username &lt;username&gt;</code> and enter the PAT as password
<ul>
<li>You may need to create the folder where skopeo is storing authentication information beforehand:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /run/containers/1000
</span></span><span style="display:flex;"><span>sudo chmod a+w /run/containers/1000
</span></span></code></pre></div></li>
<li>Start the bitbake build process</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a56f201c9d821bac8e46a01e6750e56c">3.4 - Building with kas/manually</h1>
    
	<p>After setting up your <a href="/leda/docs/build/devenv/vscode-devcontainer/">VSCode DevContainer</a> or <a href="/leda/docs/build/devenv/github-codespaces/">GitHub Codespace</a> you can proceed with the actual build process. Here you have two choices - either using the kas-build system or setting up the build manually.</p>
<h2 id="building-with-kas">Building with kas</h2>
<p>This is the easiest way to build leda semi-automatically</p>
<ul>
<li><code>cd /workspaces/meta-leda-fork/</code></li>
<li>Open the VSCode terminal and run <code>kas build</code></li>
<li><strong>Note: you can alter the build options by modifying the .config.yaml file in the trunk of the repository</strong></li>
</ul>
<h2 id="building-manually">Building manually</h2>
<p>You can also build Leda manually if more customization of the build process is required.</p>
<ul>
<li>
<p><code>export LEDA_WORKDIR=/workspaces/meta-leda-fork/</code></p>
</li>
<li>
<p><code>cd ${LEDA_WORKDIR}</code></p>
</li>
<li>
<p>Clone the Poky repository with the required release, e.g. <code>kirkstone</code> and pull updates if necessary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone git://git.yoctoproject.org/poky
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> poky
</span></span><span style="display:flex;"><span>git checkout -t origin/kirkstone -b kirkstone
</span></span><span style="display:flex;"><span>git config pull.rebase <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>git pull
</span></span></code></pre></div></li>
<li>
<p>Prepare the build environment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">source</span> oe-init-build-env
</span></span></code></pre></div></li>
<li>
<p>Dry-run a build of the Linux Kernel recipe using BitBake:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bitbake --dry-run linux-yocto
</span></span></code></pre></div></li>
<li>
<p>Checkout the meta-layer dependencies for Leda:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#000">$LEDA_WORKDIR</span>
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://github.com/rauc/meta-rauc.git meta-rauc
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://github.com/rauc/meta-rauc-community.git meta-rauc-community
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://git.yoctoproject.org/meta-virtualization meta-virtualization
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://git.openembedded.org/meta-openembedded meta-openembedded
</span></span></code></pre></div></li>
<li>
<p>Change to the <code>poky/build</code> directory (generated from the <code>oe-init-build-env</code> script automatically)</p>
</li>
<li>
<p>Add all the necessary meta-layers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-rauc
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-rauc-community/meta-rauc-qemux86
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-oe
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-filesystems
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-python
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-networking
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-virtualization
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-components
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-bsp
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-distro
</span></span></code></pre></div></li>
<li>
<p>Dry run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake --dry-run sdv-image-all
</span></span></code></pre></div></li>
<li>
<p>Real build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake sdv-image-all
</span></span></code></pre></div></li>
<li>
<p>You can also build one of the target recipies this way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake kanto-container-management
</span></span></code></pre></div></li>
<li>
<p><strong>Note: in this case you can set the target architecture and other build options in the build/local.conf file</strong></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9d306dcf183db3f873e59965d0cae97">4 - Run the build</h1>
    
	<h2 id="run-the-full-build">Run the full build</h2>
<p>To setup the environment and build the Leda image, please refer to: <a href="/leda/docs/build/devenv/">Setup development environment</a>.</p>
<h2 id="running-qemu-from-existing-build">Running QEMU from existing build</h2>
<ul>
<li>Use <code>kas shell -c &quot;runqemu qemux86-64 ovmf kvm nographic&quot; &lt;kas-configs&gt;</code> to execute the image.</li>
<li>Replace <code>qemux86-64</code> with one of the other qemu machines, such as <code>qemuarm64</code></li>
<li>Use the keyword <code>slirp</code> to enable user-networking which does not require root privileges on the host. <code>tun</code> is default but requires setup on the host.</li>
<li>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h3 id="variations-of-runqemu-command-line">Variations of runqemu command line</h3>
<ul>
<li>Use <code>runqemu ovmf</code>
<ul>
<li><code>ovmf</code> will enable the UEFI support for IA32 (x86) and X64 (x86-64) guests, for testing the dual-boot capabilities and SDV Self-Update mechanisms</li>
</ul>
</li>
<li>All other options are now part of the default Leda distribution configuration (see <em>leda-qemu-settings.inc</em>)</li>
<li>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h2 id="running-qemu-in-the-background">Running QEMU in the background</h2>
<p>To start QEMU in the background enter, use <code>nohup</code> and bring the process into the background.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nohup runqemu qemux86-64 nographic <span style="color:#000">qemuparams</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-m 2048 -pidfile qemu.pid&#34;</span> <span style="color:#000;font-weight:bold">&amp;</span>
</span></span></code></pre></div><p>The image is then reachable via <code>ssh root@192.168.7.2</code>
This will write a file qemu.pid in the current directory including the process ID of QEMU. Once done, <code>kill -9 &lt;qemu.pid&gt;</code> kills the process.</p>
<h2 id="running-with-kas-shell">Running with kas-shell</h2>
<p>If you&rsquo;ve chosen to build the Leda image with kas, you can use the kas-shell to run QEMU, with kas setting up the environment for you. To do that change to the main working directory and run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas shell -c <span style="color:#4e9a06">&#39;runqemu slirp nographic ovmf sdv-image-full&#39;</span>
</span></span></code></pre></div><h2 id="dhcp-configuration">DHCP Configuration</h2>
<p>As the Leda Quickstart image will try to retrieve its IP address via DHCP broadcast request, it is good to run a DHCP daemon on the host, listening on the respective TAP network interface of QEMU. This will then simulate a LAN with DHCP server and let&rsquo;s us control which IP address gets assigned to multiple QEMU instances.</p>
<p>The <a href="https://github.com/eclipse-leda/leda-distro/blob/main/scripts/run-dhcp.sh">run-dhcp.sh</a> utility will run an ISC-DHCP server on the host. The default configuration has a couple of MAC addresses preconfigured.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c18e94c2f6e61c26c3af49dce54f0909">5 - Automated Tests</h1>
    
	<p>Eclipse Leda is using the <a href="https://robotframework.org/">Robot Framework</a> for black box tests and system tests.</p>
<p>The black box tests are supposed to only use <em>public</em> API from SDV components, for example the MQTT interface of the Self Update Agent.
The system tests are supposed to test on Leda Distro level and can use shell and SSH commands to verify system behavior, e.g. performing a reboot.</p>
<p><img src="leda-tests-overview.png" alt="Leda Tests Docker Compose Setup Overview"></p>
<ol>
<li>Test Execution: an external trigger, such as the <code>./test-docker.sh</code> shell script, starts the <code>leda-tests</code> container.</li>
<li>Docker Compose ensures that the needed containers are built and started.
The test cases and test resources are copied into the leda-tests container at build time.</li>
<li>The Robot process is started and performs the execution of all test cases</li>
<li>Black box test cases use the MQTT interface to connect to the test target and publish messages</li>
<li>System level test cases use SSH to connect to the test target and execute commands</li>
<li>Test reports are written to a mounted volume, so that they are available on the host for further processing</li>
</ol>
<h3 id="run-the-tests">Run the tests</h3>
<p>The easiest way to run the test cases is to run it in the Docker Compose setup:</p>
<ol>
<li>
<p>Clone the <a href="https://github.com/eclipse-leda/leda-distro">leda-distro</a> repository:</p>
<pre><code> git clone https://github.com/eclipse-leda/leda-distro
</code></pre>
</li>
<li>
<p><em>Optional:</em> Build both images (qemuarm64 and qemux86-64) using kas / BitBake. If you omit this step, docker compose will download the latest container images from the Eclipse Leda Container Registry on ghcr.io.</p>
<pre><code> kas build kas/leda-qemux86-64.yml
 kas build kas/leda-qemuarm64.yml
</code></pre>
</li>
<li>
<p>Switch to the docker-snapshot directory:</p>
<pre><code> cd resources/docker-snapshot/
</code></pre>
</li>
<li>
<p>Run the Leda Tests</p>
<pre><code> ./test-docker.sh
</code></pre>
</li>
</ol>
<h3 id="test-reports">Test Reports</h3>
<p>The output of <code>test-docker.sh</code> will show the test results from Robot.</p>
<p>The test reports and debug logs are available on the host&rsquo;s filesystem in the path <code>resources/docker-snapshot/leda-tests-reports</code></p>
<ul>
<li><code>output.xml</code> - The main Robot output report</li>
<li><code>report.html</code> - A Robot HTML summary report</li>
<li><code>leda-tests-xunit.xml</code> - A xUnit report file suitable for rendering with various tools</li>
<li><code>log.html</code> - A Robot HTML report with the test execution log</li>
<li><code>leda-tests-debug.log</code> - Debug log file of the test execution, helpful during implementation of test cases and troubleshooting of failed tests</li>
</ul>
<p>The xunit report is being used to visualize the test execution results in the GitHub Workflow:</p>
<p>Example Test Report:</p>
<p><img src="gh-robot-report-with-failed.png" alt="GitHub Leda Tests Robot Report"></p>
<h3 id="adding-new-tests">Adding new tests</h3>
<p>The tests are located in the following locations of the <a href="https://github.com/eclipse-leda/leda-distro">leda-distro</a> repository:</p>
<ul>
<li><code>resources/docker-snapshot/dockerfiles/leda-tests</code> - Robot Tests which are executed inside of a Docker Compose setup</li>
<li><code>tests/src/robot</code> - Robot Tests which can be executed on the build host with a Leda Runqemu instance running</li>
</ul>
<p>General steps are:</p>
<ol>
<li>Decide whether to implement a system-level test or a black-box integration test</li>
<li>Add the test case to an existing, matching <code>.robot</code> file. If no matching test suite can be found, create a new <code>.robot</code> file. Prefix with the order number, e.g. <code>33__my-new-test.robot</code></li>
<li>Check if a refactoring of new keywords may be worthwhile for better reusability.</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8fd1dfda73f2cd3ab1ec676ecd359ca5">5.1 - Robot Keywords</h1>
    
	<p>In the Leda Robot Tests, keywords are used for reusable functionality. Common keywords are defined in <code>resources/docker-snapshot/dockerfiles/leda-tests/leda_keywords.resource</code></p>
<p>The goal is to treat the Leda Quickstart image as a black box, utilizing as much as possible with public APIs.</p>
<h2 id="interaction-with-self-update-agent">Interaction with Self Update Agent</h2>
<ul>
<li><code>Trigger to start update</code>: Send a &ldquo;Desired State Request&rdquo; to the target, to install a RAUC Update Bundle</li>
<li><code>Connect and Subscribe to Listen</code>: Wait for the asynchronous messages which indicate a successful installation of an update</li>
</ul>
<h2 id="arbitrary-commands">Arbitrary Commands</h2>
<p>Nevertheless, during implementation of test cases, it may be necessary to execute lower level processes for system level tests. For that, a fallback is possible to execute arbitrary test commands via remote SSH connection. These commands are executed through another docker container running in the same Docker network (<code>leda-network</code>) and allow access to the target QEMU instances:</p>
<ul>
<li><code>Leda Execute</code>: Execute an arbitrary shell command via SSH on the test target</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-54e9dcaf283ef882361a51e9acfc06d5">5.2 - Rust Tests</h1>
    
	<p><em>Note:</em> The Rust tests are being replaced with test cases implemented in Robot.</p>
<h3 id="cross-compiling-to-x86_64-on-ubuntu-2004">Cross Compiling to X86_64 on Ubuntu 20.04</h3>
<p>There is currently a step to cross-compile tests to X86_64. In order to successfully run the step, you need to make sure that the following artifacts are available on the runner:</p>
<ul>
<li>rustc + cargo: <code>curl https://sh.rustup.rs -sSf | sh</code></li>
<li>docker: follow <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a> and afterwards <a href="https://docs.docker.com/engine/install/linux-postinstall/">https://docs.docker.com/engine/install/linux-postinstall/</a></li>
<li>build-essential: <code>sudo apt-get install build-essential</code></li>
<li>cross (0.1.16): <code>cargo install cross --version 0.1.16</code></li>
<li>jq: <code>sudo apt-get install jq -y</code></li>
</ul>
<p>You may restart your current shell so that all components are available as env vars.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-40e3f4818f73b84ce32042db1961675c">6 - GitHub Workflow</h1>
    
	<p><img src="./github-workflow.png" alt="GitHub Workflow"></p>
<ul>
<li>Manually creating a Release triggers the release workflow.</li>
<li>The release workflow calls the build workflow.</li>
<li>The build workflow indirectly depends on the sstate cache being prebuilt manually (see optimizations below)</li>
<li>The build workflow runs a full build of the SDV-Image-All disk image for all target machines.</li>
<li>A separate job is used for each target machine, to ensure an image build for a target machine can finish within 6 hours.</li>
<li>Each build contains the creation of SBOM artifacts and the check for CVEs. The SBOM artifacts are in SPDX JSON format and packaged per target machine&rsquo;s disk image (SDV-Image-Full to include all packages).</li>
<li>The OSS License Scanning (using the OSS Review Toolkit) is done asynchronously on a separate fork, as it currently uses a proprietary infrastructure. The ORT-based infrastructure of Eclipse is planned to be used in the future. The web report is attached as a build artifact on the internal fork and not accessible by public currently.</li>
<li>Once the build workflow&rsquo;s jobs are finished, the release workflow will finalize by attaching the release artifacts as assets to the release.</li>
</ul>
<p><em>Note: While the build workflow and release workflows are in progress, the GitHub release page of that release does not show any other assets besides the source archives. The release artifacts (eclipse-leda-<machine>.tar.xz) will only be visible once all workflows have finished.</em></p>
<h2 id="limitations-on-standard-runners">Limitations on standard runners</h2>
<p>As the GitHub-managed runners are optimized for ephemeral build use cases and a Yocto-based build process is very consuming in regards to CPU and disk capacity, a few optimizations need to be done before being able to run a full build or even a release workflow on limited GitHub-managed standard runners.</p>
<p>Please see the documentation about <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources">GitHub Hosted Runners</a> for current specs.</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Standard GitHub Runner</th>
<th>Recommended for Yocto</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>2-core CPU (x86_64)</td>
<td>16-core CPU (x86_64)</td>
</tr>
<tr>
<td>RAM</td>
<td>7 GB of RAM</td>
<td>16 GB of RAM</td>
</tr>
<tr>
<td>Disk</td>
<td>14 GB of SSD</td>
<td>128+ GB of SSD</td>
</tr>
<tr>
<td>Time</td>
<td>max. 6 hours / job</td>
<td>not limited</td>
</tr>
</tbody>
</table>
<p>In general, GitHub recommends to split a build process into smaller chunks, which can then fit into the constraints.</p>
<h2 id="optimizations">Optimizations</h2>
<p>The following optimizations have been implemented for the Eclipse Leda public repository and its build workflow:</p>
<ol>
<li>
<p><strong>Remote SState Cache</strong>: To minimize build time and disk usage, a remote sstate-cache mirror is being used. The mirror is hosted by one of the project sponsors on european Azure infrastructure and available as public HTTP mirror to anonymous Leda builds. The mirror is provided as best-effort, does not provide any kind of service level and may not be available at all times.</p>
<p><em>Note: To use the mirror, set the <code>BB_HASHSERVE</code>, <code>MIRROR_SERVER</code>, <code>SSTATE_MIRRORS</code> and related configuration settings. See the <a href="https://github.com/eclipse-leda/leda-distro/blob/main/kas/mirrors.yaml">mirrors.yaml</a> for a full sample.</em></p>
<p><img src="./github-workflow-optimizations.png" alt="GitHub Workflow Optimizations"></p>
</li>
<li>
<p><strong>Prebuilding</strong>: To fill the remote sstate cache mirror, another build infrastructure is being used. The repository fork has been configured with additional credentials to authenticate against the remote mirror for uploading the built packages. To ensure these steps are not run on the public OSS repository, the workflow steps use additional conditions to check for the owner of the repository. This is a workaround due to a <a href="https://github.com/actions/runner/issues/520">known issue on GitHub Actions</a>.</p>
</li>
<li>
<p><strong>Chunking of the build steps:</strong> To minimize bandwidth transfer, a local GitHub Action Cache is being used. This cache is per target machine and filled with a separate workflow. The <a href="https://github.com/eclipse-leda/leda-distro/actions/workflows/prebuild-sstate.yml">Prebuild sstate</a> build jobs will run the BitBake process for 4 hours and then gracefully shut down. The build process will finish the current tasks. The remaining time (max. runtime for GitHub Runners is 6 hours) is used to package and upload the packages to the cache. If the 4 hours of build time are not enough, it may be required to re-run the same job more often.</p>
<p><em>Note: The disadvantage of this approach is that each run requires a significant lead time where the remote cache is downloaded, the recipes get parsed again, the build task dependencies are compiled etc. On a persistent runner, this time can be spared.</em></p>
</li>
<li>
<p><strong>Rerun on sstate miss:</strong> When BitBake is missing a package in the sstate mirror (it may exist in the Hash Equivalence Server though), BitBake will log an <strong>Error</strong> and continue to run the recipe. However, as the cache-miss is logged as error, BitBake will exit with an error code, indicating a failed build, which in turn would mark the GitHub Job as failed, too. To circumvent this problem, the BitBake build process is executed in a loop (max. 3 retries) to ensure that with the current state, all packages can be built without errors, eventually succeeding with the buid.</p>
</li>
<li>
<p><strong>Always upload GitHub Cache:</strong> Under normal circumstances, the GitHub Cache action will update the cache on success of the build job - to not poison the cache with failed builds. However, as the Leda build workflows run for a very long time and may fail due to other reasons, the goal is to still reuse the sstate-cache as much as possible. For that reason, the <code>pat-s/always-upload-cache</code> GitHub action is being used, as it will also upload the cache on failed builds.</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62352f3530820244cfc19d6fdad57df1">7 - Runqemu</h1>
    
	<p>QEMU&rsquo;s command line option can get quiet complex. Yocto is providing a convenient wrapper script called <code>runqemu</code>, which takes configurations into account which have been populated during the build process and also takes care of TAP networking setup and teardown. Unfortunately, it can only be used within an OpenEmbedded build environment.</p>
<p>Running without runqemu: when you need more control over qemu options</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qemu-system-x86_64 -kernel .<span style="color:#4e9a06">\b</span>zImage-qemux86-64.bin -nographic -m 2G -append <span style="color:#4e9a06">&#34;console=ttyS0 root=/dev/vda1&#34;</span> -drive <span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">=</span>.../sdv-image-full-qemux86-64.ext4
</span></span></code></pre></div><p>Running with runqemu: simple and some convenient flags are supported</p>
<pre><code>runqemu ovmf sdv-image-full
</code></pre>
<p>Running with leda: no options, runs the default settings only</p>
<pre><code>leda
</code></pre>
<p><img src="qemu-runner-script.png" alt=""></p>
<h2 id="enabling-kvm-for-better-performance">Enabling KVM for better performance</h2>
<p>The performance of qemux86_64 is much better when KVM can be used.
Try running with:</p>
<pre><code>runqemu ovmf kvm
</code></pre>
<p><em>Note: You may need to set up KVM for your host machine first, please refer to <a href="https://wiki.yoctoproject.org/wiki/How_to_enable_KVM_for_Poky_qemu">How to enable KVM for Poky qemu</a></em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/workspaces/leda-distro/build-sdv-x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>imageformatcleanup ✗<span style="color:#ce5c00;font-weight:bold">)</span> $ ls -al /dev/kvm
</span></span><span style="display:flex;"><span>crw-rw---- <span style="color:#0000cf;font-weight:bold">1</span> root kvm 10, <span style="color:#0000cf;font-weight:bold">232</span> May <span style="color:#0000cf;font-weight:bold">16</span> 06:46 /dev/kvm
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1c63e657519124a213cf5b9778390873">8 - Miscellaneous</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-685226a9e960be283b847d67e85319af">8.1 - Resource Consumptions</h1>
    
	<h2 id="baseline-no-apps-installed">Baseline (no apps installed)</h2>
<p>Baseline: 400 MB</p>
<p>Installed components:</p>
<ul>
<li>Container Management: runc, containerd, container-management</li>
<li>System Services: systemd, openssh, mosquitto, mosquitto-clients</li>
<li>No cloud connector or edgecontainerd yet.</li>
<li>No self update agent</li>
<li>No containers, no vehicle apps etc.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@qemux86-64:/bin# df -h
</span></span><span style="display:flex;"><span>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span style="display:flex;"><span>/dev/root       2.5G  506M  1.8G  22% /
</span></span></code></pre></div><ul>
<li>Memory Usage: 200MB</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@qemux86-64:/# free
</span></span><span style="display:flex;"><span>            total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:           1.9G      329.6M        1.4G       16.6M      222.2M        1.6G
</span></span><span style="display:flex;"><span>Swap:    
</span></span></code></pre></div><h2 id="component-details">Component Details</h2>
<p>Dependencies</p>
<ul>
<li>cni (container networking): 51 MB</li>
<li>containerd-ctr: 26 MB</li>
<li>containerd: 46 MB</li>
<li>dapr cli: 38 MB</li>
<li>helm cli: 43 MB</li>
<li>runc: 10 MB</li>
</ul>
<p>SDV Components</p>
<ul>
<li>vehicle-data-cli: 2.3 MB (dynamic)</li>
</ul>
<p>Medium:</p>
<ul>
<li>Linux Kernel (Poky minimal / Leda distro kernel): 8 MB / 21 MB</li>
<li>oci-image-tool: 9 MB</li>
<li>oci-runtime-tool: 7 MB</li>
<li>sshd: 1 MB</li>
<li>libstdc++: 2 MB</li>
<li>lic: 2 MB</li>
<li>libcrypto: 3 MB</li>
<li>containerd-shim: 7 MB</li>
<li>containerd-shim-runc-v1: 9 MB</li>
<li>containred-shim-runc-v2: 9 MB</li>
<li>libsystemd: 1 MB</li>
<li>busybox: 1 MB</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e40b1f7122c24679a439cddb45a2953">8.2 - Partition Layout</h1>
    
	<p>The bootable Leda Quickstart images are disk image with multiple partitions:</p>
<ul>
<li>Two bootloader partitions, to enable A/B update process</li>
<li>A separate partition to hold bootloader status information</li>
<li>An optional rescue partition with basic operating system and tooling</li>
<li>Two rootfs partitions with a full installation of the operating system, to enable A/B update process</li>
<li>A data partition for storing container runtime data</li>
</ul>
<h2 id="partition-layout-for-qemu-x86-64">Partition Layout for QEMU x86-64</h2>
<p>The x86_64 image uses GRUB as a bootloader and the partition layout is as follows:</p>
<p><img src="leda-disk-layout-qemux86-64.png" alt="Leda Disk Layout for QEMU x86-64"></p>
<h2 id="partition-layout-for-qemu-arm-64">Partition Layout for QEMU ARM-64</h2>
<p>The partition layout for QEMU ARM-based images are comparable, except:</p>
<ul>
<li>Bootloader is replaced with U-Boot</li>
</ul>
<h2 id="partition-layout-for-raspberry-pi">Partition Layout for Raspberry Pi</h2>
<p>The partition layout for Raspberry Pi images are comparable, except:</p>
<ul>
<li>Bootloader is replaced with U-Boot</li>
<li>The last partition (the data partition) is marked as growable, to allow the use of the larger SD-Card capacities for container runtime data</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdf9cb83992bb147748b5ca9a98cda7a">9 - Releasing</h1>
    
	<h1 id="versioning-and-codenames">Versioning and Codenames</h1>
<ul>
<li>Distribution Versioning is following the <code>x.y.z</code> syntax for the distribution, e.g. <code>Leda 0.0.1</code></li>
<li>Build Versioning is following the git describe syntax: <code>v0.0.1-blank-168-g7e14c4c</code>
<ul>
<li>Latest tag name: <code>v0.0.1</code></li>
<li>Branch name: <code>blank</code></li>
<li>Number of commits behind: <code>168</code></li>
<li>Short Commit ID: <code>g7e14c4c</code></li>
</ul>
</li>
<li>Codenames are taken from <a href="https://en.wikipedia.org/wiki/List_of_motor_racing_tracks">Wikipedia List of Motor Racing Tracks</a></li>
<li>Initial codename is <code>Hockenheim</code></li>
<li>Current distribution version can be taken from <code>/etc/issue</code>:</li>
</ul>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/issue
Eclipse Leda v0.0.8
</code></pre><h1 id="how-to-release">How to Release</h1>
<p>A new release is triggered manually from its GitHub web page <code>Releases</code> section. By
clicking on the <code>Draft new release</code> button, the release process starts:</p>
<ul>
<li>Select a branch to use as code base for the release</li>
<li>Create a tag using the standard pattern <code>vX.Y.Z</code></li>
<li>Write a title <code>Release X.Y.Z</code> and release notes</li>
<li>Optionally select if this is a pre-release</li>
<li>Publish the release</li>
<li><a href="validation.md">Validate the release</a></li>
</ul>
<p>With <code>Publish the release</code> action the release workflow located in <code>.github/workflows/release.yml</code> will be triggered. This
will start building the distro image files for the supported platforms, running the test cases and generating reports as
junit xml and license scanning. If the image generation and the test runs are successful the artifacts: images, test
binaries and qa reports will be attached as assets to the release.</p>
<p>The build (<code>build.yml</code>) and release (<code>release.yml</code>) workflows share a common reusable workflow (<code>base.yml</code>). In this way the
release workflow repeats the build actions without duplicating the code.</p>
<h1 id="detailed-build-information-on-device">Detailed build information on device</h1>
<h2 id="eclipse-leda-version">Eclipse Leda Version</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/issue
Eclipse Leda v0.0.8
</code></pre><h2 id="exact-build-timestamp">Exact Build Timestamp</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/version
20220408135014
root@qemux86-64:~# cat /etc/timestamp
20220408135230
</code></pre><h2 id="details-of-build-information">Details of Build Information</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/build 
-----------------------
Build Configuration:  |
-----------------------
DISTRO = leda
DISTRO_VERSION = 2022
DATETIME = 20220408135014
DISTRO_NAME = Eclipse Leda
IMAGE_BASENAME = core-image-minimal
MACHINE = qemux86-64
TUNE_PKGARCH = core2-64
MACHINE_FEATURES = alsa bluetooth usbgadget screen vfat x86 pci rtc qemu-usermode
DISTRO_FEATURES = acl alsa argp  debuginfod  ipv4 ipv6 largefile pcmcia usbgadget usbhost wifi xattr  zeroconf pci    vfat seccomp largefile  ptest multiarch  vulkan virtualization k8s seccomp raucg
COMMON_FEATURES = 
IMAGE_FEATURES = debug-tweaks
TUNE_FEATURES = m64 core2
TARGET_FPU = 
APP_URI_PREFIX = 
APP_URI_BRANCH = 
-----------------------
Layer Revisions:      |
-----------------------
meta              = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-poky         = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-yocto-bsp    = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-leda          = main:30a5ff0a7e04dfa2c9b43175a49ac7a2ae0c64a9 -- modified
meta-rauc         = honister:3faf4cc4fcf558e99dad5aa8532fef2ecd566653 
meta-filesystems  = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-networking   = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-oe           = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-python       = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-perl         = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-virtualization = honister:bd7511c53b921c9ce4ba2fdb42778ca194ebc3e8 
meta-security     = honister:fb77606aef461910db4836bad94d75758cc2688c 
patch             = main:a041dad5be9444d55491b57cb6a669a44196566d -- modified
</code></pre>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-36dea19e60b747437042ee148647e878">9.1 - Validating</h1>
    
	<h2 id="validating-the-release">Validating the release</h2>
<p>Steps to validate if a release is properly working:</p>
<ol>
<li>
<p>Create a new pre-release from your branch</p>
</li>
<li>
<p>Download the release artifacts onto a clean system.</p>
<p>Do not use your build environment, to minimize the impact of existing environment configuration from BitBake etc.</p>
</li>
<li>
<p>Run the <code>run-leda</code> scripts to execute Qemu</p>
<p><em>Note: You should test each of the release archives, for each target machine.</em></p>
</li>
<li>
<p>Follow the <a href="/leda/docs/device-provisioning/">Device Provisioning</a> guide</p>
</li>
<li>
<p>Perform some verification tests (see below)</p>
</li>
<li>
<p>Cleanup: Delete the pre-release and the git tag:</p>
<pre><code>git push --delete origin &lt;tagname&gt;
</code></pre>
</li>
</ol>
<h2 id="ideas-for-manual-verification-steps">Ideas for manual verification steps</h2>
<p><em>Note: These are just for manual testing, as we intend to extend the automated tests as much as possible.</em></p>
<ul>
<li>Operating system level
<ul>
<li>Run <code>sdv-health</code> on the shell</li>
<li>Verify disk partitions and RAUC status, e.g. <code>rauc status</code></li>
<li>Verify network interface and CAN-Bus with <code>ip addr</code></li>
</ul>
</li>
<li>Container runtime
<ul>
<li>Check status of containers with <code>kantui</code></li>
</ul>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c94e454d5004f1527a7e3bb4f39a40e3">10 - Developing and Maintaining Utils</h1>
    
	<p>The Leda teams provides some custom utilities that allow for a more integrated end-user experience. They can be found in the main leda-utils repository on GitHub: <a href="https://github.com/eclipse-leda/leda-utils">eclipse-leda/leda-utils</a>.</p>
<p>The following pages are meant to serve as both internal documentation and general guidelines when developing for Leda.</p>
<h2 id="bash">Bash</h2>
<p>Leda uses the classic Bourne shell as its main shell, thus all scripts should be sh-compatible (use the <code>#!/bin/sh</code> shebang). As a Poky+OE-based distro we use BusyBox for core-utils. To check explicitly for <em>&ldquo;bashisms&rdquo;</em> in your scripts, the
<code>checkbashisms</code> tool might be useful.</p>
<p><a href="shell/"><strong>Utility-Specific Pages</strong></a></p>
<p>The bash-based leda-utils are all deployed with the same recipe under the sdv-base packagegroup: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/sdv-base">meta-leda/meta-leda-components/recipes-sdv/sdv-base</a>.</p>
<h2 id="rust">Rust</h2>
<p>The current <em>main</em> branch for leda-distro (and meta-leda) is based on the Kirkstone Yocto/Poky release.</p>
<h3 id="toolchain-version">Toolchain version</h3>
<p>The version of the Rust toolchain available in OE (Kirkstone) is <strong>1.59.0</strong>. Make sure to target <strong>1.59.0</strong> (or earlier) when developing Rust-based utils for leda. To set <strong>1.59.0</strong> as your default Rust version on your development machine:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustup install 1.59.0
</span></span><span style="display:flex;"><span>$ rustup default 1.59.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo --version
</span></span><span style="display:flex;"><span>cargo 1.59.0 <span style="color:#ce5c00;font-weight:bold">(</span>49d8809dc 2022-02-10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="generating-bitbake-recipes-with-cargo-bitbake">Generating bitbake recipes with cargo-bitbake</h3>
<p>After making sure your toolchain is on version <strong>1.59.0</strong> go trough a clean build of your Rust binary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> &lt;rust_project_dir&gt;
</span></span><span style="display:flex;"><span>$ cargo clean
</span></span><span style="display:flex;"><span>$ rm Cargo.lock
</span></span><span style="display:flex;"><span>$ cargo build --release
</span></span></code></pre></div><p>This will make sure the Cargo.lock is re-generated with packages matching the Rust version. The <code>cargo.bbclass</code> on which Rust recipes are based, requires all Rust crates + their version (matching the Cargo.toml) to be specified as a &ldquo;SRC_URI +=&rdquo;. This can become tedious and error-prone if done by hand. That&rsquo;s why meta-rust provides a tool called <code>cargo-bitbake</code> that generates a minimal recipe with all the crates it finds in the <code>Cargo.lock</code> files of the project.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo install --locked cargo-bitbake
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> &lt;rust_project_dir&gt;
</span></span><span style="display:flex;"><span>$ cargo bitbake
</span></span></code></pre></div><p>This will generate a recipe in the project root which you can use as a starting point.</p>
<p>Example: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kantui_git.bb">kantui_git.bb</a></p>
<p>Note this recipe will only build your Rust crate. To deploy/install your binary you have to define a <code>.inc</code> file with the same name as the recipe that would handle the installation.</p>
<p>Example: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kantui.inc">kantui.inc</a></p>
<h3 id="known-bugs">Known bugs</h3>
<p>The built-in <code>proc_macros</code> crate is not being imported properly by meta-rust (Kirkstone), thus breaking all library crates that define a proc_macro (<a href="https://github.com/meta-rust/meta-rust/issues/266">meta-rust issue 266</a>). To fix this create a <code>libstd-rs_%.bbappend</code> file containing the single line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">S</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">RUSTSRC</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/library/test&#34;</span>
</span></span></code></pre></div><p>meta-leda already provides this fix <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/libstd-rs_%25.bbappend">here</a>, so it should not be necessary to implement it again.</p>
<h3 id="fat-link-time-optimization">&ldquo;Fat&rdquo; Link time optimization</h3>
<p>LTO is a nice feature of LLVM that can optimize even through language boundaries at link-time, but leads to longer overall build times. That is why Rust by default uses &ldquo;thin&rdquo; LTO which may result in larger/slower binaries. &ldquo;Fat&rdquo; LTO can be enabled when building release binaries by adding to the <code>Cargo.toml</code> file the following section:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lto</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span></code></pre></div><p>For <a href="rust/kantui">kantui</a> this leads to reduction of the final binary size from ~8 MiB to ~5 MiB.</p>
<p>More information on profile-optimizations can be found <a href="https://doc.rust-lang.org/cargo/reference/profiles.html">here</a>.</p>
<p><strong>Note</strong>: Stripping the debug symbols completely results in further binary size reduction, but BitBake fails with a QA problem when deploying stripped binaries.</p>
<h3 id="rust-based-utilities">Rust-based utilities</h3>
<p><a href="rust/"><strong>Utility-Specific Pages</strong></a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d807daac010fe21775fe6dc4f7bef15d">10.1 - Rust Utils</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a15bf08ceb9050ab919c4dd1e39f4581">10.1.1 - Communicating with Кanto-CM via gRPC</h1>
    
	<p>Kanto container management binds to a unix socket (default: <code>/run/container-management/container-management.sock</code>) and exposes a gRPC interface which can be used to obtain all the functionality of the <code>kanto-cm</code> cli programatically.</p>
<p>The easiest way to access this API through Rust is by creating a new Rust crate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo new talk-to-kanto
</span></span></code></pre></div><h2 id="dependencies">Dependencies</h2>
<p>The most feature-rich gRPC library for Rust right now is tonic. Add the following to your <code>Cargo.toml</code> to make tonic and the tokio async runtime available to your crate. Tower and hyper are needed to be able to bind to the unix socket.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">prost</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.11&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tokio</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;rt-multi-thread&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;fs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;macros&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;net&#34;</span><span style="color:#000;font-weight:bold">,]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tokio-stream</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;net&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tonic</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.8.2&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tower</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.4&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">http</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">hyper</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.14&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;full&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serde</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.147&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;derive&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serde_json</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.89&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">default-features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;alloc&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">build-dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tonic-build</span> <span style="color:#000;font-weight:bold">=</span>  <span style="color:#4e9a06">&#34;0.8.2&#34;</span>
</span></span></code></pre></div><h2 id="compiling-protobufs">Compiling protobufs</h2>
<p>The easiest way to obtain the kanto-cm <code>.proto</code> files is to add the container management repo in your project root as a git submodule:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git submodule init
</span></span><span style="display:flex;"><span>$ git submodule add https://github.com/eclipse-kanto/container-management.git
</span></span><span style="display:flex;"><span>$ git submodule update --init --recursive
</span></span></code></pre></div><p>You should now have the <code>container-management</code> repository available.</p>
<p>To build the <code>.proto</code> files during compile time, define a custom <code>build.rs</code> in the project root</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ touch build.rs
</span></span></code></pre></div><p>Add the following main function to the <code>build.rs</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fn</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-&gt; <span style="color:#204a87">Result</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Box</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">dyn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">std</span>::<span style="color:#000">error</span>::<span style="color:#000">Error</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tonic_build</span>::<span style="color:#000">configure</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">build_server</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">include_file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mod.rs&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">type_attribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;#[derive(serde::Serialize, serde::Deserialize)]&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">compile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;api/services/containers/containers.proto&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;container-management/containerm/&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">Ok</span><span style="color:#000;font-weight:bold">(())</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Here it is important to know that tonic does not like deeply nested protobufs such as those for kanto-cm. That is why the line <code>.include_file(&quot;mod.rs&quot;)</code> re-exports everything in a seperate module which can later be included in the main.rs file.</p>
<p><code>&quot;#[derive(serde::Serialize, serde::Deserialize)]&quot;</code> makes all structures (de-)serializable via serde.</p>
<h2 id="importing-generated-rust-modules">Importing generated Rust modules</h2>
<p>Now in <code>src/main.rs</code> add the following to import the generated Rust modules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">mod</span> <span style="color:#000">cm</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tonic</span>::<span style="color:#000">include_proto</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mod&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm</span>::<span style="color:#000">github</span>::<span style="color:#000">com</span>::<span style="color:#000">eclipse_kanto</span>::<span style="color:#000">container_management</span>::<span style="color:#000">containerm</span>::<span style="color:#000">api</span>::<span style="color:#000">services</span>::<span style="color:#000">containers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_services</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm</span>::<span style="color:#000">github</span>::<span style="color:#000">com</span>::<span style="color:#000">eclipse_kanto</span>::<span style="color:#000">container_management</span>::<span style="color:#000">containerm</span>::<span style="color:#000">api</span>::<span style="color:#000">types</span>::<span style="color:#000">containers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_types</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Now all kanto-cm services as namespaced under <code>cm_services</code>.</p>
<h2 id="obtaining-a-unix-socket-channel">Obtaining a unix socket channel</h2>
<p>To obtain a unix socket channel:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokio</span>::<span style="color:#000">net</span>::<span style="color:#000">UnixStream</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tonic</span>::<span style="color:#000">transport</span>::<span style="color:#000;font-weight:bold">{</span><span style="color:#000">Endpoint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Uri</span><span style="color:#000;font-weight:bold">};</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tower</span>::<span style="color:#000">service_fn</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/run/container-management/container-management.sock&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">channel</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Endpoint</span>::<span style="color:#000">try_from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://[::]:50051&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connect_with_connector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">service_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">move</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">_</span>: <span style="color:#000">Uri</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UnixStream</span>::<span style="color:#000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">socket_path</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">await</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This is a bit of a hack, because currently, tonic+tower don&rsquo;t support binding directly to an unix socket. Thus in this case we attemp to make an http connection to a non-existent service on port <code>5051</code>. When this fails, the fallback method <code>connect_with_connector()</code> is called where a tokio UnixStream is returned and the communication channel is generated from that.</p>
<h2 id="making-a-simple-grpc-call-to-kanto-cm">Making a simple gRPC call to kanto-cm</h2>
<p>All that is left is to use the opened channel to issue a simple &ldquo;list containers&rdquo; request to kanto.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate a CM client, that handles containers-related requests (see protobufs)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">mut</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_services</span>::<span style="color:#000">containers_client</span>::<span style="color:#000">ContainersClient</span>::<span style="color:#000">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">request</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tonic</span>::<span style="color:#000">Request</span>::<span style="color:#000">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm_services</span>::<span style="color:#000">ListContainersRequest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{});</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">response</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">await</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Since we made all tonic-generated structures (de-)serializable we can use <code>serde_json::to_string()</code> to print the response as a json string.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#000">println!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;{}&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">serde_json</span>::<span style="color:#000">to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4ceae03484d6716691789648aa48571f">10.1.2 - Kanto Auto deployer</h1>
    
	<p><strong>TLDR</strong>: To deploy a container in the final Leda image, all you generally need to do is add the manifest in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and re-build.</p>
<p>Kanto-CM does not provide (currently) an out-of-the box feature that allows for the automatic deployment of containers through manifest files similar to k3s&rsquo; automated deployment of k8s-manifests found in the <code>/var/lib/rancher/k3s/server/manifests</code> directory.</p>
<p>This can be worked around via a bash script for each container that runs on boot and makes sure it&rsquo;s deployed. Even though this approach is functional it is not very structured and would require a lot repeating code.</p>
<p>That is why the &ldquo;<a href="https://github.com/eclipse-leda/leda-utils/tree/main/src/rust/kanto-auto-deployer">Kanto Auto deployer</a>&rdquo; tool was developed. It directly implements the ideas in <a href="../notes-on-kanto-grpc">Communicating with Кanto-CM via gRPC</a>.</p>
<p>The compiled binary takes a path to a directory containing the json manifests, parses them into Rust structures and sends gRPC requests to kanto container management to deploy these containers.
If the container is already deployed the manifest is ignored.</p>
<h2 id="manifest-structure">Manifest structure</h2>
<p>Kanto auto deployer uses the exact same structure for its manifests as the internal representation of container state in kanto container management. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;databroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;image&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val/databroker:0.2.5&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;decrypt_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;domain_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;resolv_conf_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hostname_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;mounts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hooks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;devices&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restart_policy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;maximum_retry_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;retry_timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;unless-stopped&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;runtime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;io.containerd.runc.v2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;extra_hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;port_mappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;container_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">55555</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_ip&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30555</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port_end&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30555</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;log_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;driver_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;json-file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_files&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;root_dir&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;mode_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;blocking&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_buffer_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;resources&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;io_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stderr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;open_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;stdin_once&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;tty&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;RUST_LOG=info&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;vehicle_data_broker=debug&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;network_settings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;started_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exit_code&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;finished_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exited&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;dead&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restarting&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;paused&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;running&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;oom_killed&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;created&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;manually_stopped&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;restart_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The only difference to the actual internal state representation is that fields in the manifest can be left empty (<code>&quot;&quot;</code>) if they are not important for the deployment. These values will be filled in with defaults by kanto-cm after deployment.</p>
<p>For example, you do not need to specify the container &ldquo;id&rdquo; in the manifest, as an unique uuid would be assigned automatically after deployment.</p>
<h2 id="container-deployment-in-leda">Container deployment in Leda</h2>
<p>Kanto-auto-deployer runs as a one-shot service on boot that goes through the manifest folder (default: <code>/var/containers/manifests</code>) and deploys required containers.</p>
<p>The Bitbake recipe for building and installing the auto deployer service can be found at <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-auto-deployer_git.bb">kanto-auto-deployer_git.bb</a>.</p>
<p>This recipe also takes all manifests in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and installs them in the directory specified by the <code>KANTO_MANIFESTS_DIR</code> BitBake variable (weak default: <code>/var/containers/manifests</code>).</p>
<p><strong>Important</strong>: To deploy a container in the final Leda image, all you generally need to do is add the manifest in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and re-build.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1a1d75c926eacba3c473eb373af6186f">10.1.3 - Kantui</h1>
    
	<p>The k8s ecosystem comes with a lot of utilies that allow for the easier management of containers (such as k9s). The <a href="https://github.com/eclipse-leda/leda-utils/tree/main/src/rust/kanto-tui">kantui util</a> aims to be a &ldquo;nice&rdquo; text user interface that lets the user start/stop/remove/get logs of deployed containers in kanto-cm.</p>
<p><img src="https://github.com/eclipse-leda/leda-utils/blob/main/src/rust/kanto-tui/misc/kantocmcurses-ss.png?raw=true" alt="kantui screenshot"></p>
<h2 id="development-notes">Development notes</h2>
<p>This tool is again based on the ideas in <a href="../notes-on-kanto-grpc">Communicating with Кanto-CM via gRPC</a>.</p>
<p>It spins up two threads - an UI thread (drawing/updating UI) and an IO thread (communicating with kanto-cm via gRPC). The communication between these two threads happens over an <a href="https://crates.io/crates/async-priority-channel">async-priority-channel</a> with <code>ListContainers</code> request having a lower priority than <code>Start/Stop/Remove/Get Logs</code> (&ldquo;user interaction&rdquo;) requests.</p>
<p>This in an &ldquo;eventually fair&rdquo; mechanism of communication. That way even if kanto-cm is handling a slow request (such as stopping a container that does not respect SIGTERM) the UI thread is never blocked, allowing for a responsive-feeling UI. The size of the channel is 5 requests and the UI is running at 30 fps. Thus even if the UI gets out-of-sync with the actual state of container management it would be &ldquo;only&rdquo; for 5 out 30 frames.</p>
<h2 id="cursive-and-ncurses-rs">Cursive and ncurses-rs</h2>
<p>The <a href="https://crates.io/crates/cursive">cursive</a> crate is used as a high level &ldquo;framework&rdquo; as it allows very easy handling of UI events via callbacks, though this might be prone to callback hell.</p>
<p>The default backend for cursive is ncurses-rs which a very thin Rust wrapper over the standart ncurses library. This in theory would be the optimal backend for our case as ncurses is a very old and stable library that has buffering (other backends lead to flickering of the UI on updates) and is dynamically linked (smaller final binary size).</p>
<p>The ncurses-rs wrapper however is <strong>not well-suited to cross-compilation</strong> as it has a custom build.rs that generates a small C program, compiles it for the target and tries to run it on the host. The only reason for this C program to exist is to check the width of the <em>char</em> type. Obviously, the char type on the host and the target might be of different width and this binary might not even run on the host machine if the host and target architectures are different.</p>
<p>After coming to the conclusion that the ncurses-rs backend was not suitable, kantui was migrated to the termion backend + the <a href="https://crates.io/crates/cursive_buffered_backend">cursive_buffered_backend</a> crate which mitigates the flickering issue.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cursive_buffered_backend</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.5.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cursive</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default-features</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span><span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.16.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;termion-backend&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>This completely drops the need for ncurses-rs but results in a slightly bigger binary (all statically linked).</p>
<h2 id="bitbake-recipe">Bitbake Recipe</h2>
<p>The recipe was created following the guidelines in <a href="../../#generating-bitbake-recipes-with-cargo-bitbake">Generating bitbake recipes with cargo-bitbake</a> and can be found in <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda">meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/</a>.</p>
<h2 id="future-improvement-notes">Future improvement notes</h2>
<ul>
<li>
<p>The gRPC channel can get blocked thus effectively &ldquo;blocking&rdquo; the IO-thread until it is freed-up again. Maybe open a new channel for each request (slow/resource heavy)?</p>
</li>
<li>
<p>Reorganize the code a bit, move all generic functionally in the lib.rs.</p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4f521ffe9ea62a6a0abf7d17bb18e912">10.2 - Shell Utils</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6db933c8beae49618c83597c4bad0cde">10.2.1 - sdv-health</h1>
    
	<p>A general utility for monitoring the status of important sdv services/containers/devices.</p>
<h2 id="checking-the-status-of-kanto-cm-containers">Checking the status of kanto-cm containers</h2>
<p>Kanto CM containers are split into two groups - required and optional. Both groups are checked, but only a warning is issued when an optional container is missing/not working.</p>
<p>General code for checking the status is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_CONTAINERS_OPT</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">printf</span> -- <span style="color:#4e9a06">&#34;</span><span style="color:#000">$SEPARATOR</span><span style="color:#4e9a06">\n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">printf</span> -- <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">COL_WHITE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">[Kanto CM Containers (OPTIONAL)]</span><span style="color:#4e9a06">${</span><span style="color:#000">COL_NC</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">${</span><span style="color:#000">CM_STATUS</span><span style="color:#4e9a06">}</span> !<span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#4e9a06">&#34;inactive&#34;</span>*  <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># &#34;Optional containers&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KANTO_CM_LIST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CMD</span><span style="color:#4e9a06">}</span> list<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># removes tabs, splits on pipe and takes the container name column ($2)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FOUND_CONTAINERS</span><span style="color:#ce5c00;font-weight:bold">=(</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_LIST</span><span style="color:#4e9a06">&#34;</span> <span style="color:#000;font-weight:bold">|</span> awk -F<span style="color:#4e9a06">&#39;|&#39;</span> <span style="color:#4e9a06">&#39;{gsub(/\t/, &#34;&#34;); print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># array with all kanto container names</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># removes tabs, splits on pipe and takes the container status colum ($4)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FOUND_CONTAINERS_STATES</span><span style="color:#ce5c00;font-weight:bold">=(</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_LIST</span><span style="color:#4e9a06">&#34;</span> <span style="color:#000;font-weight:bold">|</span> awk -F<span style="color:#4e9a06">&#39;|&#39;</span> <span style="color:#4e9a06">&#39;{gsub(/\t/, &#34;&#34;); print $4}&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># array with all kanto container states</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KANTO_CM_CONTAINERS_ARR</span><span style="color:#ce5c00;font-weight:bold">=(</span> <span style="color:#000">$KANTO_CM_CONTAINERS_OPT</span> <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> expectedCtr in <span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CM_CONTAINERS_ARR</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CTR_IDX</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>get_array_element_index <span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">FOUND_CONTAINERS</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> ! -z <span style="color:#000">$CTR_IDX</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">FOUND_CONTAINERS_STATES</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">$CTR_IDX</span><span style="color:#000;font-weight:bold">]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$status</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Running&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_OK</span><span style="color:#4e9a06">\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_WARN</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$status</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_WARN</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;NOT FOUND&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_FAIL</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;Kanto Container Management&#34;</span> <span style="color:#4e9a06">&#34;Unavailable&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>Here it is important to know that <code>kanto-cm list</code> outputs the list of containers in a different order every time it&rsquo;s called. That is why, <code>kanto-cm list</code> is invoked once and its output is stored in a variable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>	<span style="color:#000">KANTO_CM_LIST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CMD</span><span style="color:#4e9a06">}</span> list<span style="color:#204a87;font-weight:bold">)</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID                                      <span style="color:#000;font-weight:bold">|</span>Name                                   <span style="color:#000;font-weight:bold">|</span>Image                                                                                                                          <span style="color:#000;font-weight:bold">|</span>Status         <span style="color:#000;font-weight:bold">|</span>Finished At                     <span style="color:#000;font-weight:bold">|</span>Exit Code   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>-------------------------------------   <span style="color:#000;font-weight:bold">|</span>-------------------------------------  <span style="color:#000;font-weight:bold">|</span>------------------------------------------------------------                                                                   <span style="color:#000;font-weight:bold">|</span>----------     <span style="color:#000;font-weight:bold">|</span>------------------------------  <span style="color:#000;font-weight:bold">|</span>----------  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>d82a406e-80d7-4d2c-8044-3799544fc39a    <span style="color:#000;font-weight:bold">|</span>vum                                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-vehicle-update-manager/vehicleupdatemanager:main-1d8dca55a755c4b3c7bc06eabfa06ad49e068a48    <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>0f079856-767c-4e8d-b4df-a2323392849f    <span style="color:#000;font-weight:bold">|</span>cloudconnector                         <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-cloud-connector/cloudconnector:main-47c01227a620a3dbd85b66e177205c06c0f7a52e                 <span style="color:#000;font-weight:bold">|</span>Exited         <span style="color:#000;font-weight:bold">|</span>2023-01-31T11:58:01.564126452Z  <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">1</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>e4cf317e-c2d3-42c7-8f12-8ecf6f9d5d7a    <span style="color:#000;font-weight:bold">|</span>databroker                             <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val/databroker:0.2.5                                                                                     <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>6440a9b6-4fb8-4735-b3de-484286ac705b    <span style="color:#000;font-weight:bold">|</span>feedercan                              <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.feeders/dbc2val:v0.1.1                                                                               <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>efbd572b-3331-4f19-9b17-7c69511ec5ca    <span style="color:#000;font-weight:bold">|</span>hvacservice-example                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.services/hvac_service:v0.1.0                                                                         <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>6d9a6f07-1659-4b51-9ddb-6e9ade64f2fd    <span style="color:#000;font-weight:bold">|</span>seatservice-example                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.services/seat_service:v0.1.0                                                                         <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>06b0ddf2-7c91-41e4-9a00-4213ee361cdf    <span style="color:#000;font-weight:bold">|</span>sua                                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-self-update-agent/self-update-agent:build-12                                                 <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span></code></pre></div><p>So we use awk to split on pipe (column), strip unecessary tabs. <code>print $2</code> then gives us the container name and <code>print $4</code> - its status.</p>
<p>sdv-health then proceeds to check if every container specified in the list is available and if its status is <code>Running</code>.</p>
<p>Note: <code>Exited</code> is considered a fail-state.</p>
<h2 id="checking-kanto-cm-socket">Checking kanto-cm socket</h2>
<p>This is a simple <code>test -s</code> check for the default socket path.</p>

</div>



    
	
  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      


<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/eclipse-leda" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
        
          <p class="mt-2"><a href="/leda/docs/about/">About Leda</a></p>
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org">
        Eclipse Foundation
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/privacy.php">
        Privacy Policy
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/termsofuse.php">
        Terms of Use
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/copyright.php">
        Copyright Agent
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/">
        Legal
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/epl-2.0/">
        License
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/security/">
        Report a Vulnerability
      </a>
    </small>
  </li>
  
</ul>

        
        
      </div>
  </div>
</footer>


    </div>
    
  <script src="/leda/js/main.min.b671a59c5b86cdbfc17e4c1c2db8c832613727a3e1bf00c27ddab56b30360c8a.js" integrity="sha256-tnGlnFuGzb/BfkwcLbjIMmE3J6PhvwDCfdq1azA2DIo=" crossorigin="anonymous"></script>
<script src='/leda/js/tabpane-persist.js'></script>

  </body>
</html>
