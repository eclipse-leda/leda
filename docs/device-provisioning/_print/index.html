<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.98.0" />
<link rel="canonical" type="text/html" href="https://eclipse-leda.github.io/leda/docs/device-provisioning/">
<link rel="alternate" type="application/rss&#43;xml" href="https://eclipse-leda.github.io/leda/docs/device-provisioning/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/leda/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/leda/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/leda/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/leda/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/leda/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/leda/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/leda/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/leda/favicons/android-192x192.png" sizes="192x192">

<title>Device Provisioning | Eclipse Leda Documentation</title>
<meta name="description" content="">
<meta property="og:title" content="Device Provisioning" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://eclipse-leda.github.io/leda/docs/device-provisioning/" />

<meta itemprop="name" content="Device Provisioning">
<meta itemprop="description" content=""><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Device Provisioning"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/leda/scss/main.min.74aaf46f810a3e4a4ed7ecf52b4f047e331c1f74e55ef6969c96feafd305c037.css" as="style">
<link href="/leda/scss/main.min.74aaf46f810a3e4a4ed7ecf52b4f047e331c1f74e55ef6969c96feafd305c037.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/leda/"><span class="navbar-brand__logo navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="30 270 300 300" id="svg2"><defs id="defs6"><clipPath id="clipPath24" clipPathUnits="userSpaceOnUse"><path id="path22" d="m5116.71 2737.03v81.36c0 51.02 13.61 71.72 55.28 74.55h288.29v-182.27c-4.26-34.29-16.73-48.19-55.28-48.19h-226.21c-47.05.0-62.08 20.69-62.08 74.55zm-139.46 17.86c0-128.41 84.19-198.71 222.24-198.71h42.8c107.43.0 184.82 2.84 217.99 84.19v-84.19h137.76v534.05c0 128.13-97.8 198.71-235.85 198.71H5051.8v-106.3h360c36 0 48.48-23.52 48.48-60.66v-122.74h-260.79c-138.05.0-222.24-70.59-222.24-198.71zm-332.5-44.22c-3.97-34.29-16.44-48.19-55-48.19h-225.07c-46.76.0-62.08 20.69-62.08 74.55v371.06c0 51.03 13.9 71.71 55.28 74.55h231.87c41.39-2.84 55-23.52 55-74.55zm139.46 854.08h-138.04v-360c-33.17 81.36-110.28 84.19-217.99 84.19h-42.8c-137.77.0-221.96-70.58-221.96-198.71v-335.34c0-128.41 84.19-198.71 221.96-198.71h42.8c107.71.0 184.82 2.84 217.99 84.19v-84.19h138.04zm-925.8-587.62h-362.83v144.85c0 28.91 12.47 60.66 48.2 60.66h266.45c35.71.0 48.18-31.75 48.18-60.66zm139.47-106.3v219.4c0 128.13-98.08 198.71-236.13 198.71h-169.51c-138.04.0-235.84-70.58-235.84-198.71v-335.34c0-128.41 97.8-198.71 235.84-198.71h405.64v106.3h-454.1c-35.73.0-48.2 23.54-48.2 60.66v147.69zM2642.92 2556.18h630.71v117.36h-483.02v794.55h-147.69z"/></clipPath><linearGradient id="linearGradient34" spreadMethod="pad" gradientTransform="matrix(2955.12,0,0,-2955.12,2642.92,3060.47)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop26" offset="0" style="stop-opacity:1;stop-color:#77add1"/><stop id="stop28" offset=".189014" style="stop-opacity:1;stop-color:#64c6ee"/><stop id="stop30" offset=".994475" style="stop-opacity:1;stop-color:#7b3199"/><stop id="stop32" offset="1" style="stop-opacity:1;stop-color:#7b3199"/></linearGradient><linearGradient id="linearGradient44" spreadMethod="pad" gradientTransform="matrix(1875.15,0,0,-1875.15,364.686,2981.28)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop38" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop40" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop42" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient><clipPath id="clipPath54" clipPathUnits="userSpaceOnUse"><path id="path52" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31z"/></clipPath><linearGradient id="linearGradient70" spreadMethod="pad" gradientTransform="matrix(1417.96,0,0,-1417.96,477.178,2901.88)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop56" offset="0" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop58" offset=".11811164" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop60" offset=".509456" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop62" offset=".76356415" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop64" offset=".994475" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop66" offset=".99510668" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop68" offset="1" style="stop-opacity:1;stop-color:#4e9133"/></linearGradient><linearGradient id="linearGradient80" spreadMethod="pad" gradientTransform="matrix(942.78,0,0,-942.78,720.659,3019.8)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop74" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop76" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop78" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient></defs><g transform="matrix(1.3333333,0,0,-1.3333333,0,795.04)" id="g10"><g transform="scale(0.1)" id="g12"><path id="path46" style="fill:url(#linearGradient44);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m462.512 2989.03c1.133-223.65 47.902-452.13 142.867-685.13 24.66-60.94 67.465-109.13 120.187-139.47 52.727-30.61 115.657-43.93 180.852-35.14 236.122 32.03 453.262 104.03 650.552 218.55 193.89 112.53 368.79 266.17 523.27 463.18 41.11 52.15 61.8 113.67 61.8 174.9.28 61.51-20.13 123.02-60.95 175.18-145.7 186.8-317.19 337.89-515.62 450.99-194.74 110.83-415.84 185.1-665.005 220.82-65.481 9.36-128.692-3.4-181.699-33.74C665.758 3768.85 622.672 3720.94 597.441 3660c-90.14-219.4-136.062-443.06-134.929-670.97zm51.875-721.98c-99.5 244.06-148.535 484.73-149.668 721.42-1.418 241.23 47.054 477.63 142.297 708.66 33.73 81.92 91.843 146.27 163.273 187.08 71.719 40.82 156.473 58.11 244.066 45.64 261.355-37.13 494.075-115.65 699.595-232.72 209.76-119.34 390.61-278.65 544.25-475.66 54.71-70.01 81.92-152.78 81.63-235.55.0-83.06-27.49-165.83-82.2-235.56-162.42-206.65-346.68-368.5-551.62-487.27-208.35-121.05-437.67-197.02-686.549-230.75-87.313-11.9-171.785 5.95-242.934 47.05-71.433 41.39-128.976 106.02-162.14 187.66v0"/><g id="g48"><g clip-path="url(#clipPath54)" id="g50"><path id="path72" style="fill:url(#linearGradient70);fill-opacity:1;fill-rule:nonzero;stroke:none" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31v0"/></g></g><path id="path82" style="fill:url(#linearGradient80);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m935.898 3147.21c-54.71-85.89-93.543-185.38-115.085-298.77-4.821-24.94-1.418-49.33 9.07-69.74 10.207-20.69 27.496-37.98 49.605-48.75 97.508-46.78 197.292-73.42 300.192-78.81 101.19-5.1 205.51 9.92 312.94 46.78 23.81 8.21 42.81 23.53 55.56 42.8 12.48 19.56 18.71 43.37 16.44 68.88-9.07 108.28-36.57 208.92-83.9 301.61-46.49 91.28-111.97 175.18-197.58 251.15-18.71 16.44-41.1 25.51-63.78 26.93-22.67 1.13-45.92-5.11-66.33-19.28-88.72-61.51-161.292-135.78-217.132-222.8zM724.434 2866.87c24.093 125.28 67.461 236.12 128.976 332.78 63.211 98.93 144.563 182.27 243.5 250.87 38.83 27.21 83.9 39.11 128.12 36.56 44.22-2.55 87.31-19.84 123.03-51.59 95.24-84.47 168.37-178.01 220.25-279.78 53-104.31 84.19-217.14 94.39-337.89 3.97-47.61-8.22-92.98-32.6-130.39-24.09-37.42-60.66-66.9-105.45-82.21-119.34-41.1-236.12-57.83-349.79-51.87-115.94 6.24-228.473 36-337.325 88.44-42.805 20.41-75.398 53.29-95.242 92.98-19.848 39.68-26.648 85.6-17.859 132.1v0"/></g></g></svg></span><span class="navbar-brand__name">Eclipse Leda Documentation</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item me-4 mb-2 mb-lg-0">
        <a class="nav-link" href="https://github.com/eclipse-leda" target="_blank"><span>GitHub</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/leda/offline-search-index.cb0305aa6ff71b2a0b6d9f61e5a56593.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/leda/docs/device-provisioning/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Device Provisioning</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-57ce4bccb0846f692ca5d3289bd50697">Manual Provisioning</a></li>


    
  
    
    
	
<li>2: <a href="#pg-6a8972aed290b5361baddab9db342178">Provisioning with sdv-provision</a></li>


    
  
    
    
	
<li>3: <a href="#pg-b841cdcaabc5e1bd7476de818736b5bd">Vehicle Update Manager</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-42e18573332f97451f15ebcfa61573ab">Configuration</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-a9d83955f4af71a310e5e508cd17161e">Message Flow</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-679c6c584dc366c660841bdd65d2af73">Self Updates</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-cb55165363d95c91e0f19399fa5b280b">Self Update Tutorial</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-fdfe9e0ec285454b4f0c580b5cd46e62">RAUC Integration</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-330a7bfc4527a76419775bc5ddc1265b">API Reference</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p>The device needs to be configured before it can make a connection to the cloud.</p>
<p>The following initial configuration steps are required:</p>
<ul>
<li>Create a device in the cloud backend, such as Azure IoT Hub</li>
<li>Configure authentication on device</li>
<li>Configure credentials for accessing private container registries</li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-57ce4bccb0846f692ca5d3289bd50697">1 - Manual Provisioning</h1>
    
	<p>Follow these steps to do a manual device provisioning:</p>
<ul>
<li>Generate the device certificate (eg using openssl) and sign it with your CA.</li>
<li>Log in to Azure Portal, Go to Azure Iot Hub and create a new device</li>
<li>Select the proper authentication type, e.g. X.509 Self-signed or X.509 CA Signed</li>
<li>Copy the device certificate (cert file and key file) to the device to <code>/data/var/certificate</code></li>
<li>Restart cloud connector service or container.</li>
</ul>
<h2 id="create-a-device-in-azure-iot-hub">Create a device in Azure IoT Hub</h2>
<p>For the device to be connectable, it needs to be known to the cloud service first. In these steps, we will create a new device identity by using Azure IoT Hub.</p>
<p><strong>Pre-Requisites</strong>:</p>
<ul>
<li>
<p>Virtual device must already be started with <code>runqemu ...</code> or <code>leda</code></p>
<p><em>Note: For Raspberry Pi, please follow the manual steps below and adapt the SSH connection options to the IP of your Raspbery Pi.</em></p>
</li>
<li>
<p>The virtual device needs to be remotely accessible via ssh port <code>2222</code> on the host&rsquo;s <code>localhost</code> (Qemu port forwarding in userspace)
or via ssh port <code>22</code> on the IP address <code>192.168.7.2</code> (Qemu virtual networking using TAP network interface)</p>
</li>
<li>
<p>The container runtime needs to have started successfully, check with <code>sdv-health</code></p>
</li>
<li>
<p>A Device has been created in Azure IoT Hub</p>
<p><em>Note: Do <strong>NOT</strong> create an &ldquo;edge&rdquo; device.</em></p>
</li>
</ul>
<h2 id="configure-authentication-on-device">Configure authentication on device</h2>
<p>For the proper device authentication, the device management backend authority needs to issue a device-specific certificate and sign it. This is a complex process and subject to the specific situation.</p>
<p>For the Leda quickstart images, the software configuration is prepared with dummy certificates which need to be replaced.</p>
<blockquote>
<p>ATTENTION: The Leda example device certificates are public and insecure, they only serve demonstration purposes. You need to replace the intermediate certificates and device certificates with your own.</p>
</blockquote>
<ul>
<li>Generate a device certificate using openssl</li>
<li>Sign it with your intermediate CA certificate</li>
<li>Put it into <code>/data/var/certificate/</code></li>
<li>Restart the cloud connector service or container: <code>systemctl restart cloud-connector</code> or <code>kanto-cm restart -n cloud-connector</code></li>
</ul>
<p>When finished, continue with</p>
<ul>
<li><a href="/leda/docs/app-deployment/">Deploying a Vehicle App</a></li>
<li><a href="/leda/docs/device-provisioning/self-update/self-update-tutorial/">Performing a Self Update</a></li>
</ul>
<h2 id="private-container-registries">Private container registries</h2>
<p>Please refer to the <a href="https://websites.eclipseprojects.io/kanto/docs/references/containers/container-manager-config/">Kanto Container Management documentation</a> on how to configure private container registries.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6a8972aed290b5361baddab9db342178">2 - Provisioning with sdv-provision</h1>
    
	<p>Meta-leda and the Leda-quickstart image provide a utility <code>sdv-provision</code> that simplifies the device provisioning procedure.</p>
<h2 id="connecting-to-the-device">Connecting to the device</h2>
<p>Since the procedure includes copying and pasting device IDs, it is recommended to connect to the device over a ssh connection. <code>sdv-motd</code> provides an
easy way to find your device&rsquo;s ip. More information on connecting via ssh can be found <a href="../manual-provisioning#create-a-device-in-azure-iot-hub">here</a>.</p>
<h2 id="provisioning-via-a-connection-string">Provisioning via a connection string</h2>
<h3 id="device-side">Device-side</h3>
<ol>
<li>
<p>After connecting via ssh run <code>sdv-provision</code>.</p>
<p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@qemux86-64:~# sdv-provision
</span></span><span style="display:flex;"><span>Checking Eclipse Leda Device Provisioning configuration...
</span></span><span style="display:flex;"><span>- Certificates directory exists
</span></span><span style="display:flex;"><span>Checking Device ID
</span></span><span style="display:flex;"><span>- Based on network device: eth0
</span></span><span style="display:flex;"><span>- File does not exist, creating: /etc/deviceid
</span></span><span style="display:flex;"><span>- Device ID: XX-XX-XX-XX-XX-XX
</span></span><span style="display:flex;"><span>Checking whether either IdScope or ConnectionString is configured
</span></span><span style="display:flex;"><span>- Neither Id Scope file nor ConnectionString found, needs manual configuration
</span></span><span style="display:flex;"><span>Do you want to use the global Azure IoT Device Provisioning Service <span style="color:#ce5c00;font-weight:bold">(</span>DPS<span style="color:#ce5c00;font-weight:bold">)</span> by using an Id Scope, or <span style="color:#204a87;font-weight:bold">do</span> you want to use a direct connection to a specific Azure IoT Hub using a Connection String?
</span></span><span style="display:flex;"><span>d<span style="color:#ce5c00;font-weight:bold">)</span> Azure IoT Device Provisioning Service <span style="color:#ce5c00;font-weight:bold">(</span>DPS<span style="color:#ce5c00;font-weight:bold">)</span> with Id Scope
</span></span><span style="display:flex;"><span>h<span style="color:#ce5c00;font-weight:bold">)</span> Azure IoT Hub with Connection String
</span></span><span style="display:flex;"><span>Choose:
</span></span></code></pre></div></li>
<li>
<p>Note the generated Device ID (XX-XX-XX-XX-XX-XX).</p>
</li>
<li>
<p>Type h /Azure IoT Hub with Connection String/ and press Enter.</p>
</li>
<li>
<p>Paste your Azure IoT Hub Connection String: <code>HostName=&lt;IoT Hub in Azure&gt;.azure-devices.net;DeviceId=&lt;XX-XX-XX-XX-XX-XX&gt;</code> and press enter. Where <code>&lt;IoT Hub in Azure&gt;</code> is your Azure IoT Hub name.</p>
</li>
</ol>
<h3 id="azure-portal">Azure Portal</h3>
<ol>
<li>Go to <a href="https://portal.azure.com/">https://portal.azure.com/</a> and to your Azure IoT Hub named <code>&lt;IoT Hub in Azure&gt;</code>.</li>
<li>Choose <code>Devices -&gt; Add Device</code>.</li>
<li>Enter the Device ID <code>XX-XX-XX-XX-XX-XX</code> generated on the previous step as Device ID.</li>
<li>Pick <code>X.508 Self Signed</code> and paste the two thumbprints generated by <code>sdv-provision</code>.</li>
<li>Save.</li>
</ol>
<h3 id="device-side-1">Device-Side</h3>
<p>After all of the above steps have been completed, connect back to your device and restart the cloudconnector container by running:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kanto-cm restart -n cloudconnector
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b841cdcaabc5e1bd7476de818736b5bd">3 - Vehicle Update Manager</h1>
    
	<p>The <em>Vehicle Update Manager</em> delegates two different types of updates:</p>
<ol>
<li>The <em>Desired State</em> on the container layer</li>
<li>The <em>Self Update</em> on operating system layer</li>
</ol>
<p><img src="vehicle-update-manager-arch.png" alt="Vehicle Update Manager Architecture Overview"></p>
<h2 id="desired-state">Desired State</h2>
<p>The <em>Desired State</em> is applied at runtime on the container layer.</p>
<p>This type of update mechanism can update vehicle applications, vehicle services and other containers together with configuration resources or data files at runtime. If the applications support it, the rollout can also use high-availability strategies, such as rolling deployments.</p>
<h2 id="self-update">Self Update</h2>
<p>The <em>Self Update</em> is applied on reboot of the device only.</p>
<p>This type of update mechanism is used for system-level updates which require the operating system to be rebooted to take effect.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-42e18573332f97451f15ebcfa61573ab">3.1 - Configuration</h1>
    
	<p>The vehicle update manager container requires the following configuration:</p>
<ul>
<li>
<p>Container needs to run in <strong>privileged mode</strong> to enable automatic reboot.</p>
<p><em>Note: This is enabled by default on the Leda Quickstart images to simplify automated testing.</em></p>
</li>
<li>
<p><strong>Connection to MQTT broker</strong>, defaults to <code>THINGS_CONN_BROKER=tcp://mosquitto:1883</code></p>
</li>
<li>
<p><strong>Enable container orchestration</strong> feature: <code>THINGS_FEATURES=ContainerOrchestrator</code></p>
</li>
</ul>
<p>Optional configuration options are:</p>
<dl>
<dt><code>SELF_UPDATE_ENABLE_REBOOT=true</code></dt>
<dd>Enable automatic reboot after a successfull application of the update bundle.</dd>
<dt><code>SELF_UPDATE_TIMEOUT=30m</code></dt>
<dd>Timeout for downloading and installing an update bundle.</dd>
</dl>
<h1 id="example-deployment-specification">Example Deployment Specification</h1>
<pre tabindex="0"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: vehicle-update-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vehicle-update-manager
rules:
- apiGroups:
  - &#39;*&#39;
  resources:
  - &#39;*&#39;
  verbs:
  - &#39;*&#39;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vehicle-update-manager
subjects:
- kind: ServiceAccount
  name: vehicle-update-manager
  namespace: default
roleRef:
  kind: ClusterRole
  name: vehicle-update-manager
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vehicle-update-manager
spec:
  selector:
    matchLabels:
      component: vehicle-update-manager
  template:
    metadata:
      labels:
        component: vehicle-update-manager
    spec:
      serviceAccountName: vehicle-update-manager
      containers:
        - name: vehicle-update-manager
          image: &lt;repository&gt;/vehicleupdatemanager:&lt;tag&gt;
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          env:
            - name: SELF_UPDATE_TIMEOUT
              value: 30m
            - name: SELF_UPDATE_ENABLE_REBOOT
              value: &#34;true&#34;
            - name: THINGS_CONN_BROKER
              value: tcp://mosquitto:1883
            - name: THINGS_FEATURES
              value: ContainerOrchestrator
          volumeMounts:
          - mountPath: /proc
            name: proc
      volumes:
      - hostPath:
          path: /proc
        name: proc
      imagePullSecrets:
        - name: ghcr-io
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a9d83955f4af71a310e5e508cd17161e">3.2 - Message Flow</h1>
    
	<p>The following message flow is an example for the <em>Self Update</em> use case.
The message is triggered by command line via Azure IoT Hub.</p>
<div class="mermaid">sequenceDiagram
    autonumber

    actor flops as Fleet Operations

    participant backend as Digital Twin
    participant vum as Vehicle Update Manager
    participant sua as Self Update Agent
    participant device as Device

    flops ->> backend: Rollout Campaign

    backend -->> vum: Device Command <br> Live Message: <br> yamlApply

    Note left of backend: C2D Message

    vum -->> sua: selfupdate/desiredstate <br> SelfUpdateBundle

    loop Download
        sua -->> sua: Downloading
        sua -->> vum: selfupdate/desiredstatefeedback
        vum -->> backend: progress
    end

    loop Installation
        sua -->> device: Installing
        Note right of device: RAUC Update Bundle
        sua -->> vum: selfupdate/desiredstatefeedback
        vum -->> backend: progress
    end

    sua -->> vum: Installed
    
    rect rgb(100, 255, 150)
        sua -->> backend: FINISHED_SUCCESS
    end

    opt Reboot
        vum -->> device: SysRq Reboot
    end
  </div>
  
  <h1 id="messages">Messages</h1>
<p>The following describes the message flow with example messages in more detail. The following variables are used for dynamic parts of the messages:</p>
<ul>
<li><code>&lt;cuid&gt;</code> - A Correlation ID in form of a UUID</li>
<li><code>&lt;selfUpdateRequestYaml&gt;</code> or <code>&lt;payload&gt;</code>- The Desired State Self Update Request message in YAML, as defined by the Self Update Agent API</li>
<li><code>&lt;hub&gt;</code> - The name or identifier of the message hub</li>
<li><code>&lt;device&gt;</code> - The device identifier used by the message hub or other components to identify the device.</li>
</ul>
<ol>
<li>
<p>Cloud backend sends the Self-Update Request Message as YAML embedded into an Azure IoT Hub C2D Message Envelope:</p>
<p>Payload:</p>
<pre tabindex="0"><code>{
    &#34;appId&#34;: &#34;mc-ota-update&#34;,
    &#34;cmdName&#34;: &#34;desiredstate.update&#34;,
    &#34;cId&#34;: &#34;&lt;cuid&gt;&#34;,
    &#34;eVer&#34;: &#34;2.0&#34;,
    &#34;pVer&#34;: &#34;1.0&#34;,
    &#34;p&#34;: &lt;selfUpdateRequestYaml&gt;
}
</code></pre></li>
<li>
<p>Cloud Connector validates envelope and transforms request message into a <em>ContainerOrechestrator</em> message:</p>
<p>Topic: <code>command//azure.edge:&lt;hub&gt;:&lt;device&gt;:edge:containers/req/&lt;cuid&gt;/yamlApply</code></p>
<p>Body (json):</p>
<pre tabindex="0"><code> {
  &#34;topic&#34;: &#34;azure.edge/&lt;hub&gt;:&lt;device&gt;:edge:containers/things/live/messages/yamlApply&#34;,
  &#34;headers&#34;: {
     &#34;content-type&#34;: &#34;application/json&#34;,
     &#34;correlation-id&#34;: &#34;&lt;cuid&gt;&#34;},
     &#34;path&#34;: &#34;/features/ContainerOrchestrator/inbox/messages/yamlApply&#34;,
     &#34;value&#34;: {
         &#34;correlationId&#34;: &#34;&lt;cuid&gt;&#34;,
         &#34;payload&#34;: &#34;&lt;payload&gt;&#34;
         }
     }
 }
</code></pre><p><em>Note: Payload (Yaml encoded in JSON) omitted here for clarity, see next step.</em></p>
</li>
</ol>
<ol start="3">
<li>
<p>Vehicle Update manager extracts payload and forward the message to the Self Update Agent message inbox:</p>
<p>Topic: <code>selfupdate/desiredstate</code></p>
<p>Message:</p>
<pre tabindex="0"><code>apiVersion: sdv.eclipse.org/v1
kind: SelfUpdateBundle
metadata:
    name: self-update-bundle-example
spec:
    bundleDownloadUrl: http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb
    bundleName: swdv-arm64-build42
    bundleTarget: base
    bundleVersion: v1beta3
</code></pre></li>
</ol>
<ol start="4">
<li>
<p>The Self Update Agent response with status messages during download and installation phases.</p>
<p>Topic: <code>selfupdate/desiredstatefeedback</code></p>
<p>Message:</p>
<pre tabindex="0"><code>apiVersion: sdv.eclipse.org/v1
kind: SelfUpdateBundle
metadata: 
  name: &#34;self-update-bundle-example&#34;
spec: 
  bundleDownloadUrl: &#34;http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb&#34;
  bundleName: &#34;swdv-arm64-build42&#34;
  bundleTarget: base
  bundleVersion: v1beta3
state: 
  message: Entered Downloading state
  name: downloading
  progress: 0
  techCode: 0
</code></pre></li>
<li>
<p>Once finished, the Vehicle Update Manager will also return a <code>FINISHED_SUCCESS</code> message for the conversation with the backend.</p>
<p>Topic: <code>e/defaultTenant/azure.edge:&lt;hub&gt;:&lt;device&gt;:edge:containers</code></p>
<p>Message:</p>
<pre tabindex="0"><code>{
  &#34;topic&#34;: &#34;azure.edge/&lt;hub&gt;:&lt;device&gt;:edge:containers/things/twin/commands/modify&#34;,
  &#34;headers&#34;: {
    &#34;response-required&#34;:false
  },
  &#34;path&#34;: &#34;/features/ContainerOrchestrator/properties/status/state&#34;,
  &#34;value&#34;: {
    &#34;manifest&#34;: [],
    &#34;status&#34;: &#34;FINISHED_SUCCESS&#34;,
    &#34;correlationId&#34;:&#34;&lt;cuid&gt;&#34;
    }
}
</code></pre></li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-679c6c584dc366c660841bdd65d2af73">4 - Self Updates</h1>
    
	<p>In general, the self-update mechanism for operating system level updates is done with two separate partitions. While one partition is the actively booted partition and in use, the other partition can be updated by writing a partition image to it, as it is unused or inactive.</p>
<p>Once the download and writing is done, a reboot is triggered and the boot loader will now switch to the newly updated partition.</p>
<p>If the booting of the updated partition fails, the self update mechanism can revert back to the previous partition or boot to a rescue partition.</p>
<p><img src="leda-self-update.png" alt="Leda Self Update"></p>
<p>As updating the running operating system cannot be done at runtime, the approach requires additional disk space, a second partition and also requires the device to be rebooted for the updates to take effect.</p>
<p>In a vehicle, the self-updater cannot decide on its own when to do a reboot, as the vehicle must be in a safe condition (eg parked, state of charge etc.). Hence, the trigger for performaing the switch to another slot and a subsequent reboot is handed over to a higher level component, such as the vehicle update manager, which may in turn rely on driver feedback or other conditions.</p>
<h2 id="implementation-with-rauc-update-service">Implementation with RAUC Update Service</h2>
<p><a href="https://www.rauc.io/">RAUC</a> is a lightweight update client that runs on your embedded device and reliably controls the procedure of updating your device with a new firmware revision.</p>
<p>For general usage of the RAUC tool, please see the <a href="https://rauc.readthedocs.io/en/latest/using.html">RAUC User manual</a></p>
<h2 id="reference-configuration">Reference configuration</h2>
<p>The project contains an example reference implementation and configuration using RAUC, which allows the evaluation of the concepts, mechanisms and involved software components in an emulated, virtual environment.</p>
<p>The Leda quickstart image contains the following disk partitions:</p>
<ul>
<li>a small rescue partition</li>
<li>a full SDV installation with a container runtime, pre-loaded SDV container images and deployment specifications and additional developer tools such as nerdctl and kantui.</li>
<li>a minimal SDV installation with a container runtime, but no additional examples or developer tools. This partition is used to demonstrate the self-update functionality.</li>
<li>additional boot and data partitions for keeping system state information</li>
</ul>
<p><em>Note: All three rootfs partitions (rootfs) initially contain the same identical copies of the base operating system. Both SDV Root partitions will use the same shared data partition for the container persistent state.</em></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cb55165363d95c91e0f19399fa5b280b">4.1 - Self Update Tutorial</h1>
    
	<p>This chapter describes the steps necessary to perform a local (without cloud) self update of the operating system.</p>
<p><img src="../self-update-arch.png" alt=""></p>
<h2 id="self-update-using-rauc-update-bundles">Self-Update using RAUC Update Bundles</h2>
<ul>
<li>
<p>On host: Update bundle <code>sdv-rauc-bundle-qemux86-64.raucb</code> is in current folder</p>
<p><em>Note: In the development environment, the update RAUC Update Bundle is located in the BitBake machine-specific output folder, for example <code>tmp/deploy/images/qemux86-64</code></em></p>
</li>
<li>
<p>On host: Start a dummy web server for serving the update file</p>
<pre><code>python3 -m http.server --bind 192.168.7.1
</code></pre>
</li>
<li>
<p>On host: open two new terminals - one for monitoring and one for triggering the self-update</p>
<ul>
<li>
<p>Terminal 1: To view the progress, watch the MQTT topics <code>selfupdate/desiredstate</code> and <code>selfupdate/desiredstatefeedback</code>:</p>
<pre><code>mosquitto_sub -h 192.168.7.2 -p 31883 -t &quot;selfupdate/#&quot;
</code></pre>
</li>
<li>
<p>Terminal 2: Trigger the actual self update process by publishing an MQTT message to <code>selfupdate/desiredstate</code>:</p>
<pre><code>mosquitto_pub -h 192.168.7.2 -p 31883 -t &quot;selfupdate/desiredstate&quot; -f start-update-example.yaml
</code></pre>
</li>
</ul>
</li>
<li>
<p>Switch to a terminal in the guest</p>
</li>
<li>
<p>On guest: After the self update process completed, check the status:</p>
<pre><code>rauc status --detailed
</code></pre>
</li>
</ul>
<h2 id="self-update-trigger-message">Self-Update Trigger Message</h2>
<p><code>start-update-example.yaml</code> file:</p>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;sdv.eclipse.org/v1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SelfUpdateBundle</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">self-update-bundle-example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bundleName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">swdv-qemux86-64-build42</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bundleVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1beta3 </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bundleDownloadUrl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.7.1:8000/sdv-rauc-bundle-qemux86-64.raucb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bundleTarget</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>



</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fdfe9e0ec285454b4f0c580b5cd46e62">4.2 - RAUC Integration</h1>
    
	<p>Leda integrates <a href="https://rauc.io/">RAUC</a> as a reference implementation and example configuration. It allows the evaluation of the concepts, mechanisms and involved software components in an emulated, virtual environment or on physical devices.</p>
<h2 id="checking-the-rauc-status">Checking the RAUC Status</h2>
<p>Get the current RAUC boot status:</p>
<pre><code>rauc status
</code></pre>
<p>Example output:</p>
<pre tabindex="0"><code>root@qemux86-64:~# rauc status
=== System Info ===
Compatible:  Eclipse Leda qemu86-64
Variant:     
Booted from: rootfs.1 (SDV_B)

=== Bootloader ===
Activated: rootfs.1 (SDV_B)

=== Slot States ===

o [rootfs.1] (/dev/sda5, ext4, inactive)
        bootname: SDV_B
        mounted: /
        boot status: good

x [rootfs.0] (/dev/sda4, ext4, booted)
        bootname: SDV_A
        boot status: good
</code></pre><h2 id="forcing-to-boot-the-other-slot">Forcing to boot the other slot</h2>
<p>To manually force the device to boot into another slot, mark the current booted slot as <em>bad</em>, mark the other partitions as <em>active</em> and perform a reboot:</p>
<pre tabindex="0"><code>rauc status mark-bad booted
rauc status mark-active other
reboot now
</code></pre><h2 id="testing-the-rescue-system">Testing the rescue system</h2>
<p>By marking both root slots as bad, the bootloader is supposed to boot the rescue system:</p>
<pre tabindex="0"><code>rauc status mark-bad rootfs.0
rauc status mark-bad rootfs.1
reboot now
</code></pre><p>Example output of rauc:</p>
<pre tabindex="0"><code>o [rootfs.1] (/dev/sda5, ext4, inactive)
        bootname: B
        boot status: bad

o [rootfs.0] (/dev/sda4, ext4, booted)
        bootname: A
        mounted: /
        boot status: bad
</code></pre><h2 id="customizations">Customizations</h2>
<p>The configurations can be customized by applying or patching the following files:</p>
<ul>
<li>RAUC Configuration file: <code>meta-leda/recipes-bsp/rauc/files/qemux86-64/system.conf</code></li>
<li>Bootloader Configuration file: <code>meta-leda/recipes-bsp/grub/files/grub.cfg</code></li>
<li>The physical disk partition configuration: <code>meta-leda/recipes-sdv/wic/qemux86-grub-efi.wks</code></li>
</ul>
<h2 id="rauc-system-configuration">RAUC System Configuration</h2>
<p>The <a href="https://rauc.readthedocs.io/en/latest/integration.html#rauc-system-configuration">RAUC System Configuration </a> is the central configuration of the RAUC Update system.</p>
<p>Example:</p>
<pre tabindex="0"><code>[system]
compatible=Eclipse Leda qemu86-64
bootloader=grub
grubenv=/grubenv/grubenv
statusfile=/data/rauc.status

[keyring]
path=ca.cert.pem

[slot.efi.0]
device=/dev/sda
type=boot-gpt-switch
region-start=4M
region-size=100M

[slot.rescue.0]
device=/dev/sda3
type=ext4
readonly=true

[slot.rootfs.0]
device=/dev/sda4
type=ext4
bootname=SDV_A

[slot.rootfs.1]
device=/dev/sda5
type=ext4
bootname=SDV_B
</code></pre><h2 id="grub-bootloader-configuration">GRUB Bootloader Configuration</h2>
<p>The GRUB bootloader has a configuration file which describes which partitions are bootable, which partition they are located at and a reference to RAUC&rsquo;s slot name.</p>
<p>The configuration also contains <strong>RAUC specific logic and variables required for a proper integration</strong>. Please see the full <code>grub.cfg</code> in the source repository and <a href="https://rauc.readthedocs.io/en/latest/integration.html#grub">RAUC Documentation - Integration - GRUB</a> for details.</p>
<p>Excerpt:</p>
<pre tabindex="0"><code>...

menuentry &#34;SDV Slot A (OK=$SDV_A_OK TRY=$SDV_A_TRY)&#34; {
    linux (hd0,4)/boot/bzImage root=/dev/vda4 $CMDLINE rauc.slot=SDV_A
}

menuentry &#34;SDV Slot B (OK=$SDV_B_OK TRY=$SDV_B_TRY)&#34; {
    linux (hd0,5)/boot/bzImage root=/dev/vda5 $CMDLINE rauc.slot=SDV_B
}
</code></pre><h2 id="disk-partitioning-with-openembedded-image-creator-wic">Disk Partitioning with OpenEmbedded Image Creator (WIC)</h2>
<p>The <a href="https://www.yoctoproject.org/docs/current/dev-manual/dev-manual.html#creating-partitioned-images-using-wic">OpenEmbedded Image Creator</a> is used in BitBake to actually create full disk images with multiple partitions.</p>
<p>These disk images are machine specific and the structure of the partitions are configured in <a href="https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-kickstart">OpenEmbedded Kickstart</a> files (<code>*.wks</code>).</p>
<h3 id="excerpt-qemux86-grub-efiwks">Excerpt <code>qemux86-grub-efi.wks</code></h3>
<p><em>Note: The excerpt is exemplary, please see the sources for a full representation and documentation.</em></p>
<pre tabindex="0"><code>bootloader --ptable gpt

part --fixed-size 50M --source rawcopy --sourceparams=&#34;file=efi-boot.vfat&#34; --fstype=vfat --label boot --active

part --fixed-size 10M --source rawcopy --sourceparams=&#34;file=grubenv.vfat&#34; --fstype=vfat --label grubenv

part /rescue --source rootfs --fstype=ext4 --label rescue

part / --source rootfs --fstype=ext4 --label root_a

part / --source rootfs --fstype=ext4 --label root_b

part /data --fixed-size 4G --fstype=ext4 --label data
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-330a7bfc4527a76419775bc5ddc1265b">4.3 - API Reference</h1>
    
	<p>The self update agent (SUA) is a component responsible for the OS Update process.  SUA is communicating on MQTT interface via usage of defined messages. Internally, SUA uses <a href="https://rauc.io/">RAUC</a> to perform the update.</p>
<p>Following sequence diagram shows the happy path example of communication between components.</p>
<h2 id="process-overview">Process Overview</h2>
<div class="mermaid">sequenceDiagram
    participant m as MQTT Broker 
    participant s as SUA
    participant r as RAUC
    s -->> m: connect
    loop Wait for message: selfupdate/desiredstate
    Note left of s: Initial start
    s ->> m: selfupdate/currentstate
    Note left of s: Trigger for OTA
    m ->> s: selfupdate/desiredstate
    s ->> m: selfupdate/desiredstatefeedback: downloading 0%
    s ->> s: download bundle
    s ->> m: selfupdate/desiredstatefeedback: downloading 51%
    s ->> r: install
    s ->> m: selfupdate/desiredstatefeedback: installing 0%
    r ->> r: install
    r ->> s: share progress: e.g. 51%
    s ->> m: selfupdate/desiredstatefeedback: installing 51%
    r ->> s: installation ready
    s ->> m: selfupdate/desiredstatefeedback: installed 
    s ->> m: selfupdate/desiredstatefeedback: idle 
    end
  </div>
  
  <h2 id="mqtt-message-definitions">MQTT Message Definitions</h2>
<p>MQTT messages are specified as follows:</p>
<h3 id="selfupdatedesiredstate">selfupdate/desiredstate</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/desiredstate</td>
<td>IN</td>
<td>This message triggers the update process. The payload shall contain all data necessary to obtain the update bundle and to install it.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleName: swdv-arm64-build42
  bundleVersion: v1beta3
  bundleDownloadUrl: https://example.com/repository/base/
  bundleTarget: base
</code></pre><h3 id="selfupdatecurrentstate">selfupdate/currentstate</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/currentstate</td>
<td>OUT</td>
<td>This message is being sent once, on SUA start. It contains information about currently installed OS version.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleVersion: v1beta3
</code></pre><h3 id="selfupdatedesiredstatefeedback">selfupdate/desiredstatefeedback</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/desiredstatefeedback</td>
<td>OUT</td>
<td>This message is being sent by SUA to share current progress of triggered update process. This is the <em>OUT</em> counterpart of <em>selfupdate/desiredstate</em> input message.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleName: swdv-arm64-build42
  bundleVersion: v1beta3
  bundleDownloadUrl: https://example.com/repository/base/
  bundleTarget: base
state:
  name: &#34;idle|installing|etc.&#34;
  progress: 0|51|99|etc., 
  techCode: 0|1|5|etc.,  
  message: &#34;Cannot download from url|Bundle already installed|etc.&#34; 
</code></pre><h4 id="state-enum">state enum</h4>
<p>State name field can have one of following values:</p>
<table>
<thead>
<tr>
<th>State</th>
<th>Description</th>
<th>Additional payload data</th>
</tr>
</thead>
<tbody>
<tr>
<td>uninitialized</td>
<td>When the SUA is not configured yet</td>
<td>-</td>
</tr>
<tr>
<td>idle</td>
<td>Configured and waiting for messages</td>
<td>-</td>
</tr>
<tr>
<td>downloading</td>
<td>Downloading the bundle file</td>
<td>progress</td>
</tr>
<tr>
<td>installing</td>
<td>Performing installation</td>
<td>progress</td>
</tr>
<tr>
<td>installed</td>
<td>Installation process was successful, new OS version is installed on inactive disc Slot. <br><strong>Important: to finish the OTA process, reboot is required, and it shall be performed by another component, such as the Vehicle Update Manager.</strong></td>
<td>-</td>
</tr>
<tr>
<td>failed</td>
<td>Error occurred</td>
<td>techCode</td>
</tr>
</tbody>
</table>
<h4 id="techcode-values">techCode values</h4>
<p>techCode field is providing additional details to the state value. It is especially useful for the <strong>failed</strong> state, as it can specify the reason of failure.</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>OK, no error</td>
</tr>
<tr>
<td>1001</td>
<td>Download failed</td>
</tr>
<tr>
<td>2001</td>
<td>Invalid Bundle</td>
</tr>
<tr>
<td>3001</td>
<td>Installation failed</td>
</tr>
<tr>
<td>4001</td>
<td>Update rejected, bundle version same as current OS version</td>
</tr>
<tr>
<td>5001</td>
<td>Unknown Error</td>
</tr>
</tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      


<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/eclipse-leda" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
        
          <p class="mt-2"><a href="/leda/docs/about/">About Leda</a></p>
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org">
        Eclipse Foundation
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/privacy.php">
        Privacy Policy
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/termsofuse.php">
        Terms of Use
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/copyright.php">
        Copyright Agent
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/">
        Legal
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/epl-2.0/">
        License
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/security/">
        Report a Vulnerability
      </a>
    </small>
  </li>
  
</ul>

        
        
      </div>
  </div>
</footer>


    </div>
    
  <script src="/leda/js/main.min.b671a59c5b86cdbfc17e4c1c2db8c832613727a3e1bf00c27ddab56b30360c8a.js" integrity="sha256-tnGlnFuGzb/BfkwcLbjIMmE3J6PhvwDCfdq1azA2DIo=" crossorigin="anonymous"></script>
<script src='/leda/js/tabpane-persist.js'></script>

  </body>
</html>
