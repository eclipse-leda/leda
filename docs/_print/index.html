<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://eclipse-leda.github.io/leda/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://eclipse-leda.github.io/leda/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/leda/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/leda/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/leda/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/leda/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/leda/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/leda/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/leda/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/leda/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/leda/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | Eclipse Leda Documentation</title>
<meta name="description" content="">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://eclipse-leda.github.io/leda/docs/" />
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content=""><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/leda/scss/main.min.6831d6bc2f61e5736888c6b37efd4e7410cd90d4e5e9859c154e541ea4e96886.css" as="style">
<link href="/leda/scss/main.min.6831d6bc2f61e5736888c6b37efd4e7410cd90d4e5e9859c154e541ea4e96886.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/leda/"><span class="navbar-brand__logo navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="30 270 300 300" id="svg2"><defs id="defs6"><clipPath id="clipPath24" clipPathUnits="userSpaceOnUse"><path id="path22" d="m5116.71 2737.03v81.36c0 51.02 13.61 71.72 55.28 74.55h288.29v-182.27c-4.26-34.29-16.73-48.19-55.28-48.19h-226.21c-47.05.0-62.08 20.69-62.08 74.55zm-139.46 17.86c0-128.41 84.19-198.71 222.24-198.71h42.8c107.43.0 184.82 2.84 217.99 84.19v-84.19h137.76v534.05c0 128.13-97.8 198.71-235.85 198.71H5051.8v-106.3h360c36 0 48.48-23.52 48.48-60.66v-122.74h-260.79c-138.05.0-222.24-70.59-222.24-198.71zm-332.5-44.22c-3.97-34.29-16.44-48.19-55-48.19h-225.07c-46.76.0-62.08 20.69-62.08 74.55v371.06c0 51.03 13.9 71.71 55.28 74.55h231.87c41.39-2.84 55-23.52 55-74.55zm139.46 854.08h-138.04v-360c-33.17 81.36-110.28 84.19-217.99 84.19h-42.8c-137.77.0-221.96-70.58-221.96-198.71v-335.34c0-128.41 84.19-198.71 221.96-198.71h42.8c107.71.0 184.82 2.84 217.99 84.19v-84.19h138.04zm-925.8-587.62h-362.83v144.85c0 28.91 12.47 60.66 48.2 60.66h266.45c35.71.0 48.18-31.75 48.18-60.66zm139.47-106.3v219.4c0 128.13-98.08 198.71-236.13 198.71h-169.51c-138.04.0-235.84-70.58-235.84-198.71v-335.34c0-128.41 97.8-198.71 235.84-198.71h405.64v106.3h-454.1c-35.73.0-48.2 23.54-48.2 60.66v147.69zM2642.92 2556.18h630.71v117.36h-483.02v794.55h-147.69z"/></clipPath><linearGradient id="linearGradient34" spreadMethod="pad" gradientTransform="matrix(2955.12,0,0,-2955.12,2642.92,3060.47)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop26" offset="0" style="stop-opacity:1;stop-color:#77add1"/><stop id="stop28" offset=".189014" style="stop-opacity:1;stop-color:#64c6ee"/><stop id="stop30" offset=".994475" style="stop-opacity:1;stop-color:#7b3199"/><stop id="stop32" offset="1" style="stop-opacity:1;stop-color:#7b3199"/></linearGradient><linearGradient id="linearGradient44" spreadMethod="pad" gradientTransform="matrix(1875.15,0,0,-1875.15,364.686,2981.28)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop38" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop40" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop42" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient><clipPath id="clipPath54" clipPathUnits="userSpaceOnUse"><path id="path52" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31z"/></clipPath><linearGradient id="linearGradient70" spreadMethod="pad" gradientTransform="matrix(1417.96,0,0,-1417.96,477.178,2901.88)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop56" offset="0" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop58" offset=".11811164" style="stop-opacity:1;stop-color:#bce263"/><stop id="stop60" offset=".509456" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop62" offset=".76356415" style="stop-opacity:1;stop-color:#7ab43c"/><stop id="stop64" offset=".994475" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop66" offset=".99510668" style="stop-opacity:1;stop-color:#4e9133"/><stop id="stop68" offset="1" style="stop-opacity:1;stop-color:#4e9133"/></linearGradient><linearGradient id="linearGradient80" spreadMethod="pad" gradientTransform="matrix(942.78,0,0,-942.78,720.659,3019.8)" gradientUnits="userSpaceOnUse" y2="0" x2="1" y1="0" x1="0"><stop id="stop74" offset="0" style="stop-opacity:1;stop-color:#7cd3c9"/><stop id="stop76" offset=".994475" style="stop-opacity:1;stop-color:#912d99"/><stop id="stop78" offset="1" style="stop-opacity:1;stop-color:#912d99"/></linearGradient></defs><g transform="matrix(1.3333333,0,0,-1.3333333,0,795.04)" id="g10"><g transform="scale(0.1)" id="g12"><path id="path46" style="fill:url(#linearGradient44);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m462.512 2989.03c1.133-223.65 47.902-452.13 142.867-685.13 24.66-60.94 67.465-109.13 120.187-139.47 52.727-30.61 115.657-43.93 180.852-35.14 236.122 32.03 453.262 104.03 650.552 218.55 193.89 112.53 368.79 266.17 523.27 463.18 41.11 52.15 61.8 113.67 61.8 174.9.28 61.51-20.13 123.02-60.95 175.18-145.7 186.8-317.19 337.89-515.62 450.99-194.74 110.83-415.84 185.1-665.005 220.82-65.481 9.36-128.692-3.4-181.699-33.74C665.758 3768.85 622.672 3720.94 597.441 3660c-90.14-219.4-136.062-443.06-134.929-670.97zm51.875-721.98c-99.5 244.06-148.535 484.73-149.668 721.42-1.418 241.23 47.054 477.63 142.297 708.66 33.73 81.92 91.843 146.27 163.273 187.08 71.719 40.82 156.473 58.11 244.066 45.64 261.355-37.13 494.075-115.65 699.595-232.72 209.76-119.34 390.61-278.65 544.25-475.66 54.71-70.01 81.92-152.78 81.63-235.55.0-83.06-27.49-165.83-82.2-235.56-162.42-206.65-346.68-368.5-551.62-487.27-208.35-121.05-437.67-197.02-686.549-230.75-87.313-11.9-171.785 5.95-242.934 47.05-71.433 41.39-128.976 106.02-162.14 187.66v0"/><g id="g48"><g clip-path="url(#clipPath54)" id="g50"><path id="path72" style="fill:url(#linearGradient70);fill-opacity:1;fill-rule:nonzero;stroke:none" d="m760.719 2701.88c88.719-132.65 206.929-250.3 356.031-352.34 37.13-25.23 79.65-36.85 121.32-34.58 41.39 1.98 82.49 17.85 116.79 46.77 130.11 110.26 233.01 236.97 307.27 381.26 73.14 142.01 118.49 300.76 134.36 477.63 3.97 43.66-7.65 85.61-30.89 120.2-23.81 35.43-59.53 63.49-102.9 77.95-160.16 54.42-320.88 77.38-482.74 68.03-162.43-9.35-326.269-51.31-492.659-127.28-40.821-18.7-72.285-48.75-91.281-85.04-18.704-36.28-25.508-78.52-17.29-121.89 31.75-165.26 91.848-316.06 181.989-450.71zm300.751-433.41c-159.306 109.13-286.298 235.84-382.111 378.99-97.793 145.99-162.992 308.69-197.004 486.71-12.472 65.48-1.984 130.11 26.926 185.39 28.918 55.27 76.25 101.19 137.481 128.97 177.734 81.36 353.478 126.14 527.818 136.35 174.61 9.92 347.52-14.74 519.59-73.14 64.06-21.82 117.07-63.49 152.78-116.5 35.15-52.73 53.01-116.79 47.06-183.4-17.3-189.92-66.05-360.85-144.85-513.64-79.94-155.91-191.06-292.82-331.09-411.31-51.02-43.08-112.54-66.61-175.18-69.73-62.65-3.4-126.14 13.61-181.42 51.31v0"/></g></g><path id="path82" style="fill:url(#linearGradient80);fill-opacity:1;fill-rule:evenodd;stroke:none" d="m935.898 3147.21c-54.71-85.89-93.543-185.38-115.085-298.77-4.821-24.94-1.418-49.33 9.07-69.74 10.207-20.69 27.496-37.98 49.605-48.75 97.508-46.78 197.292-73.42 300.192-78.81 101.19-5.1 205.51 9.92 312.94 46.78 23.81 8.21 42.81 23.53 55.56 42.8 12.48 19.56 18.71 43.37 16.44 68.88-9.07 108.28-36.57 208.92-83.9 301.61-46.49 91.28-111.97 175.18-197.58 251.15-18.71 16.44-41.1 25.51-63.78 26.93-22.67 1.13-45.92-5.11-66.33-19.28-88.72-61.51-161.292-135.78-217.132-222.8zM724.434 2866.87c24.093 125.28 67.461 236.12 128.976 332.78 63.211 98.93 144.563 182.27 243.5 250.87 38.83 27.21 83.9 39.11 128.12 36.56 44.22-2.55 87.31-19.84 123.03-51.59 95.24-84.47 168.37-178.01 220.25-279.78 53-104.31 84.19-217.14 94.39-337.89 3.97-47.61-8.22-92.98-32.6-130.39-24.09-37.42-60.66-66.9-105.45-82.21-119.34-41.1-236.12-57.83-349.79-51.87-115.94 6.24-228.473 36-337.325 88.44-42.805 20.41-75.398 53.29-95.242 92.98-19.848 39.68-26.648 85.6-17.859 132.1v0"/></g></g></svg></span><span class="navbar-brand__name">Eclipse Leda Documentation</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/eclipse-leda" target="_blank" rel="noopener"><span>GitHub</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/leda/offline-search-index.d04445b168c2b3d97bc38275adf81a2c.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>

  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/leda/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-c43b6569b496f1a6d7d9012ee3bc204f">About Leda</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-62f17d5d56652ecfd6e840daca9a1946">Features</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-f80a9fd12bf730f7bfa227ef3587f18f">Goals</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-5b8cf903bf49e5cac8004f4b8b1742a7">Roadmap</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-23c7f5c8a374f51bc942b91cd93c903c">Architecture</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-a7d93f0de2ee473f42138959371de2a6">Getting Started</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-1824dab7ca07fa41d55e9aa4fbba8522">Download latest release</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2.2: <a href="#pg-e38cb2d9a2a02e8c844dee80c321dfc6">Running on QEMU</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.2.1: <a href="#pg-150b34f0644b4aaccf60977ee15c9b83">CAN Bus</a></li>


    
  
    
    
	
<li>2.2.2: <a href="#pg-901f785cd6428989692f77364554603a">Transferring Files</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2.3: <a href="#pg-e3267d6dbf90873c340d40fb033d58b2">Running on Raspberry Pi</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2.4: <a href="#pg-09e9389bc1ee795bba0706ccef486884">Utilities</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2.5: <a href="#pg-2f6c44ce9348bf082b39dc70ae1a16d6">Cheatsheet</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-5803ac6efc38fc60ffeb9995f4fd6731">Device Provisioning</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-57ce4bccb0846f692ca5d3289bd50697">Manual Provisioning</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-6a8972aed290b5361baddab9db342178">Provisioning with sdv-provision</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-b841cdcaabc5e1bd7476de818736b5bd">Vehicle Update Manager</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.1: <a href="#pg-42e18573332f97451f15ebcfa61573ab">Configuration</a></li>


    
  
    
    
	
<li>3.3.2: <a href="#pg-a9d83955f4af71a310e5e508cd17161e">Message Flow</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.4: <a href="#pg-679c6c584dc366c660841bdd65d2af73">Self Updates</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.4.1: <a href="#pg-cb55165363d95c91e0f19399fa5b280b">Self Update Tutorial</a></li>


    
  
    
    
	
<li>3.4.2: <a href="#pg-fdfe9e0ec285454b4f0c580b5cd46e62">RAUC Integration</a></li>


    
  
    
    
	
<li>3.4.3: <a href="#pg-330a7bfc4527a76419775bc5ddc1265b">API Reference</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>3.5: <a href="#pg-15f7b853b9c959b01ccff386532cb867">Container Management</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-3f62c837f7dcb92aa6d45e0922ff9bb3">Vehicle Applications</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-10a0e990614b64cb6bbaff75a319ebb7">Seat Adjuster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4.2: <a href="#pg-5505f58168fbe80d37b842b17c307c91">Dog Mode</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4.3: <a href="#pg-3883f410544279ff57519024d0f51858">Kuksa Databroker</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4.4: <a href="#pg-7f8e31fb834452efdebda21d1bf86969">Velocitas VApps</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4.5: <a href="#pg-03ddd8c0f79b13ee47ac2332bd2c2a23">Cloud2Device Messages</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-398dfd1255dbe9b0d599725455290ea5">Incubator</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-6b4a440823c85f6076c29cce9db342b9">Cloud Connector</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5.2: <a href="#pg-fc286619fc6255e040c8b84e5617d350">Self Update Agent</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5.3: <a href="#pg-ba7b0fe252eaa23930a5b08ea12893eb">Vehicle Update Manager</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-529a2058d55821d1c7fd93c5ece87d4c">Building Leda</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-5a114e9c0d2f593adb6abac02f868f4c">Concepts</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-83c252b9f9f1de95e6f3ad59a0779c80">Metalayer</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-6bebc82bbfd98602300c719ed32319de">Setup development environment</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.3.1: <a href="#pg-f489e253846ca9247a8d639e81213fab">Codespaces</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.3.1.1: <a href="#pg-71f44dd882af01efbed1f4ad8361d98b">Advanced topics</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.3.2: <a href="#pg-c93bbe2b4afa4f696fe56387e16376bc">GitHub Runner</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6.3.3: <a href="#pg-dd5aea642d95644a121fa3b9232f771f">VSCode DevContainer</a></li>


    
  
    
    
	
<li>6.3.4: <a href="#pg-a56f201c9d821bac8e46a01e6750e56c">Building with kas/manually</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.4: <a href="#pg-e9d306dcf183db3f873e59965d0cae97">Run the build</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-c18e94c2f6e61c26c3af49dce54f0909">Automated Tests</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.5.1: <a href="#pg-8fd1dfda73f2cd3ab1ec676ecd359ca5">Robot Keywords</a></li>


    
  
    
    
	
<li>6.5.2: <a href="#pg-54e9dcaf283ef882361a51e9acfc06d5">Rust Tests</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.6: <a href="#pg-40e3f4818f73b84ce32042db1961675c">GitHub Workflow</a></li>


    
  
    
    
	
<li>6.7: <a href="#pg-62352f3530820244cfc19d6fdad57df1">Runqemu</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6.8: <a href="#pg-1c63e657519124a213cf5b9778390873">Miscellaneous</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.8.1: <a href="#pg-685226a9e960be283b847d67e85319af">Resource Consumptions</a></li>


    
  
    
    
	
<li>6.8.2: <a href="#pg-1e40b1f7122c24679a439cddb45a2953">Partition Layout</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>6.9: <a href="#pg-bdf9cb83992bb147748b5ca9a98cda7a">Releasing</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.9.1: <a href="#pg-36dea19e60b747437042ee148647e878">Validating</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.10: <a href="#pg-c94e454d5004f1527a7e3bb4f39a40e3">Developing and Maintaining Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.10.1: <a href="#pg-d807daac010fe21775fe6dc4f7bef15d">Rust Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.10.1.1: <a href="#pg-a15bf08ceb9050ab919c4dd1e39f4581">Communicating with Кanto-CM via gRPC</a></li>


    
  
    
    
	
<li>6.10.1.2: <a href="#pg-4ceae03484d6716691789648aa48571f">Kanto Auto deployer</a></li>


    
  
    
    
	
<li>6.10.1.3: <a href="#pg-1a1d75c926eacba3c473eb373af6186f">Kantui</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.10.2: <a href="#pg-4f521ffe9ea62a6a0abf7d17bb18e912">Shell Utils</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.10.2.1: <a href="#pg-6db933c8beae49618c83597c4bad0cde">sdv-health</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-86721597a78c875c0c696bd18f935eb3">Customizing</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-c753192d51f1964217336da765a28ba7">Custom Distros</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>7.2: <a href="#pg-20bb2af83c47c818220bae4f2b8b24f7">Deploying Containers</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>7.3: <a href="#pg-b438fd7e15c2574be03cee1dc972c1d6">Wifi Configuration</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.3.1: <a href="#pg-572603d812bc31861223167334ab4429">Notes on using iwd/iwctl</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7.4: <a href="#pg-205745980ea22e98566bc8629ffffc7a">FAQ</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-af94d3dc4d5e71fd2c9d92bcafa3b325">Project Information</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-e1426bce55eda42a39b0db25e619c6e3">Community</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>8.2: <a href="#pg-edbc3d7c3b14d2db3ea68d37f7851e4b">Dependencies</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-3804c959464b4f1164e582f67ae410d0">Contribution Guidelines</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-ecbb8edc896b280ddac3a1b67ddd7ef1">Project Logo</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>8.5: <a href="#pg-e0bf5ae54c0ca313e19d6dd625a83640">Privacy Information</a></li>


    
  
    
    
	
<li>8.6: <a href="#pg-ec74413c19c356efd4199631c80850ae">Security Policy</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-5b9855a34132ffcc60b905616e0cf498"></a></li>


    
  

    </ul>


<div class="content">
      <p><img src="/leda/assets/eclipse-leda.png" alt="Eclipse Leda"></p>
<p>The Eclipse Leda project provides system image &ldquo;recipes&rdquo; to deliver a functional and always-available Linux-based image/distribution in the context of SDV (Software Defined Vehicle), by pulling together individual contributor pieces from <a href="https://sdv.eclipse.org/">Eclipse SDV</a> and the larger OSS community.</p>
<p>The quickstart images help to learn how the SDV development, test and deployment lifecycle works from an E2E perspective, including the deployment of applications into the container runtimes on constrained embedded devices.</p>
<p>The ready images are also useful for quickly setting up showcases with virtual or real hardware devices.</p>
<p>Eclipse Leda provides a Poky-based reference build pipeline and an OpenEmbedded Metalayer <a href="https://github.com/eclipse-leda/meta-leda">meta-leda</a> for integration into existing Yocto-based projects.</p>
<h2 id="usage">Usage</h2>
  <ol>
<li>Download <a href="/leda/docs/general-usage/download-releases/">latest Eclipse Leda release</a></li>
<li>Run Eclipse Leda
<ul>
<li>on <a href="/leda/docs/general-usage/running-qemu/">emulated Qemu devices</a> or</li>
<li>on <a href="/leda/docs/general-usage/raspberry-pi/">Raspberry Pi 4</a></li>
</ul>
</li>
<li>Configure device, e.g. <a href="/leda/docs/device-provisioning/">provision the device</a></li>
<li>Explore the <a href="/leda/docs/build/misc/tools/">device tools</a></li>
<li>Develop your first Vehicle App using <a href="https://github.com/eclipse-velocitas/vehicle-app-python-template">Eclipse Velocitas template</a></li>
<li><a href="/leda/docs/app-deployment/">Deploy a Vehicle App to the device</a></li>
</ol>
<p>Supported Machines / Build Configurations</p>
<ul>
<li>Emulated Qemu: x86-64, ARM64, ARM</li>
<li>Raspberry Pi 4</li>
</ul>
<h2 id="introduction-video">Introduction Video</h2>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/91hNeQ3kf0w" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="Eclipse Leda - Build your ideas in the playground and make it automotive ready!"></iframe>
</div>

<h2 id="components-overview">Components Overview</h2>
<p><img src="/leda/assets/eclipse-leda-arch-overview.png" alt="Eclipse Leda Component Overview"></p>
<h2 id="features">Features</h2>
<ul>
<li>Publish/Subscribe infrastructure for <strong>local messaging and cloud connectivity</strong></li>
<li>Lightweight <strong>container runtime</strong></li>
<li><strong>Vehicle Update Manager</strong> to orchestrate deployments of Vehicle Applications over the air (SOTA)</li>
<li><strong>Self Update Agent</strong> for firmware-over-the-air (FOTA) updates</li>
<li><strong>Example Vehicle Seat Service</strong> implementation</li>
<li><strong>Metrics and logs collector</strong> for Vehicle Apps</li>
</ul>
<p>See <a href="/leda/docs/about/features/">About - Features</a> for more details about current implementation and <a href="/leda/docs/about/roadmap/">About - Roadmap</a> for our future work.</p>
<h2 id="license-and-copyright">License and Copyright</h2>
<p>This program and the accompanying materials are made available under the
terms of the Apache License 2.0 which is available at
<a href="https://www.apache.org/licenses/LICENSE-2.0">https://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>For details, please see our license <a href="https://github.com/eclipse-leda/leda/blob/main/NOTICE.md">NOTICE</a></p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c43b6569b496f1a6d7d9012ee3bc204f">1 - About Leda</h1>
    
	<p>The Eclipse Leda project will provide system image “recipes” to deliver a functional Linux-based image/distribution in the context of SDV (Software Defined Vehicle), by pulling together individual contributons from the SDV and the larger OSS community.</p>
<p>The Eclipse Leda distribution will work with build scripts, package definitions, image build pipelines, etc, with the goal to pull SDV projects and dependecies from the larger OSS community into a working Linux system. Such system images (or other useful forms of delivery, as determined by the project) will be made available for consumption for anyone who is interested in working with the SDV tech stack. These deliveries take the form of container (base) images, installable/flashable image files, etc (again to be evolved by the project team according to community needs). Also in scope is concise and useful documentation for consumers of the project&rsquo;s deliverables, plus a method of delivering that documentation.</p>
<p>In the context described above - the ambition of SDV to build a technology ecosystem for software-defined vehicle concern - a prime challenge will be the combination of these initially diverse components into a coherent and useful whole: all the software components in the world will not have the impact needed to transform the automotive industry unless we can make them play together coherently an form a functional portfolio. As a first step towards that goal, this proposal (Eclipse Leda) is for a &ldquo;SDV distribution&rdquo; project that pulls together individual contributor pieces from SDV and the larger OSS community, to deliver a functional and always-available Linux-based image/distribution with two primary goals:</p>
<ul>
<li>
<p>be the crystalization point for functionally integrating diverse SDV-scope projects into a working whole</p>
</li>
<li>
<p>deliver a continually available, always working starting image for developers interested in getting going with the SDV tech stack</p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62f17d5d56652ecfd6e840daca9a1946">1.1 - Features</h1>
    
	<ul>
<li><strong>Publish/Subscribe messaging infrastructure for cloud connectivity</strong> by <a href="https://github.com/eclipse-kanto/">Eclipse Kanto</a>
<ul>
<li>local messaging for applications and SDV system components via an MQTT message broker</li>
<li>connection to a backend messaging hub, such as Azure IoT Hub or the IoT Suite</li>
<li>device identification and authentication for cloud connectivity by using TLS device certificates</li>
</ul>
</li>
<li><strong>Container runtime</strong>
<ul>
<li>An OCI-compliant container orchestration for vehicle applications and services by <a href="https://github.com/eclipse-kanto/">Eclipse Kanto</a></li>
<li><a href="https://containerd.io/">containerd.io</a> as the default container runtime. Both layers of container runtimes can be exchanged with other implementations</li>
</ul>
</li>
<li>A <strong>Vehicle Update Manager</strong> to orchestrate deployments of Vehicle Applications, configurations and base operating system updates</li>
<li>An example Vehicle Seat Service implementation to showcase
<ul>
<li>the <a href="https://projects.eclipse.org/projects/automotive.velocitas">Eclipse Velocitas</a> programming model,</li>
<li>the <a href="https://github.com/eclipse/kuksa.val">Eclipse Kuksa.VAL</a> vehicle databroker and</li>
<li>the <a href="https://github.com/COVESA/vehicle_signal_specification">Covesa Vehicle Signal Specification</a></li>
<li>the communication with basic vehicle communication networks such as CAN-Bus (CAN Feeder)</li>
</ul>
</li>
<li>A <strong>Self Update Agent</strong> for firmware-over-the-air (FOTA) updates, using an A/B deployment strategy
<ul>
<li>Integration with <a href="https://www.rauc.io/">RAUC</a></li>
</ul>
</li>
<li>An <a href="https://github.com/open-telemetry/">OpenTelemetry collector</a> and example configurations to collect and publish logs and metrics of containerized Vehicle Applications to the cloud backend for further processing</li>
</ul>
<p>The features of the reusable build recipes implemented as an <a href="https://www.openembedded.org">OpenEmbedded</a> metalayer <code>meta-leda</code> are:</p>
<ul>
<li>Build recipes for a <a href="https://www.yoctoproject.org/">Yocto</a>-based distribution to build SDV-related software components</li>
<li>Build recipes for customizations of the target device&rsquo;s storage structure to enable A/B system updates</li>
<li>Build recipes for pre-packaging container images into the device during the manufacturing process to minimize initial online provisioning time</li>
<li>A customized minimal setup for use on constrained devices and a full setup with convenient developer tools</li>
<li>Ready images for virtual devices, for automated testing and evaluation purposes, eg QEMU ARM-64</li>
<li>Ready images for physical devices, for evaluation and demo purposes, eg Raspberry Pi 4</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f80a9fd12bf730f7bfa227ef3587f18f">1.2 - Goals</h1>
    
	<p>The project aims to provide <strong>an integration point for Open Source components for the Software Defined Vehicle</strong>. For vehicle software systems, there are a lot of requirements to consider. Some of these requirements are taken into account for Leda&rsquo;s quickstart setups, thereas some other requirements can only be met once in a production environment and by customizing the target device image.</p>
<p>The following document will list some of these requirements and give an explanation on why they are met in the Leda quickstart distribution.</p>
<h2 id="overview">Overview</h2>
<ul>
<li>Provide an example operating system and configuration for constrained in-vehicle devices</li>
<li>Integrate software-defined-vehicle Open Source components to showcase the available features and their state of maturity</li>
<li>Demonstrate the use and interaction of open protocols and specifications, such as
<ul>
<li>the specifications from the <a href="https://www.covesa.global/">The Connected Vehicle Systems Alliance (COVESA)</a></li>
<li>OpenTelemetry specs and components</li>
<li>Eclipse IoT related specifications for software rollouts and digital twin representations</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5b8cf903bf49e5cac8004f4b8b1742a7">1.3 - Roadmap</h1>
    
	<ul>
<li>Initial Open Source contribution expected by Q2 2022 (Done)</li>
<li>A first milestone build is expected end of 2022 (Done)</li>
<li>Plan for the first release cycle to be created in Q1/2023</li>
<li>Release cycles are planned every 3-6 months</li>
<li>Release planning will be conducted together with corresponding Eclipse projects</li>
</ul>
<h2 id="backlog">Backlog</h2>
<p>The Leda team maintains a backlog roadmap using GitHub projects at <a href="https://github.com/orgs/eclipse-leda/projects/1/views/1">https://github.com/orgs/eclipse-leda/projects/1/views/1</a></p>
<h2 id="future-work">Future Work</h2>
<p>The project intends to be the integration and collaboration platform for Software defined Vehicle functionality.</p>
<p>Exemplary future work:</p>
<ul>
<li>Migrate to official Eclipse Kanto releases for Cloud Connector, Container Management and Vehicle Update Manager</li>
<li>Include reference implementations from the <a href="https://projects.eclipse.org/working-group/eclipse-software-defined-vehicle">Eclipse Software Defined Vehicle working group</a> projects:
<ul>
<li>Eclipse Velocitas</li>
<li>Eclipse Kuksa</li>
<li>Eclipse SommR</li>
<li>Eclipse Chariott</li>
<li>Eclipse Backend function Bindings (BfB)</li>
</ul>
</li>
<li>Include and showcase more features regarding development, operation and monitoring of Vehicle Services and Vehicle Applications</li>
</ul>
<p>If you have feedback, please use <a href="https://github.com/eclipse-leda/">GitHub Issues</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-23c7f5c8a374f51bc942b91cd93c903c">1.4 - Architecture</h1>
    
	<p><img src="/leda/assets/leda-architecture-details.png" alt="Architecture Overview"></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a7d93f0de2ee473f42138959371de2a6">2 - Getting Started</h1>
    
	  <ol>
<li>Download <a href="/leda/docs/general-usage/download-releases/">latest Eclipse Leda release</a></li>
<li>Run Eclipse Leda
<ul>
<li>on <a href="/leda/docs/general-usage/running-qemu/">emulated Qemu devices</a> or</li>
<li>on <a href="/leda/docs/general-usage/raspberry-pi/">Raspberry Pi 4</a></li>
</ul>
</li>
<li>Configure device, e.g. <a href="/leda/docs/device-provisioning/">provision the device</a></li>
<li>Explore the <a href="/leda/docs/build/misc/tools/">device tools</a></li>
<li>Develop your first Vehicle App using <a href="https://github.com/eclipse-velocitas/vehicle-app-python-template">Eclipse Velocitas template</a></li>
<li><a href="/leda/docs/app-deployment/">Deploy a Vehicle App to the device</a></li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1824dab7ca07fa41d55e9aa4fbba8522">2.1 - Download latest release</h1>
    
	<p>Go to the <a href="https://github.com/eclipse-leda/leda-distro/releases">Eclipse Leda Releases</a> page and download the disk image for the respective machine and the respective Linux kernel:</p>
<h1 id="latest-release-artifacts">Latest Release Artifacts</h1>
<p><strong>Note: There are no official releases yet. The artifacts available on the Release page are for testing the build and release workflows and should be considered as unstable nightly builds from the main branch.</strong></p>
<table>
<thead>
<tr>
<th>Machine</th>
<th>Filename</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>QEMU x86_64</td>
<td>eclipse-leda-qemu-x86_64.tar.xz</td>
<td>For running QEMU x86 64-Bit</td>
</tr>
<tr>
<td>QEMU ARM 64</td>
<td>eclipse-leda-qemu-arm64.tar.xz</td>
<td>For running QEMU ARM 64-Bit</td>
</tr>
<tr>
<td>Raspberry Pi 4</td>
<td>eclipse-leda-raspberrypi.tar.xz</td>
<td>For running on Raspberry Pi 4 (SD-Card Image)</td>
</tr>
</tbody>
</table>
<h1 id="using-github-cli-tool">Using GitHub CLI tool</h1>
<p>To download all files of the latest release using the GitHub CLI:</p>
<ul>
<li>Install <a href="https://github.com/cli/cli">GitHub CLI</a>, e.g. for Ubuntu:</li>
</ul>
<pre tabindex="0"><code>curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
echo &#34;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main&#34; | sudo tee /etc/apt/sources.list.d/github-cli.list &gt; /dev/null
sudo apt update
sudo apt install gh
</code></pre><ul>
<li>Authenticate to GitHub:</li>
</ul>
<pre tabindex="0"><code>gh auth login
</code></pre><ul>
<li>Download Leda latest release:</li>
</ul>
<p>On Linux:</p>
<pre tabindex="0"><code>mkdir leda &amp;&amp; cd leda

gh release download \
  --pattern &#39;*.zip&#39; \
  --pattern &#39;eclipse-leda-*&#39; \
  --repo eclipse-leda/leda-distro
</code></pre><p>On Windows:</p>
<pre tabindex="0"><code>gh release download --pattern &#34;*.zip&#34; --pattern &#34;eclipse-leda-*&#34; --repo eclipse-leda/leda-distro
</code></pre><ul>
<li>Continue with <a href="/leda/docs/general-usage/running-qemu/">Running Eclipse Leda on QEMU</a> or <a href="/leda/docs/general-usage/raspberry-pi/">Running Eclipse Leda on Raspberry Pi 4</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e38cb2d9a2a02e8c844dee80c321dfc6">2.2 - Running on QEMU</h1>
    
	<p>If you want to execute the image without building first, grab the latest release or build artifacts from <a href="https://github.com/eclipse-leda/leda-distro/">https://github.com/eclipse-leda/leda-distro/</a></p>
<h2 id="recommendations">Recommendations</h2>
<ul>
<li>A <strong>Linux host</strong> with 8 vCPUs, 16GB of RAM and SSD storage is recommended</li>
<li>Your Linux user should be <strong>sudoer</strong> to allow TAP network interfaces to be set up</li>
</ul>
<h2 id="qemu-x86_64">QEMU x86_64</h2>
<ul>
<li>
<p>Install <a href="https://www.qemu.org/">Qemu</a>, e.g. for Ubuntu:</p>
<pre><code>sudo apt-get update -y
sudo apt-get install -y xz-utils qemu-system-x86-64
</code></pre>
</li>
<li>
<p>Download <a href="/leda/docs/general-usage/download-releases/">latest Eclipse Leda release</a></p>
</li>
<li>
<p>Uncompress the archive</p>
<pre><code>tar xf eclipse-leda-qemu-x86_64.tar.xz
</code></pre>
</li>
<li>
<p>Run QEMU on Linux:</p>
<pre><code>./run-leda.sh
</code></pre>
</li>
<li>
<p>Run QEMU on Windows:</p>
<pre><code>run-leda.cmd
</code></pre>
<p><img src="leda-bootsequence.png" alt="Leda boot sequence"></p>
</li>
<li>
<p>Login as <code>root</code> without password on login prompt</p>
</li>
<li>
<p>Verify and wait until container runtime is started: <code>systemctl status container-management</code></p>
</li>
<li>
<p><em>Optional:</em> Check the system health: <code>sdv-health</code></p>
<p><img src="sdv-health1.png" alt="sdv-health"></p>
<p><em>Note: The status of some containers (e.g. cloud connector) are expected to stay in <strong>FAILED</strong> status as long as the <strong>Device Provisioning</strong> steps are not completed.</em></p>
</li>
<li>
<p>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></p>
</li>
</ul>
<h2 id="qemu-arm-64-bit">QEMU ARM 64-Bit</h2>
<ul>
<li>
<p>Install <a href="https://www.qemu.org/">Qemu</a>, e.g. for ARM 64-Bit: <code>sudo apt install qemu-system-aarch64</code></p>
</li>
<li>
<p>Download <a href="/leda/docs/general-usage/download-releases/">latest Eclipse Leda release</a></p>
</li>
<li>
<p>Uncompress the archive</p>
<pre><code>tar xf eclipse-leda-qemu-arm64.tar.xz
</code></pre>
</li>
<li>
<p>Run QEMU on Linux:</p>
<pre><code>./run-leda.sh
</code></pre>
</li>
<li>
<p>Run QEMU on Windows:</p>
<pre><code>run-leda.cmd
</code></pre>
</li>
<li>
<p>Login as <code>root</code> without password on login prompt</p>
</li>
<li>
<p>Verify and wait until container runtime is started: <code>systemctl status container-management</code></p>
</li>
<li>
<p><em>Optional:</em> Check the system health: <code>sdv-health</code></p>
<p><em>Note: The status of some containers (e.g. cloud connector) are expected to stay in <strong>FAILED</strong> status as long as the <strong>Device Provisioning</strong> steps are not completed.</em></p>
</li>
<li>
<p>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-150b34f0644b4aaccf60977ee15c9b83">2.2.1 - CAN Bus</h1>
    
	<p><em>Note: The configuration mentioned in this chapter is already enabled in the <code>run-leda.sh</code> script.</em></p>
<h2 id="qemu">QEMU</h2>
<p>General documentation about using CAN-Bus in Qemu: <a href="https://www.qemu.org/docs/master/system/devices/can.html">https://www.qemu.org/docs/master/system/devices/can.html</a></p>
<h3 id="enabling-virtual-can-bus-interfaces-vcan">Enabling Virtual CAN Bus interfaces (vcan)</h3>
<p>No special parameters are necessary for qemu, as vcan is virtual:</p>
<pre tabindex="0"><code>runqemu qemux86-64 nographic slirp qemuparams=&#34;-m 2048&#34;
</code></pre><p>Bring interface up:</p>
<pre tabindex="0"><code>ip link add dev vcan0 type vcan
ip link set vcan0 up
</code></pre><h3 id="enabling-can-bus-interfaces-can">Enabling CAN Bus interfaces (can)</h3>
<h4 id="standalone-can-within-qemu">Standalone CAN within Qemu</h4>
<p>To run a standalone CAN setup, qemu must be instructed to emulate a specific CAN hardware device. We will be using the <code>kvaser_pci</code> device in this example:</p>
<pre tabindex="0"><code>runqemu qemux86-64 nographic slirp qemuparams=&#34;-m 2048 -object can-bus,id=canbus0 -device kvaser_pci,canbus=canbus0&#34;
</code></pre><p>After the image has booted, load the Linux Kernel Module <code>kvaser_pci</code> device driver and configure the CAN-Bus device (eg bitrate) before bringing the interface up:</p>
<pre tabindex="0"><code>root@qemux86-64:~# modprobe kvaser_pci

root@qemux86-64:~# dmesg | grep kvaser
[    9.565149] kvaser_pci 0000:00:04.0: initializing device 10e8:8406
[    9.569308] kvaser_pci 0000:00:04.0: reg_base=00000000d5a68095 conf_addr=000000002b3c7ef6 irq=20
[    9.596942] kvaser_pci 0000:00:04.0: xilinx version=13 number of channels=0

root@qemux86-64:~# ip link show type can
4: can0: &lt;NOARP,ECHO&gt; mtu 16 qdisc noop state DOWN mode DEFAULT group default qlen 10
    link/can
</code></pre><p>Configure the interface:</p>
<pre tabindex="0"><code>root@qemux86-64:~# ip link set can0 type can bitrate 1000000
[  165.519919] kvaser_pci 0000:00:04.0 can0: setting BTR0=0x00 BTR1=0x14

root@qemux86-64:~# ip link set can0 up
[  186.906065] IPv6: ADDRCONF(NETDEV_CHANGE): can0: link becomes ready

root@qemux86-64:~# ip link show type can
4: can0: &lt;NOARP,UP,LOWER_UP,ECHO&gt; mtu 16 qdisc pfifo_fast state UP mode DEFAULT group default qlen 10
    link/can 
</code></pre><h4 id="tunneling-a-can-interface-from-the-host">Tunneling a CAN Interface from the Host</h4>
<pre tabindex="0"><code>runqemu qemux86-64 nographic slirp qemuparams=&#34;-m 2048 -object can-bus,id=canbus0 -object can-host-socketcan,id=canhost0,if=can0,canbus=canbus0 -device kvaser_pci,canbus=canbus0&#34;
</code></pre><p>Bring interface up:</p>
<pre tabindex="0"><code>ip link add dev can0 type can
ip link set can0 type can bitrate 1000000
ip link set can0 up
ip link show type can
</code></pre><h1 id="raspberry-pi-can-hat-extensions">Raspberry Pi CAN HAT Extensions</h1>
<p>Supported boards:</p>
<ul>
<li>Boards with a Microchip MCP251x based CAN chip, such as Waveshare CAN HAT or PiCAN 2</li>
</ul>
<p>Verify driver is loaded:</p>
<pre tabindex="0"><code># dmesg | grep mcp
[    8.23543] mcp251x spi0.0 can0: MCP2515 successfully initialized
</code></pre><p>Verify SocketCAN network interface shows up:</p>
<pre tabindex="0"><code># ip link show type can
3: can0: &lt;NOARP,ECHO&gt; mtu 16 qdisc noop state DOWN mode DEFAULT roup default qlen 10
</code></pre><p>Continue with configuring the CAN chip and bring up the SocketCAN network interface:</p>
<pre tabindex="0"><code># ip link set can0 type can bitrate 1000000
# ip link set can0 up
# ip link show type can
</code></pre><h1 id="linux-kernel-modules">Linux Kernel Modules</h1>
<p>The following Linux Kernel modules are available on the quickstart images:</p>
<p><em>Note: For QEMU, only <em>kvaser_pci</em> is used</em></p>
<h2 id="leda-main-kernel">Leda main Kernel</h2>
<ul>
<li>peak_pciefd - Socket-CAN driver for PEAK PCAN PCIe/M.2 FD family cards</li>
<li>m_can - CAN bus driver for Bosch M_CAN controller</li>
<li>m_can_pci - CAN bus driver for Bosch M_CAN controller on PCI bus</li>
<li>m_can_platform - M_CAN driver for IO Mapped Bosch controllers</li>
<li>softing - Softing DPRAM CAN driver</li>
<li>cc770_platform - Socket-CAN driver for CC770 on the platform bus</li>
<li>cc770_isa - Socket-CAN driver for CC770 on the ISA bus</li>
<li>cc770 - cc770CAN netdevice driver</li>
<li>ifi_canfd - CAN bus driver for IFI CANFD controller</li>
<li>kvaser_usb - CAN driver for Kvaser CAN/USB devices</li>
<li>etas_es58x - Socket CAN driver for ETAS ES58X USB adapters</li>
<li>ucan - Driver for Theobroma Systems UCAN devices</li>
<li>peak_usb - CAN driver for PEAK-System USB adapters</li>
<li>kvaser_pciefd - CAN driver for Kvaser CAN/PCIe devices</li>
<li>kvaser_pci - Socket-CAN driver for KVASER PCAN PCI cards</li>
<li>f81601 - Fintek F81601 PCIE to 2 CANBUS adaptor driver</li>
<li>sja1000_isa - Socket-CAN driver for SJA1000 on the ISA bus</li>
<li>plx_pci - Socket-CAN driver for PLX90xx PCI-bridge cards with the SJA1000 chips</li>
<li>sja1000 - sja1000CAN netdevice driver</li>
<li>ems_pci - Socket-CAN driver for EMS CPC-PCI/PCIe/104P CAN cards</li>
<li>peak_pci - Socket-CAN driver for PEAK PCAN PCI family cards</li>
<li>sja1000_platform - Socket-CAN driver for SJA1000 on the platform bus</li>
<li>vxcan - Virtual CAN Tunnel</li>
<li>c_can_platform - Platform CAN bus driver for Bosch C_CAN controller</li>
<li>c_can - CAN bus driver for Bosch C_CAN controller</li>
<li>c_can_pci - PCI CAN bus driver for Bosch C_CAN/D_CAN controller</li>
<li>slcan - serial line CAN interface</li>
<li>can_dev - CAN device driver interface</li>
<li>vcan - virtual CAN interface</li>
<li>can-isotop - PF_CAN isotp 15765-2:2016 protocol</li>
<li>can-gw - PF_CAN netlink gateway</li>
<li>can-j1939 - PF_CAN SAE J1939</li>
<li>can-raw - PF_CAN raw protocol</li>
<li>can-bcm - PF_CAN broadcast manager protocol</li>
<li>can - Controller Area Network PF_CAN core</li>
</ul>
<h2 id="raspberry-pi">Raspberry Pi</h2>
<p>The following Linux Kernel modules are available on the quickstart image for Raspberry Pi:</p>
<ul>
<li>can - Controller Area Network PF_CAN core</li>
<li>vxcan - Virtual CAN Tunnel</li>
<li>can-dev - CAN device driver interface</li>
<li>can-bcm - PF_CAN broadcast manager protocol</li>
<li>can-gw - PF_CAN netlink gateway</li>
<li>can-raw - PF_CAN raw protocol</li>
<li>can-isotop - PF_CAN isotp 15765-2:2016 protocol</li>
<li>can-j1939 - PF_CAN SAE J1939</li>
<li>vcan - virtual CAN interface</li>
<li>slcan - serial line CAN interface</li>
<li>mcp251x - Microchip 251x/25625 CAN driver</li>
<li>mcp251xfd - Microchip 251xFD Family CAN controller driver</li>
<li>ems_usb - CAN driver for EMS Dr. Thomas Wuensche CAN/USB interfaces</li>
<li>gs_usb - Socket CAN device driver for Geschwister Schneider UG</li>
<li>peak_usb - CAN driver for PEAK-System USB adapters</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-901f785cd6428989692f77364554603a">2.2.2 - Transferring Files</h1>
    
	<h1 id="sharing-a-directory-with-the-guest">Sharing a directory with the guest</h1>
<p>When you want to copy files between the host and the guest, an easy way is to use an SFTP tunnel.
With <code>sshfs</code>, you can mount a local directory to a remote directory via SSH.</p>
<h2 id="pre-requisites">Pre-Requisites</h2>
<p>Installation of needed packages:</p>
<ul>
<li>Run <code>apt-get install sshfs</code> on your host</li>
<li>Enable <code>CORE_IMAGE_EXTRA_INSTALL += &quot; openssh-sftp-server&quot;</code> in <code>local.conf</code> of your image (e.g. in the local_conf_header section in your kas file)</li>
<li>Verify SFTP connection working with <code>sftp -P 2222 root@localhost</code></li>
</ul>
<h2 id="transfering-files-from-host-to-guest">Transfering files from host to guest</h2>
<p>When you want to copy files from the host to the guest, an easy way is to use an SFTP tunnel.
With <code>sshfs</code>, you can mount a local directory to a remote directory via SSH.</p>
<ul>
<li>Create a mount point on your host: <code>mkdir remote</code></li>
<li>Open the SSH Filesystem tunnel: <code>sshfs root@localhost:/ remote/ -p 2222</code></li>
<li>Check files: <code>ls -al remote/</code> - you should see the root filesystem of the device now</li>
<li>You can now easily copy files: <code>cp foo.txt remote/home/root/</code></li>
</ul>
<h2 id="transfering-files-from-guest-to-host">Transfering files from guest to host</h2>
<p><em>Note:</em> The reverse direction, e.g. initiating an SSH tunnel from within the device to the host, is currently not supported by the installed software on the image.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3267d6dbf90873c340d40fb033d58b2">2.3 - Running on Raspberry Pi</h1>
    
	<p>What you need:</p>
<ul>
<li>A Raspberry Pi 4B (64 Bit) with 2 GiB of RAM or more, recommended is 8 GiB</li>
<li>Network connection (Ethernet or Wifi) with transparent internet access</li>
<li>Optional keyboard and display (makes it easier to troubleshoot)</li>
</ul>
<p>Steps:</p>
<ul>
<li>
<p>Download the <a href="/leda/docs/general-usage/download-releases/">latest released SD-Card Image</a>: <code>eclipse-leda-raspberrypi.tar.xz</code></p>
</li>
<li>
<p>Uncompress the SD Card image:</p>
<pre><code>apt-get install -y xz-utils
tar xf eclipse-leda-raspberrypi.tar.xz
bzip2 -d -f sdv-image-full-raspberrypi4.wic.bz2
</code></pre>
</li>
<li>
<p>Flash the <code>sdv-image-all-raspberrypi4.wic</code> file to an SD-Card</p>
<ul>
<li>On Linux:
<ul>
<li>Install bmap tools: <code>sudo apt-get install -y bmap-tools</code></li>
<li>Insert SD Card and check which device is mounted: <code>sudo fdisk -l</code></li>
<li>Unmount the device: <code>sudo umount /dev/mmcblk[X]</code></li>
<li><code>sudo bmaptool copy --bmap sdv-image-all-raspberrypi4-64.wic.bmap sdv-image-all-raspberrypi4-64.wic.gz /dev/mmcblk[X]</code></li>
<li><em>Note:  Using <code>bmap</code> is <strong>much</strong> faster but works the same as with plain <code>dd if=&lt;wic-file&gt; of=dev/mmcblk[x]</code>.</em></li>
</ul>
</li>
<li>On Windows:
<ul>
<li><a href="https://www.raspberrypi.org/documentation/installation/installing-images/">Raspberry Pi Imager</a></li>
<li><a href="https://www.balena.io/etcher/">Balena Etcher</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><em>Optional: If you need to adapt the network configuration eg Wifi credentials, edit the configuration files on the <code>boot</code> partition.</em></p>
</li>
<li>
<p>Shutdown the Raspberry and insert the SD-Card into the Raspberry Pi SD-Card slot at the bottom</p>
</li>
<li>
<p>Power on your Raspberry to boot the image</p>
</li>
<li>
<p>Login with <code>root</code></p>
</li>
<li>
<p>Check disk space:</p>
<ul>
<li>
<p>The <code>raspberry-growdisk</code> system service will do this automatically on first boot.</p>
</li>
<li>
<p>To manually enlarge the available disk space on the SD-Card, resize the disk partition: <code>parted /dev/mmcblk0 resizepart 6 100% &amp;&amp; resize2fs /dev/mmcblk0p6</code>.</p>
<p><em>Note: Due to changes in the disk partition, the partition number (<code>6</code> in the example) may have changed.</em></p>
</li>
<li>
<p>Verify with <code>df -h</code>.</p>
</li>
</ul>
</li>
<li>
<p>Verify and wait until container runtime is started: <code>systemctl status container-management</code></p>
</li>
<li>
<p><em>Optional:</em> Check the system health: <code>sdv-health</code></p>
</li>
<li>
<p>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-09e9389bc1ee795bba0706ccef486884">2.4 - Utilities</h1>
    
	<p>The quickstart image contains the following utilities:</p>
<ul>
<li><strong>sdv-health:</strong> Show SDV software components health status</li>
<li><strong>kantui:</strong> A text user interface for kanto-cm to manage containers (start, stop, logs, redeploy all)</li>
<li><strong>sdv-device-info:</strong> Show and update device information</li>
<li><strong>sdv-motd:</strong> Message-of-the-Day shown after login prompt</li>
<li><strong>can-forward:</strong> Forwarding a CAN-bus network interface into a containerized Vehicle Application</li>
<li><strong>kanto-auto-deployer:</strong> Automatically deploys containers on boot. Runs as a systemd service, and can also be invoked by a user directly.</li>
</ul>
<p>For details, please see <a href="https://github.com/eclipse-leda/leda-utils/">leda-utils</a></p>
<h2 id="health-check">Health check</h2>
<p>The sdv-health utility displays a status overview of some important dependencies and device configurations for the SDV edge stack. The sdv health utility can be configured using the sdv.conf configuration file.</p>
<p>Usage:</p>
<pre><code># sdv-health
</code></pre>
<p>Example output:</p>
<p><img src="https://raw.githubusercontent.com/eclipse-leda/leda-utils/main/assets/sdv-health.png" alt="SDV Health Example Output"></p>
<h3 id="version-information">Version Information</h3>
<p>The Leda image version and build time will be displayed at the top in the first category:</p>
<ul>
<li>OS Release: Year and codename of the release version</li>
<li>Image Version: Name of the image and more specific version information, such as the git tag or commit id</li>
<li>Build timestamp in <code>yyyMMddHHmmss</code> notation</li>
</ul>
<h3 id="bus-networks">Bus networks</h3>
<p>If available, vehicle bus network information, such as the status of the CAN-Bus, will be displayed iin its own category. This helps to quickly identify if there problems with the hardware connectivity for automotive bus networks.</p>
<h3 id="ports">Ports</h3>
<p>The health utility checks the TCP ports of specific services. This helps to identify if these services are up and running and potentiallyconnectable via external network interfaces.</p>
<h3 id="services-and-containers">Services and Containers</h3>
<p>The services category shows the status of required and optional containers. The required containers are supposed to be up and running for the SDV.EDGE stack to be correctly up and running. If any of these core components have a failed state, the functionality is impacted.</p>
<p>The optional containers are for additional features and for example applications. These containers may not be necessary for each use case and hence will be marked as a warning if they are not up and running. The overview still helps to identify which containers are working properly.</p>
<h3 id="errors-warnings-failed-states">Errors, Warnings, Failed states</h3>
<p>When there are errors or warnings related to the status of SDV related components, the health utility will print out these error states, and if available also a more detailed error message.</p>
<p>In the following example, the health utility helps the troubleshooting process:</p>
<ul>
<li>The container runtime is properly started: &ldquo;Kanto CM&rdquo; is OK in the &ldquo;SDV Ports&rdquo; section and the &ldquo;container-management&rdquo; service is OK in the &ldquo;SDV Services&rdquo; section&quot;.</li>
<li>Some containers are in state &ldquo;OK&rdquo;, which means there is no general issue with the container runtime.</li>
<li>The cloud connector is in a &ldquo;Stopped&rdquo; state, which indicates that the user manually stopped the container by using &ldquo;kanto-cm stop -n cloud-connector&rdquo;.</li>
<li>The sua container is in a &ldquo;Exited&rdquo; state, which indicates the process exited with an error code.</li>
</ul>
<p><img src="sdv-health-example-errors2.png" alt="SDV Health Example Errors"></p>
<h2 id="kanto-user-interface">Kanto User Interface</h2>
<p>The KantoUI tool is a text-based user interface for conveniently managing containers in the Kanto Container Management. It supports simple navigation using keyboard and mouse to select a specific container. Commands to start, stop, remove and re-deploy containers are available along with a functionality to retrieve the application logs of a selected container.</p>
<p>Usage:</p>
<pre><code># kantui
</code></pre>
<p>Example output:</p>
<p><img src="kantui-large.png" alt="KantoUI"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2f6c44ce9348bf082b39dc70ae1a16d6">2.5 - Cheatsheet</h1>
    
	<p>This cheat sheet gives you an overview of common command line commands to interact with the tools available on the quickstart image.</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Task</th>
<th>Command</th>
</tr>
</thead>
<tbody>
<tr>
<td>General</td>
<td>Overall info</td>
<td><code>sdv-health</code></td>
</tr>
<tr>
<td></td>
<td>Show device info</td>
<td><code>sdv-device-info</code></td>
</tr>
<tr>
<td></td>
<td>Device provisioning</td>
<td><code>sdv-provision</code></td>
</tr>
<tr>
<td></td>
<td>Switch Keyboard layout</td>
<td><code>loadkeys de</code></td>
</tr>
<tr>
<td>System</td>
<td>System load</td>
<td><code>htop</code></td>
</tr>
<tr>
<td></td>
<td>Disk free</td>
<td><code>df -h -t ext4</code></td>
</tr>
<tr>
<td></td>
<td>Memory free</td>
<td><code>free -h</code></td>
</tr>
<tr>
<td>Network</td>
<td>Interfaces summary</td>
<td><code>networkctl</code></td>
</tr>
<tr>
<td></td>
<td>Ethernet status</td>
<td><code>networkctl status enp0s2</code></td>
</tr>
<tr>
<td></td>
<td>Routing table</td>
<td><code>route</code></td>
</tr>
<tr>
<td></td>
<td>Active listeners</td>
<td><code>netstat -l -n -t</code></td>
</tr>
<tr>
<td>Kanto-CM</td>
<td>Show all containers</td>
<td><code>kanto-cm list</code></td>
</tr>
<tr>
<td></td>
<td>User interface</td>
<td><code>kantui</code></td>
</tr>
<tr>
<td></td>
<td>Service logs</td>
<td><code>journalctl -f -l -t container-management</code></td>
</tr>
<tr>
<td></td>
<td>Auto deployments</td>
<td>See <code>/data/var/containers/manifests/</code></td>
</tr>
<tr>
<td></td>
<td>Development deployments</td>
<td>See <code>/data/var/containers/manifests_dev/</code></td>
</tr>
<tr>
<td></td>
<td>Restart a container</td>
<td><code>kanto-cm restart -n &lt;containername&gt;</code></td>
</tr>
<tr>
<td>ContainerdD</td>
<td>Show images</td>
<td><code>ctr --address /data/run/containerd/containerd/containerd.sock --namespace=kanto-cm i ls</code></td>
</tr>
<tr>
<td></td>
<td>Import local archive</td>
<td><code>ctr --address /data/run/containerd/containerd.sock --namespace=kanto-cm i import &lt;docker.tar&gt;</code></td>
</tr>
<tr>
<td></td>
<td>Prune containers</td>
<td><code>nerdctl system prune --all</code></td>
</tr>
<tr>
<td>Mosquitto</td>
<td>Show all messages</td>
<td><code>mosquitto_sub -v -t '#' -h localhost</code></td>
</tr>
<tr>
<td></td>
<td>Send message</td>
<td><code>mosquitto_pub -t '&lt;target/topic&gt;' -h localhost -m '{&quot;foo&quot;:&quot;bar&quot;}'</code></td>
</tr>
<tr>
<td></td>
<td>Connectivity status</td>
<td><code>mosquitto_rr --quiet -h localhost -t 'edge/thing/request' -e 'edge/thing/response' -m ''</code></td>
</tr>
<tr>
<td>RAUC Self Update</td>
<td>Current boot status</td>
<td><code>rauc status</code></td>
</tr>
<tr>
<td></td>
<td>Switch to other boot slot</td>
<td><code>rauc status mark-active other</code></td>
</tr>
<tr>
<td>CAN-Bus</td>
<td>CAN Dump</td>
<td><code>candump -l any,0:0,#FFFFFFFF</code></td>
</tr>
</tbody>
</table>
<h2 id="running-custom-ad-hoc-containers">Running custom ad-hoc containers</h2>
<p>To install arbitrary containers, create the container using the <code>kanto-cm</code> command line tool.
If it&rsquo;s not a background service, but a cli tool, adding the <code>--t --i</code> options allows console access.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@qemux86-64:~# kanto-cm remove --name python
</span></span><span style="display:flex;"><span>root@qemux86-64:~# kanto-cm create --name python --t --i --privileged docker.io/library/python:3.8.16-slim-bullseye
</span></span><span style="display:flex;"><span>bf9deca4-dbf1-4132-9ba7-e0f378bd34a7
</span></span><span style="display:flex;"><span>root@qemux86-64:~# kanto-cm start --name python --a --i
</span></span><span style="display:flex;"><span>Python 3.8.16 <span style="color:#ce5c00;font-weight:bold">(</span>default, Jan <span style="color:#0000cf;font-weight:bold">24</span> 2023, 00:19:05<span style="color:#ce5c00;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>GCC 10.2.1 20210110<span style="color:#ce5c00;font-weight:bold">]</span> on linux
</span></span><span style="display:flex;"><span>Type <span style="color:#4e9a06">&#34;help&#34;</span>, <span style="color:#4e9a06">&#34;copyright&#34;</span>, <span style="color:#4e9a06">&#34;credits&#34;</span> or <span style="color:#4e9a06">&#34;license&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; quit<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5803ac6efc38fc60ffeb9995f4fd6731">3 - Device Provisioning</h1>
    
	<p>The device needs to be configured before it can make a connection to the cloud.</p>
<p>The following initial configuration steps are required:</p>
<ul>
<li>Create a device in the cloud backend, such as Azure IoT Hub</li>
<li>Configure authentication on device</li>
<li>Configure credentials for accessing private container registries</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-57ce4bccb0846f692ca5d3289bd50697">3.1 - Manual Provisioning</h1>
    
	<p>Follow these steps to do a manual device provisioning:</p>
<ul>
<li>Generate the device certificate (eg using openssl) and sign it with your CA.</li>
<li>Log in to Azure Portal, Go to Azure Iot Hub and create a new device</li>
<li>Select the proper authentication type, e.g. X.509 Self-signed or X.509 CA Signed</li>
<li>Copy the device certificate (cert file and key file) to the device to <code>/data/var/certificate</code></li>
<li>Restart cloud connector service or container.</li>
</ul>
<h2 id="create-a-device-in-azure-iot-hub">Create a device in Azure IoT Hub</h2>
<p>For the device to be connectable, it needs to be known to the cloud service first. In these steps, we will create a new device identity by using Azure IoT Hub.</p>
<p><strong>Pre-Requisites</strong>:</p>
<ul>
<li>
<p>Virtual device must already be started with <code>runqemu ...</code> or <code>leda</code></p>
<p><em>Note: For Raspberry Pi, please follow the manual steps below and adapt the SSH connection options to the IP of your Raspbery Pi.</em></p>
</li>
<li>
<p>The virtual device needs to be remotely accessible via ssh port <code>2222</code> on the host&rsquo;s <code>localhost</code> (Qemu port forwarding in userspace)
or via ssh port <code>22</code> on the IP address <code>192.168.7.2</code> (Qemu virtual networking using TAP network interface)</p>
</li>
<li>
<p>The container runtime needs to have started successfully, check with <code>sdv-health</code></p>
</li>
<li>
<p>A Device has been created in Azure IoT Hub</p>
<p><em>Note: Do <strong>NOT</strong> create an &ldquo;edge&rdquo; device.</em></p>
</li>
</ul>
<h2 id="configure-authentication-on-device">Configure authentication on device</h2>
<p>For the proper device authentication, the device management backend authority needs to issue a device-specific certificate and sign it. This is a complex process and subject to the specific situation.</p>
<p>For the Leda quickstart images, the software configuration is prepared with dummy certificates which need to be replaced.</p>
<blockquote>
<p>ATTENTION: The Leda example device certificates are public and insecure, they only serve demonstration purposes. You need to replace the intermediate certificates and device certificates with your own.</p>
</blockquote>
<ul>
<li>Generate a device certificate using openssl</li>
<li>Sign it with your intermediate CA certificate</li>
<li>Put it into <code>/data/var/certificate/</code></li>
<li>Restart the cloud connector service or container: <code>systemctl restart cloud-connector</code> or <code>kanto-cm stop -n cloudconnector --force; kanto-cm start -n cloudconnector</code></li>
</ul>
<p>When finished, continue with</p>
<ul>
<li><a href="/leda/docs/app-deployment/">Deploying a Vehicle App</a></li>
<li><a href="/leda/docs/device-provisioning/self-update/self-update-tutorial/">Performing a Self Update</a></li>
</ul>
<h2 id="private-container-registries">Private container registries</h2>
<p>Please refer to the <a href="https://websites.eclipseprojects.io/kanto/docs/references/containers/container-manager-config/">Kanto Container Management documentation</a> on how to configure private container registries.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6a8972aed290b5361baddab9db342178">3.2 - Provisioning with sdv-provision</h1>
    
	<p>Meta-leda and the Leda-quickstart image provide a utility <code>sdv-provision</code> that simplifies the device provisioning procedure.</p>
<h2 id="connecting-to-the-device">Connecting to the device</h2>
<p>Since the procedure includes copying and pasting device IDs, it is recommended to connect to the device over a ssh connection. <code>sdv-motd</code> provides an
easy way to find your device&rsquo;s ip. More information on connecting via ssh can be found <a href="../manual-provisioning#create-a-device-in-azure-iot-hub">here</a>.</p>
<h2 id="provisioning-via-a-connection-string">Provisioning via a connection string</h2>
<h3 id="device-side">Device-side</h3>
<ol>
<li>
<p>After connecting via ssh run <code>sdv-provision</code>.</p>
<p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@qemux86-64:~# sdv-provision
</span></span><span style="display:flex;"><span>Checking Eclipse Leda Device Provisioning configuration...
</span></span><span style="display:flex;"><span>- Certificates directory exists
</span></span><span style="display:flex;"><span>Checking Device ID
</span></span><span style="display:flex;"><span>- Based on network device: eth0
</span></span><span style="display:flex;"><span>- File does not exist, creating: /etc/deviceid
</span></span><span style="display:flex;"><span>- Device ID: XX-XX-XX-XX-XX-XX
</span></span><span style="display:flex;"><span>Checking whether either IdScope or ConnectionString is configured
</span></span><span style="display:flex;"><span>- Neither Id Scope file nor ConnectionString found, needs manual configuration
</span></span><span style="display:flex;"><span>Do you want to use the global Azure IoT Device Provisioning Service <span style="color:#ce5c00;font-weight:bold">(</span>DPS<span style="color:#ce5c00;font-weight:bold">)</span> by using an Id Scope, or <span style="color:#204a87;font-weight:bold">do</span> you want to use a direct connection to a specific Azure IoT Hub using a Connection String?
</span></span><span style="display:flex;"><span>d<span style="color:#ce5c00;font-weight:bold">)</span> Azure IoT Device Provisioning Service <span style="color:#ce5c00;font-weight:bold">(</span>DPS<span style="color:#ce5c00;font-weight:bold">)</span> with Id Scope
</span></span><span style="display:flex;"><span>h<span style="color:#ce5c00;font-weight:bold">)</span> Azure IoT Hub with Connection String
</span></span><span style="display:flex;"><span>Choose:
</span></span></code></pre></div></li>
<li>
<p>Note the generated Device ID (XX-XX-XX-XX-XX-XX).</p>
</li>
<li>
<p>Type h /Azure IoT Hub with Connection String/ and press Enter.</p>
</li>
<li>
<p>Paste your Azure IoT Hub Connection String: <code>HostName=&lt;IoT Hub in Azure&gt;.azure-devices.net;DeviceId=&lt;XX-XX-XX-XX-XX-XX&gt;</code> and press enter. Where <code>&lt;IoT Hub in Azure&gt;</code> is your Azure IoT Hub name.</p>
</li>
</ol>
<h3 id="azure-portal">Azure Portal</h3>
<ol>
<li>Go to <a href="https://portal.azure.com/">https://portal.azure.com/</a> and to your Azure IoT Hub named <code>&lt;IoT Hub in Azure&gt;</code>.</li>
<li>Choose <code>Devices -&gt; Add Device</code>.</li>
<li>Enter the Device ID <code>XX-XX-XX-XX-XX-XX</code> generated on the previous step as Device ID.</li>
<li>Pick <code>X.509 Self-Signed</code> and paste the two thumbprints generated by <code>sdv-provision</code>.</li>
<li>Save.</li>
</ol>
<h3 id="device-side-1">Device-Side</h3>
<p>After all of the above steps have been completed, connect back to your device and restart the cloudconnector container by running:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kanto-cm stop -n cloudconnector --force
</span></span><span style="display:flex;"><span>kanto-cm start -n cloudconnector
</span></span></code></pre></div><p>Or alternatively use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kantui
</span></span></code></pre></div><p>And restart the container from the TUI.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b841cdcaabc5e1bd7476de818736b5bd">3.3 - Vehicle Update Manager</h1>
    
	<p>The <em>Vehicle Update Manager</em> delegates two different types of updates:</p>
<ol>
<li>The <em>Desired State</em> on the container layer</li>
<li>The <em>Self Update</em> on operating system layer</li>
</ol>
<p><img src="vehicle-update-manager-arch.png" alt="Vehicle Update Manager Architecture Overview"></p>
<h2 id="desired-state">Desired State</h2>
<p>The <em>Desired State</em> is applied at runtime on the container layer.</p>
<p>This type of update mechanism can update vehicle applications, vehicle services and other containers together with configuration resources or data files at runtime. If the applications support it, the rollout can also use high-availability strategies, such as rolling deployments.</p>
<h2 id="self-update">Self Update</h2>
<p>The <em>Self Update</em> is applied on reboot of the device only.</p>
<p>This type of update mechanism is used for system-level updates which require the operating system to be rebooted to take effect.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-42e18573332f97451f15ebcfa61573ab">3.3.1 - Configuration</h1>
    
	<p><strong>Note: This part of the Leda meta-layer and quickstart image is currently under active development and this documentation page may not represent the actual state of VUM</strong></p>
<p>The vehicle update manager container requires the following configuration:</p>
<ul>
<li>
<p>Container needs to run in <strong>privileged mode</strong> to enable automatic reboot.</p>
<p><em>Note: This is enabled by default on the Leda Quickstart images to simplify automated testing.</em></p>
</li>
<li>
<p><strong>Connection to MQTT broker</strong>, defaults to <code>THINGS_CONN_BROKER=tcp://mosquitto:1883</code></p>
</li>
<li>
<p><strong>Enable container orchestration</strong> feature: <code>THINGS_FEATURES=ContainerOrchestrator</code></p>
</li>
</ul>
<p>Optional configuration options are:</p>
<dl>
<dt><code>SELF_UPDATE_ENABLE_REBOOT=true</code></dt>
<dd>Enable automatic reboot after a successfull application of the update bundle.</dd>
<dt><code>SELF_UPDATE_TIMEOUT=30m</code></dt>
<dd>Timeout for downloading and installing an update bundle.</dd>
</dl>
<h1 id="example-deployment-specification">Example Deployment Specification</h1>
<pre tabindex="0"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: vehicle-update-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vehicle-update-manager
rules:
- apiGroups:
  - &#39;*&#39;
  resources:
  - &#39;*&#39;
  verbs:
  - &#39;*&#39;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vehicle-update-manager
subjects:
- kind: ServiceAccount
  name: vehicle-update-manager
  namespace: default
roleRef:
  kind: ClusterRole
  name: vehicle-update-manager
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vehicle-update-manager
spec:
  selector:
    matchLabels:
      component: vehicle-update-manager
  template:
    metadata:
      labels:
        component: vehicle-update-manager
    spec:
      serviceAccountName: vehicle-update-manager
      containers:
        - name: vehicle-update-manager
          image: &lt;repository&gt;/vehicleupdatemanager:&lt;tag&gt;
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          env:
            - name: SELF_UPDATE_TIMEOUT
              value: 30m
            - name: SELF_UPDATE_ENABLE_REBOOT
              value: &#34;true&#34;
            - name: THINGS_CONN_BROKER
              value: tcp://mosquitto:1883
            - name: THINGS_FEATURES
              value: ContainerOrchestrator
          volumeMounts:
          - mountPath: /proc
            name: proc
      volumes:
      - hostPath:
          path: /proc
        name: proc
      imagePullSecrets:
        - name: ghcr-io
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a9d83955f4af71a310e5e508cd17161e">3.3.2 - Message Flow</h1>
    
	<p>The following message flow is an example for the <em>Self Update</em> use case.
The message is triggered by command line via Azure IoT Hub.</p>
<div class="mermaid">sequenceDiagram
    autonumber

    actor flops as Fleet Operations

    participant backend as Digital Twin
    participant vum as Vehicle Update Manager
    participant sua as Self Update Agent
    participant device as Device

    flops ->> backend: Rollout Campaign

    backend -->> vum: Device Command <br> Live Message: <br> yamlApply

    Note left of backend: C2D Message

    vum -->> sua: selfupdate/desiredstate <br> SelfUpdateBundle

    loop Download
        sua -->> sua: Downloading
        sua -->> vum: selfupdate/desiredstatefeedback
        vum -->> backend: progress
    end

    loop Installation
        sua -->> device: Installing
        Note right of device: RAUC Update Bundle
        sua -->> vum: selfupdate/desiredstatefeedback
        vum -->> backend: progress
    end

    sua -->> vum: Installed
    
    rect rgb(100, 255, 150)
        sua -->> backend: FINISHED_SUCCESS
    end

    opt Reboot
        vum -->> device: SysRq Reboot
    end
  </div>
  
  <h1 id="messages">Messages</h1>
<p>The following describes the message flow with example messages in more detail. The following variables are used for dynamic parts of the messages:</p>
<ul>
<li><code>&lt;cuid&gt;</code> - A Correlation ID in form of a UUID</li>
<li><code>&lt;selfUpdateRequestYaml&gt;</code> or <code>&lt;payload&gt;</code>- The Desired State Self Update Request message in YAML, as defined by the Self Update Agent API</li>
<li><code>&lt;hub&gt;</code> - The name or identifier of the message hub</li>
<li><code>&lt;device&gt;</code> - The device identifier used by the message hub or other components to identify the device.</li>
</ul>
<ol>
<li>
<p>Cloud backend sends the Self-Update Request Message as YAML embedded into an Azure IoT Hub C2D Message Envelope:</p>
<p>Payload:</p>
<pre tabindex="0"><code>{
    &#34;appId&#34;: &#34;mc-ota-update&#34;,
    &#34;cmdName&#34;: &#34;desiredstate.update&#34;,
    &#34;cId&#34;: &#34;&lt;cuid&gt;&#34;,
    &#34;eVer&#34;: &#34;2.0&#34;,
    &#34;pVer&#34;: &#34;1.0&#34;,
    &#34;p&#34;: &lt;selfUpdateRequestYaml&gt;
}
</code></pre></li>
<li>
<p>Cloud Connector validates envelope and transforms request message into a <em>ContainerOrechestrator</em> message:</p>
<p>Topic: <code>command//azure.edge:&lt;hub&gt;:&lt;device&gt;:edge:containers/req/&lt;cuid&gt;/yamlApply</code></p>
<p>Body (json):</p>
<pre tabindex="0"><code> {
  &#34;topic&#34;: &#34;azure.edge/&lt;hub&gt;:&lt;device&gt;:edge:containers/things/live/messages/yamlApply&#34;,
  &#34;headers&#34;: {
     &#34;content-type&#34;: &#34;application/json&#34;,
     &#34;correlation-id&#34;: &#34;&lt;cuid&gt;&#34;},
     &#34;path&#34;: &#34;/features/ContainerOrchestrator/inbox/messages/yamlApply&#34;,
     &#34;value&#34;: {
         &#34;correlationId&#34;: &#34;&lt;cuid&gt;&#34;,
         &#34;payload&#34;: &#34;&lt;payload&gt;&#34;
         }
     }
 }
</code></pre><p><em>Note: Payload (Yaml encoded in JSON) omitted here for clarity, see next step.</em></p>
</li>
</ol>
<ol start="3">
<li>
<p>Vehicle Update manager extracts payload and forward the message to the Self Update Agent message inbox:</p>
<p>Topic: <code>selfupdate/desiredstate</code></p>
<p>Message:</p>
<pre tabindex="0"><code>apiVersion: sdv.eclipse.org/v1
kind: SelfUpdateBundle
metadata:
    name: self-update-bundle-example
spec:
    bundleDownloadUrl: http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb
    bundleName: swdv-arm64-build42
    bundleTarget: base
    bundleVersion: v1beta3
</code></pre></li>
</ol>
<ol start="4">
<li>
<p>The Self Update Agent response with status messages during download and installation phases.</p>
<p>Topic: <code>selfupdate/desiredstatefeedback</code></p>
<p>Message:</p>
<pre tabindex="0"><code>apiVersion: sdv.eclipse.org/v1
kind: SelfUpdateBundle
metadata: 
  name: &#34;self-update-bundle-example&#34;
spec: 
  bundleDownloadUrl: &#34;http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb&#34;
  bundleName: &#34;swdv-arm64-build42&#34;
  bundleTarget: base
  bundleVersion: v1beta3
state: 
  message: Entered Downloading state
  name: downloading
  progress: 0
  techCode: 0
</code></pre></li>
<li>
<p>Once finished, the Vehicle Update Manager will also return a <code>FINISHED_SUCCESS</code> message for the conversation with the backend.</p>
<p>Topic: <code>e/defaultTenant/azure.edge:&lt;hub&gt;:&lt;device&gt;:edge:containers</code></p>
<p>Message:</p>
<pre tabindex="0"><code>{
  &#34;topic&#34;: &#34;azure.edge/&lt;hub&gt;:&lt;device&gt;:edge:containers/things/twin/commands/modify&#34;,
  &#34;headers&#34;: {
    &#34;response-required&#34;:false
  },
  &#34;path&#34;: &#34;/features/ContainerOrchestrator/properties/status/state&#34;,
  &#34;value&#34;: {
    &#34;manifest&#34;: [],
    &#34;status&#34;: &#34;FINISHED_SUCCESS&#34;,
    &#34;correlationId&#34;:&#34;&lt;cuid&gt;&#34;
    }
}
</code></pre></li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-679c6c584dc366c660841bdd65d2af73">3.4 - Self Updates</h1>
    
	<p>In general, the self-update mechanism for operating system level updates is done with two separate partitions. While one partition is the actively booted partition and in use, the other partition can be updated by writing a partition image to it, as it is unused or inactive.</p>
<p>Once the download and writing is done, a reboot is triggered and the boot loader will now switch to the newly updated partition.</p>
<p>If the booting of the updated partition fails, the self update mechanism can revert back to the previous partition or boot to a rescue partition.</p>
<p><img src="leda-self-update.png" alt="Leda Self Update"></p>
<p>As updating the running operating system cannot be done at runtime, the approach requires additional disk space, a second partition and also requires the device to be rebooted for the updates to take effect.</p>
<p>In a vehicle, the self-updater cannot decide on its own when to do a reboot, as the vehicle must be in a safe condition (eg parked, state of charge etc.). Hence, the trigger for performaing the switch to another slot and a subsequent reboot is handed over to a higher level component, such as the vehicle update manager, which may in turn rely on driver feedback or other conditions.</p>
<h2 id="implementation-with-rauc-update-service">Implementation with RAUC Update Service</h2>
<p><a href="https://www.rauc.io/">RAUC</a> is a lightweight update client that runs on your embedded device and reliably controls the procedure of updating your device with a new firmware revision.</p>
<p>For general usage of the RAUC tool, please see the <a href="https://rauc.readthedocs.io/en/latest/using.html">RAUC User manual</a></p>
<h2 id="reference-configuration">Reference configuration</h2>
<p>The project contains an example reference implementation and configuration using RAUC, which allows the evaluation of the concepts, mechanisms and involved software components in an emulated, virtual environment.</p>
<p>The Leda quickstart image contains the following disk partitions:</p>
<ul>
<li>a small rescue partition</li>
<li>a full SDV installation with a container runtime, pre-loaded SDV container images and deployment specifications and additional developer tools such as nerdctl and kantui.</li>
<li>a minimal SDV installation with a container runtime, but no additional examples or developer tools. This partition is used to demonstrate the self-update functionality.</li>
<li>additional boot and data partitions for keeping system state information</li>
</ul>
<p><em>Note: All three rootfs partitions (rootfs) initially contain the same identical copies of the base operating system. Both SDV Root partitions will use the same shared data partition for the container persistent state.</em></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cb55165363d95c91e0f19399fa5b280b">3.4.1 - Self Update Tutorial</h1>
    
	<p>This chapter describes the steps necessary to perform a local (without cloud) self update of the operating system.</p>
<p><img src="../self-update-arch.png" alt="Self Update Architecture"></p>
<h2 id="self-update-using-rauc-update-bundles">Self-Update using RAUC Update Bundles</h2>
<ul>
<li>
<p>On host: Update bundle <code>sdv-rauc-bundle-qemux86-64.raucb</code> is in current folder</p>
<p><em>Note: In the development environment, the update RAUC Update Bundle is located in the BitBake machine-specific output folder
Example location is <code>tmp/deploy/images/qemux86-64</code></em></p>
</li>
<li>
<p>On host: Start a dummy web server for serving the update file</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 -m http.server --bind 192.168.7.1
</span></span></code></pre></div></li>
<li>
<p>On host: open two new terminals - one for monitoring and one for triggering the self-update</p>
<ul>
<li>
<p>Terminal 1: To view the progress, watch the MQTT topics <code>selfupdate/desiredstate</code> and <code>selfupdate/desiredstatefeedback</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_sub -h 192.168.7.2 -p <span style="color:#0000cf;font-weight:bold">1883</span> -t <span style="color:#4e9a06">&#34;selfupdate/#&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>Terminal 2: Trigger the actual self update process by publishing an MQTT message to <code>selfupdate/desiredstate</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_pub -h 192.168.7.2 -p <span style="color:#0000cf;font-weight:bold">1883</span> -t <span style="color:#4e9a06">&#34;selfupdate/desiredstate&#34;</span> -f start-update-example.json
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>Switch to a terminal in the guest</p>
</li>
<li>
<p>On guest: After the self update process completed, check the status:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rauc status --detailed
</span></span></code></pre></div></li>
</ul>
<h2 id="self-update-trigger-message">Self-Update Trigger Message</h2>
<p><code>start-update-example.json</code> file:</p>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;random-uuid-as-string&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123456789</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;domains&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;components&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb&#34;</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>


<h2 id="example-message-flows">Example Message Flows</h2>
<h3 id="current-state">Current State</h3>
<ol>
<li>
<p>Initial response message on startup from self update agent in topic <code>selfupdate/currentstate</code>, or upon request by sending message to <code>selfupdate/currentstate/get</code></p>
<p>Request:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1676332092</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Response:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675345910</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;domains&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;components&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bundle_version_not_available&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="desired-state">Desired State</h3>
<ol>
<li>
<p>External trigger to update via desired state on topic <code>selfupdate/desiredstate</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123456789</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;domains&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;components&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#204a87;font-weight:bold">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://leda-bundle-server/sdv-rauc-bundle-qemux86-64.raucb&#34;</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Initialization response by Self Update Agent on topic <code>selfupdate/desiredstatefeedback</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675347152</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;IDENTIFIED&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Self-update agent is about to perform an OS image update.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;actions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Responses while downloading by Self Update Agent on topic <code>selfupdate/desiredstatefeedback</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675347152</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Self-update agent is performing an OS image update.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;actions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;component&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update:os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;DOWNLOADING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Downloading 0.0 MiB...&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Response by Self Update Agent on topic <code>selfupdate/desiredstatefeedback</code> when download successfully finished:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675347154</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Self-update agent is performing an OS image update.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;actions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;component&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update:os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;DOWNLOAD_SUCCESS&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Downloaded 108.9 MiB...&#34;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Response by Self Update Agent on topic <code>selfupdate/desiredstatefeedback</code> while performing the installation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675347159</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Self-update agent is performing an OS image update.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;actions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;component&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update:os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UPDATING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RAUC install...&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Response by Self Update Agent on topic <code>selfupdate/desiredstatefeedback</code> when installation completed successfully:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;activityId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;timestamp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1675347186</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;payload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;COMPLETED&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Self-update completed, reboot required.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;actions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;component&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;self-update:os-image&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${VERSION_ID}&#34;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UPDATE_SUCCESS&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Writing partition completed, reboot required.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fdfe9e0ec285454b4f0c580b5cd46e62">3.4.2 - RAUC Integration</h1>
    
	<p>Leda integrates <a href="https://rauc.io/">RAUC</a> as a reference implementation and example configuration. It allows the evaluation of the concepts, mechanisms and involved software components in an emulated, virtual environment or on physical devices.</p>
<h2 id="checking-the-rauc-status">Checking the RAUC Status</h2>
<p>Get the current RAUC boot status:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rauc status
</span></span></code></pre></div><p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@qemux86-64:~# rauc <span style="color:#000">status</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">===</span> System <span style="color:#000">Info</span> <span style="color:#ce5c00;font-weight:bold">===</span>
</span></span><span style="display:flex;"><span>Compatible:  Eclipse Leda qemu86-64
</span></span><span style="display:flex;"><span>Variant:     
</span></span><span style="display:flex;"><span>Booted from: rootfs.1 <span style="color:#ce5c00;font-weight:bold">(</span>SDV_B<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">Bootloader</span> <span style="color:#ce5c00;font-weight:bold">===</span>
</span></span><span style="display:flex;"><span>Activated: rootfs.1 <span style="color:#ce5c00;font-weight:bold">(</span>SDV_B<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">===</span> Slot <span style="color:#000">States</span> <span style="color:#ce5c00;font-weight:bold">===</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>o <span style="color:#ce5c00;font-weight:bold">[</span>rootfs.1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span>/dev/sda5, ext4, inactive<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        bootname: SDV_B
</span></span><span style="display:flex;"><span>        mounted: /
</span></span><span style="display:flex;"><span>        boot status: good
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#ce5c00;font-weight:bold">[</span>rootfs.0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span>/dev/sda4, ext4, booted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        bootname: SDV_A
</span></span><span style="display:flex;"><span>        boot status: good
</span></span></code></pre></div><h2 id="forcing-to-boot-the-other-slot">Forcing to boot the other slot</h2>
<p>To manually force the device to boot into another slot, mark the current booted slot as <em>bad</em>, mark the other partitions as <em>active</em> and perform a reboot:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rauc status mark-bad booted
</span></span><span style="display:flex;"><span>rauc status mark-active other
</span></span><span style="display:flex;"><span>reboot now
</span></span></code></pre></div><h2 id="testing-the-rescue-system">Testing the rescue system</h2>
<p>By marking both root slots as bad, the bootloader is supposed to boot the rescue system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rauc status mark-bad rootfs.0
</span></span><span style="display:flex;"><span>rauc status mark-bad rootfs.1
</span></span><span style="display:flex;"><span>reboot now
</span></span></code></pre></div><p>Example output of rauc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>o <span style="color:#ce5c00;font-weight:bold">[</span>rootfs.1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span>/dev/sda5, ext4, inactive<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        bootname: B
</span></span><span style="display:flex;"><span>        boot status: bad
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>o <span style="color:#ce5c00;font-weight:bold">[</span>rootfs.0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span>/dev/sda4, ext4, booted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        bootname: A
</span></span><span style="display:flex;"><span>        mounted: /
</span></span><span style="display:flex;"><span>        boot status: bad
</span></span></code></pre></div><h2 id="customizations">Customizations</h2>
<p>The configurations can be customized by applying or patching the following files:</p>
<ul>
<li>RAUC Configuration file: <code>meta-leda/recipes-bsp/rauc/files/qemux86-64/system.conf</code></li>
<li>Bootloader Configuration file: <code>meta-leda/recipes-bsp/grub/files/grub.cfg</code></li>
<li>The physical disk partition configuration: <code>meta-leda/recipes-sdv/wic/qemux86-grub-efi.wks</code></li>
</ul>
<h2 id="rauc-system-configuration">RAUC System Configuration</h2>
<p>The <a href="https://rauc.readthedocs.io/en/latest/integration.html#rauc-system-configuration">RAUC System Configuration</a> is the central configuration of the RAUC Update system.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>system<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">compatible</span><span style="color:#ce5c00;font-weight:bold">=</span>Eclipse Leda qemu86-64
</span></span><span style="display:flex;"><span><span style="color:#000">bootloader</span><span style="color:#ce5c00;font-weight:bold">=</span>grub
</span></span><span style="display:flex;"><span><span style="color:#000">grubenv</span><span style="color:#ce5c00;font-weight:bold">=</span>/grubenv/grubenv
</span></span><span style="display:flex;"><span><span style="color:#000">statusfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/data/rauc.status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>keyring<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=</span>ca.cert.pem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>slot.efi.0<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">device</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/sda
</span></span><span style="display:flex;"><span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>boot-gpt-switch
</span></span><span style="display:flex;"><span>region-start<span style="color:#ce5c00;font-weight:bold">=</span>4M
</span></span><span style="display:flex;"><span>region-size<span style="color:#ce5c00;font-weight:bold">=</span>100M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>slot.rescue.0<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">device</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/sda3
</span></span><span style="display:flex;"><span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>ext4
</span></span><span style="display:flex;"><span><span style="color:#000">readonly</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>slot.rootfs.0<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">device</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/sda4
</span></span><span style="display:flex;"><span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>ext4
</span></span><span style="display:flex;"><span><span style="color:#000">bootname</span><span style="color:#ce5c00;font-weight:bold">=</span>SDV_A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>slot.rootfs.1<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">device</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/sda5
</span></span><span style="display:flex;"><span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>ext4
</span></span><span style="display:flex;"><span><span style="color:#000">bootname</span><span style="color:#ce5c00;font-weight:bold">=</span>SDV_B
</span></span></code></pre></div><h2 id="grub-bootloader-configuration">GRUB Bootloader Configuration</h2>
<p>The GRUB bootloader has a configuration file which describes which partitions are bootable, which partition they are located at and a reference to RAUC&rsquo;s slot name.</p>
<p>The configuration also contains <strong>RAUC specific logic and variables required for a proper integration</strong>. Please see the full <code>grub.cfg</code> in the source repository and <a href="https://rauc.readthedocs.io/en/latest/integration.html#grub">RAUC Documentation - Integration - GRUB</a> for details.</p>
<p>Excerpt:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>menuentry &#34;SDV Slot A (OK=$SDV_A_OK TRY=$SDV_A_TRY)&#34; {
</span></span><span style="display:flex;"><span>    linux (hd0,4)/boot/bzImage root=/dev/vda4 $CMDLINE rauc.slot=SDV_A
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>menuentry &#34;SDV Slot B (OK=$SDV_B_OK TRY=$SDV_B_TRY)&#34; {
</span></span><span style="display:flex;"><span>    linux (hd0,5)/boot/bzImage root=/dev/vda5 $CMDLINE rauc.slot=SDV_B
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="u-boot-bootloader-configuration">U-Boot Bootloader Configuration</h2>
<p>Similarly to GRUB, integration of RAUC with U-Boot requires custom boot scripting. A highly detailed explaination can, again, be found in the official <a href="https://rauc.readthedocs.io/en/latest/integration.html#id5">RAUC Documentation - Integration - U-Boot</a>.</p>
<p>Meta-Leda provides such integration recipes and scripts for all U-boot based targets, for which a Leda Quickstart image is available (qemuarm64, qemuarm and rpi4-64). For example:</p>
<ul>
<li><a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/u-boot_%25.bbappend">Main uboot_%.bbappend</a></li>
<li><a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/uboot-targets/qemuarm.inc">Qemuarm custom script integration recipe</a></li>
<li><a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/files/qemuarm/boot.cmd.in">Qemuarm custom boot.scr</a></li>
</ul>
<p><em>Note: A custom U-Boot device defconfig might be required for some devices to be integrated with RAUC. Leda Quickstart images patch the default defconfigs for qemuarm64 and qemuarm to save the U-Boot environment in a VFAT BOOT partition.</em></p>
<h2 id="disk-partitioning-with-openembedded-image-creator-wic">Disk Partitioning with OpenEmbedded Image Creator (WIC)</h2>
<p>The <a href="https://www.yoctoproject.org/docs/current/dev-manual/dev-manual.html#creating-partitioned-images-using-wic">OpenEmbedded Image Creator</a> is used in BitBake to actually create full disk images with multiple partitions.</p>
<p>These disk images are machine specific and the structure of the partitions are configured in <a href="https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-kickstart">OpenEmbedded Kickstart</a> files (<code>*.wks</code>).</p>
<h3 id="excerpt-qemux86-grub-efiwks">Excerpt <code>qemux86-grub-efi.wks</code></h3>
<p><em>Note: The excerpt is exemplary, please see the sources for a full representation and documentation.</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bootloader --ptable gpt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part --fixed-size 50M --source rawcopy --sourceparams=&#34;file=efi-boot.vfat&#34; --fstype=vfat --label boot --active
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part --fixed-size 10M --source rawcopy --sourceparams=&#34;file=grubenv.vfat&#34; --fstype=vfat --label grubenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part /rescue --source rootfs --fstype=ext4 --label rescue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part / --source rootfs --fstype=ext4 --label root_a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part / --source rootfs --fstype=ext4 --label root_b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part /data --fixed-size 4G --fstype=ext4 --label data
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-330a7bfc4527a76419775bc5ddc1265b">3.4.3 - API Reference</h1>
    
	<p>The self update agent (SUA) is a component responsible for the OS Update process.  SUA is communicating on MQTT interface via usage of defined messages. Internally, SUA uses <a href="https://rauc.io/">RAUC</a> to perform the update.</p>
<p>Following sequence diagram shows the happy path example of communication between components.</p>
<h2 id="process-overview">Process Overview</h2>
<div class="mermaid">sequenceDiagram
    participant m as MQTT Broker 
    participant s as SUA
    participant r as RAUC
    s -->> m: connect
    loop Wait for message: selfupdate/desiredstate
    Note left of s: Initial start
    s ->> m: selfupdate/currentstate
    Note left of s: Trigger for OTA
    m ->> s: selfupdate/desiredstate
    s ->> m: selfupdate/desiredstatefeedback: downloading 0%
    s ->> s: download bundle
    s ->> m: selfupdate/desiredstatefeedback: downloading 51%
    s ->> r: install
    s ->> m: selfupdate/desiredstatefeedback: installing 0%
    r ->> r: install
    r ->> s: share progress: e.g. 51%
    s ->> m: selfupdate/desiredstatefeedback: installing 51%
    r ->> s: installation ready
    s ->> m: selfupdate/desiredstatefeedback: installed 
    s ->> m: selfupdate/desiredstatefeedback: idle 
    end
  </div>
  
  <h2 id="mqtt-message-definitions">MQTT Message Definitions</h2>
<p>MQTT messages are specified as follows:</p>
<h3 id="selfupdatedesiredstate">selfupdate/desiredstate</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/desiredstate</td>
<td>IN</td>
<td>This message triggers the update process. The payload shall contain all data necessary to obtain the update bundle and to install it.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleName: swdv-arm64-build42
  bundleVersion: v1beta3
  bundleDownloadUrl: https://example.com/repository/base/
  bundleTarget: base
</code></pre><h3 id="selfupdatecurrentstate">selfupdate/currentstate</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/currentstate</td>
<td>OUT</td>
<td>This message is being sent once, on SUA start. It contains information about currently installed OS version.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleVersion: v1beta3
</code></pre><h3 id="selfupdatedesiredstatefeedback">selfupdate/desiredstatefeedback</h3>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>selfupdate/desiredstatefeedback</td>
<td>OUT</td>
<td>This message is being sent by SUA to share current progress of triggered update process. This is the <em>OUT</em> counterpart of <em>selfupdate/desiredstate</em> input message.</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code>apiVersion: &#34;sdv.eclipse.org/v1&#34;
kind: SelfUpdateBundle
metadata:
  name: self-update-bundle-example
spec:
  bundleName: swdv-arm64-build42
  bundleVersion: v1beta3
  bundleDownloadUrl: https://example.com/repository/base/
  bundleTarget: base
state:
  name: &#34;idle|installing|etc.&#34;
  progress: 0|51|99|etc., 
  techCode: 0|1|5|etc.,  
  message: &#34;Cannot download from url|Bundle already installed|etc.&#34; 
</code></pre><h4 id="state-enum">state enum</h4>
<p>State name field can have one of following values:</p>
<table>
<thead>
<tr>
<th>State</th>
<th>Description</th>
<th>Additional payload data</th>
</tr>
</thead>
<tbody>
<tr>
<td>uninitialized</td>
<td>When the SUA is not configured yet</td>
<td>-</td>
</tr>
<tr>
<td>idle</td>
<td>Configured and waiting for messages</td>
<td>-</td>
</tr>
<tr>
<td>downloading</td>
<td>Downloading the bundle file</td>
<td>progress</td>
</tr>
<tr>
<td>installing</td>
<td>Performing installation</td>
<td>progress</td>
</tr>
<tr>
<td>installed</td>
<td>Installation process was successful, new OS version is installed on inactive disc Slot. <br><strong>Important: to finish the OTA process, reboot is required, and it shall be performed by another component, such as the Vehicle Update Manager.</strong></td>
<td>-</td>
</tr>
<tr>
<td>failed</td>
<td>Error occurred</td>
<td>techCode</td>
</tr>
</tbody>
</table>
<h4 id="techcode-values">techCode values</h4>
<p>techCode field is providing additional details to the state value. It is especially useful for the <strong>failed</strong> state, as it can specify the reason of failure.</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>OK, no error</td>
</tr>
<tr>
<td>1001</td>
<td>Download failed</td>
</tr>
<tr>
<td>2001</td>
<td>Invalid Bundle</td>
</tr>
<tr>
<td>3001</td>
<td>Installation failed</td>
</tr>
<tr>
<td>4001</td>
<td>Update rejected, bundle version same as current OS version</td>
</tr>
<tr>
<td>5001</td>
<td>Unknown Error</td>
</tr>
</tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-15f7b853b9c959b01ccff386532cb867">3.5 - Container Management</h1>
    
	<p>Leda is using Kanto Container Management as the upper-layer container runtime and container orchestration engine.</p>
<p>Besides the command line tool <code>kanto-cm</code>, Kanto also has remote interfaces to manage containers.</p>
<h2 id="remote-interface">Remote Interface</h2>
<p>Kanto&rsquo;s container-management service offers a remote interface via local messaging (MQTT) to interact with a digital twin on the cloud side.
This feature can be easily enabled by setting <code>&quot;things&quot;: { &quot;enabled&quot;: true }</code> in <code>/etc/container-management/config.toml</code>.</p>
<p>When one of the cloud connector components, such as leda-contrib-cloud-connector or Kanto&rsquo;s azure-connector, is connected to a cloud backend, the container-management will publish its own information using Eclipse Ditto and Eclipse Hono messages. For this, container-management only needs the device Id, gateway Id and tenant Id.</p>
<h3 id="simulation-of-cloud-connectivity">Simulation of cloud connectivity</h3>
<ol>
<li>Container Management starts and subscribes to <code>edge/thing/response</code></li>
<li>Cloud Connector starts and publishes the following message to <code>edge/thing/response</code> as soon as the connection is online:</li>
</ol>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;deviceId&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;&lt;namespace&gt;:&lt;gatewayId&gt;:&lt;deviceId&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;tenantId&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;&lt;tenantId&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>


<ul>
<li><code>namespace</code> is <code>azure.edge</code> for Kanto&rsquo;s Azure Cloud Connector</li>
<li><code>gatewayId</code> indicates the hostname of the Azure IoT Hub</li>
<li><code>deviceId</code> is the identifier for the device, this can either be part of the Azure Connection String or part of the device authentication certificate (CN)</li>
<li><code>tenantId</code> is a configuration setting in the cloud connector</li>
</ul>
<blockquote>
<p><strong>Note:</strong> You can simulate the cloud connector trigger by issueing the MQTT message manually on command line:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_pub -t <span style="color:#4e9a06">&#39;edge/thing/response&#39;</span> -m <span style="color:#4e9a06">&#39;{&#34;deviceId&#34;:&#34;dummy-namespace:dummy-gateway:dummy-device-id&#34;,&#34;tenantId&#34;:&#34;dummy-tenant-id&#34;}&#39;</span>
</span></span></code></pre></div><h3 id="container-management">Container Management</h3>
<p>The container management will respond to the cloud connectivity status message by initially sending a list of containers:</p>
<ol>
<li>Container Management responds with a list of containers in the topic <code>e/&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers</code></li>
</ol>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;topic&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers/things/twin/commands/modify&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;headers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;response-required&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/features/SoftwareUpdatable&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;definition&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;org.eclipse.hawkbit.swupdatable:SoftwareUpdatable:2.0.0&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;properties&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;softwareModuleType&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;oci:container&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;installedDependencies&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;ghcr.io%2Feclipse%2Fkuksa.val%2Fdatabroker.&lt;uuid&gt;:0.2.5&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;group&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val/databroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0.2.5&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;ghcr.io%2Feclipse%2Fkuksa.val.services%2Fseat_service.&lt;uuid&gt;:v0.1.0&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;group&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val.services/seat_service&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v0.1.0&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;ghcr.io%2Feclipse-leda%2Fleda-contrib-cloud-connector%2Fcloudconnector.&lt;uuid&gt;:latest&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;group&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse-leda/leda-contrib-cloud-connector/cloudconnector&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;latest&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;ghcr.io%2Feclipse-leda%2Fleda-contrib-self-update-agent%2Fself-update-agent.&lt;uuid&gt;:build-20&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;group&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse-leda/leda-contrib-self-update-agent/self-update-agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;build-20&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;ghcr.io%2Feclipse-leda%2Fleda-contrib-vehicle-update-manager%2Fvehicleupdatemanager.&lt;uuid&gt;:latest&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;group&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse-leda/leda-contrib-vehicle-update-manager/vehicleupdatemanager&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;version&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;latest&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>


<ol start="2">
<li>Container Management answers with an additional message for each container in the topic <code>e/&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers</code></li>
</ol>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;topic&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers/things/twin/commands/modify&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;headers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;response-required&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/features/Container:&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;definition&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;com.bosch.iot.suite.edge.containers:Container:1.5.0&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;properties&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;imageRef&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val.services/seat_service:v0.1.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;domainName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example-domain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;hostName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example-host&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;VEHICLEDATABROKER_DAPR_APP_ID=databroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;BROKER_ADDR=databroker-host:30555&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;RUST_LOG=info&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;vehicle_data_broker=info&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;restartPolicy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UNLESS_STOPPED&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;extraHosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;databroker-host:host_ip&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;proto&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostPort&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostPortEnd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;containerPort&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostIP&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;networkMode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BRIDGE&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;log&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;JSON_FILE&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;maxFiles&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;maxSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BLOCKING&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;createdAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T08:46:33.792687313Z&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">13627</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;startedAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T09:51:08.049572297Z&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;finishedAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T09:50:51.752255799Z&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div>


<h3 id="container-metrics">Container Metrics</h3>
<p>Container-level metrics, such as CPU utilization or memory usage, can be retrieved on-demand and continuously by enabling the container metrics events.
This is done by sending a request to the topic <code>command//&lt;namespaceId&gt;:&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers/req/&lt;correlationId&gt;/request</code>:</p>
<ol>
<li>Enable Container Metrics with a frequency of <code>5s</code>:</li>
</ol>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;topic&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;dummy-namespace/dummy-gateway:dummy-device-id:edge:containers/things/live/messages/request&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;headers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;response-required&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;content-type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;application/json&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;correlation-id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;3fdc463c-293c-4f39-ab19-24aef7944550&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/features/Metrics/inbox/messages/request&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;frequency&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5s&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span></span></span></code></pre></div>


<p>Example command line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_pub -t command//dummy-namespace:dummy-gateway:dummy-device-id:edge:containers/req/3fdc463c-293c-4f39-ab19-24aef7944550/request -m <span style="color:#4e9a06">&#39;{&#34;topic&#34;:&#34;dummy-namespace/dummy-gateway:dummy-device-id:edge:containers/things/live/messages/request&#34;,&#34;headers&#34;:{&#34;timeout&#34;:&#34;10&#34;,&#34;response-required&#34;:true,&#34;content-type&#34;:&#34;application/json&#34;,&#34;correlation-id&#34;:&#34;3fdc463c-293c-4f39-ab19-24aef7944550&#34;},&#34;path&#34;:&#34;/features/Metrics/inbox/messages/request&#34;,&#34;value&#34;:{&#34;frequency&#34;:&#34;5s&#34;}}&#39;</span>
</span></span></code></pre></div><ol start="2">
<li>Container Metrics answers with an additional message for each container in the topic <code>e/&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers</code></li>
</ol>


  




	






  
  
  






  <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;topic&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;tenantId&gt;/&lt;gatewayId&gt;:&lt;deviceId&gt;:edge:containers/things/twin/commands/modify&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;headers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;response-required&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/features/Container:&lt;uuid&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;definition&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;com.bosch.iot.suite.edge.containers:Container:1.5.0&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;properties&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;imageRef&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val.services/seat_service:v0.1.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;domainName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example-domain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;hostName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;seatservice-example-host&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;VEHICLEDATABROKER_DAPR_APP_ID=databroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;BROKER_ADDR=databroker-host:30555&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;RUST_LOG=info&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;vehicle_data_broker=info&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;restartPolicy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UNLESS_STOPPED&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;extraHosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;databroker-host:host_ip&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;proto&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostPort&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostPortEnd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;containerPort&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50051</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">&#34;hostIP&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;networkMode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BRIDGE&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;log&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;JSON_FILE&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;maxFiles&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;maxSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BLOCKING&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;createdAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T08:46:33.792687313Z&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNING&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">13627</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;startedAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T09:51:08.049572297Z&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">&#34;finishedAt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-02-02T09:50:51.752255799Z&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div>


<ol start="3">
<li>
<p>To disable Container Metrics, send a request with frequency of <code>0s</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mosquitto_pub -t command//dummy-namespace:dummy-gateway:dummy-device-id:edge:containers/req/3fdc463c-293c-4f39-ab19-24aef7944550/request -m <span style="color:#4e9a06">&#39;{&#34;topic&#34;:&#34;dummy-namespace/dummy-gateway:dummy-device-id:edge:containers/things/live/messages/request&#34;,&#34;headers&#34;:{&#34;timeout&#34;:&#34;10&#34;,&#34;response-required&#34;:true,&#34;content-type&#34;:&#34;application/json&#34;,&#34;correlation-id&#34;:&#34;3fdc463c-293c-4f39-ab19-24aef7944550&#34;},&#34;path&#34;:&#34;/features/Metrics/inbox/messages/request&#34;,&#34;value&#34;:{&#34;frequency&#34;:&#34;0s&#34;}}&#39;</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3f62c837f7dcb92aa6d45e0922ff9bb3">4 - Vehicle Applications</h1>
    
	<p>This chapter contains use cases and examples for SDV applications.</p>
<p>Some of these example are taken from the following sources:</p>
<ul>
<li><a href="https://digital.auto">Digital.Auto</a> and its <a href="https://digitalauto.netlify.app/">playground</a></li>
<li><a href="https://websites.eclipseprojects.io/velocitas/docs/tutorials/">Eclipse Velocitas tutorials</a></li>
<li><a href="https://github.com/eclipse/kuksa.val.services">Eclipse Kuksa.VAL examples</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-10a0e990614b64cb6bbaff75a319ebb7">4.1 - Seat Adjuster</h1>
    
	<p>The <strong>Seat Adjuster</strong> use case has been derived from the <a href="https://websites.eclipseprojects.io/velocitas/docs/about/use_cases/seat_adjuster/">Eclipse Velocitas Seat Adjuster example</a>, the <a href="https://github.com/eclipse/kuksa.val.services/tree/main/seat_service">Eclipse Kuksa.VAL Seat Service example</a> and the <a href="https://digitalauto.netlify.app/model/997XF1ch2f5DjgPIzhY3/library/prototype/ZqhnonCBSSwP8ZVM7CFh">Digital.Playground Prototyping Library</a></p>
<h2 id="description">Description</h2>
<p>The Seat Adjuster use cases demonstrates the idea of having a cloud-based driver profile hosted by a third-party web service, which is then used by a custom application to move the driver seat to certain positions.</p>
<p>Examples range from simple personalization to dynamic seat control (such as periodic back massages) based on personal health treatment plans by an health insurance organization. A driver could opt-in to such a service, which would lead to the ad-hoc installation of a seat adjuster vehicle application when the driver enters the vehicle. The seat adjuster application would then contact the health insurance webservice to retrieve the driver&rsquo;s personal treatment plan for back massage and start moving the motors in certain intervals, to ease or prevent back pain during long driving periods.</p>
<p>This example focuses on the technical aspect, namely the interface between such an assumed application with the high-level logic, and the lower-level backend service (Seat Service), which controls the communication to the underlying hardware (Seat ECU). In this case, the Vehicle Signal Specification and the simple signal for seat position is used exemplarily. Safety considerations are not in scope for this example, but would probably be handled within the Seat ECU as the lowest level component to guard against non-safe use of the seat motors.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><img src="seatadjuster.png" alt="Leda Seat Adjuster Use Case"></p>
<ul>
<li>Cloud or mobile trigger: not part of the Leda image, but can be simulated by issueing MQTT messages</li>
<li>Eclipse Velocitas - Vehicle Application: <strong>Seat Adjuster</strong> (to be deployed by user as part of the Velocitas tutorial)</li>
<li>Eclipse Kuksa.VAL - Example Service: <strong>Seat Service</strong> (pre-installed)</li>
<li>Eclipse Kuksa.VAL - <strong>Data Broker</strong> (pre-installed)</li>
<li>Seat ECU and the separate Seat Motor hardware: not part of the Leda image, but can be emulated using virtual CAN-Bus. The Kuksa Seat Service container contains configuration options to use VCAN</li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ol>
<li>
<p>Follow the Velocitas tutorial: build and deploy your clone of the <a href="https://websites.eclipseprojects.io/velocitas/docs/about/use_cases/seat_adjuster/">seat adjuster example</a></p>
</li>
<li>
<p>Download and run the Leda quickstart image</p>
</li>
<li>
<p>Deploy your seat adjuster application to the container runtime, either manually by using <code>kanto-cm create</code> or by providing a deployment descriptor in <code>/var/containers/manifests</code>. An example deployment descriptor can be found in <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatservice.json">meta-leda-components</a>. Details on the deployment can be found in <a href="/leda/docs/app-deployment/velocitas/">Leda Vehicle Applications</a></p>
</li>
<li>
<p>Ensure the databroker and the seat service containers are running and you know how to check their log files</p>
</li>
<li>
<p>Publish an MQTT message for the seat adjuster application, e.g. <code>mosquitto_pub -t seatadjuster/setPosition/request -f seat-request.json</code> and a possible payload like this:</p>
<pre><code> {&quot;position&quot;: 300, &quot;requestId&quot;: &lt;request_id&gt;}
</code></pre>
</li>
</ol>
<h2 id="prototyping">Prototyping</h2>
<p>The pseudo-code for the Seat Adjuster application could look like the following excerpt from the <a href="https://digitalauto.netlify.app/model/997XF1ch2f5DjgPIzhY3/library/prototype/ZqhnonCBSSwP8ZVM7CFh/view/code">Digital.Playground example</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">sdv_model</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Vehicle</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vehicle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Vehicle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">on_user_profile_changed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Height</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#34;VerticalHeight&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Position</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Issuer</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#34;HorizontalPosition&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><p>In the next step, this prototype can be taken to the next level of implementation by using the <a href="https://github.com/eclipse-velocitas/vehicle-app-python-sdk/blob/main/examples/seat-adjuster/src/main.py#L81">Velocitas example</a> to express it like this, with possibly more logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@subscribe_topic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;seatadjuster/setPosition/request&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">on_set_position_request_received</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_str</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vehicle_speed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Speed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">vehicle_speed</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Vehicle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Cabin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Seat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Row1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Pos1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Position</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">position</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Set Seat position to: </span><span style="color:#4e9a06">{</span><span style="color:#000">position</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Failed to set the position </span><span style="color:#4e9a06">{</span><span style="color:#000">position</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, error: </span><span style="color:#4e9a06">{</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Exception on set Seat position&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">error_msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;&#34;&#34;Not allowed to move seat because vehicle speed
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        is </span><span style="color:#4e9a06">{</span><span style="color:#000">vehicle_speed</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> and not 0&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">error_msg</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">publish_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response_topic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response_data</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="testing-the-seatservice-example-container-on-the-leda-quickstart-image">Testing the seatservice-example container on the Leda Quickstart Image</h2>
<p>Whether you are running the seatservice-example with a simulated CAN or a physical (emulated) CAN, the seatservice-example container included in the Leda Quickstart image provides a simple client application that can be used to test the GRPC interface.</p>
<p>To set the seat position to <code>x%</code>, take <code>x*10</code> and truncate it to an integer <code>&lt;position&gt;</code>. Then using the sdv-ctr-exec script issue the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sdv-ctr-exec -n seatservice-example /app/bin/seat_svc_client &lt;position&gt;
</span></span></code></pre></div><p>You can now check the logs (either with <code>kanto-cm logs</code> or <code>kantui</code>) and you should be able to see the <code>seatservice-example</code> application responding to the command by moving the seat to the desired position.</p>
<h3 id="specifics-for-physical-emulated-can">Specifics for physical (emulated) CAN</h3>
<ol>
<li>
<p>You will have to generate initial CAN frames that will emulate the car ECU responding to the service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cangen -v can0 -L <span style="color:#0000cf;font-weight:bold">8</span> -I <span style="color:#0000cf;font-weight:bold">712</span> -D r -n <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>can0  712#4F.BF.B0.6B.5F.2D.54.09
</span></span><span style="display:flex;"><span>can0  712#13.2E.98.7E.77.11.99.5B
</span></span><span style="display:flex;"><span>can0  712#15.70.87.07.73.24.3A.7A
</span></span><span style="display:flex;"><span>can0  712#99.7F.F5.3F.FB.99.00.04
</span></span><span style="display:flex;"><span>can0  712#FE.1C.D5.55.22.86.3A.1F
</span></span></code></pre></div></li>
<li>
<p>You can now start tracing CAN frames written to the bus with <code>candump can0</code></p>
</li>
<li>
<p>From now on when a request to change the seat position is issued you will be able to see the corresponding CAN frames in the trace.</p>
</li>
</ol>
<p><em>Note</em>: On QEMU you can tunnel the host CAN bus to the guest: <a href="../../general-usage/running-qemu/canbus/#enabling-can-bus-interfaces-can">Tunneling a CAN Interface from the Host</a>.</p>
<h2 id="hardware-can-bus">Hardware CAN-Bus</h2>
<p>The default configuration of the <em>Seat Service</em> is using simulated VCAN. If you want to switch to a physical CAN-Bus interface, the container needs to have access to the CAN-Bus hardware.</p>
<p>Such a CAN-Bus device might be a Raspberry Pi setup with an MCP251x-based CAN-Hat extension or a QEMU image with an emulated <em>kvaser_pci</em> device (enabled on the Leda QEMU Quickstart images by default).</p>
<p>This setup would require some adjustments to the container manifest in order for the container to have access to the physical CAN-Bus.</p>
<ol>
<li>
<p>Make Seat Service container privileged and run on the host network interface:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;host_config&#34;</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Remove all port mappings and extra hosts (set <code>&quot;extra_hosts&quot;: []</code> and <code>&quot;port_mappings&quot;: []</code>) for the container as it&rsquo;s now running in host-networking mode (host_ip variable no longer available) and all ports are directly exposed.</p>
</li>
<li>
<p>Set the address to the databroker to <code>localhost:30555</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;BROKER_ADDR=127.0.0.1:30555&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Reconfigure the seat controller application to use the physical CAN interface, please see Eclipse Kuksa.VAL <a href="https://github.com/eclipse/kuksa.val.services/blob/main/seat_service/src/lib/seat_adjuster/seat_controller/README.md">seat_controller/README.md</a> for details:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#000">SC_CAN</span><span style="color:#ce5c00;font-weight:bold">=</span>can0
</span></span><span style="display:flex;"><span><span style="color:#000">CAN</span><span style="color:#ce5c00;font-weight:bold">=</span>can0
</span></span></code></pre></div><p>All the necessary changes combined for clarity as a single diff can be found below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#a40000">--- ../meta-leda-fork/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example_dev/seatservice.json	2023-03-06 11:32:00.771754434 +0200
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+++ seatservice-new.json	2023-03-06 11:37:12.967182044 +0200
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span><span style="color:#800080;font-weight:bold">@@ -14,26 +14,16 @@
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>    &#34;hooks&#34;: [],
</span></span><span style="display:flex;"><span>    &#34;host_config&#34;: {
</span></span><span style="display:flex;"><span>        &#34;devices&#34;: [],
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;network_mode&#34;: &#34;bridge&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;privileged&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        &#34;network_mode&#34;: &#34;host&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+        &#34;privileged&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        &#34;restart_policy&#34;: {
</span></span><span style="display:flex;"><span>            &#34;maximum_retry_count&#34;: 0,
</span></span><span style="display:flex;"><span>            &#34;retry_timeout&#34;: 0,
</span></span><span style="display:flex;"><span>            &#34;type&#34;: &#34;unless-stopped&#34;
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        &#34;runtime&#34;: &#34;io.containerd.runc.v2&#34;,
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;extra_hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            &#34;databroker-host:host_ip&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        ],
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        &#34;port_mappings&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            {
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;protocol&#34;: &#34;tcp&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;container_port&#34;: 50051,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_ip&#34;: &#34;localhost&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_port&#34;: 30051,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-              &#34;host_port_end&#34;: 30051
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            }
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        ],
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        &#34;extra_hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+        &#34;port_mappings&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        &#34;log_config&#34;: {
</span></span><span style="display:flex;"><span>            &#34;driver_config&#34;: {
</span></span><span style="display:flex;"><span>                &#34;type&#34;: &#34;json-file&#34;,
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">@@ -58,9 +48,11 @@
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>    },
</span></span><span style="display:flex;"><span>    &#34;config&#34;: {
</span></span><span style="display:flex;"><span>        &#34;env&#34;: [
</span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;BROKER_ADDR=databroker-host:30555&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;RUST_LOG=info&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-           &#34;vehicle_data_broker=info&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+            &#34;CAN=can0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;SC_CAN=can0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;BROKER_ADDR=127.0.0.1:30555&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;RUST_LOG=info&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            &#34;vehicle_data_broker=info&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>        ],
</span></span><span style="display:flex;"><span>        &#34;cmd&#34;: []
</span></span><span style="display:flex;"><span>    },
</span></span></code></pre></div></li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5505f58168fbe80d37b842b17c307c91">4.2 - Dog Mode</h1>
    
	<p>The <strong>Dog Mode</strong> use case has been derived from the <a href="https://websites.eclipseprojects.io/velocitas/docs/about/use_cases/dog_mode/">Eclipse Velocitas Dog Mode example</a> and the <a href="https://github.com/eclipse/kuksa.val.services/tree/main/hvac_service">Eclipse Kuksa.VAL HVAC Service example</a>.</p>
<h2 id="description">Description</h2>
<p>In the <strong>Dog Mode</strong> use case, an existing vehicle service (such as HVAC for Heating, Ventilation and Air Conditioning) is used for another use case.
When a driver enables the dog mode, the vehicle will keep the climate in a status to accomodates the pet while the driver is gone for a few minutes.</p>
<p>The focus on this example is to show how an additional application can reuse existing functionality for new use cases. The vehicle service being used does not need to be adapted for the new use case. The new use case is deployed as an additional functionality, separated from the rest of the existing system.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><img src="dogmode.png" alt="Leda Dog Mode Use Case"></p>
<ul>
<li>Cloud or mobile trigger: not part of the Leda image, but can be simulated by issueing MQTT messages</li>
<li>Eclipse Velocitas - Vehicle Application: <strong>Dog Mode</strong> (to be deployed by user as part of the Velocitas tutorial)</li>
<li>Eclipse Kuksa.VAL - Example Service: <strong>HVAC Service</strong> (pre-installed)</li>
<li>Eclipse Kuksa.VAL - <strong>Data Broker</strong> (pre-installed)</li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ol>
<li>
<p>Follow the Velocitas tutorial: build and deploy your clone of the <a href="https://websites.eclipseprojects.io/velocitas/docs/about/use_cases/dog_mode/">dog mode example</a></p>
</li>
<li>
<p>Download and run the Leda quickstart image</p>
</li>
<li>
<p>Deploy the application to the container runtime, either manually by using <code>kanto-cm create</code> or by providing a deployment descriptor in <code>/var/containers/manifests</code>. An example deployment descriptor can be found in <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/seatservice.json">meta-leda-components</a>. Details on the deployment can be found in <a href="/leda/docs/app-deployment/velocitas/">Leda Vehicle Applications</a></p>
</li>
<li>
<p>Ensure the databroker and the service containers are running and you know how to check their log files</p>
</li>
<li>
<p>Monitor vehicle data: <code>mosquitto_sub -t dogmode/display</code></p>
</li>
<li>
<p>Enable dog mode by using the <code>databroker-cli</code></p>
<pre><code> connect
 set Vehicle.Cabin.DogMode 1
</code></pre>
</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3883f410544279ff57519024d0f51858">4.3 - Kuksa Databroker</h1>
    
	<p>To generically interact with the Vehicle Signals which are managed in the Eclipse Kuksa.VAL Databroker,
you can either use the natively installed <code>databroker-cli</code> command line tool, or use the CLI tool from an updated and released containerized image.</p>
<h2 id="kuksa-databroker-cli">Kuksa Databroker CLI</h2>
<p>To install a new version of the Kuksa Databroker CLI container, follow these steps:</p>
<ol>
<li>
<p>Create the container in Kanto:</p>
<pre><code> kanto-cm create --i --t --network=host --name=databroker-cli ghcr.io/eclipse/kuksa.val/databroker-cli:master
</code></pre>
</li>
<li>
<p>Start the command line tool within a container in interactive mode:</p>
<pre><code> kanto-cm start --a --i --name databroker-cli
</code></pre>
</li>
<li>
<p>In the databroker shell, connect to the databroker via the URL <code>http://127.0.0.1:30555/</code>:</p>
<pre><code> connect http://127.0.0.1:30555/
</code></pre>
</li>
</ol>
<p><img src="kuksa-databroker-cli.png" alt="Kuksa Databroker CLI Container"></p>
<h2 id="kuksa-client">Kuksa Client</h2>
<p>To install a new version of the Kuksa Client container, follow these steps:</p>
<ol>
<li>
<p>Create the container in Kanto Namespace:</p>
<pre><code> ctr --namespace kanto-cm container create --net-host --tty ghcr.io/eclipse/kuksa.val/kuksa-client:master kuksa-client
</code></pre>
</li>
<li>
<p>Start the container in detached mode:</p>
<pre><code> ctr --namespace kanto-cm tasks start --detach kuksa-client
</code></pre>
</li>
<li>
<p>Start the command line tool with additional command line options:</p>
<pre><code> ctr --namespace kanto-cm tasks exec --tty --exec-id sometask kuksa-client /kuksa-client/bin/kuksa-client --port 30555 --protocol grpc --insecure
</code></pre>
</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f8e31fb834452efdebda21d1bf86969">4.4 - Velocitas VApps</h1>
    
	<p>For local deployment without a cloud backend, deployment specifications for <a href="https://projects.eclipse.org/projects/automotive.velocitas">Eclipse Velocitas</a> Vehicle Apps may be put directly onto the device.</p>
<ul>
<li>Create a Kanto deployment specification for your vehicle app. You may copy one of the existing JSON files in <code>/data/var/containers/manifests</code> as a template</li>
<li>Copy the specification file to the device, e.g. <code>scp -P 2222 myapp.json root@localhost:/data/var/containers/manifests/</code></li>
<li>Apply the specification: <code>systemctl restart kanto-auto-deployer</code></li>
</ul>
<p>To update an existing container when the configuration has changed, delete the container and restart kanto-auto-deployer:</p>
<pre><code>kanto-cm remove -n myapp-example
# Edit /data/var/containers/manifests/myapp.json
kanto-auto-deployer
</code></pre>
<h2 id="example-deployment-specification">Example Deployment Specification</h2>
<blockquote>
<p>Attention: The current implementation requires all fields to be present in the JSON, even if the values are not set or used. Do not remove any fields, as it may break the functionality.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myapp-example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;image&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/my-org/my-repo/my-app:latest&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;decrypt_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;domain_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;resolv_conf_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hostname_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;mounts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hooks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;devices&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restart_policy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;maximum_retry_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;retry_timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;unless-stopped&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;runtime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;io.containerd.runc.v2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;extra_hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;port_mappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;container_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30151</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_ip&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50151</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port_end&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50151</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;log_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;driver_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;json-file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_files&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;100M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;root_dir&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;mode_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;blocking&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_buffer_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;resources&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;io_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stderr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;open_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;stdin_once&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;tty&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;VEHICLEDATABROKER_DAPR_APP_ID=vehicledatabroker&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;network_settings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;started_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exit_code&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;finished_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exited&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;dead&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restarting&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;paused&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;running&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;oom_killed&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;created&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;manually_stopped&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;restart_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-03ddd8c0f79b13ee47ac2332bd2c2a23">4.5 - Cloud2Device Messages</h1>
    
	<p><img src="c2d-architecture-overview.png" alt="c2d-overview"></p>
<p>In order to verify that the device and the cloud connector can successfully receive messages sent by the cloud backend, we will send a dummy message to the device.</p>
<h2 id="pre-requisites">Pre-Requisites</h2>
<ul>
<li>Device is up and running, e.g by <a href="/leda/docs/general-usage/running-qemu/">running in qemu</a></li>
<li>Eclipse Leda has successfully booted</li>
<li>The device has been provisioned and configured, see <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h2 id="validating-configuration">Validating configuration</h2>
<p>First, let&rsquo;s check that the cloud connection is active.</p>
<ul>
<li>
<p>Login as <code>root</code></p>
</li>
<li>
<p>Run sdv-health and check for the <em>SDV Connectivity</em> section:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sdv-health
</span></span></code></pre></div><p><img src="sdv-health-connectivity.png" alt="sdv-health-connectivity"></p>
</li>
<li>
<p>Start watching the output of the cloud connector:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kantui
</span></span></code></pre></div></li>
<li>
<p>Select the <code>cloud-connector</code> container and press <code>L</code> to watch the logs</p>
<blockquote>
<p><em>Note:</em> When an unknown type of message is received, the cloud connector will log an error:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>2022/04/13 16:04:41.911727  [agent]  ERROR  Handler returned error err=&#34;cannot deserialize cloud message: invalid character &#39;H&#39; looking for beginning of value
</span></span></code></pre></div></blockquote>
</li>
<li>
<p>Start watching on the MQTT message broker:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mosquitto_sub -h localhost -t <span style="color:#4e9a06">&#39;#&#39;</span> --pretty -v
</span></span></code></pre></div><blockquote>
<p><em>Note:</em> When a known type of message is received, the cloud connector will forward the message to the MQTT broker into the corresponding topic <code>$appId/$cmdName</code></p>
</blockquote>
</li>
</ul>
<h2 id="sending-a-device-message">Sending a Device Message</h2>
<ul>
<li>Go to the Web Console of Azure IoT Hub</li>
<li>Select the device</li>
<li>Click on &ldquo;Send Message&rdquo;</li>
<li>Enter a C2D payload and click &ldquo;Send&rdquo;</li>
</ul>
<p>Alternatively, on command line, use the Azure CLI client. Replace <code>DeviceId</code> and <code>IotHubName</code> with the appropriate names of your IoT Hub and device.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>az iot device c2d-message send <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --device-id <span style="color:#4e9a06">${</span><span style="color:#000">DeviceID</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --hub-name <span style="color:#4e9a06">${</span><span style="color:#000">IotHubName</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> --data <span style="color:#4e9a06">&#39;Hello World&#39;</span>
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-398dfd1255dbe9b0d599725455290ea5">5 - Incubator</h1>
    
	<p>The <a href="https://projects.eclipse.org/proposals/eclipse-leda-incubator">Leda Incubator project</a> is a place for new software-defined-vehicle related software components which are in incubation state.</p>
<p>The goal of the Eclipse Leda Incubator is to foster collaboration in the Eclipse Software Defined Vehicle (SDV) ecosystem, and hopefully results in work proceeding to contribution by their original authors into upstream projects. The Eclipse Leda Incubator would not make any releases itself.</p>
<p>The project hosts software-defined vehicle components which are fitting into the general Eclipse Leda scope, but do not fit to either being part of Leda itself, which should be upstreamed into other projects in the future, or which are still highly experimental and should not be considered for any kind of production use.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b4a440823c85f6076c29cce9db342b9">5.1 - Cloud Connector</h1>
    
	<p>The cloud connector is used in the context of <a href="/leda/docs/device-provisioning/">Device Provisioning</a> and cloud backend connectivity.</p>
<h2 id="overview">Overview</h2>
<p>Leda Cloud Connector for Azure IoT Hub is a fork (extended and adapted) of the generic <a href="https://github.com/eclipse-kanto/azure-connector">Eclipse Kanto&rsquo;s Azure connector</a> that is being able to process cloud-to-device and device-to-cloud messages as defined for the Software-Defined Vehicle cloud backend.</p>
<p><img src="./cloud-connector-fork.png" alt="Cloud Connector Fork Relationship"></p>
<h2 id="runtime">Runtime</h2>
<p>The SDV cloud connector will come up with pluggable architecture that will allow easy <strong>transformation of the incoming cloud-to-device command messages (SDV message envelope) to a format suitable and understandable by the rest of the in-vehicle components</strong> and vice-versa. It shall be possible to map SDV messages to and from <a href="https://www.eclipse.org/hono/docs/concepts/connecting-devices/">Eclipse Hono</a> and <a href="https://www.eclipse.org/ditto/">Eclipse Ditto</a> messages using simple configuration, rules written in JSON; thus allowing this component to work together with other <a href="https://websites.eclipseprojects.io/kanto/">Eclipse Kanto</a> components too.</p>
<p><img src="./cloud-connector-runtime.png" alt="Cloud Connector Runtime View"></p>
<h2 id="source-repository">Source Repository</h2>
<p>Source Repository: <a href="https://github.com/eclipse-leda/leda-contrib-cloud-connector">https://github.com/eclipse-leda/leda-contrib-cloud-connector</a></p>
<h2 id="building-and-deployment">Building and Deployment</h2>
<p>The Cloud Connector can either be installed natively into the system image by using the respective Yocto recipe <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/leda-contrib-cloud-connector_git.bb">leda-contrib-cloud-connector_git.bb</a>, or the cloud connector can be deployed as a <a href="https://github.com/eclipse-leda/leda-contrib-cloud-connector/pkgs/container/leda-contrib-cloud-connector%2Fcloudconnector">container</a>.</p>
<h3 id="native-installation">Native Installation</h3>
<p>A native installation has the advantage that no additional container runtime is required. In some vehicle system architectures, there are separate devices for connectivity and for general computation. The actual physical device for connectivity may hence have less ressources available which then requires a native installation of such core components.</p>
<ul>
<li>Add the recipe to the image in your Yocto configuration:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    <span style="color:#000">IMAGE_INSTALL</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;leda-contrib-cloud-connector&#34;</span>
</span></span></code></pre></div><ul>
<li>Override the configuration in <code>/etc/cloud-connector/config.json</code></li>
<li>Create the device certificate</li>
<li>The cloud-connector can be managed (start, stop, restart) using systemd: <code>systemctl restart cloud-connector</code></li>
</ul>
<h3 id="container-installation">Container Installation</h3>
<p>When the connectivity components can be deployed on the more generic compute module, where a container runtime is available, the cloud connector can also be deployed as a container. This is the default for the Eclipse Leda quickstart images.</p>
<p>Initial deployment and configuration steps are:</p>
<ul>
<li>On first start, the auto deployment will deploy and start the cloud connector container automatically, but with invalid default values or missing device certificates.</li>
<li>The user needs to adapt the device authentication to suit his needs, e.g. creating and providing a device certificate. Check the <code>/data/containers/cloud-connector.json</code> deployment descriptor for the correct location of the certificate files.</li>
<li>After this configuration has been done once, the container needs to be restarted using the Kanto CLI: <code>kanto-cm restart -n cloud-connector</code></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fc286619fc6255e040c8b84e5617d350">5.2 - Self Update Agent</h1>
    
	<p>The self update agent is used in the context of <a href="/leda/docs/device-provisioning/self-update/">OTA Self Updates</a>.</p>
<h2 id="overview">Overview</h2>
<p>The Self Update Agent (SUA) as part of the <a href="https://projects.eclipse.org/projects/automotive.leda.ledaincubator/reviews/creation-review">Eclipse Leda Incubator project proposal</a> is a software component responsible for <strong>performing updates of system-level components of the connectivity device</strong>, such as</p>
<ul>
<li>Boot Loader</li>
<li>Operating System</li>
<li>Device Firmware</li>
<li>Hardware Drivers</li>
<li>&hellip; other parts of the system, which cannot be deployed as containerized packages or may require a reboot of the device.</li>
</ul>
<p><img src="./self-update-agent-arch.png" alt="Self Update Agent Scope"></p>
<h2 id="implementation-and-deployment">Implementation and Deployment</h2>
<p>SUA is using the RAUC framework via D-Bus calls, but it is designed in a way that switching to other updating solution shall be possible. SUA may be controlled by an external higher-level orchestration component via defined MQTT messages, which carry necessary for update data, such as version and URL of the update bundle. Update process feedback and the end result are also communicated via defined MQTT messages. Software Update Agent is implemented in C++ and configured to be running inside of a container.</p>
<p><img src="./self-update-agent-deploy.png" alt="Self Update Agent Runtime Deployment Diagram"></p>
<h2 id="building">Building</h2>
<p>SUA can either be installed natively into the system image by using the respective Yocto recipe <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/leda-contrib-self-update-agent_git.bb">leda-contrib-self-update-agent_git.bb</a>, or can be deployed as a <a href="https://github.com/eclipse-leda/leda-contrib-self-update-agent/pkgs/container/leda-contrib-self-update-agent%2Fself-update-agent">container</a>.</p>
<h3 id="native-installation">Native Installation</h3>
<p>A native installation has the advantage that no additional container runtime is required. In some vehicle system architectures, there are separate devices for connectivity and for general computation. The actual physical device for connectivity may hence have less ressources available which then requires a native installation of such core components.</p>
<ul>
<li>Add the recipe to the image in your Yocto configuration:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    <span style="color:#000">IMAGE_INSTALL</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;leda-contrib-self-update-agent&#34;</span>
</span></span></code></pre></div><ul>
<li>The self update agent can be managed (start, stop, restart) using systemd: <code>systemctl restart self-update-agent</code></li>
</ul>
<h3 id="container-installation">Container Installation</h3>
<p>When the component can be deployed on the more generic compute module, where a container runtime is available, the self update agent can also be deployed as a container. This is the default for the Eclipse Leda quickstart images.</p>
<p>Initial deployment and configuration steps are:</p>
<ul>
<li>On first start, the auto deployment will deploy and start the self update agent container automatically.</li>
<li>The self update agent will then connect to the locally running mosquitto server, awaiting update requests.</li>
<li>The default configuration will use the location <code>/data/selfupdates/</code> to write and read update files.</li>
</ul>
<h2 id="source-repository">Source Repository</h2>
<p>Source Repository: <a href="https://github.com/eclipse-leda/leda-contrib-self-update-agent">https://github.com/eclipse-leda/leda-contrib-self-update-agent</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ba7b0fe252eaa23930a5b08ea12893eb">5.3 - Vehicle Update Manager</h1>
    
	<p>The vehicle update manager is used in the context of <a href="/leda/docs/device-provisioning/vehicle-update-manager">OTA Software Updates</a>.</p>
<h2 id="overview">Overview</h2>
<p>Vehicle Update Manager (VUM) is an extended version of the <a href="https://github.com/eclipse-kanto/container-management">Eclipse Kanto Container Manager</a> that is being able to <strong>handle new desired state for the software on the whole vehicle device</strong>.</p>
<p><img src="./vehicle-update-manager-arch.png" alt="Vehicle Update Manager Scope"></p>
<h2 id="implementation">Implementation</h2>
<p>The desired state comes as a multi document YAML content and it includes a list of container resources:</p>
<ul>
<li>Container</li>
<li>Configuration</li>
</ul>
<p>VUM detects the system-level update custom resource and passes it for further processing to the <a href="/leda/docs/leda-incubator/self-update-agent/">Self Update Agent</a>.</p>
<p>VUM also monitors the self-update agent and the control plane, and compiles and report the current state of the device.</p>
<h2 id="source-repository">Source Repository</h2>
<p>Source Repository: <a href="https://github.com/eclipse-leda/leda-contrib-vehicle-update-manager">https://github.com/eclipse-leda/leda-contrib-vehicle-update-manager</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-529a2058d55821d1c7fd93c5ece87d4c">6 - Building Leda</h1>
    
	<p>Running BitBake to build your own images requires some extra setup on the build machine. Please see the following chapters for more information about the build process itself and how to setup a development and build infrastructure.</p>
<p><img src="build-terminal.png" alt="Build Shell"></p>
<p>If you are interested to contribute or to get in touch with us, please see our <a href="/leda/docs/project-info/community/">Community</a> pages and <a href="/leda/docs/project-info/contribution-guidelines/">Contribution Guidelines</a>.</p>
<p>For reporting security vulnerabilities, please follow our <a href="/leda/docs/project-info/security/">Security Policy</a>.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5a114e9c0d2f593adb6abac02f868f4c">6.1 - Concepts</h1>
    
	<p>The example build configurations in this repository are based on the official <a href="https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html">BitBake Quickstart tutorial</a> and have been extended to include Leda SDV components.</p>
<h2 id="build-setup">Build Setup</h2>
<p>To set up your own BitBake build configuration, follow the BitBake documentation and include <code>meta-leda</code> in your <code>bblayers.conf</code> and add the SDV packages into your <code>local.conf</code>.</p>
<p>The Leda build is mainly using the kas tool for a simplified maintenance of the BitBake Configuration files. The kas configuration files are located in <code>kas/</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">header</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">distro</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">leda</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">machine</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">qemux86-64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">target</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sdv-image-all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repos</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">meta-leda</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://github.com/eclipse-leda/meta-leda&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">refspec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">layers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-bsp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-components</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">meta-leda-distro</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="leda-metalayer">Leda Metalayer</h2>
<p>The <code>meta-leda</code> layer conatins the BitBake Classes and Recipes to integrate SDV Components into a BitBake based build setup.</p>
<p>Please see <a href="https://github.com/eclipse-leda/meta-leda">https://github.com/eclipse-leda/meta-leda</a> for more information.</p>
<h2 id="recipes-for-containerized-components">Recipes for containerized components</h2>
<p>The SDV.EDGE stack is based on a containerized architecture and the intention is to have as much components containerized as possible, to ensure a high degree of isolation and updateability. To ensure some degree of flexibility and control, certain core components may also be installed as native services.</p>
<p>To automatically deploy the containers of the SDV reference implementation and example applications and services, the build configurations will deploy a couple of deployment specifiction files into the auto-deployment folder <code>/data/var/containers/manifests</code>.</p>
<p>At start time, these containers will be automatically deployed:</p>
<ul>
<li>Cloud Connector</li>
<li>Self Update Agent</li>
<li>Vehicle Update Manager</li>
<li>Vehicle API / Vehicle Abstraction Layer
<ul>
<li>Data Broker (Eclipse Kuksa)</li>
<li>Example Seat Service (CAN-bus implementation)</li>
</ul>
</li>
</ul>
<p>For a full list of containers, see <code>meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers</code></p>
<h2 id="recipes-for-containerized-applications">Recipes for containerized applications</h2>
<p>OpenEmbedded&rsquo;s <a href="https://layers.openembedded.org/layerindex/branch/master/layer/meta-virtualization/">meta-virtualization</a> already contains some recipes and reusabled classes for building virtualization and containerized applications.</p>
<p><code>meta-leda</code> extends that functionality by using <code>skopeo</code> to package container images. To minimize the runtime requirements (dependencies, disk usage), an approach to pre-load container images and its layers directly into the content storage of the container runtime is followed.</p>
<h2 id="building-containers-with-yocto">Building containers with Yocto</h2>
<p>For components which can either be installed natively or as container, it can be beneficial to build these containers using Yocto as well. An example is in <code>meta-leda-distro-container/recipes-sdv/sdv-containers/cyclonedds-example-container_0.1.bb</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83c252b9f9f1de95e6f3ad59a0779c80">6.2 - Metalayer</h1>
    
	<h2 id="initializing-bitbake-environment">Initializing BitBake environment</h2>
<p>Initialize the build environment and start the build for QEMU:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas build kas/leda-qemux86-64.yaml
</span></span></code></pre></div><h2 id="building-specific-recipes">Building specific recipes</h2>
<p>General usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas build kas/leda-qemux86-64.yaml --target &lt;recipename&gt;
</span></span></code></pre></div><h2 id="metalayer-structure">Metalayer Structure</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span> meta-leda-bsp
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-bsp                  // Board Support Packages, eg specifics for QEMU and Raspberry Pi
</span></span><span style="display:flex;"><span> meta-leda-components
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-sdv
</span></span><span style="display:flex;"><span>   |-- eclipse-leda               // Build recipes for Eclipse Leda Incubator components
</span></span><span style="display:flex;"><span>   |-- eclipse-kuksa              // Build recipes for Eclipse Kuksa
</span></span><span style="display:flex;"><span>   |-- eclipse-cyclonedds         // Build recipes for Eclipse CycloneDDS
</span></span><span style="display:flex;"><span>   |-- northstar                  // Build recipes for Northstar Container Runtime
</span></span><span style="display:flex;"><span>   |-- packagegroups              // Grouping packages
</span></span><span style="display:flex;"><span>   \-- sdv-base                   // SDV Base Bundle: fstab, can0.network
</span></span><span style="display:flex;"><span>     |--- base-files
</span></span><span style="display:flex;"><span>     |--- SDV Core Utilities
</span></span><span style="display:flex;"><span>     \--- SDV Utilities
</span></span><span style="display:flex;"><span>   |-- sdv-containers             // Container images recipes for pre-caching / airgap installation
</span></span><span style="display:flex;"><span>     |--- Cloud Agent
</span></span><span style="display:flex;"><span>     |--- Data Broker
</span></span><span style="display:flex;"><span>     |--- Feeder CAN
</span></span><span style="display:flex;"><span>     |--- OTel Collector
</span></span><span style="display:flex;"><span>     |--- Self Update Agent
</span></span><span style="display:flex;"><span>     |--- Vehicle Update manager
</span></span><span style="display:flex;"><span>     |--- Example Seat Service
</span></span><span style="display:flex;"><span>     \--- ...
</span></span><span style="display:flex;"><span>   |-- sdv-core                   // SDV Core Bundle
</span></span><span style="display:flex;"><span>     |--- SDV RAUC Bundle         // RAUC Update Bundle Manifest
</span></span><span style="display:flex;"><span>   \-- tools                      // Convenience tools for the &#34;full&#34; image, eg nerdctl and kantui
</span></span><span style="display:flex;"><span> meta-leda-distro
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-containers           // Container related configuration recipes (containerd, nerdctl)
</span></span><span style="display:flex;"><span> \-- recipes-core                 // Core recipes (base-files, systemd)
</span></span><span style="display:flex;"><span> \-- recipes-kernel               // Kernel configuration, eg kernel modules, logging, virtio
</span></span><span style="display:flex;"><span> \-- recipes-sdv-distro           // Image definitions
</span></span><span style="display:flex;"><span> \-- wic                          // WIC Kickstarter files - Partition layouts
</span></span><span style="display:flex;"><span>meta-leda-distro-container
</span></span><span style="display:flex;"><span> \-- classes                      // Reusable BitBake Classes, eg for offline container image pre-caching
</span></span><span style="display:flex;"><span> \-- conf                         // Distribution specific configurations, eg version numbers, release codename
</span></span><span style="display:flex;"><span> \-- recipes-sdv                  // Build containers with Yocto
</span></span></code></pre></div><h2 id="base-bundle">Base Bundle</h2>
<p>Contains the recipes to build and install the minimal set of dependencies for the SDV stack on the edge device. With these minimal components, the SDV stack should be able to bootstrap itself.</p>
<h3 id="can-bus-kernel-configuration">CAN-Bus Kernel Configuration</h3>
<p>To enable support for CAN bus related modules, the kernel needs to be reconfigured. This is done by the <code>sdv-canbus-modules.inc</code> include file in the <code>recipes-kernel/linux</code> folder, which patches Poky&rsquo;s <code>linux-yocto</code> recipe.</p>
<p>Verifying and displaying the current kernel configuration: <code>bitbake -e virtual/kernel</code></p>
<p>To verify the recipe and the kernel configuration: <code>bitbake linux-yocto -c kernel_configcheck -f</code></p>
<p>The kernel config file can be found in:
<code>./tmp/work/qemux86_64-poky-linux/linux-yocto/*/linux-qemux86_64-standard-build/.config</code></p>
<h2 id="core-bundle">Core Bundle</h2>
<p>Contains the recipes to build and install additional SDV components, which are required for a proper runtime setup.</p>
<h2 id="containers">Containers</h2>
<p>Contains the recipes for pre-installing specific containers into the container management at runtime. This is mainly for pre-caching container image layers onto the device to speed up the initial deployment but can also be used to enable offline usecases.</p>
<h2 id="build-host-system-requirements">Build Host System Requirements</h2>
<ul>
<li>Yocto Project 4.0 (kirkstone) or higher</li>
<li>100GB+ free disk space per build configuration</li>
<li>Online connection for fetching sources and container images</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6bebc82bbfd98602300c719ed32319de">6.3 - Setup development environment</h1>
    
	<p>There are multiple variants on how to set up a build environment:</p>
<ul>
<li>with <a href="/leda/docs/build/devenv/github-codespaces/">GitHub Codespaces</a> - recommended for developers with restricted internet access, such as corporate proxies, or with Windows hosts</li>
<li>with <a href="/leda/docs/build/devenv/vscode-devcontainer/">VSCode DevContainer</a> - recommended for Linux hosts</li>
<li>Custom setup - for teams</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f489e253846ca9247a8d639e81213fab">6.3.1 - Codespaces</h1>
    
	<h1 id="setting-up-development-environment-in-github-codespaces">Setting up Development Environment in GitHub Codespaces</h1>
<h2 id="install-the-github-codespaces-extension">Install the GitHub Codespaces Extension</h2>
<p><em>Note:</em> When using our DevContainer, the <em>GitHub Codespaces</em> extension is pre-installed.</p>
<ul>
<li>Start VSCode</li>
<li>Go to <em>Extensions</em></li>
<li>Search for &ldquo;GitHub Codespaces&rdquo;</li>
<li>Click <em>Install</em></li>
</ul>
<p>Alternatively, create a new codespace via the GitHub web interface:</p>
<p><img src="github-code-new-codespace.png" alt=""></p>
<p>Select a big enough machine type for Yocto/BitBake, e.g. 16 CPU. You need at leasst 50GB disk space.</p>
<p><img src="github-codespaces-remote-explorer.png" alt=""></p>
<h2 id="building-leda-in-a-github-codespace">Building Leda in a Github Codespace</h2>
<p>After successfully obtaining and connecting to a codespace you can build Leda either with kas or manually:</p>
<ul>
<li>
<p>To build with kas follow the instructions at: <a href="/leda/docs/build/devenv/build-kas-manually/#building-with-kas">Building with kas</a></p>
</li>
<li>
<p>To build manually: <a href="/leda/docs/build/devenv/build-kas-manually/#building-manually">Building manually</a></p>
</li>
</ul>
<h2 id="private-repositories">Private Repositories</h2>
<p>When using GitHub Codespaces with submodules and private repositories,
a separate tool for git authentication is required (see <a href="https://github.com/microsoft/vscode/issues/109050">VSCode issue #109050</a>), as the authentication token provided to the GitHub Codespaces virtual machine only allows access to the main repository.</p>
<p>Git Credential Manager:
<a href="https://aka.ms/gcm">https://aka.ms/gcm</a></p>
<p>Installation:</p>
<pre tabindex="0"><code>curl -LO https://raw.githubusercontent.com/GitCredentialManager/git-credential-manager/main/src/linux/Packaging.Linux/install-from-source.sh &amp;&amp;
sh ./install-from-source.sh &amp;&amp;
git-credential-manager-core configure
</code></pre>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-71f44dd882af01efbed1f4ad8361d98b">6.3.1.1 - Advanced topics</h1>
    
	<h2 id="git-authentication">Git Authentication</h2>
<p>For private repositories, we need to separately authenticate against the submodule repositories, as
GitHub Codespaces will only inject a token with access rights to the current repository.</p>
<ol>
<li>
<p>Change to the users home directory</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~
</span></span></code></pre></div></li>
<li>
<p>Install <a href="https://github.com/GitCredentialManager/git-credential-manager">Git Credential Manager</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://raw.githubusercontent.com/GitCredentialManager/git-credential-manager/main/src/linux/Packaging.Linux/install-from-source.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>sh ./install-from-source.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>git-credential-manager-core configure
</span></span></code></pre></div></li>
<li>
<p>Configure a credential store typ, e.g. <code>git config --global credential.credentialStore plaintext</code></p>
</li>
<li>
<p>Verify with <code>git config --global -l</code>, it should show git-credential-manager-core as the credential helper.</p>
</li>
</ol>
<h2 id="update-the-submodules">Update the submodules</h2>
<p>Run <code>git submodule update --recursive</code></p>
<p>See <a href="https://github.com/microsoft/vscode/issues/109050">VSCode Issue #109050</a> for details.</p>
<h2 id="setup-skopeo">Setup skopeo</h2>
<p>Skopeo is needed to download various files during the build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /run/containers/1000
</span></span><span style="display:flex;"><span>sudo chmod a+w /run/containers/1000
</span></span><span style="display:flex;"><span>skopeo login ghcr.io --authfile ~/auth.json --username &lt;your GitHub User&gt; 
</span></span></code></pre></div><p>Enter your token when asked for the password.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c93bbe2b4afa4f696fe56387e16376bc">6.3.2 - GitHub Runner</h1>
    
	<h1 id="create-a-new-github-runner-for-this-repo">Create a new GitHub Runner for this repo</h1>
<p>Start with creating a new azure VM:</p>
<ul>
<li>Ubuntu Server Latest, currently 20.04</li>
<li>Size Standard D16ds v5</li>
<li>The admin user should be called &ldquo;runner&rdquo;</li>
</ul>
<p>Once the VM is ready:</p>
<ol>
<li>Stop the VM</li>
<li>Go to &ldquo;Disk&rdquo; and resize the OS disk to 512 GB</li>
<li>Start the VM again</li>
</ol>
<h1 id="run-the-script-to-setup-the-runner">Run the script to setup the runner</h1>
<p>Log on to the VM as runner. Either copy the <code>scripts/PrepVMasGHRunner.sh</code> onto the VM or create a new script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nano prep.sh
</span></span></code></pre></div><p>Copy the content of the PrepVMasGHRunner.sh from this repo into the new file, save it and make it executable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod <span style="color:#0000cf;font-weight:bold">755</span> prep.sh
</span></span></code></pre></div><p>Call it with the token and the next available nummer, see below how to get this items:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./prep.sh <span style="color:#4e9a06">&#34;ASYVOMU........DTCFCMBA&#34;</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><p>In the Azure portal go the VM, go to the &ldquo;network&rdquo; section and delete the rule opening port 22.
Congratulation, you are done!</p>
<h1 id="how-to-get-the-token-and-the-number-to-call-the-script">How to get the token and the number to call the script</h1>
<p>In the repo, go to &ldquo;Settings&rdquo; -&gt; &ldquo;Actions&rdquo;. You see the currently provisioned runners:</p>
<p><img src="nextnumber.png" alt="Alt text" title="Find next number"></p>
<p>Pick the next number and pass it to the script.</p>
<p>To get the token press the green button in the above screenshot. The token is in the command:</p>
<p><img src="token.png" alt="Alt text" title="Get the token"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd5aea642d95644a121fa3b9232f771f">6.3.3 - VSCode DevContainer</h1>
    
	<h2 id="preparation">Preparation</h2>
<ul>
<li>Obtain the <a href="https://docs.docker.com/engine/install/">Docker Engine</a> for your distribution and add your non-privileged user to the docker group (<code>sudo usermod -aG docker $USER</code> )</li>
<li>Install <a href="https://code.visualstudio.com/download">Visual Studio Code</a></li>
</ul>
<h2 id="visual-studio-code-development-containers">Visual Studio Code: Development Containers</h2>
<ul>
<li>Open Visual Studio Code</li>
<li>Open Command Palette (<code>F1</code>) and select <code>Clone repository in Container Volume</code></li>
<li>Select <code>eclipse-leda/meta-leda</code> and the main branch.</li>
<li>Adapt proxy configurations if necessary (<code>.devcontainer/proxy.sh</code>)</li>
</ul>
<p><em>For a clean remote build machine, you may want to <a href="/leda/docs/build/devenv/github-codespaces/">set up a development environment on GitHub CodeSpaces</a></em></p>
<h2 id="building-leda-in-a-vscode-devcontainer">Building Leda in a VSCode DevContainer:</h2>
<p>After successfully setting up your DevContainer you can build Leda either with kas or manually:</p>
<ul>
<li>
<p>To build with kas follow the instructions at: <a href="/leda/docs/build/devenv/build-kas-manually/#building-with-kas">Building with kas</a></p>
</li>
<li>
<p>To build manually: <a href="/leda/docs/build/devenv/build-kas-manually/#building-manually">Building manually</a></p>
</li>
</ul>
<h2 id="authentication">Authentication</h2>
<p>The build process requires online connection and you must be authenticated to access private repositories.</p>
<ol>
<li>Create a GitHub Personal Access Token (PAT) at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> and grant <code>read:packages</code> permission</li>
<li>Use <code>Configure SSO</code> and authorize your PAT for the organization</li>
<li>On the build host, authenticate to ghcr.io: <code>skopeo login ghcr.io --authfile ~/auth.json --username &lt;username&gt;</code> and enter the PAT as password
<ul>
<li>You may need to create the folder where skopeo is storing authentication information beforehand:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /run/containers/1000
</span></span><span style="display:flex;"><span>sudo chmod a+w /run/containers/1000
</span></span></code></pre></div></li>
<li>Start the bitbake build process</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a56f201c9d821bac8e46a01e6750e56c">6.3.4 - Building with kas/manually</h1>
    
	<p>After setting up your <a href="/leda/docs/build/devenv/vscode-devcontainer/">VSCode DevContainer</a> or <a href="/leda/docs/build/devenv/github-codespaces/">GitHub Codespace</a> you can proceed with the actual build process. Here you have two choices - either using the kas-build system or setting up the build manually.</p>
<h2 id="building-with-kas">Building with kas</h2>
<p>This is the easiest way to build leda semi-automatically</p>
<ul>
<li><code>cd /workspaces/meta-leda-fork/</code></li>
<li>Open the VSCode terminal and run <code>kas build</code></li>
<li><strong>Note: you can alter the build options by modifying the .config.yaml file in the trunk of the repository</strong></li>
</ul>
<h2 id="building-manually">Building manually</h2>
<p>You can also build Leda manually if more customization of the build process is required.</p>
<ul>
<li>
<p><code>export LEDA_WORKDIR=/workspaces/meta-leda-fork/</code></p>
</li>
<li>
<p><code>cd ${LEDA_WORKDIR}</code></p>
</li>
<li>
<p>Clone the Poky repository with the required release, e.g. <code>kirkstone</code> and pull updates if necessary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone git://git.yoctoproject.org/poky
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> poky
</span></span><span style="display:flex;"><span>git checkout -t origin/kirkstone -b kirkstone
</span></span><span style="display:flex;"><span>git config pull.rebase <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>git pull
</span></span></code></pre></div></li>
<li>
<p>Prepare the build environment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">source</span> oe-init-build-env
</span></span></code></pre></div></li>
<li>
<p>Dry-run a build of the Linux Kernel recipe using BitBake:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bitbake --dry-run linux-yocto
</span></span></code></pre></div></li>
<li>
<p>Checkout the meta-layer dependencies for Leda:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#000">$LEDA_WORKDIR</span>
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://github.com/rauc/meta-rauc.git meta-rauc
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://github.com/rauc/meta-rauc-community.git meta-rauc-community
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://git.yoctoproject.org/meta-virtualization meta-virtualization
</span></span><span style="display:flex;"><span>git clone -b kirkstone https://git.openembedded.org/meta-openembedded meta-openembedded
</span></span></code></pre></div></li>
<li>
<p>Change to the <code>poky/build</code> directory (generated from the <code>oe-init-build-env</code> script automatically)</p>
</li>
<li>
<p>Add all the necessary meta-layers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-rauc
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-rauc-community/meta-rauc-qemux86
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-oe
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-filesystems
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-python
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-openembedded/meta-networking
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-virtualization
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-components
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-bsp
</span></span><span style="display:flex;"><span>bitbake-layers add-layer <span style="color:#4e9a06">${</span><span style="color:#000">LEDA_WORKDIR</span><span style="color:#4e9a06">}</span>/meta-leda-distro
</span></span></code></pre></div></li>
<li>
<p>Dry run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake --dry-run sdv-image-all
</span></span></code></pre></div></li>
<li>
<p>Real build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake sdv-image-all
</span></span></code></pre></div></li>
<li>
<p>You can also build one of the target recipies this way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span>leda bitbake kanto-container-management
</span></span></code></pre></div></li>
<li>
<p><strong>Note: in this case you can set the target architecture and other build options in the build/local.conf file</strong></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9d306dcf183db3f873e59965d0cae97">6.4 - Run the build</h1>
    
	<h2 id="run-the-full-build">Run the full build</h2>
<p>To setup the environment and build the Leda image, please refer to: <a href="/leda/docs/build/devenv/">Setup development environment</a>.</p>
<h2 id="running-qemu-from-existing-build">Running QEMU from existing build</h2>
<ul>
<li>Use <code>kas shell -c &quot;runqemu qemux86-64 ovmf kvm nographic&quot; &lt;kas-configs&gt;</code> to execute the image.</li>
<li>Replace <code>qemux86-64</code> with one of the other qemu machines, such as <code>qemuarm64</code></li>
<li>Use the keyword <code>slirp</code> to enable user-networking which does not require root privileges on the host. <code>tun</code> is default but requires setup on the host.</li>
<li>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h3 id="variations-of-runqemu-command-line">Variations of runqemu command line</h3>
<ul>
<li>Use <code>runqemu ovmf</code>
<ul>
<li><code>ovmf</code> will enable the UEFI support for IA32 (x86) and X64 (x86-64) guests, for testing the dual-boot capabilities and SDV Self-Update mechanisms</li>
</ul>
</li>
<li>All other options are now part of the default Leda distribution configuration (see <em>leda-qemu-settings.inc</em>)</li>
<li>Continue with <a href="/leda/docs/device-provisioning/">Device Provisioning</a></li>
</ul>
<h2 id="running-qemu-in-the-background">Running QEMU in the background</h2>
<p>To start QEMU in the background enter, use <code>nohup</code> and bring the process into the background.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nohup runqemu qemux86-64 nographic <span style="color:#000">qemuparams</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-m 2048 -pidfile qemu.pid&#34;</span> <span style="color:#000;font-weight:bold">&amp;</span>
</span></span></code></pre></div><p>The image is then reachable via <code>ssh root@192.168.7.2</code>
This will write a file qemu.pid in the current directory including the process ID of QEMU. Once done, <code>kill -9 &lt;qemu.pid&gt;</code> kills the process.</p>
<h2 id="running-with-kas-shell">Running with kas-shell</h2>
<p>If you&rsquo;ve chosen to build the Leda image with kas, you can use the kas-shell to run QEMU, with kas setting up the environment for you. To do that change to the main working directory and run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kas shell -c <span style="color:#4e9a06">&#39;runqemu slirp nographic ovmf sdv-image-full&#39;</span>
</span></span></code></pre></div><h2 id="dhcp-configuration">DHCP Configuration</h2>
<p>As the Leda Quickstart image will try to retrieve its IP address via DHCP broadcast request, it is good to run a DHCP daemon on the host, listening on the respective TAP network interface of QEMU. This will then simulate a LAN with DHCP server and let&rsquo;s us control which IP address gets assigned to multiple QEMU instances.</p>
<p>The <a href="https://github.com/eclipse-leda/leda-distro/blob/main/scripts/run-dhcp.sh">run-dhcp.sh</a> utility will run an ISC-DHCP server on the host. The default configuration has a couple of MAC addresses preconfigured.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c18e94c2f6e61c26c3af49dce54f0909">6.5 - Automated Tests</h1>
    
	<p>Eclipse Leda is using the <a href="https://robotframework.org/">Robot Framework</a> for black box tests and system tests.</p>
<p>The black box tests are supposed to only use <em>public</em> API from SDV components, for example the MQTT interface of the Self Update Agent.
The system tests are supposed to test on Leda Distro level and can use shell and SSH commands to verify system behavior, e.g. performing a reboot.</p>
<p><img src="leda-tests-overview.png" alt="Leda Tests Docker Compose Setup Overview"></p>
<ol>
<li>Test Execution: an external trigger, such as the <code>./test-docker.sh</code> shell script, starts the <code>leda-tests</code> container.</li>
<li>Docker Compose ensures that the needed containers are built and started.
The test cases and test resources are copied into the leda-tests container at build time.</li>
<li>The Robot process is started and performs the execution of all test cases</li>
<li>Black box test cases use the MQTT interface to connect to the test target and publish messages</li>
<li>System level test cases use SSH to connect to the test target and execute commands</li>
<li>Test reports are written to a mounted volume, so that they are available on the host for further processing</li>
</ol>
<h3 id="run-the-tests">Run the tests</h3>
<p>The easiest way to run the test cases is to run it in the Docker Compose setup:</p>
<ol>
<li>
<p>Clone the <a href="https://github.com/eclipse-leda/leda-distro">leda-distro</a> repository:</p>
<pre><code> git clone https://github.com/eclipse-leda/leda-distro
</code></pre>
</li>
<li>
<p><em>Optional:</em> Build both images (qemuarm64 and qemux86-64) using kas / BitBake. If you omit this step, docker compose will download the latest container images from the Eclipse Leda Container Registry on ghcr.io.</p>
<pre><code> kas build kas/leda-qemux86-64.yml
 kas build kas/leda-qemuarm64.yml
</code></pre>
</li>
<li>
<p>Switch to the docker-snapshot directory:</p>
<pre><code> cd resources/docker-snapshot/
</code></pre>
</li>
<li>
<p>Run the Leda Tests</p>
<pre><code> ./test-docker.sh
</code></pre>
</li>
</ol>
<h3 id="test-reports">Test Reports</h3>
<p>The output of <code>test-docker.sh</code> will show the test results from Robot.</p>
<p>The test reports and debug logs are available on the host&rsquo;s filesystem in the path <code>resources/docker-snapshot/leda-tests-reports</code></p>
<ul>
<li><code>output.xml</code> - The main Robot output report</li>
<li><code>report.html</code> - A Robot HTML summary report</li>
<li><code>leda-tests-xunit.xml</code> - A xUnit report file suitable for rendering with various tools</li>
<li><code>log.html</code> - A Robot HTML report with the test execution log</li>
<li><code>leda-tests-debug.log</code> - Debug log file of the test execution, helpful during implementation of test cases and troubleshooting of failed tests</li>
</ul>
<p>The xunit report is being used to visualize the test execution results in the GitHub Workflow:</p>
<p>Example Test Report:</p>
<p><img src="gh-robot-report-with-failed.png" alt="GitHub Leda Tests Robot Report"></p>
<h3 id="adding-new-tests">Adding new tests</h3>
<p>The tests are located in the following locations of the <a href="https://github.com/eclipse-leda/leda-distro">leda-distro</a> repository:</p>
<ul>
<li><code>resources/docker-snapshot/dockerfiles/leda-tests</code> - Robot Tests which are executed inside of a Docker Compose setup</li>
<li><code>tests/src/robot</code> - Robot Tests which can be executed on the build host with a Leda Runqemu instance running</li>
</ul>
<p>General steps are:</p>
<ol>
<li>Decide whether to implement a system-level test or a black-box integration test</li>
<li>Add the test case to an existing, matching <code>.robot</code> file. If no matching test suite can be found, create a new <code>.robot</code> file. Prefix with the order number, e.g. <code>33__my-new-test.robot</code></li>
<li>Check if a refactoring of new keywords may be worthwhile for better reusability.</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8fd1dfda73f2cd3ab1ec676ecd359ca5">6.5.1 - Robot Keywords</h1>
    
	<p>In the Leda Robot Tests, keywords are used for reusable functionality. Common keywords are defined in <code>resources/docker-snapshot/dockerfiles/leda-tests/leda_keywords.resource</code></p>
<p>The goal is to treat the Leda Quickstart image as a black box, utilizing as much as possible with public APIs.</p>
<h2 id="interaction-with-self-update-agent">Interaction with Self Update Agent</h2>
<ul>
<li><code>Trigger to start update</code>: Send a &ldquo;Desired State Request&rdquo; to the target, to install a RAUC Update Bundle</li>
<li><code>Connect and Subscribe to Listen</code>: Wait for the asynchronous messages which indicate a successful installation of an update</li>
</ul>
<h2 id="arbitrary-commands">Arbitrary Commands</h2>
<p>Nevertheless, during implementation of test cases, it may be necessary to execute lower level processes for system level tests. For that, a fallback is possible to execute arbitrary test commands via remote SSH connection. These commands are executed through another docker container running in the same Docker network (<code>leda-network</code>) and allow access to the target QEMU instances:</p>
<ul>
<li><code>Leda Execute</code>: Execute an arbitrary shell command via SSH on the test target</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-54e9dcaf283ef882361a51e9acfc06d5">6.5.2 - Rust Tests</h1>
    
	<p><em>Note:</em> The Rust tests are being replaced with test cases implemented in Robot.</p>
<h3 id="cross-compiling-to-x86_64-on-ubuntu-2004">Cross Compiling to X86_64 on Ubuntu 20.04</h3>
<p>There is currently a step to cross-compile tests to X86_64. In order to successfully run the step, you need to make sure that the following artifacts are available on the runner:</p>
<ul>
<li>rustc + cargo: <code>curl https://sh.rustup.rs -sSf | sh</code></li>
<li>docker: follow <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a> and afterwards <a href="https://docs.docker.com/engine/install/linux-postinstall/">https://docs.docker.com/engine/install/linux-postinstall/</a></li>
<li>build-essential: <code>sudo apt-get install build-essential</code></li>
<li>cross (0.1.16): <code>cargo install cross --version 0.1.16</code></li>
<li>jq: <code>sudo apt-get install jq -y</code></li>
</ul>
<p>You may restart your current shell so that all components are available as env vars.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-40e3f4818f73b84ce32042db1961675c">6.6 - GitHub Workflow</h1>
    
	<p><img src="./github-workflow.png" alt="GitHub Workflow"></p>
<ul>
<li>Manually creating a Release triggers the release workflow.</li>
<li>The release workflow calls the build workflow.</li>
<li>The build workflow indirectly depends on the sstate cache being prebuilt manually (see optimizations below)</li>
<li>The build workflow runs a full build of the SDV-Image-All disk image for all target machines.</li>
<li>A separate job is used for each target machine, to ensure an image build for a target machine can finish within 6 hours.</li>
<li>Each build contains the creation of SBOM artifacts and the check for CVEs. The SBOM artifacts are in SPDX JSON format and packaged per target machine&rsquo;s disk image (SDV-Image-Full to include all packages).</li>
<li>The OSS License Scanning (using the OSS Review Toolkit) is done asynchronously on a separate fork, as it currently uses a proprietary infrastructure. The ORT-based infrastructure of Eclipse is planned to be used in the future. The web report is attached as a build artifact on the internal fork and not accessible by public currently.</li>
<li>Once the build workflow&rsquo;s jobs are finished, the release workflow will finalize by attaching the release artifacts as assets to the release.</li>
</ul>
<p><em>Note: While the build workflow and release workflows are in progress, the GitHub release page of that release does not show any other assets besides the source archives. The release artifacts (eclipse-leda-<machine>.tar.xz) will only be visible once all workflows have finished.</em></p>
<h2 id="limitations-on-standard-runners">Limitations on standard runners</h2>
<p>As the GitHub-managed runners are optimized for ephemeral build use cases and a Yocto-based build process is very consuming in regards to CPU and disk capacity, a few optimizations need to be done before being able to run a full build or even a release workflow on limited GitHub-managed standard runners.</p>
<p>Please see the documentation about <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources">GitHub Hosted Runners</a> for current specs.</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Standard GitHub Runner</th>
<th>Recommended for Yocto</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>2-core CPU (x86_64)</td>
<td>16-core CPU (x86_64)</td>
</tr>
<tr>
<td>RAM</td>
<td>7 GB of RAM</td>
<td>16 GB of RAM</td>
</tr>
<tr>
<td>Disk</td>
<td>14 GB of SSD</td>
<td>128+ GB of SSD</td>
</tr>
<tr>
<td>Time</td>
<td>max. 6 hours / job</td>
<td>not limited</td>
</tr>
</tbody>
</table>
<p>In general, GitHub recommends to split a build process into smaller chunks, which can then fit into the constraints.</p>
<h2 id="optimizations">Optimizations</h2>
<p>The following optimizations have been implemented for the Eclipse Leda public repository and its build workflow:</p>
<ol>
<li>
<p><strong>Remote SState Cache</strong>: To minimize build time and disk usage, a remote sstate-cache mirror is being used. The mirror is hosted by one of the project sponsors on european Azure infrastructure and available as public HTTP mirror to anonymous Leda builds. The mirror is provided as best-effort, does not provide any kind of service level and may not be available at all times.</p>
<p><em>Note: To use the mirror, set the <code>BB_HASHSERVE</code>, <code>MIRROR_SERVER</code>, <code>SSTATE_MIRRORS</code> and related configuration settings. See the <a href="https://github.com/eclipse-leda/leda-distro/blob/main/kas/mirrors.yaml">mirrors.yaml</a> for a full sample.</em></p>
<p><img src="./github-workflow-optimizations.png" alt="GitHub Workflow Optimizations"></p>
</li>
<li>
<p><strong>Prebuilding</strong>: To fill the remote sstate cache mirror, another build infrastructure is being used. The repository fork has been configured with additional credentials to authenticate against the remote mirror for uploading the built packages. To ensure these steps are not run on the public OSS repository, the workflow steps use additional conditions to check for the owner of the repository. This is a workaround due to a <a href="https://github.com/actions/runner/issues/520">known issue on GitHub Actions</a>.</p>
</li>
<li>
<p><strong>Chunking of the build steps:</strong> To minimize bandwidth transfer, a local GitHub Action Cache is being used. This cache is per target machine and filled with a separate workflow. The <a href="https://github.com/eclipse-leda/leda-distro/actions/workflows/prebuild-sstate.yml">Prebuild sstate</a> build jobs will run the BitBake process for 4 hours and then gracefully shut down. The build process will finish the current tasks. The remaining time (max. runtime for GitHub Runners is 6 hours) is used to package and upload the packages to the cache. If the 4 hours of build time are not enough, it may be required to re-run the same job more often.</p>
<p><em>Note: The disadvantage of this approach is that each run requires a significant lead time where the remote cache is downloaded, the recipes get parsed again, the build task dependencies are compiled etc. On a persistent runner, this time can be spared.</em></p>
</li>
<li>
<p><strong>Rerun on sstate miss:</strong> When BitBake is missing a package in the sstate mirror (it may exist in the Hash Equivalence Server though), BitBake will log an <strong>Error</strong> and continue to run the recipe. However, as the cache-miss is logged as error, BitBake will exit with an error code, indicating a failed build, which in turn would mark the GitHub Job as failed, too. To circumvent this problem, the BitBake build process is executed in a loop (max. 3 retries) to ensure that with the current state, all packages can be built without errors, eventually succeeding with the buid.</p>
</li>
<li>
<p><strong>Always upload GitHub Cache:</strong> Under normal circumstances, the GitHub Cache action will update the cache on success of the build job - to not poison the cache with failed builds. However, as the Leda build workflows run for a very long time and may fail due to other reasons, the goal is to still reuse the sstate-cache as much as possible. For that reason, the <code>pat-s/always-upload-cache</code> GitHub action is being used, as it will also upload the cache on failed builds.</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62352f3530820244cfc19d6fdad57df1">6.7 - Runqemu</h1>
    
	<p>QEMU&rsquo;s command line option can get quiet complex. Yocto is providing a convenient wrapper script called <code>runqemu</code>, which takes configurations into account which have been populated during the build process and also takes care of TAP networking setup and teardown. Unfortunately, it can only be used within an OpenEmbedded build environment.</p>
<p>Running without runqemu: when you need more control over qemu options</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qemu-system-x86_64 -kernel .<span style="color:#4e9a06">\b</span>zImage-qemux86-64.bin -nographic -m 2G -append <span style="color:#4e9a06">&#34;console=ttyS0 root=/dev/vda1&#34;</span> -drive <span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">=</span>.../sdv-image-full-qemux86-64.ext4
</span></span></code></pre></div><p>Running with runqemu: simple and some convenient flags are supported</p>
<pre><code>runqemu ovmf sdv-image-full
</code></pre>
<p>Running with leda: no options, runs the default settings only</p>
<pre><code>leda
</code></pre>
<p><img src="qemu-runner-script.png" alt=""></p>
<h2 id="enabling-kvm-for-better-performance">Enabling KVM for better performance</h2>
<p>The performance of qemux86_64 is much better when KVM can be used.
Try running with:</p>
<pre><code>runqemu ovmf kvm
</code></pre>
<p><em>Note: You may need to set up KVM for your host machine first, please refer to <a href="https://wiki.yoctoproject.org/wiki/How_to_enable_KVM_for_Poky_qemu">How to enable KVM for Poky qemu</a></em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/workspaces/leda-distro/build-sdv-x86_64 <span style="color:#ce5c00;font-weight:bold">(</span>imageformatcleanup ✗<span style="color:#ce5c00;font-weight:bold">)</span> $ ls -al /dev/kvm
</span></span><span style="display:flex;"><span>crw-rw---- <span style="color:#0000cf;font-weight:bold">1</span> root kvm 10, <span style="color:#0000cf;font-weight:bold">232</span> May <span style="color:#0000cf;font-weight:bold">16</span> 06:46 /dev/kvm
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1c63e657519124a213cf5b9778390873">6.8 - Miscellaneous</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-685226a9e960be283b847d67e85319af">6.8.1 - Resource Consumptions</h1>
    
	<h2 id="baseline-no-apps-installed">Baseline (no apps installed)</h2>
<p>Baseline: 400 MB</p>
<p>Installed components:</p>
<ul>
<li>Container Management: runc, containerd, container-management</li>
<li>System Services: systemd, openssh, mosquitto, mosquitto-clients</li>
<li>No cloud connector or edgecontainerd yet.</li>
<li>No self update agent</li>
<li>No containers, no vehicle apps etc.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@qemux86-64:/bin# df -h
</span></span><span style="display:flex;"><span>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span style="display:flex;"><span>/dev/root       2.5G  506M  1.8G  22% /
</span></span></code></pre></div><ul>
<li>Memory Usage: 200MB</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@qemux86-64:/# free
</span></span><span style="display:flex;"><span>            total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:           1.9G      329.6M        1.4G       16.6M      222.2M        1.6G
</span></span><span style="display:flex;"><span>Swap:    
</span></span></code></pre></div><h2 id="component-details">Component Details</h2>
<p>Dependencies</p>
<ul>
<li>cni (container networking): 51 MB</li>
<li>containerd-ctr: 26 MB</li>
<li>containerd: 46 MB</li>
<li>dapr cli: 38 MB</li>
<li>helm cli: 43 MB</li>
<li>runc: 10 MB</li>
</ul>
<p>SDV Components</p>
<ul>
<li>vehicle-data-cli: 2.3 MB (dynamic)</li>
</ul>
<p>Medium:</p>
<ul>
<li>Linux Kernel (Poky minimal / Leda distro kernel): 8 MB / 21 MB</li>
<li>oci-image-tool: 9 MB</li>
<li>oci-runtime-tool: 7 MB</li>
<li>sshd: 1 MB</li>
<li>libstdc++: 2 MB</li>
<li>lic: 2 MB</li>
<li>libcrypto: 3 MB</li>
<li>containerd-shim: 7 MB</li>
<li>containerd-shim-runc-v1: 9 MB</li>
<li>containred-shim-runc-v2: 9 MB</li>
<li>libsystemd: 1 MB</li>
<li>busybox: 1 MB</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e40b1f7122c24679a439cddb45a2953">6.8.2 - Partition Layout</h1>
    
	<p>The bootable Leda Quickstart images are disk image with multiple partitions:</p>
<ul>
<li>Two bootloader partitions, to enable A/B update process</li>
<li>A separate partition to hold bootloader status information</li>
<li>An optional rescue partition with basic operating system and tooling</li>
<li>Two rootfs partitions with a full installation of the operating system, to enable A/B update process</li>
<li>A data partition for storing container runtime data</li>
</ul>
<h2 id="partition-layout-for-qemu-x86-64">Partition Layout for QEMU x86-64</h2>
<p>The x86_64 image uses GRUB as a bootloader and the partition layout is as follows:</p>
<p><img src="leda-disk-layout-qemux86-64.png" alt="Leda Disk Layout for QEMU x86-64"></p>
<h2 id="partition-layout-for-qemu-arm-64">Partition Layout for QEMU ARM-64</h2>
<p>The partition layout for QEMU ARM-based images are comparable, except:</p>
<ul>
<li>Bootloader is replaced with U-Boot</li>
</ul>
<h2 id="partition-layout-for-raspberry-pi">Partition Layout for Raspberry Pi</h2>
<p>The partition layout for Raspberry Pi images are comparable, except:</p>
<ul>
<li>Bootloader is replaced with U-Boot</li>
<li>The last partition (the data partition) is marked as growable, to allow the use of the larger SD-Card capacities for container runtime data</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdf9cb83992bb147748b5ca9a98cda7a">6.9 - Releasing</h1>
    
	<h1 id="versioning-and-codenames">Versioning and Codenames</h1>
<ul>
<li>Distribution Versioning is following the <code>x.y.z</code> syntax for the distribution, e.g. <code>Leda 0.0.1</code></li>
<li>Build Versioning is following the git describe syntax: <code>v0.0.1-blank-168-g7e14c4c</code>
<ul>
<li>Latest tag name: <code>v0.0.1</code></li>
<li>Branch name: <code>blank</code></li>
<li>Number of commits behind: <code>168</code></li>
<li>Short Commit ID: <code>g7e14c4c</code></li>
</ul>
</li>
<li>Codenames are taken from <a href="https://en.wikipedia.org/wiki/List_of_motor_racing_tracks">Wikipedia List of Motor Racing Tracks</a></li>
<li>Initial codename is <code>Hockenheim</code></li>
<li>Current distribution version can be taken from <code>/etc/issue</code>:</li>
</ul>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/issue
Eclipse Leda v0.0.8
</code></pre><h1 id="how-to-release">How to Release</h1>
<p>A new release is triggered manually from its GitHub web page <code>Releases</code> section. By
clicking on the <code>Draft new release</code> button, the release process starts:</p>
<ul>
<li>Select a branch to use as code base for the release</li>
<li>Create a tag using the standard pattern <code>vX.Y.Z</code></li>
<li>Write a title <code>Release X.Y.Z</code> and release notes</li>
<li>Optionally select if this is a pre-release</li>
<li>Publish the release</li>
<li><a href="validation.md">Validate the release</a></li>
</ul>
<p>With <code>Publish the release</code> action the release workflow located in <code>.github/workflows/release.yml</code> will be triggered. This
will start building the distro image files for the supported platforms, running the test cases and generating reports as
junit xml and license scanning. If the image generation and the test runs are successful the artifacts: images, test
binaries and qa reports will be attached as assets to the release.</p>
<p>The build (<code>build.yml</code>) and release (<code>release.yml</code>) workflows share a common reusable workflow (<code>base.yml</code>). In this way the
release workflow repeats the build actions without duplicating the code.</p>
<h1 id="detailed-build-information-on-device">Detailed build information on device</h1>
<h2 id="eclipse-leda-version">Eclipse Leda Version</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/issue
Eclipse Leda v0.0.8
</code></pre><h2 id="exact-build-timestamp">Exact Build Timestamp</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/version
20220408135014
root@qemux86-64:~# cat /etc/timestamp
20220408135230
</code></pre><h2 id="details-of-build-information">Details of Build Information</h2>
<pre tabindex="0"><code>root@qemux86-64:~# cat /etc/build 
-----------------------
Build Configuration:  |
-----------------------
DISTRO = leda
DISTRO_VERSION = 2022
DATETIME = 20220408135014
DISTRO_NAME = Eclipse Leda
IMAGE_BASENAME = core-image-minimal
MACHINE = qemux86-64
TUNE_PKGARCH = core2-64
MACHINE_FEATURES = alsa bluetooth usbgadget screen vfat x86 pci rtc qemu-usermode
DISTRO_FEATURES = acl alsa argp  debuginfod  ipv4 ipv6 largefile pcmcia usbgadget usbhost wifi xattr  zeroconf pci    vfat seccomp largefile  ptest multiarch  vulkan virtualization k8s seccomp raucg
COMMON_FEATURES = 
IMAGE_FEATURES = debug-tweaks
TUNE_FEATURES = m64 core2
TARGET_FPU = 
APP_URI_PREFIX = 
APP_URI_BRANCH = 
-----------------------
Layer Revisions:      |
-----------------------
meta              = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-poky         = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-yocto-bsp    = honister:ee68ae307fd951b9de6b31dc6713ea29186b7749 
meta-leda          = main:30a5ff0a7e04dfa2c9b43175a49ac7a2ae0c64a9 -- modified
meta-rauc         = honister:3faf4cc4fcf558e99dad5aa8532fef2ecd566653 
meta-filesystems  = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-networking   = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-oe           = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-python       = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-perl         = honister:061b7fc74f887454251307ef119b808a90654d3f 
meta-virtualization = honister:bd7511c53b921c9ce4ba2fdb42778ca194ebc3e8 
meta-security     = honister:fb77606aef461910db4836bad94d75758cc2688c 
patch             = main:a041dad5be9444d55491b57cb6a669a44196566d -- modified
</code></pre>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-36dea19e60b747437042ee148647e878">6.9.1 - Validating</h1>
    
	<h2 id="validating-the-release">Validating the release</h2>
<p>Steps to validate if a release is properly working:</p>
<ol>
<li>
<p>Create a new pre-release from your branch</p>
</li>
<li>
<p>Download the release artifacts onto a clean system.</p>
<p>Do not use your build environment, to minimize the impact of existing environment configuration from BitBake etc.</p>
</li>
<li>
<p>Run the <code>run-leda</code> scripts to execute Qemu</p>
<p><em>Note: You should test each of the release archives, for each target machine.</em></p>
</li>
<li>
<p>Follow the <a href="/leda/docs/device-provisioning/">Device Provisioning</a> guide</p>
</li>
<li>
<p>Perform some verification tests (see below)</p>
</li>
<li>
<p>Cleanup: Delete the pre-release and the git tag:</p>
<pre><code>git push --delete origin &lt;tagname&gt;
</code></pre>
</li>
</ol>
<h2 id="ideas-for-manual-verification-steps">Ideas for manual verification steps</h2>
<p><em>Note: These are just for manual testing, as we intend to extend the automated tests as much as possible.</em></p>
<ul>
<li>Operating system level
<ul>
<li>Run <code>sdv-health</code> on the shell</li>
<li>Verify disk partitions and RAUC status, e.g. <code>rauc status</code></li>
<li>Verify network interface and CAN-Bus with <code>ip addr</code></li>
</ul>
</li>
<li>Container runtime
<ul>
<li>Check status of containers with <code>kantui</code></li>
</ul>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c94e454d5004f1527a7e3bb4f39a40e3">6.10 - Developing and Maintaining Utils</h1>
    
	<p>The Leda teams provides some custom utilities that allow for a more integrated end-user experience. They can be found in the main leda-utils repository on GitHub: <a href="https://github.com/eclipse-leda/leda-utils">eclipse-leda/leda-utils</a>.</p>
<p>The following pages are meant to serve as both internal documentation and general guidelines when developing for Leda.</p>
<h2 id="bash">Bash</h2>
<p>Leda uses the classic Bourne shell as its main shell, thus all scripts should be sh-compatible (use the <code>#!/bin/sh</code> shebang). As a Poky+OE-based distro we use BusyBox for core-utils. To check explicitly for <em>&ldquo;bashisms&rdquo;</em> in your scripts, the
<code>checkbashisms</code> tool might be useful.</p>
<p><a href="shell/"><strong>Utility-Specific Pages</strong></a></p>
<p>The bash-based leda-utils are all deployed with the same recipe under the sdv-base packagegroup: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/sdv-base">meta-leda/meta-leda-components/recipes-sdv/sdv-base</a>.</p>
<h2 id="rust">Rust</h2>
<p>The current <em>main</em> branch for leda-distro (and meta-leda) is based on the Kirkstone Yocto/Poky release.</p>
<h3 id="toolchain-version">Toolchain version</h3>
<p>The version of the Rust toolchain available in OE (Kirkstone) is <strong>1.59.0</strong>. Make sure to target <strong>1.59.0</strong> (or earlier) when developing Rust-based utils for leda. To set <strong>1.59.0</strong> as your default Rust version on your development machine:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustup install 1.59.0
</span></span><span style="display:flex;"><span>$ rustup default 1.59.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo --version
</span></span><span style="display:flex;"><span>cargo 1.59.0 <span style="color:#ce5c00;font-weight:bold">(</span>49d8809dc 2022-02-10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="generating-bitbake-recipes-with-cargo-bitbake">Generating bitbake recipes with cargo-bitbake</h3>
<p>After making sure your toolchain is on version <strong>1.59.0</strong> go trough a clean build of your Rust binary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> &lt;rust_project_dir&gt;
</span></span><span style="display:flex;"><span>$ cargo clean
</span></span><span style="display:flex;"><span>$ rm Cargo.lock
</span></span><span style="display:flex;"><span>$ cargo build --release
</span></span></code></pre></div><p>This will make sure the Cargo.lock is re-generated with packages matching the Rust version. The <code>cargo.bbclass</code> on which Rust recipes are based, requires all Rust crates + their version (matching the Cargo.toml) to be specified as a &ldquo;SRC_URI +=&rdquo;. This can become tedious and error-prone if done by hand. That&rsquo;s why meta-rust provides a tool called <code>cargo-bitbake</code> that generates a minimal recipe with all the crates it finds in the <code>Cargo.lock</code> files of the project.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo install --locked cargo-bitbake
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> &lt;rust_project_dir&gt;
</span></span><span style="display:flex;"><span>$ cargo bitbake
</span></span></code></pre></div><p>This will generate a recipe in the project root which you can use as a starting point.</p>
<p>Example: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kantui_git.bb">kantui_git.bb</a></p>
<p>Note this recipe will only build your Rust crate. To deploy/install your binary you have to define a <code>.inc</code> file with the same name as the recipe that would handle the installation.</p>
<p>Example: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kantui.inc">kantui.inc</a></p>
<h3 id="known-bugs">Known bugs</h3>
<p>The built-in <code>proc_macros</code> crate is not being imported properly by meta-rust (Kirkstone), thus breaking all library crates that define a proc_macro (<a href="https://github.com/meta-rust/meta-rust/issues/266">meta-rust issue 266</a>). To fix this create a <code>libstd-rs_%.bbappend</code> file containing the single line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">S</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">RUSTSRC</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/library/test&#34;</span>
</span></span></code></pre></div><p>meta-leda already provides this fix <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/libstd-rs_%25.bbappend">here</a>, so it should not be necessary to implement it again.</p>
<h3 id="fat-link-time-optimization">&ldquo;Fat&rdquo; Link time optimization</h3>
<p>LTO is a nice feature of LLVM that can optimize even through language boundaries at link-time, but leads to longer overall build times. That is why Rust by default uses &ldquo;thin&rdquo; LTO which may result in larger/slower binaries. &ldquo;Fat&rdquo; LTO can be enabled when building release binaries by adding to the <code>Cargo.toml</code> file the following section:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">profile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lto</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span></code></pre></div><p>For <a href="rust/kantui">kantui</a> this leads to reduction of the final binary size from ~8 MiB to ~5 MiB.</p>
<p>More information on profile-optimizations can be found <a href="https://doc.rust-lang.org/cargo/reference/profiles.html">here</a>.</p>
<p><strong>Note</strong>: Stripping the debug symbols completely results in further binary size reduction, but BitBake fails with a QA problem when deploying stripped binaries.</p>
<h3 id="rust-based-utilities">Rust-based utilities</h3>
<p><a href="rust/"><strong>Utility-Specific Pages</strong></a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d807daac010fe21775fe6dc4f7bef15d">6.10.1 - Rust Utils</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a15bf08ceb9050ab919c4dd1e39f4581">6.10.1.1 - Communicating with Кanto-CM via gRPC</h1>
    
	<p>Kanto container management binds to a unix socket (default: <code>/run/container-management/container-management.sock</code>) and exposes a gRPC interface which can be used to obtain all the functionality of the <code>kanto-cm</code> cli programatically.</p>
<p>The easiest way to access this API through Rust is by creating a new Rust crate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cargo new talk-to-kanto
</span></span></code></pre></div><h2 id="dependencies">Dependencies</h2>
<p>The most feature-rich gRPC library for Rust right now is tonic. Add the following to your <code>Cargo.toml</code> to make tonic and the tokio async runtime available to your crate. Tower and hyper are needed to be able to bind to the unix socket.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">prost</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.11&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tokio</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;rt-multi-thread&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;fs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;macros&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;net&#34;</span><span style="color:#000;font-weight:bold">,]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tokio-stream</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;net&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tonic</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.8.2&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tower</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.4&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">http</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">hyper</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.14&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;full&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serde</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.147&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;derive&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serde_json</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.89&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">default-features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;alloc&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">build-dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tonic-build</span> <span style="color:#000;font-weight:bold">=</span>  <span style="color:#4e9a06">&#34;0.8.2&#34;</span>
</span></span></code></pre></div><h2 id="compiling-protobufs">Compiling protobufs</h2>
<p>The easiest way to obtain the kanto-cm <code>.proto</code> files is to add the container management repo in your project root as a git submodule:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git submodule init
</span></span><span style="display:flex;"><span>$ git submodule add https://github.com/eclipse-kanto/container-management.git
</span></span><span style="display:flex;"><span>$ git submodule update --init --recursive
</span></span></code></pre></div><p>You should now have the <code>container-management</code> repository available.</p>
<p>To build the <code>.proto</code> files during compile time, define a custom <code>build.rs</code> in the project root</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ touch build.rs
</span></span></code></pre></div><p>Add the following main function to the <code>build.rs</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fn</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-&gt; <span style="color:#204a87">Result</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Box</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">dyn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">std</span>::<span style="color:#000">error</span>::<span style="color:#000">Error</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tonic_build</span>::<span style="color:#000">configure</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">build_server</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">include_file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mod.rs&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">type_attribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;#[derive(serde::Serialize, serde::Deserialize)]&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">compile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;api/services/containers/containers.proto&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;container-management/containerm/&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">Ok</span><span style="color:#000;font-weight:bold">(())</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Here it is important to know that tonic does not like deeply nested protobufs such as those for kanto-cm. That is why the line <code>.include_file(&quot;mod.rs&quot;)</code> re-exports everything in a seperate module which can later be included in the main.rs file.</p>
<p><code>&quot;#[derive(serde::Serialize, serde::Deserialize)]&quot;</code> makes all structures (de-)serializable via serde.</p>
<h2 id="importing-generated-rust-modules">Importing generated Rust modules</h2>
<p>Now in <code>src/main.rs</code> add the following to import the generated Rust modules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">mod</span> <span style="color:#000">cm</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tonic</span>::<span style="color:#000">include_proto</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mod&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm</span>::<span style="color:#000">github</span>::<span style="color:#000">com</span>::<span style="color:#000">eclipse_kanto</span>::<span style="color:#000">container_management</span>::<span style="color:#000">containerm</span>::<span style="color:#000">api</span>::<span style="color:#000">services</span>::<span style="color:#000">containers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_services</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm</span>::<span style="color:#000">github</span>::<span style="color:#000">com</span>::<span style="color:#000">eclipse_kanto</span>::<span style="color:#000">container_management</span>::<span style="color:#000">containerm</span>::<span style="color:#000">api</span>::<span style="color:#000">types</span>::<span style="color:#000">containers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_types</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Now all kanto-cm services as namespaced under <code>cm_services</code>.</p>
<h2 id="obtaining-a-unix-socket-channel">Obtaining a unix socket channel</h2>
<p>To obtain a unix socket channel:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokio</span>::<span style="color:#000">net</span>::<span style="color:#000">UnixStream</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tonic</span>::<span style="color:#000">transport</span>::<span style="color:#000;font-weight:bold">{</span><span style="color:#000">Endpoint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Uri</span><span style="color:#000;font-weight:bold">};</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tower</span>::<span style="color:#000">service_fn</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/run/container-management/container-management.sock&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">channel</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Endpoint</span>::<span style="color:#000">try_from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://[::]:50051&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connect_with_connector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">service_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">move</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">_</span>: <span style="color:#000">Uri</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UnixStream</span>::<span style="color:#000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">socket_path</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">await</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This is a bit of a hack, because currently, tonic+tower don&rsquo;t support binding directly to an unix socket. Thus in this case we attemp to make an http connection to a non-existent service on port <code>5051</code>. When this fails, the fallback method <code>connect_with_connector()</code> is called where a tokio UnixStream is returned and the communication channel is generated from that.</p>
<h2 id="making-a-simple-grpc-call-to-kanto-cm">Making a simple gRPC call to kanto-cm</h2>
<p>All that is left is to use the opened channel to issue a simple &ldquo;list containers&rdquo; request to kanto.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate a CM client, that handles containers-related requests (see protobufs)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">mut</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">client</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm_services</span>::<span style="color:#000">containers_client</span>::<span style="color:#000">ContainersClient</span>::<span style="color:#000">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">request</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tonic</span>::<span style="color:#000">Request</span>::<span style="color:#000">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm_services</span>::<span style="color:#000">ListContainersRequest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">{});</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">let</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">response</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">await</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Since we made all tonic-generated structures (de-)serializable we can use <code>serde_json::to_string()</code> to print the response as a json string.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Rust" data-lang="Rust"><span style="display:flex;"><span><span style="color:#000">println!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;{}&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">serde_json</span>::<span style="color:#000">to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4ceae03484d6716691789648aa48571f">6.10.1.2 - Kanto Auto deployer</h1>
    
	<p><strong>TLDR</strong>: To deploy a container in the final Leda image, all you generally need to do is add the manifest in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and re-build.</p>
<p>Kanto-CM does not provide (currently) an out-of-the box feature that allows for the automatic deployment of containers through manifest files similar to k3s&rsquo; automated deployment of k8s-manifests found in the <code>/var/lib/rancher/k3s/server/manifests</code> directory.</p>
<p>This can be worked around via a bash script for each container that runs on boot and makes sure it&rsquo;s deployed. Even though this approach is functional it is not very structured and would require a lot repeating code.</p>
<p>That is why the &ldquo;<a href="https://github.com/eclipse-leda/leda-utils/tree/main/src/rust/kanto-auto-deployer">Kanto Auto deployer</a>&rdquo; tool was developed. It directly implements the ideas in <a href="../notes-on-kanto-grpc">Communicating with Кanto-CM via gRPC</a>.</p>
<p>The compiled binary takes a path to a directory containing the json manifests, parses them into Rust structures and sends gRPC requests to kanto container management to deploy these containers.
If the container is already deployed the manifest is ignored.</p>
<h2 id="manifest-structure">Manifest structure</h2>
<p>Kanto auto deployer uses the exact same structure for its manifests as the internal representation of container state in kanto container management. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;databroker&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;image&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ghcr.io/eclipse/kuksa.val/databroker:0.2.5&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;decrypt_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;domain_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;resolv_conf_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hostname_path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;mounts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hooks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;devices&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restart_policy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;maximum_retry_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;retry_timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;unless-stopped&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;runtime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;io.containerd.runc.v2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;extra_hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;port_mappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;container_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">55555</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_ip&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30555</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;host_port_end&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30555</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;log_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;driver_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;json-file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_files&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1M&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;root_dir&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;mode_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;blocking&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">&#34;max_buffer_size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;resources&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;io_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stderr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach_stdout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;open_stdin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;stdin_once&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;tty&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;RUST_LOG=info&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;vehicle_data_broker=debug&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;network_settings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;state&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;pid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;started_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exit_code&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;finished_at&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;exited&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;dead&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;restarting&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;paused&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;running&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;oom_killed&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;created&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;manually_stopped&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;restart_count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The only difference to the actual internal state representation is that fields in the manifest can be left empty (<code>&quot;&quot;</code>) if they are not important for the deployment. These values will be filled in with defaults by kanto-cm after deployment.</p>
<p>For example, you do not need to specify the container &ldquo;id&rdquo; in the manifest, as an unique uuid would be assigned automatically after deployment.</p>
<h2 id="container-deployment-in-leda">Container deployment in Leda</h2>
<p>Kanto-auto-deployer runs as a one-shot service on boot that goes through the manifest folder (default: <code>/var/containers/manifests</code>) and deploys required containers.</p>
<p>The Bitbake recipe for building and installing the auto deployer service can be found at <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-auto-deployer_git.bb">kanto-auto-deployer_git.bb</a>.</p>
<p>This recipe also takes all manifests in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and installs them in the directory specified by the <code>KANTO_MANIFESTS_DIR</code> BitBake variable (weak default: <code>/var/containers/manifests</code>).</p>
<p><strong>Important</strong>: To deploy a container in the final Leda image, all you generally need to do is add the manifest in the <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers">kanto-containers</a> directory and re-build.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1a1d75c926eacba3c473eb373af6186f">6.10.1.3 - Kantui</h1>
    
	<p>The k8s ecosystem comes with a lot of utilies that allow for the easier management of containers (such as k9s). The <a href="https://github.com/eclipse-leda/leda-utils/tree/main/src/rust/kanto-tui">kantui util</a> aims to be a &ldquo;nice&rdquo; text user interface that lets the user start/stop/remove/get logs of deployed containers in kanto-cm.</p>
<p><img src="https://github.com/eclipse-leda/leda-utils/blob/main/src/rust/kanto-tui/misc/kantocmcurses-ss.png?raw=true" alt="kantui screenshot"></p>
<h2 id="development-notes">Development notes</h2>
<p>This tool is again based on the ideas in <a href="../notes-on-kanto-grpc">Communicating with Кanto-CM via gRPC</a>.</p>
<p>It spins up two threads - an UI thread (drawing/updating UI) and an IO thread (communicating with kanto-cm via gRPC). The communication between these two threads happens over an <a href="https://crates.io/crates/async-priority-channel">async-priority-channel</a> with <code>ListContainers</code> request having a lower priority than <code>Start/Stop/Remove/Get Logs</code> (&ldquo;user interaction&rdquo;) requests.</p>
<p>This in an &ldquo;eventually fair&rdquo; mechanism of communication. That way even if kanto-cm is handling a slow request (such as stopping a container that does not respect SIGTERM) the UI thread is never blocked, allowing for a responsive-feeling UI. The size of the channel is 5 requests and the UI is running at 30 fps. Thus even if the UI gets out-of-sync with the actual state of container management it would be &ldquo;only&rdquo; for 5 out 30 frames.</p>
<h2 id="cursive-and-ncurses-rs">Cursive and ncurses-rs</h2>
<p>The <a href="https://crates.io/crates/cursive">cursive</a> crate is used as a high level &ldquo;framework&rdquo; as it allows very easy handling of UI events via callbacks, though this might be prone to callback hell.</p>
<p>The default backend for cursive is ncurses-rs which a very thin Rust wrapper over the standart ncurses library. This in theory would be the optimal backend for our case as ncurses is a very old and stable library that has buffering (other backends lead to flickering of the UI on updates) and is dynamically linked (smaller final binary size).</p>
<p>The ncurses-rs wrapper however is <strong>not well-suited to cross-compilation</strong> as it has a custom build.rs that generates a small C program, compiles it for the target and tries to run it on the host. The only reason for this C program to exist is to check the width of the <em>char</em> type. Obviously, the char type on the host and the target might be of different width and this binary might not even run on the host machine if the host and target architectures are different.</p>
<p>After coming to the conclusion that the ncurses-rs backend was not suitable, kantui was migrated to the termion backend + the <a href="https://crates.io/crates/cursive_buffered_backend">cursive_buffered_backend</a> crate which mitigates the flickering issue.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cursive_buffered_backend</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.5.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dependencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cursive</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default-features</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span><span style="color:#000">version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.16.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">features</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;termion-backend&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>This completely drops the need for ncurses-rs but results in a slightly bigger binary (all statically linked).</p>
<h2 id="bitbake-recipe">Bitbake Recipe</h2>
<p>The recipe was created following the guidelines in <a href="../../#generating-bitbake-recipes-with-cargo-bitbake">Generating bitbake recipes with cargo-bitbake</a> and can be found in <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-components/recipes-sdv/eclipse-leda">meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/</a>.</p>
<h2 id="future-improvement-notes">Future improvement notes</h2>
<ul>
<li>
<p>The gRPC channel can get blocked thus effectively &ldquo;blocking&rdquo; the IO-thread until it is freed-up again. Maybe open a new channel for each request (slow/resource heavy)?</p>
</li>
<li>
<p>Reorganize the code a bit, move all generic functionally in the lib.rs.</p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4f521ffe9ea62a6a0abf7d17bb18e912">6.10.2 - Shell Utils</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6db933c8beae49618c83597c4bad0cde">6.10.2.1 - sdv-health</h1>
    
	<p>A general utility for monitoring the status of important sdv services/containers/devices.</p>
<h2 id="checking-the-status-of-kanto-cm-containers">Checking the status of kanto-cm containers</h2>
<p>Kanto CM containers are split into two groups - required and optional. Both groups are checked, but only a warning is issued when an optional container is missing/not working.</p>
<p>General code for checking the status is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_CONTAINERS_OPT</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">printf</span> -- <span style="color:#4e9a06">&#34;</span><span style="color:#000">$SEPARATOR</span><span style="color:#4e9a06">\n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">printf</span> -- <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">COL_WHITE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">[Kanto CM Containers (OPTIONAL)]</span><span style="color:#4e9a06">${</span><span style="color:#000">COL_NC</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">${</span><span style="color:#000">CM_STATUS</span><span style="color:#4e9a06">}</span> !<span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#4e9a06">&#34;inactive&#34;</span>*  <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># &#34;Optional containers&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KANTO_CM_LIST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CMD</span><span style="color:#4e9a06">}</span> list<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># removes tabs, splits on pipe and takes the container name column ($2)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FOUND_CONTAINERS</span><span style="color:#ce5c00;font-weight:bold">=(</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_LIST</span><span style="color:#4e9a06">&#34;</span> <span style="color:#000;font-weight:bold">|</span> awk -F<span style="color:#4e9a06">&#39;|&#39;</span> <span style="color:#4e9a06">&#39;{gsub(/\t/, &#34;&#34;); print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># array with all kanto container names</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic"># removes tabs, splits on pipe and takes the container status colum ($4)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FOUND_CONTAINERS_STATES</span><span style="color:#ce5c00;font-weight:bold">=(</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$KANTO_CM_LIST</span><span style="color:#4e9a06">&#34;</span> <span style="color:#000;font-weight:bold">|</span> awk -F<span style="color:#4e9a06">&#39;|&#39;</span> <span style="color:#4e9a06">&#39;{gsub(/\t/, &#34;&#34;); print $4}&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># array with all kanto container states</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KANTO_CM_CONTAINERS_ARR</span><span style="color:#ce5c00;font-weight:bold">=(</span> <span style="color:#000">$KANTO_CM_CONTAINERS_OPT</span> <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> expectedCtr in <span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CM_CONTAINERS_ARR</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CTR_IDX</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>get_array_element_index <span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">FOUND_CONTAINERS</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> ! -z <span style="color:#000">$CTR_IDX</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">FOUND_CONTAINERS_STATES</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">$CTR_IDX</span><span style="color:#000;font-weight:bold">]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$status</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Running&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_OK</span><span style="color:#4e9a06">\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_WARN</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$status</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_WARN</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">expectedCtr</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;NOT FOUND&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;  * %-40s : </span><span style="color:#000">$TEXT_FAIL</span><span style="color:#4e9a06"> (%s)\n&#34;</span> <span style="color:#4e9a06">&#34;Kanto Container Management&#34;</span> <span style="color:#4e9a06">&#34;Unavailable&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>Here it is important to know that <code>kanto-cm list</code> outputs the list of containers in a different order every time it&rsquo;s called. That is why, <code>kanto-cm list</code> is invoked once and its output is stored in a variable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>	<span style="color:#000">KANTO_CM_LIST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#4e9a06">${</span><span style="color:#000">KANTO_CMD</span><span style="color:#4e9a06">}</span> list<span style="color:#204a87;font-weight:bold">)</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID                                      <span style="color:#000;font-weight:bold">|</span>Name                                   <span style="color:#000;font-weight:bold">|</span>Image                                                                                                                          <span style="color:#000;font-weight:bold">|</span>Status         <span style="color:#000;font-weight:bold">|</span>Finished At                     <span style="color:#000;font-weight:bold">|</span>Exit Code   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>-------------------------------------   <span style="color:#000;font-weight:bold">|</span>-------------------------------------  <span style="color:#000;font-weight:bold">|</span>------------------------------------------------------------                                                                   <span style="color:#000;font-weight:bold">|</span>----------     <span style="color:#000;font-weight:bold">|</span>------------------------------  <span style="color:#000;font-weight:bold">|</span>----------  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>d82a406e-80d7-4d2c-8044-3799544fc39a    <span style="color:#000;font-weight:bold">|</span>vum                                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-vehicle-update-manager/vehicleupdatemanager:main-1d8dca55a755c4b3c7bc06eabfa06ad49e068a48    <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>0f079856-767c-4e8d-b4df-a2323392849f    <span style="color:#000;font-weight:bold">|</span>cloudconnector                         <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-cloud-connector/cloudconnector:main-47c01227a620a3dbd85b66e177205c06c0f7a52e                 <span style="color:#000;font-weight:bold">|</span>Exited         <span style="color:#000;font-weight:bold">|</span>2023-01-31T11:58:01.564126452Z  <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">1</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>e4cf317e-c2d3-42c7-8f12-8ecf6f9d5d7a    <span style="color:#000;font-weight:bold">|</span>databroker                             <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val/databroker:0.2.5                                                                                     <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>6440a9b6-4fb8-4735-b3de-484286ac705b    <span style="color:#000;font-weight:bold">|</span>feedercan                              <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.feeders/dbc2val:v0.1.1                                                                               <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>efbd572b-3331-4f19-9b17-7c69511ec5ca    <span style="color:#000;font-weight:bold">|</span>hvacservice-example                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.services/hvac_service:v0.1.0                                                                         <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>6d9a6f07-1659-4b51-9ddb-6e9ade64f2fd    <span style="color:#000;font-weight:bold">|</span>seatservice-example                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse/kuksa.val.services/seat_service:v0.1.0                                                                         <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>06b0ddf2-7c91-41e4-9a00-4213ee361cdf    <span style="color:#000;font-weight:bold">|</span>sua                                    <span style="color:#000;font-weight:bold">|</span>ghcr.io/eclipse-leda/leda-contrib-self-update-agent/self-update-agent:build-12                                                 <span style="color:#000;font-weight:bold">|</span>Running        <span style="color:#000;font-weight:bold">|</span>                                <span style="color:#000;font-weight:bold">|</span><span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000;font-weight:bold">|</span>
</span></span></code></pre></div><p>So we use awk to split on pipe (column), strip unecessary tabs. <code>print $2</code> then gives us the container name and <code>print $4</code> - its status.</p>
<p>sdv-health then proceeds to check if every container specified in the list is available and if its status is <code>Running</code>.</p>
<p>Note: <code>Exited</code> is considered a fail-state.</p>
<h2 id="checking-kanto-cm-socket">Checking kanto-cm socket</h2>
<p>This is a simple <code>test -s</code> check for the default socket path.</p>

</div>



    
	
  

    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-86721597a78c875c0c696bd18f935eb3">7 - Customizing</h1>
    
	<p>When you want to reuse Leda for your custom setup or hardware we do not directly provide BSPs for (see <a href="../customization/custom-images#Hardware">Hardware</a>) you can reference the following chapters. They describe the general approaches for different level of customization - from deploying different sets of containers from those provided by default to building completely custom distros based on meta-leda.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c753192d51f1964217336da765a28ba7">7.1 - Custom Distros</h1>
    
	<p>The Leda project aims to provide a BitBake meta-layer for building custom images within the SDV context. The Leda quickstart image serves as an experimentation and development platform but is not production-ready. The focus of the meta-leda meta-layer is to offer reusable components for custom SDV images.</p>
<p>This documentation section is aimed at anyone who wishes to build such a custom image.</p>
<h2 id="hardware">Hardware</h2>
<p>The Leda Quickstart image directly provides BSP-recipes for the following platforms:</p>
<ul>
<li>QEMUx86-64 (64 bit)</li>
<li>QEMUARM64 (64 bit)</li>
<li>QEMUARM (32 bit)</li>
<li>Raspberry Pi 4B (64 bit)</li>
</ul>
<p>Other hardware would require customizing your image with additional BSP-layers.</p>
<h2 id="kas-and-meta-layers">kas and meta-layers</h2>
<p>We recommend (and use for the quickstart image) the <a href="https://github.com/siemens/kas">kas tool</a> developed by Siemens as a way to help with reproducible builds. It is, however, not required and you would still need to
define your own distro meta-layer on top of meta-leda. The Leda quickstart image kas-files can be found here: <a href="https://github.com/eclipse-leda/leda-distro/tree/main/kas">leda-distro/kas</a>. Most of the distro-configuration can be found
in the <code>common-kirkstone.yaml</code> file.</p>
<p>Other than meta-leda you will need the following external meta-layers:</p>
<ul>
<li><a href="https://git.yoctoproject.org/git/poky">Poky</a> - The base poky distro</li>
<li><a href="https://git.openembedded.org/meta-openembedded">meta-openembedded</a> - Busybox, systemd, and other core packages</li>
<li><a href="https://github.com/rauc/meta-rauc">meta-rauc</a> - RAUC integration</li>
<li><a href="https://github.com/eclipse-kanto/meta-kanto">meta-kanto</a> - Kanto container management</li>
<li><a href="https://git.yoctoproject.org/meta-virtualization">meta-virtualization</a> - containerd</li>
</ul>
<p>From here on we will assume that you are working with kas as your main build tool.</p>
<h2 id="setting-up-your-custom-image">Setting up your custom image</h2>
<ol>
<li>
<p>Create a new repository for your distro. Create a top-level container meta-layer that would contain your distro-specific configurations which will be explained below.</p>
</li>
<li>
<p>In the root of the repository create a <code>.config.yaml</code> that would be used by kas to build your image. The minimal kas-config file can be found in the tool&rsquo;s official documentation <a href="https://kas.readthedocs.io/en/latest/userguide.html#project-configuration">Project Configuration</a>.</p>
</li>
<li>
<p>Referencing <a href="https://github.com/eclipse-leda/leda-distro/blob/main/kas/common-kirkstone.yaml">leda-distro/kas/common-kirkstone.yaml</a>, add to this minimal configuration all required meta-layers from above and sub-layers from meta-leda you will need.</p>
</li>
<li>
<p>Add your custom container layer (you can reference meta-layers by path in kas) to the kas-config. Reference: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/kas/.config-components.yaml">meta-leda/kas/.config-components.yaml</a>.</p>
</li>
<li>
<p>From this point on you can use <code>kas build</code> from the root of your repository or <code>kas build /path/to/.config.yaml</code> from anywhere to start the build process.</p>
</li>
</ol>
<h2 id="general-distro-configuration">General distro configuration</h2>
<p>The place you should start is by configuring your custom distribution. The BitBake mechanism for doing so can be found in the official BitBake documentation: <a href="https://docs.yoctoproject.org/dev/dev-manual/custom-distribution.html#creating-your-own-distribution">22 Creating Your Own Distribution</a>.</p>
<p>As a working example, you can use the Leda-distro config file: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-distro/conf/distro/leda.conf">meta-leda/meta-leda-distro/conf/distro/leda.conf</a>. We will now go through some of the lines in the <em>leda.conf</em>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>require conf/distro/include/buildinfo.inc <span style="color:#8f5902;font-style:italic"># -&gt; Defines entries for /etc/build</span>
</span></span><span style="display:flex;"><span>require conf/distro/include/leda-distro-features.inc <span style="color:#8f5902;font-style:italic"># -&gt; Defines the quickstart image features. Use it as a guide for your distro.</span>
</span></span><span style="display:flex;"><span>require conf/distro/include/leda-package-blacklist.inc <span style="color:#8f5902;font-style:italic"># -&gt; Defines blacklisted packages (e.g. alsa)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include conf/machine/<span style="color:#4e9a06">${</span><span style="color:#000">MACHINE</span><span style="color:#4e9a06">}</span>-extra.conf <span style="color:#8f5902;font-style:italic"># -&gt; Defines ${MACHINE}-specific configuration files FSTAB, wks, etc. Would be elaborated on further down.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">QB_KERNEL_CMDLINE_APPEND</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;net.ifnames=0 panic=5 ip=dhcp ip=192.168.7.2::192.168.7.1:255.255.255.0::eth0:off rootwait&#34;</span> <span style="color:#8f5902;font-style:italic"># -&gt; QEMU-specific kernel command line with which all images/partitions are booted</span>
</span></span></code></pre></div><p>The only <strong>required</strong> contents of your distro-config file are the following (all other includes and distro features are optional):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in the main leda.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DISTRO</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&lt;distro_name&gt;&#34;</span> <span style="color:#8f5902;font-style:italic"># should be the same as the &lt;distro_name&gt;.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DISTRO_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&lt;long_distro_name&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DISTRO_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&lt;version&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DISTRO_CODENAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&lt;distro_codename&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># imported with require conf/distro/include/leda-distro-features.inc in Leda Quickstart</span>
</span></span><span style="display:flex;"><span>DISTRO_FEATURES:append <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34; virtualization&#34;</span> <span style="color:#8f5902;font-style:italic"># required for containerd</span>
</span></span><span style="display:flex;"><span>DISTRO_FEATURES:append <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34; sdv&#34;</span> <span style="color:#8f5902;font-style:italic"># required by the sdv-packagegroups</span>
</span></span><span style="display:flex;"><span>DISTRO_FEATURES:append <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34; rauc&#34;</span> <span style="color:#8f5902;font-style:italic"># required for the rauc integration</span>
</span></span></code></pre></div><h3 id="machine-specific-configs">Machine-specific configs</h3>
<p>The &ldquo;extra&rdquo; machine specific-configs the meta-leda-bsp layer provides can be found here: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/conf/machine">meta-leda-bsp/conf/machine</a>. These files here provide examples on how to configure machine specific options such as the Linux Kernel image type, bootloader configuration, etc. E.g. if you need a working example of how to set up U-Boot for your machine, you might reference <code>common-qemu-arm.inc</code> since the Leda quickstart QEMUARM (64bit and 32bit) images use U-Boot as a bootloader.</p>
<h2 id="partitioning-your-storage">Partitioning your storage</h2>
<p>The Leda quickstart image uses RAUC as a way to do A/B partition type updates. We also add a third &ldquo;rescue&rdquo; partition and a persistent &ldquo;data&rdquo; partition. Generally, the Leda quickstart image partitions its storage as so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span> ----------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>|            |             |             |             |             |             |
</span></span><span style="display:flex;"><span>|            |             |             |             |             |             |
</span></span><span style="display:flex;"><span>|    VFAT    |    NO-FS    |    EXT4     |    EXT4     |    EXT4     |    EXT4     |
</span></span><span style="display:flex;"><span>|   (BOOT)   |  (GRUBENV)  |   (RESCUE)  |   (SDV_A)   |   (SDV_B)   |   (DATA)    |
</span></span><span style="display:flex;"><span>|            |             |             |             |             |             |
</span></span><span style="display:flex;"><span>|            |             |             |             |             |             |
</span></span><span style="display:flex;"><span> ----------------------------------------------------------------------------------
</span></span></code></pre></div><p>Where the partitions <strong>SDV_A</strong> and <strong>SDV_B</strong> are managed/updated by RAUC. They are read-only (<strong>SDV_A</strong> has the <em>sdv-image-full</em> image installed, <strong>SDV_B</strong> - <em>sdv-image-minimal</em>). All container/user data is in the last <strong>DATA</strong> partition (grows dynamically to fill out the storage). The boot partition contains the U-Boot/Grub bootloaders and their environment.</p>
<p><strong>GRUBENV</strong> is reserved for future boot-partition updates and saving the GRUB/U-Boot environment. Currently <em>unused</em> in the Leda quickstart image.</p>
<p>In the <strong>RESCUE</strong> partition the <em>sdv-image-rescue</em> image is installed, which is a &ldquo;fallback&rdquo; image for recovering the system if both partitions <strong>SDV_A</strong> and <strong>SDV_B</strong> get corrupted.</p>
<p>This partition scheme has to be seen, as of course, a <em>suggestion</em> (you are free to use any RAUC-compatible one) but is important for understanding the later sections on this page.</p>
<h2 id="wicwks">WIC/WKS</h2>
<p>To partition your storage you will need to define your custom <strong>.wks</strong>-file that defines the partition table type, the bootloader, and the order and size of partitions.</p>
<p>More details on OpenEmbedded Kickstart files can be found in the official documentation for Yocto: <a href="https://docs.yoctoproject.org/ref-manual/kickstart.html">OpenEmbedded Kickstart (.wks) Reference</a>. In short, <strong>.wks</strong>-files provide a reproducible way to partition your storage.</p>
<p><em>IMPORTANT: the path to your <strong>.wks</strong>-file should be provided via the <strong>WKS_FILES=</strong> BitBake variable. For example, in the quickstart image for QEMUARM64 this variable is set in <code>qemuarm64-extra.conf</code>.</em></p>
<p>Again, example <strong>.wks/.wks.in</strong> files are provided in <a href="https://github.com/eclipse-leda/meta-leda/tree/main/meta-leda-distro/wic">meta-leda/meta-leda-distro/wic</a>. We will now take a look at the qemuarm64 <strong>.wks</strong>-file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bootloader --ptable gpt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part --source bootimg-partition --ondisk vda --fstype=vfat --label BOOT --active --align 4096 --size 100 --use-uuid
</span></span><span style="display:flex;"><span># Second Bootloader Partition (empty, for future updates)
</span></span><span style="display:flex;"><span>part --fixed-size 10M --ondisk vda --align 4096 --no-table
</span></span><span style="display:flex;"><span># Empty partition (on x86, this is grubenv - we store RAUC Status here as well)
</span></span><span style="display:flex;"><span>part --fixed-size 10M --ondisk vda --align 4096
</span></span><span style="display:flex;"><span>part --source rootfs --rootfs-dir=sdv-image-rescue --ondisk vda --fstype=ext4 --label rescue --align 1024
</span></span><span style="display:flex;"><span>part --source rootfs --rootfs-dir=sdv-image-full --ondisk vda --fstype=ext4 --label root_a --align 4096
</span></span><span style="display:flex;"><span>part --source rootfs --rootfs-dir=sdv-image-minimal  --ondisk vda --fstype=ext4 --label root_b --align 4096
</span></span><span style="display:flex;"><span>part --fixed-size 2048M --source rootfs --rootfs-dir=sdv-image-data --ondisk vda --fstype=ext4 --label data --align 4096
</span></span></code></pre></div><p>As you can see it directly implements the partition scheme described above. The partition table type is defined with the <code>bootloader --ptable gpt</code> line and every line after that corresponds to a partition from the diagram above.
Please note, that the order in which the <code>part</code> lines in the <strong>.wks</strong>-file appear would be the order of the partitions.</p>
<p>Here it is important to note that for the VFAT boot partition the label should be uppercase and you should add the <code>--use-uuid</code> option. Otherwise, it might not be mounted properly in the final Linux distro.</p>
<h2 id="fstab">FSTAB</h2>
<p><strong>.wks</strong>-files partition your storage, define partition tables, filesystem types and install images, but do nothing about actually mounting said partitions in the Linux userspace. This is the job of the FSTAB file. More information about writing a FSTAB file can be found in the <a href="https://man7.org/linux/man-pages/man5/fstab.5.html">Linux FSTAB manpage</a>.</p>
<p>FSTAB files are installed through the OE-core recipe <code>base-files_&lt;version&gt;.bb</code>. To install a custom FSTAB in your image create a <code>recipes-core/base-files</code> directory in your container meta-layer and create a <code>base-files_%.bbappend</code> inside.
Use this <em>.bbappend</em> to prepend the directory containing your custom FSTAB to the <code>FILESEXTRAPATHS</code> list for that recipe.</p>
<p>An example can be found in <code>meta-leda/meta-leda-distro/recipes-core/base-files/</code> where you would find the needed <code>.bbappend</code> file and the <code>meta-leda/meta-leda-distro/recipes-core/base-files/base-files/&lt;machine&gt;</code> directory containing the actual FSTAB files.</p>
<p>Let&rsquo;s investigate the Leda <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-distro/recipes-core/base-files/base-files/qemuarm64/fstab">qemuarm64 FSTAB</a> as an example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># Eclipse Leda - fstab for qemuarm64 RAUC redundant boot setup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/dev/root            /                    auto       defaults,noatime              1  1
</span></span><span style="display:flex;"><span>proc                 /proc                proc       defaults              0  0
</span></span><span style="display:flex;"><span>devpts               /dev/pts             devpts     mode=0620,ptmxmode=0666,gid=5      0  0
</span></span><span style="display:flex;"><span>tmpfs                /run                 tmpfs      mode=0755,nodev,nosuid,strictatime 0  0
</span></span><span style="display:flex;"><span>tmpfs                /var/volatile        tmpfs      defaults              0  0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Add mount for boot, grubenv and data partition
</span></span><span style="display:flex;"><span>LABEL=BOOT           /boot                vfat       defaults,nofail,noatime  0  0
</span></span><span style="display:flex;"><span>LABEL=grubenv        /grubenv             auto       defaults,nofail,noatime  0  0
</span></span><span style="display:flex;"><span>LABEL=data           /data                auto       defaults,nofail,noatime  0  2
</span></span></code></pre></div><p>Here only the BOOT, grubenv, and data partitions are mounted by label.</p>
<p>The root partition depends on the image (sdv-image-full/minimal/rescue) that has been currently booted. Here /dev/root is a &ldquo;special variable&rdquo; that is set from the <code>root=</code> option in the kernel command line. This is important to be able
to boot from the different partitions via a custom bootloader script (and as a consequence these partitions are to be managed by RAUC).</p>
<h2 id="integrating-rauc">Integrating RAUC</h2>
<p>Whether you are using GRUB or U-Boot, integrating RAUC requires custom bootloader scripting. The official documentation for integrating RAUC can be found here: <a href="https://rauc.readthedocs.io/en/latest/integration.html">6. Integration</a>.</p>
<p>This documentation can, however, be quite complicated. Concise, self-contained examples for proper integration of the most popular targets can be found in the <a href="https://github.com/rauc/meta-rauc-community/tree/master/meta-rauc-qemux86">meta-rauc-community</a> repository.</p>
<h3 id="the-rauc-system-config-file">The RAUC system config file</h3>
<p>Irrespective of your bootloader, you need to provide a RAUC system.conf file describing the slots, the bootloader, certificates, etc. This is best explained via an example: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/rauc/files/qemuarm64/system.conf">meta-leda/meta-leda-bsp/recipes-bsp/rauc/files/qemuarm64/system.conf</a></p>
<h3 id="grub">GRUB</h3>
<p>The only Leda quickstart image that uses GRUB as a bootloader is for qemux86_64. It directly uses the <a href="https://github.com/rauc/meta-rauc-community/tree/master/meta-rauc-qemux86">meta-rauc-community/meta-rauc-qemux86/</a> meta-layer.</p>
<h3 id="u-boot">U-Boot</h3>
<p><em>Note: The following sub-sections are based on the official <a href="https://source.denx.de/u-boot/u-boot">U-Boot source</a> which the OE recipes use. Your BSP may provide another hardware-specific fork of U-Boot that may or may not be entirely compatible with this integration guide. (e.g. fw_utils not being available)</em></p>
<p>The rpi4-64 target, similar to qemux86_64, directly uses <a href="https://github.com/rauc/meta-rauc-community/tree/master/meta-rauc-raspberrypi">meta-rauc-community/meta-rauc-raspberrypi</a> which also has a great README, explaining the details of the integration. This meta-layer includes quite a lot of rpi4-64 specific recipes and depends on the fact that the meta-raspberrypi layer provides a recipe for custom boot scripts. Such a recipe, in general, for U-Boot-based targets is not available and has to be manually created. That is why, <a href="https://github.com/rauc/meta-rauc-community/tree/master/meta-rauc-sunxi">meta-rauc-community/meta-rauc-sunxi</a> might provide a better example in a more general case.</p>
<p>The Leda quickstart images that use U-boot as a bootloader are based on the ideas in <code>meta-rauc-sunxi</code>. We will now go into more detail on how to integrate such a U-Boot target that requires a more &ldquo;from-scratch&rdquo; integration.</p>
<h4 id="the-u-boot-environment-and-slot-counting">The U-Boot environment and &ldquo;slot-counting&rdquo;</h4>
<p>RAUC &ldquo;talks&rdquo; to the bootloader and tracks how many times you have tried to boot a slot via the <strong>bootloader</strong> environment variables &ldquo;BOOT_ORDER&rdquo; and &ldquo;BOOT_&lt;SLOT_NAME&gt;_LEFT&rdquo;. Thus, U-Boot should be able to save its environment in a file
(<code>uboot.env</code>) somewhere that can be read by RAUC from userspace (the booted Linux image). This can be the VFAT BOOT partition, a flash chip, EEPROM, etc. which can be mounted in userspace and read by RAUC.</p>
<p>Note that while most of the steps for each of these storage options are the same, they might need some specific configuration. For example, the build for the Leda Quickstart QEMUARM64 patches the U-Boot defconfig file to point U-Boot to save its environment in the VFAT BOOT partition <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/files/qemuarm64/env_in_fat_qemuarm.patch">env_in_fat_qemuarm.patch</a>. You can instead directly provide a custom defconfig in your machine-specific config (ref: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/conf/machine/qemuarm64-extra.conf#L8">qemuarm64-extra.conf</a>).</p>
<h4 id="uboot_bbappend">uboot_%.bbappend</h4>
<p>After ensuring that the device containing the U-Boot environment is correctly mounted in userspace (e.g. the BOOT partition as /boot). Create a custom <code>uboot_%.bbappend</code> file and as an example, you can use <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/uboot-targets/qemuarm64.inc">meta-leda/meta-leda-bsp/recipes-bsp/uboot/uboot-targets/qemuarm64.inc</a>. This .bbappend should, generally do two things:</p>
<ul>
<li>
<p>Take your custom <code>boot.cmd.in</code> script and compile it to a boot.scr  (or boot.scr.uimg) file with mkimage.</p>
</li>
<li>
<p>Install the <code>fw_env.config</code> file in /etc/fw_env.config.</p>
</li>
<li>
<p>Optional: Apply any patches, custom settings, etc.</p>
</li>
</ul>
<p><em>Note: if you are building for more than one U-Boot-based target extensive use of machine-specific overrides is recommended.</em></p>
<h4 id="custom-bootscr">Custom boot.scr</h4>
<p>If a custom boot.scr that was compiled with the <em>mkimage</em> tool is in the same partition as the U-Boot binary, U-Boot will run that on boot. This is the point of integration of RAUC and U-Boot. All concepts behind setting up such a script are explained in the <a href="https://github.com/rauc/rauc/blob/8216e0df6c716a87406df676295af94b77814e5e/docs/integration.rst#id27">rauc documentation</a>.</p>
<p>Generally, as a starting point, you can use one of the custom scripts in meta-rauc-community or those in meta-leda: <a href="https://github.com/eclipse-leda/meta-leda/blob/main/meta-leda-bsp/recipes-bsp/uboot/files/qemuarm64/boot.cmd.in">meta-leda/meta-leda-bsp/recipes-bsp/uboot/files/qemuarm64/boot.cmd.in</a>.</p>
<p><strong>IMPORTANT: Be consistent with your slot names!</strong></p>
<p>As it can be seen in the examples, after the &ldquo;slot retries counting&rdquo; part of the script is done, the <code>root=</code> and <code>rauc.slot=</code> kernel command line arguments are set, the U-Boot environment is saved in the VFAT boot partition as uboot.env and the selected image is booted.</p>
<p>Then, from userspace RAUC reads the kernel command line (/proc/cmdline) and the uboot.env (through the fw_printenv/fw_setenv utilities) and decides (based on that) whether a slot is &ldquo;<span class="-text-green">Good</span>&rdquo; or &ldquo;<span class="-text-red">Bad</span>&rdquo;.</p>
<h4 id="fw_envconfig">fw_env.config</h4>
<p>For RAUC to be able to read and modify the U-Boot environment from userspace, it needs the fw_printenv/fw_setenv utilities to be installed in the distro. This can be done by installing the packages: <code>&quot;u-boot-fw-utils u-boot-env libubootenv&quot;</code> through IMAGE_INSTALL or RDEPENDS in a recipe.</p>
<p>This, however, is not enough since these utilities, in turn, have to be configured to know where U-Boot stores its environment. This is done through the /etc/fw_env.config file. An example of such a file with all of its different variations can be seen here <a href="https://github.com/ARM-software/u-boot/blob/master/tools/env/fw_env.config">fw_env.config</a>.</p>
<p>The one for Leda quickstart contains a single line:</p>
<pre tabindex="0"><code>/boot/uboot.env 0x0000  0x4000
</code></pre><p>If you are unsure of the environment size and the device offset, check the defconfig file for your machine, where these two values should be specified as U-Boot compile-time configuration parameters.</p>
<h4 id="conclusion-u-boot---rauc-integration-checklist">Conclusion (U-Boot &lt;-&gt; RAUC integration checklist)</h4>
<p>Given the following:</p>
<ol>
<li>
<p>You have setup U-Boot to save its environment in a known place (device, partition, etc).</p>
</li>
<li>
<p>This device storing the U-Boot environment is mounted in userspace.</p>
</li>
<li>
<p>You have provided a custom boot-script that does the RAUC slot counting.</p>
</li>
<li>
<p>You have installed fw_printenv/fw_setenv and properly setup the /etc/fw_env.config file.</p>
</li>
</ol>
<p>The RAUC mark-good-service should successfully go through and mark both RAUC slots as &ldquo;<span class="-text-green">GOOD</span>&rdquo;.</p>
<h2 id="final-steps---building-and-flashing">Final steps - building and flashing</h2>
<p>Build:</p>
<p>Run <code>kas build</code> in the root of your repository and wait for the build to finish successfully. If any BitBake errors occur during the build process, you need to fix them before a final flashable image can be built.</p>
<p>Flash:</p>
<p>Obtain the <code>image-name.wic.bz2</code> and <code>image-name.wic.bmap</code> files from the <code>tmp/deploy/images</code> directory. Mount your storage and use bmaptool to quickly flash the built image. More information on flashing can be found in the <a href="../../general-usage/raspberry-pi/">Running on Raspberry Pi</a> section of this documentation.</p>
<p>If everything works as intended you should see in the U-Boot output that it found <code>/boot.scr</code> and started executing it. This should lead to a successful boot of your custom Linux distro image with the RAUC-mark-good.service being marked as [<span class="-text-green">OK</span>] in the systemd logs (if your distro uses systemd).</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-20bb2af83c47c818220bae4f2b8b24f7">7.2 - Deploying Containers</h1>
    
	<h2 id="kanto-container-management-kanto-cm-init-dir">Kanto Container Management (kanto-cm) init-dir</h2>
<p>Kanto-cm provides a mechanism to automatically deploy containers based on json-manifests stored in a so-called <code>init_dir</code> on boot. The template can be found in the kanto-cm documentation: <a href="https://websites.eclipseprojects.io/kanto/docs/references/containers/container-manager-config/#template">Template</a>.</p>
<p>A &ldquo;filled in&rdquo; template can be found in meta-leda (e.g. meta <a href="https://github.com/eclipse-leda/meta-leda/blob/2cb683a9606c01a73fc4f4d01df92a23a2cd2b9c/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/core/databroker.json">meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/core/databroker.json</a>).</p>
<p>The directory for these manifests is set during image build time through the BitBake variable <code>KANTO_MANIFESTS_DIR</code>. By default, the Leda Quickstart image sets this directory to <code>/data/var/containers/manifests</code>. Since this is a directory mounted on the persistent <strong>data</strong>-partition you can add custom manifests/customize the default ones after an image has been built. These changes <strong>will not be affected</strong> by a RAUC update.</p>
<p>A standard set of containers is deployed with meta-leda, the manifests for which can be found in <code>meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/core</code> and <code>meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example/</code>.</p>
<p><strong>Important: The manifests in the kanto-cm init-dir are checked only <em>ONCE</em>  - on service start-up. If you add/change a manifest you would need to restart the whole &ldquo;container-management&rdquo; service for your changes to take effect.</strong></p>
<h2 id="kanto-auto-deployer">Kanto-auto-deployer</h2>
<p>This service has been implemented as a stopgap solution by the Leda team before the kanto-cm init-dir mechanism was implemented by the Kanto team. In-depth documentation on its operation and development can be found in the <a href="../../build/dev-and-maintenance/rust/kanto-auto-deployer">Kanto Auto deployer</a>. This runs as a one-shot service on boot and checks the directory defined in the BitBake variable <code>KANTO_MANIFESTS_DEV_DIR</code> in the distro config recipes. By default, the Leda quickstart images use <code>KANTO_MANIFESTS_DEV_DIR=/data/var/containers/manifests_dev&quot;</code>. So, these manifest are again stored in the persistent <strong>data</strong>-partition and can be modified after the image has been deployed.</p>
<p><strong>Important: the <a href="../../build/dev-and-maintenance/rust/kanto-auto-deployer#manifest-structure">manifest template</a> used for this service is similar to the one for the kanto-cm native mechanism, but is, in fact, different. Kanto-auto-deployer uses the kanto-cm internal state representation.</strong></p>
<p>A standard set of <em>dev</em>-containers is deployed with meta-leda, the manifests for which can be found in <code>meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/core_dev</code> and <code>meta-leda/meta-leda-components/recipes-sdv/eclipse-leda/kanto-containers/example_dev/</code>.</p>
<p>The advantage of this service is that it can be restarted very quickly (<code>systemctl restart kanto-auto-deployer</code>), without having to restart the <em>whole</em> container-management service. This allows for rapid testing when deploying a new container. Due to the similarity of both manifests, the kanto-auto-deployer-style manifest can later be easily migrated to the kanto ini-dir style-one.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b438fd7e15c2574be03cee1dc972c1d6">7.3 - Wifi Configuration</h1>
    
	<p>BSP packages for emulated WiFi devices (QEMU) and hardware device drivers are provided in <code>meta-leda</code> for <a href="../custom-images#hardware">supported hardware</a>.
They usually do not require extra configuration. Images built with our meta-layer provide iwd/iwctl as a high-level daemon/interface for managing wireless
connectivity.</p>
<p>For a guide on how to connect to a wireless network with iwctl check the <a href="iwd-iwctl"><em>Notes on using iwctl</em></a> page.</p>
<h2 id="raspberry-pi-4b-64">Raspberry Pi 4B 64</h2>
<p>The required kernel modules and binary blobs are provided with the <code>sdv-wifi-kernel-config.inc</code> config file and the <code>packagegroup-sdv-rpi4wifi</code> packagegroup. These
are included in <code>sdv-image-full.bb</code> and <code>sdv-image-minimal.bb</code> by default.</p>
<p>If you, however, decide to define your own custom image based on <a href="../custom-images"><em>Custom Distros</em></a>,
you would have to make sure the packagegroup is installed to enable WiFi connectivity.</p>
<h2 id="qemu">QEMU</h2>
<p>QEMU images provide the kernel modules necessary to set-up a virtual wlan interface and connect it to a virtual wifi network. This can be useful in various testing scenarios.</p>
<p>To create and link a virtual WiFi interface boot your QEMU image and run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ip link add link eth0 name wlan0 <span style="color:#204a87">type</span> virt_wifi
</span></span><span style="display:flex;"><span>$ iwctl station wlan0 connect VirtWifi
</span></span></code></pre></div><p>You will now have a virtual wlan0 interface with the same configuration as eth0.</p>
<p><em>Note:</em> Leda Quickstart QEMU images set the name of the default virtual ethernet interface to <code>eth0</code> through kernel CMDLINE configurations (<code>net.ifnames=0 biosdevname=0</code>).
If you are building a custom image with a different kernel CMDLINE replace <code>eth0</code> with the name of your virtual intrface (check <code>ifconfig</code>).</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-572603d812bc31861223167334ab4429">7.3.1 - Notes on using iwd/iwctl</h1>
    
	<p>Here we will describe the basic steps on how to connect to a WiFi network using iwctl.</p>
<h2 id="initial-steps-identifying-wlan-interfaces">Initial steps (identifying wlan interfaces)</h2>
<p>Start by opening the <code>iwctl</code> shell</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iwctl
</span></span></code></pre></div><p>If you are unsure of the name of the name of your wireless device, you can list all Wi-Fi devices and network adapters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># adapter list</span>
</span></span><span style="display:flex;"><span>                                    Adapters                                  *
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  Name               Powered   Vendor              Model               
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  phy0               on        Broadcom Corp.BCM43438 combo WLAN 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># device list</span>
</span></span><span style="display:flex;"><span>                                    Devices                                    
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  Name                Address             Powered   Adapter   Mode      
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  &lt;device&gt;               &lt;MAC&gt;              on        phy0      station   
</span></span></code></pre></div><p>If the device or its corresponding adapter is turned off (the <code>Powered</code> property), turn it on by running:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># device &lt;device&gt; set-property Powered on</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># adapter &lt;adapter&gt; set-property Powered on</span>
</span></span></code></pre></div><p>Check the device/adapter list again to ensure they are now powered on.</p>
<h2 id="connecting-to-a-network">Connecting to a network</h2>
<p>Initiate a network scan by running (<em>Note:</em> this command has no output):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># station &lt;device&gt; scan</span>
</span></span></code></pre></div><p>List all available networks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># station &lt;device&gt; get-networks </span>
</span></span><span style="display:flex;"><span>                               Available networks                              
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>    Network name                    Security          Signal
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>    &lt;SSID&gt;                           psk               ****  
</span></span></code></pre></div><p>Finally, after identifying your network&rsquo;s SSID, connect to it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># station &lt;device&gt; connect &lt;SSID&gt;</span>
</span></span></code></pre></div><p>If a passphrase is required, you will be prompted to enter it.</p>
<p>You can now exit the <code>iwctl</code> shell:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>iwd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># exit</span>
</span></span></code></pre></div><h3 id="connecting-with-a-single-command">Connecting with a single command</h3>
<p>Alternatively, if you know you network&rsquo;s SSID and your wireless device&rsquo;s name you can connect to the network with a single command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iwctl --passphrase &lt;passphrase&gt; station &lt;device&gt; connect &lt;SSID&gt;
</span></span></code></pre></div><p>To check current status of device (for example wlan0):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iw dev wlan0 link
</span></span></code></pre></div><p>From now on this WiFi network will be remembered for future connections.</p>
<h4 id="references">References</h4>
<p>This readme is based on the guidelines documented in the <a href="https://wiki.archlinux.org/title/Iwd#Connect_to_a_network">ArchLinux Documentation</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-205745980ea22e98566bc8629ffffc7a">7.4 - FAQ</h1>
    
	<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3 id="why-is-the-performance-very-slow"><strong>Why is the performance very slow?</strong></h3>
<p>The performance of a system heavily relies on the infrastructure and the general setup.</p>
<ul>
<li>On virtual setup (QEMU): Typical reasons for slow performance are software emulation, e.g. when you run an ARM-based image on an x86-based host machine. This requires QEMU to emulate the execution, which is very slow. When you run an x86-based image on an x86-based host machine, QEMU can leverage acceleration, such as KVM, which greatly improves the performance. For network performance issues, try to use TAP networking instead of SLIRP networking for QEMU. That requires more setup on the host though.</li>
<li>On hardware, such as Raspberry Pi, it should be fast. If the system startup takes very long, you may have an outdated image, please update to the latest version. Another cause of performance loss can be networking issues, especially if the system does not have transparent internet access, network requests (e.g. DNS) may time out and slowing down the startup. On startup, the container runtime may download newer versions of containers and unpack them, which takes a considerable amount of time depending on the size of the container images.</li>
</ul>
<h3 id="why-is-my-bluetoothwifi-driver-missing"><strong>Why is my Bluetooth/Wifi driver missing?</strong></h3>
<p>Please check the latest release, as we&rsquo;re continously adding features. If your driver is still missing, please <a href="https://github.com/eclipse-leda/leda-distro/issues/new/choose">open a new GitHub Issue</a>. We can add Kernel Modules for supported hardware. If you hardware is not supported out of the box by the Eclipse Leda project, you need to build your own image and customize the Linux Kernel configuration. Please see the <a href="https://www.yoctoproject.org/">Yocto Project</a> documentation on how to do that.</p>
<h3 id="how-do-i-connect-to-a-wifi-network"><strong>How do I connect to a WiFi network?</strong></h3>
<p>We use iwd/iwctl as high-level interfaces to manage wireless devices. For a guide on how to connect to a WiFi network with iwctl, you can check: <a href="../wifi-configuration/iwd-iwctl"><em>Notes on using iwd/iwctl</em></a>.</p>
<h3 id="how-can-a-container-access-can-bus-interfaces"><strong>How can a container access CAN-Bus interfaces?</strong></h3>
<p>As using a CAN-Bus requires access to the host network interface, the container needs to run in privileged mode and it needs access to the host network interface. For a Kanto-CM container, simply add <code>privileged: true</code> to the <a href="https://websites.eclipseprojects.io/kanto/docs/references/containers/container-config/">container configuration</a>. A more sophisticated setup involves using virtual CAN interfaces for each container and using a CAN gateway to route the traffic accordingly. However, using CAN-Bus is not in the focus of SDV-style applications, as we assume that <em>Vehicle Services</em> would be running on dedicated ECUs, offering higher-level interfaces to <em>Vehicle Applications</em> on other protocols, such as Some/IP.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;host_config&#34;</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;network_mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;privileged&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="why-does-booting-from-sd-card-sometimes-fail-and-enters-maintenance-mode"><strong>Why does booting from SD-Card sometimes fail and enters maintenance mode?</strong></h3>
<p>This may depend on the quality or age of the SD-Card as well. Also, consumer-grade hardware like a Raspberry Pi may fail at times. Please try another SD-Card. Another reason may be high write operations to the SD-Card due to excessive data transfer (logging, container deployment etc.).</p>
<h3 id="how-can-i-install-additional-software-in-leda"><strong>How can I install additional software in Leda?</strong></h3>
<p>As we&rsquo;re using Yocto, there is no central repository for software packages. Thus, we did not include any kind of package manager. If you feel that the software you want to install is valuable for other Leda users as well, please <a href="https://github.com/eclipse-leda/leda-distro/issues/new/choose">open a new GitHub Issue</a> and request the installation of the software. If the software is specific to your use case, you need to build your own image using Yocto. Alternatively, you may build a container for your software and deploy the container into the container runtime. Using <code>kanto-cm</code> or <code>ctr</code> you would be able to execute your software as a container. See the <a href="/leda/docs/general-usage/cheatsheet/#running-custom-ad-hoc-containers">Cheatsheet</a> for an example.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af94d3dc4d5e71fd2c9d92bcafa3b325">8 - Project Information</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e1426bce55eda42a39b0db25e619c6e3">8.1 - Community</h1>
    
	<p>Thanks for your interest in this project and in our community.</p>
<ul>
<li><a href="https://projects.eclipse.org/projects/automotive.leda">https://projects.eclipse.org/projects/automotive.leda</a></li>
</ul>
<h2 id="contact">Contact</h2>
<p>Contact the project developers via the project&rsquo;s &ldquo;dev&rdquo; list.</p>
<ul>
<li><a href="https://accounts.eclipse.org/mailing-list/leda-dev">https://accounts.eclipse.org/mailing-list/leda-dev</a></li>
</ul>
<h2 id="developer-resources">Developer resources</h2>
<p>Information regarding source code management, builds, coding standards, and
more.</p>
<ul>
<li><a href="https://projects.eclipse.org/projects/automotive.leda/developer">https://projects.eclipse.org/projects/automotive.leda/developer</a></li>
</ul>
<p>The project maintains the following source code repositories</p>
<ul>
<li><a href="https://github.com/eclipse-leda/leda">https://github.com/eclipse-leda/leda</a></li>
<li><a href="https://github.com/eclipse-leda/leda-distro">https://github.com/eclipse-leda/leda-distro</a></li>
<li><a href="https://github.com/eclipse-leda/meta-leda">https://github.com/eclipse-leda/meta-leda</a></li>
</ul>
<h2 id="publications">Publications</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=91hNeQ3kf0w">Eclipse Leda Introduction Video</a> - YouTube, 2min</li>
<li><a href="https://www.youtube.com/watch?v=yOVHyG0aZ7M&amp;list=PLy7t4z5SYNaRYI7lH26szREOi9pfqxOUU&amp;index=8">Eclipse SDV - First Contribution Day (June 2022)</a> - Session Recording, YouTube, 26min</li>
<li><a href="https://www.youtube.com/watch?v=hiFriZhv1NE&amp;list=PLy7t4z5SYNaRYI7lH26szREOi9pfqxOUU&amp;index=17">Eclipse SDV - Second Contribution Day (September 2022)</a> - Session Recording, YouTube, 30min</li>
<li><a href="./Eclipse%20Leda%20-%20Slides%20SDV%20Contribution%20Day%20-%20September%202022.pdf">Eclipse Leda - Slides SDV Contribution Day - September 2022</a> - Slides (PDF)</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-edbc3d7c3b14d2db3ea68d37f7851e4b">8.2 - Dependencies</h1>
    
	<table>
<thead>
<tr>
<th>Dependency</th>
<th>Type</th>
<th>License</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>poky</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://www.yoctoproject.org/software-item/poky/">https://www.yoctoproject.org/software-item/poky/</a></td>
</tr>
<tr>
<td>meta-virtualization</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://git.yoctoproject.org/meta-virtualization">https://git.yoctoproject.org/meta-virtualization</a></td>
</tr>
<tr>
<td>meta-networking</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://git.yoctoproject.org/meta-networking">https://git.yoctoproject.org/meta-networking</a></td>
</tr>
<tr>
<td>meta-rauc</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://github.com/rauc/meta-rauc">https://github.com/rauc/meta-rauc</a></td>
</tr>
<tr>
<td>meta-openembedded</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://git.openembedded.org/meta-openembedded">https://git.openembedded.org/meta-openembedded</a></td>
</tr>
<tr>
<td>meta-security</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://git.yoctoproject.org/meta-security">https://git.yoctoproject.org/meta-security</a></td>
</tr>
<tr>
<td>meta-rauc-community</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://github.com/rauc/meta-rauc-community">https://github.com/rauc/meta-rauc-community</a></td>
</tr>
<tr>
<td>meta-raspberrypi</td>
<td>OpenEmbedded Metalayer</td>
<td>MIT</td>
<td><a href="https://git.yoctoproject.org/meta-raspberrypi">https://git.yoctoproject.org/meta-raspberrypi</a></td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3804c959464b4f1164e582f67ae410d0">8.3 - Contribution Guidelines</h1>
    
	<p>Thanks for considering to contribute to Eclipse Leda. We really appreciate the time and effort you want to spend helping to improve the project.</p>
<p>In order to get you started as fast as possible we need to go through some organizational issues first, though.</p>
<h2 id="eclipse-development-process">Eclipse Development Process</h2>
<p>This Eclipse Foundation open project is governed by the Eclipse Foundation
Development Process and operates under the terms of the Eclipse IP Policy.</p>
<ul>
<li><a href="https://eclipse.org/projects/dev_process">https://eclipse.org/projects/dev_process</a></li>
<li><a href="https://www.eclipse.org/org/documents/Eclipse_IP_Policy.pdf">https://www.eclipse.org/org/documents/Eclipse_IP_Policy.pdf</a></li>
</ul>
<h2 id="eclipse-contributor-agreement">Eclipse Contributor Agreement</h2>
<p>Before your contribution can be accepted by the project team contributors must
electronically sign the Eclipse Contributor Agreement (ECA).</p>
<ul>
<li><a href="http://www.eclipse.org/legal/ECA.php">http://www.eclipse.org/legal/ECA.php</a></li>
</ul>
<p>Commits that are provided by non-committers must have a Signed-off-by field in
the footer indicating that the author is aware of the terms by which the
contribution has been provided to the project. The non-committer must
additionally have an Eclipse Foundation account and must have a signed Eclipse
Contributor Agreement (ECA) on file.</p>
<p>For more information, please see the Eclipse Committer Handbook:
<a href="https://www.eclipse.org/projects/handbook/#resources-commit">https://www.eclipse.org/projects/handbook/#resources-commit</a></p>
<h2 id="making-your-changes">Making Your Changes</h2>
<ul>
<li>Fork the repository on GitHub.</li>
<li>Create a new branch for your changes.
<ul>
<li><em>Note: When forking multiple repositories (eg most of the time, you also need to make modifications to meta-leda), please use the same branch name of each repository.</em></li>
</ul>
</li>
<li>Make your changes following the code style guide for the respective type of content:
<ul>
<li>BitBake Recipes: <a href="https://www.openembedded.org/wiki/Styleguide">https://www.openembedded.org/wiki/Styleguide</a></li>
<li>Documentation: <a href="https://www.docsy.dev/docs/best-practices/">https://www.docsy.dev/docs/best-practices/</a></li>
<li>Shell Scripts (Example Style Guide): <a href="https://google.github.io/styleguide/shellguide.html">https://google.github.io/styleguide/shellguide.html</a></li>
</ul>
</li>
<li>When you create new files make sure you include a proper license header at the top of the file (see License Header section below).</li>
<li>Make sure you include test cases for non-trivial features.</li>
<li>Make sure the test suite passes after your changes.</li>
<li>Commit your changes into that branch.</li>
<li>Use descriptive and meaningful commit messages. Start the first line of the commit message with the a GitHub Issue number if available and a title e.g. <code>[#9865] Add token based authentication</code>.</li>
<li>Squash multiple commits that are related to each other semantically into a single one.</li>
<li>Make sure you use the <code>-s</code> flag when committing as explained above.</li>
<li>Push your changes to your branch in your forked repository.</li>
<li>Once you&rsquo;re satisfied with your contribution, open a Pull Request and Eclipse Leda Committers will start with the review of your changes.
<ul>
<li><em>Note: When working with multiple repositories, you need to open separate Pull Requests for each repository.</em></li>
</ul>
</li>
</ul>
<h2 id="adding-documentation-to-hugo">Adding Documentation to Hugo</h2>
<ul>
<li>Add the markdown document to the appropriate folder in the path <code>leda/content/en</code>.</li>
<li>Add the front-matter</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;title of the file&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">date</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2022-05-09T13:43:25</span><span style="color:#0000cf;font-weight:bold">+05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>Additional front matter that can be added –
<ul>
<li>url : &quot;specifying a definite url to the file&quot;</li>
<li>weight : 10 (used for ordering your content in lists. Lower weight gets higher precedence.)</li>
</ul>
</li>
<li>The images need to be put in path <code>leda/static/assets</code>. The image reference should be <code>/assets/image.jpg</code> in the markdown file.
(Note: Do not use relative paths or url)</li>
<li>In case you are creating a new folder, create _index.md file with the front matter only.</li>
</ul>
<h2 id="running-locally">Running Locally</h2>
<ul>
<li>Install hugo version 0.98.0 extended <a href="https://github.com/gohugoio/hugo/releases/tag/v0.98.0">Release v0.98.0 · gohugoio/hugo (github.com)</a></li>
<li>Install Docsy theme in the path leda/themes/docsy –</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#Run this command from root directory of velocitas-docs</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/google/docsy.git themes/docsy
</span></span></code></pre></div><ul>
<li>Install pre-requisites</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> themes/docsy/userguide/
</span></span><span style="display:flex;"><span>npm install
</span></span><span style="display:flex;"><span>npm install --save-dev postcss
</span></span></code></pre></div><ul>
<li>From the leda directory run the command <strong>hugo server</strong> visit localhost:1313 to see the rendered static site.</li>
</ul>
<h2 id="submitting-the-changes">Submitting the Changes</h2>
<p>Submit a pull request via the normal GitHub UI.</p>
<h2 id="after-submitting">After Submitting</h2>
<ul>
<li>Do not use your branch for any other development, otherwise further changes that you make will be visible in the PR.</li>
</ul>
<h2 id="license-header">License Header</h2>
<p>Please make sure any file you newly create contains a proper license header like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># /********************************************************************************</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * Copyright (c) 2022 Contributors to the Eclipse Foundation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># *</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * See the NOTICE file(s) distributed with this work for additional</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * information regarding copyright ownership.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># *</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * This program and the accompanying materials are made available under the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * terms of the Apache License 2.0 which is available at</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * https://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># *</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * SPDX-License-Identifier: Apache-2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ********************************************************************************/</span>
</span></span></code></pre></div><p>You should, of course, adapt this header to use the specific mechanism for comments pertaining to the type of file you create.</p>
<p><strong>Important</strong></p>
<p>Please do not forget to add your name/organization to the <code>LICENSE</code> file&rsquo;s <em>Copyright Holders</em> section. If this is not the first contribution you make, then simply update the time period contained in the copyright entry to use the year of your first contribution as the lower boundary and the current year as the upper boundary, e.g.</p>
<p><code>Copyright 2017, 2018 ACME Corporation</code></p>
<h2 id="build">Build</h2>
<ul>
<li>On every PR merge a pipeline run will be triggered. This run will trigger the hugo docs build</li>
<li>Hugo v0.98.0 extended is set up for the runner</li>
<li>Docsy theme is setup for beautification of static site</li>
<li>Then dependencies are installed for the theme</li>
<li>Static site is generated and stored in a folder &quot;public&quot;</li>
<li>The contents of public are committed to gh_pages branch which is exposed to host the github pages</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ecbb8edc896b280ddac3a1b67ddd7ef1">8.4 - Project Logo</h1>
    
	<p><a href="eclipse-leda-logo.zip">Download eclipse-leda-logo.zip</a></p>
<h2 id="for-screen">For Screen</h2>
<h3 id="white-background">White background</h3>







<figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 650px">
	<img class="card-img-top" src="/leda/docs/project-info/logo/eclipse-leda-logo-white-transparent_hu9a062543d0484a5cb9683d4306669d63_91703_640x0_resize_catmullrom_3.png" width="640" height="233">
	
	<figcaption class="card-body px-0 pt-2 pb-0">
		<p class="card-text">
2182x794, white, transparent
</p>
	</figcaption>
	
</figure>

<h3 id="black-background">Black background</h3>







<figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 650px">
	<img class="card-img-top" src="/leda/docs/project-info/logo/eclipse-leda-logo-black_hu3de800b8cf15ea47f176e535cd90a422_110601_640x0_resize_catmullrom_3.png" width="640" height="233">
	
	<figcaption class="card-body px-0 pt-2 pb-0">
		<p class="card-text">
2182x794, black, opaque
<small class="text-muted"><br/>Credits: prothesis / kanellos @ 99designs.com | Font: https://www.dafont.com/olney.font</small></p>
	</figcaption>
	
</figure>








<figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 138px">
	<img class="card-img-top" src="/leda/docs/project-info/logo/icon_hue62b0b1a8d8b9fe0e0ffe6ab60b42779_84571_128x128_resize_catmullrom_3.png" width="128" height="128">
	
	<figcaption class="card-body px-0 pt-2 pb-0">
		<p class="card-text">
916x916, black
</p>
	</figcaption>
	
</figure>

<h2 id="for-print">For Print</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>File Format</th>
<th>Color model</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="eclipse-leda-logo_01_cmyk.ai">eclipse-leda-logo_01_cmyk.ai</a></td>
<td>Adobe Illustrator</td>
<td>CMYK, Black background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_01_cmyk.eps">eclipse-leda-logo_01_cmyk.eps</a></td>
<td>Encapsulated PostScript</td>
<td>CMYK, Black background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_01_cmyk.pdf">eclipse-leda-logo_01_cmyk.pdf</a></td>
<td>Portable Document Format</td>
<td>CMYK, Black background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_01_rgb.ai">eclipse-leda-logo_01_rgb.ai</a></td>
<td>Adobe Illustrator</td>
<td>RGB, Black background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_01_rgb.jpg">eclipse-leda-logo_01_rgb.jpg</a></td>
<td>JPEG</td>
<td>RGB, Black background, 2480x2480</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_01_rgb.png">eclipse-leda-logo_01_rgb.png</a></td>
<td>PNG</td>
<td>RGB, Black background, 2480x2480</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_cmyk.ai">eclipse-leda-logo_02_cmyk.ai</a></td>
<td>Adobe Illustrator</td>
<td>CMYK, Transparent background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_cmyk.eps">eclipse-leda-logo_02_cmyk.eps</a></td>
<td>Encapsulated PostScript</td>
<td>CMYK, Transparent background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_cmyk.pdf">eclipse-leda-logo_02_cmyk.pdf</a></td>
<td>Portable Document Format</td>
<td>CMYK, Transparent background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_rgb.ai">eclipse-leda-logo_02_rgb.ai</a></td>
<td>Adobe Illustrator</td>
<td>RGB, Transparent background</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_rgb.jpg">eclipse-leda-logo_02_rgb.jpg</a></td>
<td>JPEG</td>
<td>RGB, White background, 2480x2480</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_02_rgb.png">eclipse-leda-logo_02_rgb.png</a></td>
<td>PNG</td>
<td>RGB, Transparent background, 2480x2480</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_03_cmyk_cropped.svg">eclipse-leda-logo_03_cmyk_cropped.svg</a></td>
<td>Scalable Vector Graphics</td>
<td>CMYK, Transparent background, Cropped</td>
</tr>
<tr>
<td><a href="eclipse-leda-logo_03_cmyk.svg">eclipse-leda-logo_03_cmyk.svg</a></td>
<td>Scalable Vector Graphics</td>
<td>CMYK, Transparent background</td>
</tr>
</tbody>
</table>
<h2 id="colors">Colors</h2>
<ul>
<li>Primary Color: #6daed1</li>
<li>Secondary Color: #804096</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e0bf5ae54c0ca313e19d6dd625a83640">8.5 - Privacy Information</h1>
    
	<p>Your privacy is important to us. The following Information is to provide you with all information relevant to data protection in order to be able to use the software, in a data protection compliant manner. It is provided as an information source for your solution-specific data protection and data privacy topics. This is not intended to provide and should not be relied on for legal advice.</p>
<h3 id="your-role">Your Role</h3>
<p>First things first: when you choose and use our software, you are most likely acting in the role of data controller, if personal related data is being processed. Therefore, you must ensure that the processing of personal data complies with the respective local legal requirements, e.g. when processing data within the scope of General Data Protection Regulation (GDPR) the legal requirements for a controller from the GDPR.</p>
<h3 id="where-may-the-processing-of-personal-related-data-be-relevant">Where may the processing of personal related data be relevant?</h3>
<p>When using our software in combination with other software components, personal data or data categories may be collected for the purpose of developing, testing and running in-vehicle applications (Vehicle Apps). Possible examples are the vehicle identification number (VIN), the number plate, GPS data, video data, audio data, or other measurement data. You can determine which data or data categories are collected when configuring the software. These data are stored in volatile memory and are deleted by shutting down the system. You are responsible for the compliant handling of the data in accordance with the applicable local law.</p>
<h3 id="what-have-we-done-to-make-the-software-data-protection-friendly">What have we done to make the software data protection friendly?</h3>
<p>This section describes the measures taken to integrate the requirements of the data protection directly into the software development. The technical measures described below follow a &ldquo;privacy by design&rdquo; approach.</p>
<ul>
<li>
<p><strong>Local data:</strong> The software may save data permanently in local virtual storage (eg when run in QEMU Emulator) or on local physical storage (SD-Card on Raspberry PI). All collected or processed data can be deleted by either deleting the virtual storage file (*.qcow2), or by erasing the SD-Card.</p>
</li>
<li>
<p><strong>Cloud storage:</strong> The software may send data to cloud endpoints controlled by you or your organization. Examples include connectivity data, device identification, device health, device telemetry, application metrics and application logs. Collection and processing of example data on the device is enabled by default. Sending of device data to cloud endpoints must be explicitly enabled by performing the device provisioning process. The actual cloud endpoints are determined and configured during the device provisioning process. All collected or processed data can be deleted on the cloud side in the respective cloud endpoints.</p>
</li>
<li>
<p><strong>Vulnerabilities:</strong> The release process for this software is set up to always update to the newest package updates. The project will continously release new versions of the software. To protect personal data, it is advisable to always use the latest version of the software.</p>
</li>
<li>
<p><strong>Important:</strong> When you use the Eclipse Leda quickstart images for non-volatile setups, it is essential to reconfigure the system and harden it, this includes but is not limited to the following configuration items:</p>
<ul>
<li>Disable system user (root) password and login</li>
<li>Disable SSH login with password</li>
<li>Adding a new Linux user with restricted permissions</li>
<li>Adding SSH key based authentication</li>
<li>Container Resources and Configurations: Secrets, such as Device Identity Certificates for Cloud Connection and Access credentials for private Container Registries</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ec74413c19c356efd4199631c80850ae">8.6 - Security Policy</h1>
    
	<p>This project implements the Eclipse Foundation Security Policy</p>
<ul>
<li><a href="https://www.eclipse.org/security">https://www.eclipse.org/security</a></li>
</ul>
<h2 id="reporting-a-vulnerability">Reporting a Vulnerability</h2>
<p>Please report vulnerabilities to the Eclipse Foundation Security Team at
<a href="mailto:security@eclipse.org">security@eclipse.org</a></p>
<h2 id="supported-yocto-versions">Supported Yocto Versions</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>Yocto 4.x (Kirkstone)</td>
<td>Yes</td>
</tr>
<tr>
<td>Yocto 3.4 (Honister)</td>
<td>EOL</td>
</tr>
<tr>
<td>Yocto 3.3</td>
<td>Untested</td>
</tr>
<tr>
<td>Yocto &lt; 3.3</td>
<td>No</td>
</tr>
</tbody>
</table>
<p><strong>Important: When you use the quickstart images for non-volatile setups, it is essential to reconfigure the system and harden it.</strong></p>
<h2 id="configuration-items">Configuration Items</h2>
<ul>
<li>Disable system user (root) password and login</li>
<li>Disable SSH login with password</li>
<li>Adding a new Linux user with restricted permissions</li>
<li>Adding SSH key based authentication</li>
<li>Container Secrets
<ul>
<li>Device identity certificates for cloud connection</li>
<li>Access credentials for private container registries</li>
</ul>
</li>
</ul>
<h3 id="device-identity-for-cloud-connector">Device Identity for Cloud Connector</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Implementation</th>
<th>Intended use</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pre-Shared Symmetric Key</td>
<td>Azure IoT Hub Connection String</td>
<td>Development</td>
</tr>
<tr>
<td>Certificates</td>
<td>X.509 Certificates</td>
<td>Production</td>
</tr>
</tbody>
</table>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5b9855a34132ffcc60b905616e0cf498">9 - </h1>
    
	<ol>
<li>Download <a href="/leda/docs/general-usage/download-releases/">latest Eclipse Leda release</a></li>
<li>Run Eclipse Leda
<ul>
<li>on <a href="/leda/docs/general-usage/running-qemu/">emulated Qemu devices</a> or</li>
<li>on <a href="/leda/docs/general-usage/raspberry-pi/">Raspberry Pi 4</a></li>
</ul>
</li>
<li>Configure device, e.g. <a href="/leda/docs/device-provisioning/">provision the device</a></li>
<li>Explore the <a href="/leda/docs/build/misc/tools/">device tools</a></li>
<li>Develop your first Vehicle App using <a href="https://github.com/eclipse-velocitas/vehicle-app-python-template">Eclipse Velocitas template</a></li>
<li><a href="/leda/docs/app-deployment/">Deploy a Vehicle App to the device</a></li>
</ol>

</div>



    
	
  



          </main>
        </div>
      </div>
      


<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/eclipse-leda" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
        
          <p class="mt-2"><a href="/leda/docs/about/">About Leda</a></p>
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org">
        Eclipse Foundation
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/privacy.php">
        Privacy Policy
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/termsofuse.php">
        Terms of Use
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/copyright.php">
        Copyright Agent
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/">
        Legal
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/legal/epl-2.0/">
        License
      </a>
    </small>
  </li>
  
  <li class="list-inline-item mx-2">
    <small class="ml-1">
      <a class="text-footer-menu" target="_blank" rel="noopener" href="https://eclipse.org/security/">
        Report a Vulnerability
      </a>
    </small>
  </li>
  
</ul>

        
        
      </div>
  </div>
</footer>


    </div>
    
  <script src="/leda/js/main.min.054f118c2d3b183635f9655daee6fcebd03931cb3727d1f12fe0dda1fd784631.js" integrity="sha256-BU8RjC07GDY1&#43;WVdrub869A5Mcs3J9HxL&#43;Ddof14RjE=" crossorigin="anonymous"></script>
<script src='/leda/js/tabpane-persist.js'></script>

  </body>
</html>
